[{"content":"ç¬¬ä¸€ç« ï¼šå¤§æ‰«é™¤ â€”â€” æ ¹é™¤ Snap ç”Ÿæ€ èƒŒæ™¯åˆ†æï¼šSnap æ˜¯ Canonical æ¨å‡ºçš„é€šç”¨è½¯ä»¶åŒ…æ ¼å¼ï¼Œæ—¨åœ¨ç®€åŒ–è·¨å‘è¡Œç‰ˆéƒ¨ç½²ã€‚å…¶æ²™ç®±æœºåˆ¶å¸¦æ¥äº†å®‰å…¨ä¼˜åŠ¿ï¼Œä½†ä¹Ÿå¼•å…¥äº†æ˜¾è‘—çš„æ€§èƒ½å¼€é”€ï¼šé¦–æ¬¡å¯åŠ¨ç¼“æ…¢ã€åå°æœåŠ¡ï¼ˆsnapdï¼‰æŒç»­å ç”¨èµ„æºã€ä»¥åŠç£ç›˜ç©ºé—´çš„å¤§é‡æ¶ˆè€—ï¼ˆæ¯ä¸ªåº”ç”¨éƒ½æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„ loop deviceï¼‰ã€‚å¯¹äºå¼€å‘è€…æ¥è¯´ï¼Œè¿™äº›ä»£ä»·è¿œè¶…å…¶å¸¦æ¥çš„ä¾¿åˆ©ã€‚\nè¡ŒåŠ¨æ–¹æ¡ˆï¼šæˆ‘ä»¬çš„ç¬¬ä¸€æ­¥ï¼Œå°±æ˜¯å½»åº•ã€å¹²å‡€åœ°ç§»é™¤æ•´ä¸ª Snap ç”Ÿæ€ç³»ç»Ÿã€‚\nè¯†åˆ«å¹¶å¸è½½æ‰€æœ‰å·²å®‰è£…çš„ Snap åŒ…ï¼š\n# åˆ—å‡ºæ‰€æœ‰å·²å®‰è£…çš„ snap åŒ… snap list # é€ä¸€å¸è½½ï¼Œä» Firefox å¼€å§‹ sudo snap remove --purge firefox sudo snap remove --purge snap-store # ...å¸è½½å…¶ä»–æ‰€æœ‰ snap åŒ…... åœæ­¢å¹¶ç¦ç”¨ snapd æœåŠ¡ï¼š\nsudo systemctl disable --now snapd.service snapd.socket snapd.seeded.service å½»åº•æ¸…é™¤ snapd åŠå…¶æ®‹ç•™æ–‡ä»¶ï¼š\nsudo apt autoremove --purge snapd -y rm -rf ~/snap sudo rm -rf /var/cache/snapd/ å…³é”®é—®é¢˜ï¼šFirefox çš„æ›¿ä»£æ–¹æ¡ˆ\nç§»é™¤ Snap ç‰ˆ Firefox åï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªåŸç”Ÿçš„æ›¿ä»£å“ã€‚æœ€ä½³é€‰æ‹©æ˜¯ Mozilla å®˜æ–¹æä¾›çš„ PPAï¼ˆPersonal Package Archiveï¼‰ã€‚\n# æ·»åŠ  Mozilla å®˜æ–¹ PPA sudo add-apt-repository ppa:mozillateam/ppa # é…ç½® PPA ä¼˜å…ˆçº§ï¼Œç¡®ä¿ç³»ç»Ÿä¼˜å…ˆé€‰æ‹© PPA ç‰ˆæœ¬è€Œé Snap ç‰ˆæœ¬ echo \u0026#39; Package: * Pin: release o=LP-PPA-mozillateam Pin-Priority: 1001 \u0026#39; | sudo tee /etc/apt/preferences.d/mozilla-firefox # å®‰è£…åŸç”Ÿ .deb ç‰ˆ Firefox sudo apt update \u0026amp;\u0026amp; sudo apt install firefox -y è‡³æ­¤ï¼Œæˆ‘ä»¬å®Œæˆäº†ç¬¬ä¸€é¡¹é‡å¤§ä¼˜åŒ–ã€‚ç³»ç»Ÿå˜å¾—æ›´åŠ è½»ç›ˆï¼Œåå°å™ªéŸ³æ˜¾è‘—å‡å°‘ã€‚\nç¬¬äºŒç« ï¼šå¿ƒè„ç§»æ¤ â€”â€” æ¢è£… XanMod å†…æ ¸ èƒŒæ™¯åˆ†æï¼šLinux å†…æ ¸æ˜¯æ“ä½œç³»ç»Ÿçš„æ ¸å¿ƒï¼Œè´Ÿè´£ç®¡ç† CPUã€å†…å­˜å’Œç¡¬ä»¶ã€‚Ubuntu çš„é€šç”¨å†…æ ¸ï¼ˆGeneric Kernelï¼‰ä¸ºäº†ç¨³å®šæ€§å’Œå…¼å®¹æ€§ï¼Œåœ¨è°ƒåº¦å™¨ç­‰æ–¹é¢åšäº†å¾ˆå¤šä¿å®ˆçš„æƒè¡¡ã€‚è€Œ XanMod å†…æ ¸ æ˜¯ä¸€ä¸ªç¤¾åŒºé©±åŠ¨çš„é¡¹ç›®ï¼Œä¸“ä¸ºæ¡Œé¢ã€å¤šåª’ä½“å’Œæ¸¸æˆç­‰é«˜å“åº”æ€§åœºæ™¯ä¼˜åŒ–ã€‚å®ƒé‡‡ç”¨äº†æ›´å…ˆè¿›çš„è¿›ç¨‹è°ƒåº¦å™¨ï¼ˆå¦‚ Task Type Schedulerï¼‰ã€æ›´ä½çš„å»¶è¿Ÿé…ç½®å’Œæœ€æ–°çš„å†…æ ¸è¡¥ä¸ï¼Œèƒ½æ˜¾è‘—æå‡ç³»ç»Ÿçš„äº¤äº’æµç•…åº¦å’Œååé‡ã€‚\nè¡ŒåŠ¨æ–¹æ¡ˆï¼šä¸ºæˆ‘ä»¬çš„ç³»ç»Ÿæ›´æ¢ä¸€é¢—æ›´å¼ºåŠ²çš„â€œå¿ƒè„â€ã€‚\næ·»åŠ  XanMod çš„è½¯ä»¶æºï¼š\nwget -qO - https://dl.xanmod.org/archive.key | sudo gpg --dearmor -o /usr/share/keyrings/xanmod-archive-keyring.gpg echo \u0026#39;deb [signed-by=/usr/share/keyrings/xanmod-archive-keyring.gpg] http://deb.xanmod.org releases main\u0026#39; | sudo tee /etc/apt/sources.list.d/xanmod-release.list å®‰è£…é’ˆå¯¹ç°ä»£ CPU ä¼˜åŒ–çš„ç‰ˆæœ¬ï¼š XanMod æä¾›å¤šä¸ªç‰ˆæœ¬ã€‚å¯¹äºç°ä»£ AMD å’Œ Intel CPUï¼ˆ2015å¹´åï¼‰ï¼Œx64v3 ç‰ˆæœ¬æ˜¯æœ€ä½³é€‰æ‹©ï¼Œå› ä¸ºå®ƒåˆ©ç”¨äº† AVX/AVX2 ç­‰æ–°æŒ‡ä»¤é›†ã€‚\nsudo apt update # å®‰è£… x64v3 ç‰ˆæœ¬çš„ LTS (é•¿æœŸæ”¯æŒ) å†…æ ¸ sudo apt install linux-xanmod-lts-x64v3 -y é‡å¯ä¸éªŒè¯ï¼š å®‰è£…åï¼Œå¿…é¡»é‡å¯ç³»ç»Ÿä»¥åŠ è½½æ–°å†…æ ¸ã€‚\n# é‡å¯ç”µè„‘ sudo reboot # é‡å¯åï¼ŒéªŒè¯å†…æ ¸ç‰ˆæœ¬ uname -r # é¢„æœŸè¾“å‡ºåº”åŒ…å« \u0026#39;xanmod\u0026#39; å®Œæˆè¿™ä¸€æ­¥åï¼Œæ‚¨ä¼šç›´è§‚åœ°æ„Ÿè§‰åˆ°ç³»ç»Ÿå“åº”é€Ÿåº¦çš„æå‡ï¼Œå°¤å…¶æ˜¯åœ¨é«˜è´Ÿè½½ä¸‹çš„å¤šä»»åŠ¡å¤„ç†åœºæ™¯ã€‚\nç¬¬ä¸‰ç« ï¼šè§£é™¤å°å° â€”â€” ç¦ç”¨ CPU å®‰å…¨ç¼“è§£ èƒŒæ™¯åˆ†æï¼šè¿™æ˜¯æœ¬æ¬¡ä¼˜åŒ–ä¸­æœ€ç¡¬æ ¸ã€ä¹Ÿæœ€å…·äº‰è®®çš„ä¸€æ­¥ã€‚è‡ª Spectre å’Œ Meltdown æ¼æ´è¢«å‘ç°ä»¥æ¥ï¼Œæ‰€æœ‰ç°ä»£æ“ä½œç³»ç»Ÿéƒ½åŠ å…¥äº†è½¯ä»¶å±‚é¢çš„â€œç¼“è§£æªæ–½â€ï¼ˆMitigationsï¼‰æ¥é˜²æ­¢æ¶æ„æ”»å‡»ã€‚ç„¶è€Œï¼Œè¿™äº›å®‰å…¨è¡¥ä¸æ˜¯æœ‰æ€§èƒ½ä»£ä»·çš„ï¼Œå®ƒä»¬ä¼šç»™ CPU å¸¦æ¥ 5% åˆ° 30% ä¸ç­‰çš„æ€§èƒ½æŸå¤±ã€‚\nå¯¹äºä¸€ä¸ªç‰©ç†éš”ç¦»ã€ä¸è¿è¡Œä¸å—ä¿¡ä»»ä»£ç ã€ä¸”æ•°æ®éé«˜åº¦æ•æ„Ÿçš„å¼€å‘å·¥ä½œç«™æ¥è¯´ï¼Œæˆ‘ä»¬å¯ä»¥åšå‡ºä¸€ä¸ªæƒè¡¡ï¼šç”¨å¯æ¥å—çš„å®‰å…¨é£é™©ï¼Œæ¢å–å¯è§‚çš„åŸå§‹è®¡ç®—æ€§èƒ½ã€‚è¿™å¯¹äºç¼–è¯‘ã€ç§‘å­¦è®¡ç®—å’Œ AI æ¨ç†ç­‰ CPU å¯†é›†å‹ä»»åŠ¡ï¼Œæ”¶ç›Šå·¨å¤§ã€‚\nè¡ŒåŠ¨æ–¹æ¡ˆï¼šé€šè¿‡ä¿®æ”¹ GRUB å¼•å¯¼å‚æ•°ï¼ŒæŒ‡ç¤ºå†…æ ¸åœ¨å¯åŠ¨æ—¶ç¦ç”¨è¿™äº›ç¼“è§£æªæ–½ã€‚ä¸ºäº†ç¡®ä¿æ“ä½œçš„å®‰å…¨æ€§å’Œå¯é€†æ€§ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªä¸€é”®å¼å¼€å…³è„šæœ¬ã€‚\nåˆ›å»º toggle_cpu_mitigations.sh è„šæœ¬ï¼š è¿™ä¸ªè„šæœ¬çš„æ ¸å¿ƒæ˜¯é€šè¿‡ä¿®æ”¹ /etc/default/grub æ–‡ä»¶ä¸­çš„ GRUB_CMDLINE_LINUX_DEFAULT è¡Œï¼Œæ¥æ·»åŠ æˆ–ç§»é™¤ mitigations=off å‚æ•°ã€‚\nå®Œæ•´è„šæœ¬å†…å®¹è¯·å‚è€ƒé¡¹ç›® Git ä»“åº“ã€‚\næ‰§è¡Œè„šæœ¬ä»¥ç¦ç”¨ç¼“è§£æªæ–½ï¼š\n# èµ‹äºˆè„šæœ¬æ‰§è¡Œæƒé™ chmod +x toggle_cpu_mitigations.sh # è¿è¡Œè„šæœ¬ä»¥å…³é—­ç¼“è§£æªæ–½ sudo ./toggle_cpu_mitigations.sh on è¯¥è„šæœ¬ä¼šè‡ªåŠ¨å¤‡ä»½åŸå§‹é…ç½®ï¼Œç„¶ååº”ç”¨æ›´æ”¹å¹¶æ›´æ–° GRUBã€‚\né‡å¯ä¸éªŒè¯ï¼š åŒæ ·ï¼Œå¿…é¡»é‡å¯æ‰èƒ½ä½¿æ›´æ”¹ç”Ÿæ•ˆã€‚\n# é‡å¯ç”µè„‘ sudo reboot # é‡å¯åï¼Œæ£€æŸ¥æ¼æ´çŠ¶æ€ cat /sys/devices/system/cpu/vulnerabilities/* å¦‚æœçœ‹åˆ°å¤šä¸ªæ¼æ´çš„çŠ¶æ€ä» Mitigation å˜ä¸º Vulnerableï¼Œè¿™ä¸æ˜¯è­¦æŠ¥ï¼Œè€Œæ˜¯æˆåŠŸçš„æ ‡å¿—ã€‚å®ƒè¯æ˜äº†ç³»ç»Ÿçš„â€œå°å°â€å·²è¢«è§£é™¤ï¼ŒCPU æ­£ä»¥å…¶æœ€åŸå§‹çš„æ€§èƒ½è¿è¡Œã€‚\n","permalink":"https://jackypanster.github.io/ai-stream/posts/ubuntu-24-04-performance-tuning-guide/","summary":"\u003ch2 id=\"ç¬¬ä¸€ç« å¤§æ‰«é™¤--æ ¹é™¤-snap-ç”Ÿæ€\"\u003eç¬¬ä¸€ç« ï¼šå¤§æ‰«é™¤ â€”â€” æ ¹é™¤ Snap ç”Ÿæ€\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eèƒŒæ™¯åˆ†æ\u003c/strong\u003eï¼šSnap æ˜¯ Canonical æ¨å‡ºçš„é€šç”¨è½¯ä»¶åŒ…æ ¼å¼ï¼Œæ—¨åœ¨ç®€åŒ–è·¨å‘è¡Œç‰ˆéƒ¨ç½²ã€‚å…¶æ²™ç®±æœºåˆ¶å¸¦æ¥äº†å®‰å…¨ä¼˜åŠ¿ï¼Œä½†ä¹Ÿå¼•å…¥äº†æ˜¾è‘—çš„æ€§èƒ½å¼€é”€ï¼šé¦–æ¬¡å¯åŠ¨ç¼“æ…¢ã€åå°æœåŠ¡ï¼ˆ\u003ccode\u003esnapd\u003c/code\u003eï¼‰æŒç»­å ç”¨èµ„æºã€ä»¥åŠç£ç›˜ç©ºé—´çš„å¤§é‡æ¶ˆè€—ï¼ˆæ¯ä¸ªåº”ç”¨éƒ½æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„ loop deviceï¼‰ã€‚å¯¹äºå¼€å‘è€…æ¥è¯´ï¼Œè¿™äº›ä»£ä»·è¿œè¶…å…¶å¸¦æ¥çš„ä¾¿åˆ©ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eè¡ŒåŠ¨æ–¹æ¡ˆ\u003c/strong\u003eï¼šæˆ‘ä»¬çš„ç¬¬ä¸€æ­¥ï¼Œå°±æ˜¯å½»åº•ã€å¹²å‡€åœ°ç§»é™¤æ•´ä¸ª Snap ç”Ÿæ€ç³»ç»Ÿã€‚\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eè¯†åˆ«å¹¶å¸è½½æ‰€æœ‰å·²å®‰è£…çš„ Snap åŒ…\u003c/strong\u003eï¼š\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e# åˆ—å‡ºæ‰€æœ‰å·²å®‰è£…çš„ snap åŒ…\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003esnap list\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e# é€ä¸€å¸è½½ï¼Œä» Firefox å¼€å§‹\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003esudo snap remove --purge firefox\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003esudo snap remove --purge snap-store\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e# ...å¸è½½å…¶ä»–æ‰€æœ‰ snap åŒ…...\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eåœæ­¢å¹¶ç¦ç”¨ \u003ccode\u003esnapd\u003c/code\u003e æœåŠ¡\u003c/strong\u003eï¼š\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003esudo systemctl disable --now snapd.service snapd.socket snapd.seeded.service\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eå½»åº•æ¸…é™¤ \u003ccode\u003esnapd\u003c/code\u003e åŠå…¶æ®‹ç•™æ–‡ä»¶\u003c/strong\u003eï¼š\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003esudo apt autoremove --purge snapd -y\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003erm -rf ~/snap\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003esudo rm -rf /var/cache/snapd/\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e\u003cstrong\u003eå…³é”®é—®é¢˜ï¼šFirefox çš„æ›¿ä»£æ–¹æ¡ˆ\u003c/strong\u003e\u003c/p\u003e","title":"Ubuntu 24.04 ç»ˆææ€§èƒ½è°ƒä¼˜æŒ‡å—ï¼šä»ç³»ç»Ÿè‡ƒè‚¿åˆ°å†…æ ¸å®šåˆ¶"},{"content":" ä½¿ç”¨æ—§æ˜¾å¡ä¹Ÿèƒ½è·‘ 32B å¤§æ¨¡å‹ï¼Ÿæœ¬æ–‡æ‰‹æŠŠæ‰‹æ¼”ç¤ºå¦‚ä½•åœ¨ 4Ã—RTX 2080 Ti (å…± 88 GB æ˜¾å­˜) æœåŠ¡å™¨ä¸Šï¼Œé€šè¿‡ vLLM 0.8.5 + AWQ é‡åŒ–ï¼Œè·‘èµ· Qwen3-32B å¹¶æ”¯æŒ 32 K tokens è¶…é•¿ä¸Šä¸‹æ–‡ä¸é«˜ååæ¨ç†ã€‚å…¨æ–‡è®°å½•äº†è¸©å‘è¿‡ç¨‹ä¸å‚æ•°æƒè¡¡ï¼Œå¸Œæœ›ç»™åŒæ ·é¢„ç®—æœ‰é™ã€ç¡¬ä»¶å—é™çš„å·¥ç¨‹å¸ˆå¸¦æ¥å€Ÿé‰´ã€‚\n{{.TableOfContents}}\n1 é¡¹ç›®èƒŒæ™¯ ä¸»è§’ï¼šQwen3-32B-AWQ é‡åŒ–æ¨¡å‹ ï¼ˆâ‰ˆ 18 GBï¼‰ ç›®æ ‡ï¼šåœ¨æ¶ˆè´¹çº§ Turing æ¶æ„æ˜¾å¡ï¼ˆ2080 Tiï¼‰ä¸Šæœ€å¤§åŒ–åˆ©ç”¨æ˜¾å­˜ä¸ååã€‚ æ¡†æ¶ï¼švLLM 0.8.5 (openai-compatible server) å–èˆï¼šç‰ºç‰²éƒ¨åˆ†å»¶è¿Ÿ / ç¨³å®šæ€§ â†’ æ¢å– åå + ä¸Šä¸‹æ–‡é•¿åº¦ 2 ç¡¬ä»¶ä¸ç³»ç»Ÿç¯å¢ƒ ç»„ä»¶ è§„æ ¼ GPU 4 Ã— RTX 2080 Ti, 22 GB each, Compute Capability 7.5 CPU â‰¥ 56 cores (vLLM çº¿ç¨‹å¯åƒæ»¡) RAM 512 GB Storage NVMe SSD 2 TB (æ¨¡å‹ + KV ç¼“å†²) OS Ubuntu 24.04 Driver NVIDIA 570.153.02 CUDA 12.8 2.1 NVIDIA-SMI åŸºçº¿ä¿¡æ¯ nvidia-smi Wed Jul 16 13:27:17 2025 +-----------------------------------------------------------------------------------------+ | NVIDIA-SMI 570.153.02 Driver Version: 570.153.02 CUDA Version: 12.8 | +-----------------------------------------------------------------------------------------+ å¯ä»¥çœ‹åˆ°é©±åŠ¨ä¸ CUDA ç‰ˆæœ¬ä¸ä¸Šè¡¨ä¸€è‡´ï¼Œç¡®è®¤ç¯å¢ƒæ— åå·®ã€‚\nä¸ºä»€ä¹ˆ 2080 Tiï¼Ÿ äºŒæ‰‹å¸‚åœºä»·æ ¼å‹å¥½ï¼Œä½† Flash-Attention-2 ä¸æ”¯æŒï¼Œéœ€è¦è‡ªå·±ç¼–è¯‘ flash-attn-1 æˆ–ä½¿ç”¨ XFormersã€‚\n3 å¿«é€Ÿéƒ¨ç½²æ­¥éª¤æ¦‚è§ˆ ä¸‹è½½å¹¶è§£å‹ Qwen3-32B-AWQ æƒé‡è‡³ /home/llm/model/qwen/Qwen3-32B-AWQã€‚ ï¼ˆå¯é€‰ï¼‰ç¼–è¯‘ flash-attn-1 ä»¥æ›¿ä»£åŸç”Ÿ attentionã€‚ æ‹‰å–å®˜æ–¹ vLLM é•œåƒ vllm/vllm-openai:v0.8.5ã€‚ æŒ‰ä¸‹æ–‡ run.sh å‚æ•°å¯åŠ¨å®¹å™¨ã€‚ ä¸‹é¢æ‹†è§£æ¯ä¸€æ­¥çš„æŠ€æœ¯ç»†èŠ‚ã€‚\n3.1 æ¨¡å‹å‡†å¤‡ mkdir -p /home/llm/model/qwen # çœç•¥ huggingface-cli ç™»å½•æ­¥éª¤ huggingface-cli download Qwen/Qwen3-32B-AWQ --local-dir /home/llm/model/qwen/Qwen3-32B-AWQ --local-dir-use-symlinks False 3.2 ç¼–è¯‘ Flash-Attention-1ï¼ˆ2080 Ti ä¸“ç”¨ï¼‰ # CUDA 12.x + Python 3.12 ç¤ºä¾‹ python3 -m pip install --upgrade pip python3 -m pip install ninja packaging cmake # å¼ºåˆ¶æºç ç¼–è¯‘ï¼Œç¡®ä¿ç”Ÿæˆ sm75 kernel FLASH_ATTENTION_FORCE_BUILD=1 \\ python3 -m pip install flash-attn --no-build-isolation --no-binary :all: å®¹å™¨ç”¨æˆ·è¯·æ³¨æ„ï¼šå¦‚æœä½¿ç”¨ä¸‹æ–‡çš„å®˜æ–¹ vLLM Docker é•œåƒï¼Œéœ€åœ¨ å®¹å™¨å†…éƒ¨ æˆ–è‡ªå»º Dockerfile å®ŒæˆåŒæ ·çš„ flash-attn-1 ç¼–è¯‘ï¼ˆæˆ–å°†å·²ç¼–è¯‘å¥½çš„ wheel å¤åˆ¶è¿›é•œåƒï¼‰ã€‚å®¿ä¸»æœºå®‰è£…çš„ Python åŒ…ä¸ä¼šè¢«å®¹å™¨ç¯å¢ƒè¯»å–ã€‚\n3.2.1 æ— éœ€é‡å»ºå¤§é•œåƒçš„æŠ˜ä¸­åšæ³• åšæ³• è¯´æ˜ é¢å¤–ä½“ç§¯ å¯åŠ¨æ—¶ä¸´æ—¶ --pip-install vLLM â‰¥0.9 æ”¯æŒ --pip å‚æ•°ï¼Œå®¹å™¨å¯åŠ¨æ—¶å³åœ¨çº¿ç¼–è¯‘ flash-attn 0ï¼ˆç¼–è¯‘äº§ç‰©ç¼“å­˜äº volumeï¼‰ å®¿ä¸»æœºå…ˆç¼–è¯‘ wheel pip wheel flash-attn -w /tmp/wheelsï¼Œè¿è¡Œæ—¶æŒ‚è½½ /tmp/wheels å¹¶ pip install ~30-40 MB æ”¹ç”¨ XFormers åŠ  --xformersï¼Œæ€§èƒ½ç•¥ä½äº flash-attn-1ï¼Œä½†å…ç¼–è¯‘ 0 ä¿æŒé»˜è®¤ attention å¯¹ååè¦æ±‚ä¸€èˆ¬çš„åœºæ™¯å¯æ¥å— 0 æ¨èé¡ºåºï¼šä¸´æ—¶ --pip \u0026gt; wheel æŒ‚è½½ \u0026gt; XFormers \u0026gt; é»˜è®¤ Attentionã€‚æŒ‰ä¸šåŠ¡å¯¹æ€§èƒ½ \u0026amp; ç®€æ˜“åº¦çš„æƒè¡¡è‡ªè¡Œé€‰æ‹©ã€‚\néªŒè¯ï¼š\npython3 - \u0026lt;\u0026lt;\u0026#39;PY\u0026#39; import flash_attn, torch, platform print(\u0026#39;flash-attn\u0026#39;, flash_attn.__version__, \u0026#39;torch\u0026#39;, torch.__version__, \u0026#39;python\u0026#39;, platform.python_version()) PY 3.3 å¯åŠ¨è„šæœ¬ run.sh #!/usr/bin/env bash docker run -d \\ --runtime=nvidia --gpus=all --name coder \\ -v /home/llm/model/qwen/Qwen3-32B-AWQ:/model/Qwen3-32B-AWQ \\ -p 8888:8000 --cpuset-cpus 0-55 \\ --ulimit memlock=-1 --ulimit stack=67108864 --restart always --ipc=host \\ vllm/vllm-openai:v0.8.5 \\ --model /model/Qwen3-32B-AWQ --served-model-name coder \\ --tensor-parallel-size 4 --quantization awq --dtype auto \\ --max-model-len 32768 --max-num-batched-tokens 32768 \\ --gpu-memory-utilization 0.96 \\ --block-size 16 \\ --enable-prefix-caching \\ --swap-space 64 \\ --max-num-seqs 64 å®¹å™¨ vs æœ¬æœºï¼šç›´æ¥è£¸è·‘äº¦å¯ï¼Œæ ¸å¿ƒå‚æ•°å®Œå…¨ç›¸åŒã€‚å®¹å™¨ä¾¿äºå¤ç°ä¸å¿«é€Ÿé‡å¯ã€‚\n4 å…³é”®è¿è¡Œå‚æ•°æ‹†è§£ å‚æ•° ä½œç”¨ / è°ƒä¼˜æ€è·¯ --tensor-parallel-size 4 4 å¡åˆ‡åˆ†æ¨¡å‹å‚æ•°ï¼Œ2080 Ti å•å¡æ˜¾å­˜æœ‰é™å¿…é¡»æ‹†åˆ†ã€‚ --quantization awq å¯ç”¨ AWQ æƒé‡é‡åŒ–ï¼Œæ˜¾å­˜â‰ˆå†é™ 40%ã€‚æŸäº›é•¿æ–‡æœ¬åœºæ™¯ä¸‹ FP16 ä»æ›´å¿«ï¼Œéœ€å®æµ‹ã€‚ --max-model-len 32768 æ”¯æŒ 32 K tokensï¼›å¤§å¹…å¢åŠ  KV Cacheï¼Œéœ€è¦é…åˆ --swap-spaceã€‚ --max-num-batched-tokens 32768 å•æ‰¹æ¬¡ tokens ä¸Šé™ã€‚åå / æ˜¾å­˜ trade-offã€‚ --gpu-memory-utilization 0.96 è¿‘ä¹åƒæ»¡æ˜¾å­˜ï¼Œè°¨æ…è°ƒï¼›ç•™ 0.04 ä½œä½™é‡ã€‚ --block-size 16 KV Cache åˆ†å—ã€‚å—è¶Šå°è¶Šçµæ´»ï¼Œç®¡ç†å¼€é”€ç¨å¢ã€‚ --enable-prefix-caching é«˜å¤ç”¨ prompt å‘½ä¸­ç‡å¯\u0026gt;90%ï¼Œæ˜¾è‘—æå‡é•¿å¯¹è¯ååã€‚ --swap-space 64 å…è®¸ 64 GB CPU RAM ä½œä¸º KV Cache æº¢å‡ºã€‚swap å¤§å»¶è¿Ÿé«˜ã€‚ --max-num-seqs 64 æ§åˆ¶å¹¶å‘åºåˆ—æ•°ã€‚è¶Šå¤§ååé«˜ï¼Œé•¿æ–‡æœ¬ OOM é£é™©ä¹Ÿé«˜ã€‚ 5 API è°ƒç”¨èŒƒä¾‹ curl http://localhost:8888/v1/chat/completions \\ -H \u0026#39;Content-Type: application/json\u0026#39; \\ -d \u0026#39;{ \u0026#34;model\u0026#34;: \u0026#34;coder\u0026#34;, \u0026#34;messages\u0026#34;: [ {\u0026#34;role\u0026#34;: \u0026#34;system\u0026#34;, \u0026#34;content\u0026#34;: \u0026#34;ä½ æ˜¯ä¸€ä¸ªèªæ˜çš„ AI åŠ©æ‰‹ã€‚\u0026#34;}, {\u0026#34;role\u0026#34;: \u0026#34;user\u0026#34;, \u0026#34;content\u0026#34;: \u0026#34;è¯·å†™ä¸€ä¸ª Python å†’æ³¡æ’åºã€‚\u0026#34;} ], \u0026#34;max_tokens\u0026#34;: 512, \u0026#34;temperature\u0026#34;: 0.2 }\u0026#39; max_tokens å»ºè®® 512 ~ 2048ï¼›æé™ context æ—¶è¿‡å¤§æ˜“ OOMã€‚ stream=true å¯è·å¾—æµå¼è¾“å‡ºï¼›è€—æ—¶æ›´çŸ­ï¼Œå ç”¨æ›´ä½ã€‚ 6 æ€§èƒ½å‹æ¦¨æŠ€å·§ AWQ vs FP16 æŸäº›æ¨ç†é˜¶æ®µ AWQ kernel å°šæœªä¼˜åŒ–ï¼ŒğŸš€ ç»“æœ FP16 æ›´å¿«ã€‚å®æµ‹äºŒé€‰ä¸€ã€‚ Flash-Attn-1 / XFormers 2080 Ti æ—  Flash-Attn-2ï¼›ç¼–è¯‘ v1 æˆ–ä½¿ç”¨ XFormers çš†å¯ã€‚ KV Cache \u0026amp; Swap ç›‘æ§ gpu_kv_cache ä¸ swap_used ä¸¤é¡¹ï¼›é•¿æ–‡æœ¬æ˜“ç‚¸ã€‚ å¤šå®ä¾‹åˆ†å¡ æŠŠ 4 å¡æ‹†æˆ 2 Ã— 2 å¡å®ä¾‹ï¼Œå¯æé«˜ GPU åˆ©ç”¨ç‡ (ä¸åŒä¸šåŠ¡è´Ÿè½½)ã€‚ è‡ªåŠ¨é™çº§ åœ¨ API å±‚æ£€æµ‹ OOM â†’ è‡ªåŠ¨ç¼©çŸ­ä¸Šä¸‹æ–‡ or è°ƒå°å¹¶å‘ï¼Œä¿è¯å¯ç”¨æ€§ã€‚ 7 å¸¸è§é—®é¢˜é€ŸæŸ¥ ç—‡çŠ¶ è§£å†³æ–¹æ¡ˆ è¿”å›ä¸å®Œæ•´/æˆªæ–­ å¢å¤§ max_tokensï¼›ç¼©çŸ­è¾“å…¥ï¼›æ£€æŸ¥æ—¥å¿—ä¸­ context_windowã€‚ CUDA OOM / å®¹å™¨å´©æºƒ é™ä½ max-model-lenã€max-num-batched-tokensï¼›å¢å¤§ swap-spaceã€‚ æ¨ç†é€Ÿåº¦æ…¢ ç¡®è®¤ flash-attn-1 å·²å¯ç”¨ï¼›å¹¶å‘ä¸è¦è¿‡é«˜ï¼›å°è¯• FP16ã€‚ NCCL æ­»é” / hang åŠ  --disable-custom-all-reduce æˆ–å‡çº§ NCCLã€‚ 8 å®æˆ˜å‹æµ‹ç»“æœ (10 å¹¶å‘ Â· 32 K prompt) æŒ‡æ ‡ æ•°å€¼ Avg prompt throughput 63 K tokens/s Avg generation throughput 57 tokens/s å¹³å‡å“åº”æ—¶é—´ 5.63 s GPU KV Cache å ç”¨ 15 % Prefix cache å‘½ä¸­ç‡ 94 % é”™è¯¯ / OOM 0 é«˜ååå½’åŠŸäºï¼š1) prefix caching 2) AWQ é‡åŒ– 3) è¿‘ä¹æ»¡æ˜¾å­˜åˆ©ç”¨ã€‚\nç»“æœè§£è¯» ååï¼šè¾“å…¥é˜¶æ®µ 63K tokens/sï¼Œç”Ÿæˆé˜¶æ®µ 57 tokens/sï¼Œå¯¹ 32B æ¨¡å‹éå¸¸å¯è§‚ã€‚ èµ„æºï¼šGPU KV Cache ä»… 15 %ï¼›ç³»ç»Ÿè¿˜å¯ä¸Šè°ƒå¹¶å‘ / ä¸Šä¸‹æ–‡ã€‚ ç¨³å®šï¼šé•¿æ—¶é—´å‹æµ‹æ—  OOM / pendingï¼›å®¹å™¨ restart=always å¯å…œåº•ã€‚ 9 æ€»ç»“ \u0026amp; å»ºè®® ä½¿ç”¨æ—§ä¸–ä»£æ˜¾å¡å¹¶ä¸æ„å‘³ç€æ”¾å¼ƒå¤§æ¨¡å‹ã€‚é€šè¿‡ vLLM + AWQ + Prefix Cache ç­‰ç»„åˆæ‹³ï¼Œ4Ã—2080 Ti ä¾æ—§èƒ½å¤Ÿæ”¯æ’‘ Qwen3-32B çš„ 32 K è¶…é•¿ä¸Šä¸‹æ–‡æ¨ç†ã€‚\nç§‘ç ” / æµ‹è¯• åœºæ™¯ï¼šå¼ºçƒˆæ¨èè¯¥æ–¹æ¡ˆï¼Œå¯ç”¨æœ€ä½æˆæœ¬æ¢ç´¢å¤§æ¨¡å‹æ¨ç†æé™ã€‚ ç”Ÿäº§ åœºæ™¯ï¼šéœ€è°¨æ…è¯„ä¼°å´©æºƒæ¦‚ç‡ä¸å»¶è¿Ÿï¼Œåšå¥½ç›‘æ§ä¸è‡ªåŠ¨é™çº§ã€‚ âš™ï¸ åç»­æ–¹å‘\nè¿ç§»åˆ° RTX 5000 Ada ç­‰æ–°å¡ï¼Œå¯è§£é” Flash-Attn-2 ä¸æ›´é«˜å¸¦å®½ã€‚ å…³æ³¨ vLLM åç»­å¯¹ AWQ Kernel çš„ä¼˜åŒ–ï¼›å‡çº§ \u0026gt;=0.9 å¯èƒ½å…å»è‡ªå·±ç¼–è¯‘ã€‚ å°è¯• TensorRT-LLM è‡ªåŠ¨å¹¶è¡Œæ‹†åˆ†ï¼Œè·å¾—é¢å¤– 10~20% æ€§èƒ½ã€‚ ","permalink":"https://jackypanster.github.io/ai-stream/posts/qwen3-32b-2080ti-vllm-deploy/","summary":"\u003cblockquote\u003e\n\u003cp\u003eä½¿ç”¨æ—§æ˜¾å¡ä¹Ÿèƒ½è·‘ 32B å¤§æ¨¡å‹ï¼Ÿæœ¬æ–‡æ‰‹æŠŠæ‰‹æ¼”ç¤ºå¦‚ä½•åœ¨ \u003cstrong\u003e4Ã—RTX 2080 Ti (å…± 88 GB æ˜¾å­˜)\u003c/strong\u003e æœåŠ¡å™¨ä¸Šï¼Œé€šè¿‡ vLLM 0.8.5 + AWQ é‡åŒ–ï¼Œè·‘èµ· \u003cstrong\u003eQwen3-32B\u003c/strong\u003e å¹¶æ”¯æŒ \u003cstrong\u003e32 K tokens\u003c/strong\u003e è¶…é•¿ä¸Šä¸‹æ–‡ä¸é«˜ååæ¨ç†ã€‚å…¨æ–‡è®°å½•äº†è¸©å‘è¿‡ç¨‹ä¸å‚æ•°æƒè¡¡ï¼Œå¸Œæœ›ç»™åŒæ ·é¢„ç®—æœ‰é™ã€ç¡¬ä»¶å—é™çš„å·¥ç¨‹å¸ˆå¸¦æ¥å€Ÿé‰´ã€‚\u003c/p\u003e\u003c/blockquote\u003e\n\u003cp\u003e{{.TableOfContents}}\u003c/p\u003e\n\u003ch2 id=\"1-é¡¹ç›®èƒŒæ™¯\"\u003e1 é¡¹ç›®èƒŒæ™¯\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003eä¸»è§’ï¼š\u003ccode\u003eQwen3-32B-AWQ\u003c/code\u003e é‡åŒ–æ¨¡å‹  ï¼ˆâ‰ˆ 18 GBï¼‰\u003c/li\u003e\n\u003cli\u003eç›®æ ‡ï¼šåœ¨æ¶ˆè´¹çº§ \u003cstrong\u003eTuring\u003c/strong\u003e æ¶æ„æ˜¾å¡ï¼ˆ2080 Tiï¼‰ä¸Šæœ€å¤§åŒ–åˆ©ç”¨æ˜¾å­˜ä¸ååã€‚\u003c/li\u003e\n\u003cli\u003eæ¡†æ¶ï¼š\u003ccode\u003evLLM 0.8.5\u003c/code\u003e (openai-compatible server)\u003c/li\u003e\n\u003cli\u003eå–èˆï¼šç‰ºç‰²éƒ¨åˆ†å»¶è¿Ÿ / ç¨³å®šæ€§ â†’ æ¢å– \u003cstrong\u003eåå + ä¸Šä¸‹æ–‡é•¿åº¦\u003c/strong\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"2-ç¡¬ä»¶ä¸ç³»ç»Ÿç¯å¢ƒ\"\u003e2 ç¡¬ä»¶ä¸ç³»ç»Ÿç¯å¢ƒ\u003c/h2\u003e\n\u003ctable\u003e\n  \u003cthead\u003e\n      \u003ctr\u003e\n          \u003cth\u003eç»„ä»¶\u003c/th\u003e\n          \u003cth\u003eè§„æ ¼\u003c/th\u003e\n      \u003c/tr\u003e\n  \u003c/thead\u003e\n  \u003ctbody\u003e\n      \u003ctr\u003e\n          \u003ctd\u003eGPU\u003c/td\u003e\n          \u003ctd\u003e4 Ã— RTX 2080 Ti, 22 GB \u003cem\u003eeach\u003c/em\u003e, Compute Capability 7.5\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003eCPU\u003c/td\u003e\n          \u003ctd\u003eâ‰¥ 56 cores (vLLM çº¿ç¨‹å¯åƒæ»¡)\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003eRAM\u003c/td\u003e\n          \u003ctd\u003e512 GB\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003eStorage\u003c/td\u003e\n          \u003ctd\u003eNVMe SSD 2 TB (æ¨¡å‹ + KV ç¼“å†²)\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003eOS\u003c/td\u003e\n          \u003ctd\u003eUbuntu 24.04\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003eDriver\u003c/td\u003e\n          \u003ctd\u003eNVIDIA 570.153.02\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003eCUDA\u003c/td\u003e\n          \u003ctd\u003e12.8\u003c/td\u003e\n      \u003c/tr\u003e\n  \u003c/tbody\u003e\n\u003c/table\u003e\n\u003ch3 id=\"21-nvidia-smi-åŸºçº¿ä¿¡æ¯\"\u003e2.1 NVIDIA-SMI åŸºçº¿ä¿¡æ¯\u003c/h3\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003envidia-smi\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eWed Jul \u003cspan style=\"color:#ae81ff\"\u003e16\u003c/span\u003e 13:27:17 \u003cspan style=\"color:#ae81ff\"\u003e2025\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e+-----------------------------------------------------------------------------------------+\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e| NVIDIA-SMI 570.153.02             Driver Version: 570.153.02     CUDA Version: 12.8     |\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e+-----------------------------------------------------------------------------------------+\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cblockquote\u003e\n\u003cp\u003eå¯ä»¥çœ‹åˆ°é©±åŠ¨ä¸ CUDA ç‰ˆæœ¬ä¸ä¸Šè¡¨ä¸€è‡´ï¼Œç¡®è®¤ç¯å¢ƒæ— åå·®ã€‚\u003c/p\u003e","title":"Qwen3-32B-AWQ vLLM å¤šå¡ 2080 Ti æé™éƒ¨ç½²å®æˆ˜"},{"content":"å‰è¨€ æœåŠ¡å™¨ï¼š4å—NVIDIA RTX 2080 Tiï¼Œæ¯å¼ æ‹¥æœ‰22GBæ˜¾å­˜ï¼Œæ€»è®¡88GBçš„VRAMã€‚ç›®æ ‡ï¼šè®©Ollamaåœ¨è¿™å°æœºå™¨ä¸Šç«åŠ›å…¨å¼€ï¼Œä¸ºå¤§è¯­è¨€æ¨¡å‹æä¾›å¼ºåŠ²çš„æ¨ç†æœåŠ¡ã€‚\nç„¶è€Œï¼Œæœ€åˆçš„æƒ³æ³•â€”â€”â€œå¦‚ä½•ç”¨å…‰æ‰€æœ‰æ˜¾å­˜ï¼Ÿâ€â€”â€”å¾ˆå¿«è¢«è¯æ˜æ˜¯ä¸€ä¸ªè¯¯åŒºã€‚çœŸæ­£çš„ç›®æ ‡åº”è¯¥æ˜¯ï¼šå¦‚ä½•æœ€é«˜æ•ˆåœ°åˆ©ç”¨æ‰€æœ‰GPUèµ„æºï¼Œå®ç°æœ€å¤§çš„ååé‡å’Œæœ€ä½çš„å»¶è¿Ÿï¼Ÿ\næœ¬æ–‡å°†å®Œæ•´è®°å½•ä»æœ€åˆçš„é…ç½®æ¢ç´¢ï¼Œåˆ°å‘ç°å¹¶è§£å†³æ€§èƒ½ç“¶é¢ˆï¼Œå†åˆ°æœ€ç»ˆæ­å»ºèµ·ä¸€ä¸ªå¥å£®çš„4-GPUè´Ÿè½½å‡è¡¡æœåŠ¡é›†ç¾¤çš„å…¨è¿‡ç¨‹ã€‚è¿™ä¸ä»…æ˜¯ä¸€ä»½æ“ä½œæŒ‡å—ï¼Œæ›´æ˜¯ä¸€æ¬¡å……æ»¡æ´è§çš„æ€§èƒ½ä¼˜åŒ–ä¹‹æ—…ã€‚\nç¬¬ä¸€ç« ï¼šåˆæ¢é…ç½®ï¼Œå•å¡è¿è¡Œçš„â€œçœŸç›¸â€ é¦–å…ˆï¼Œç¡®è®¤ç¡¬ä»¶å·²è¢«ç³»ç»Ÿæ­£ç¡®è¯†åˆ«ã€‚\n$ nvidia-smi -L GPU 0: NVIDIA GeForce RTX 2080 Ti (UUID: GPU-b5040762-a75e-f78a-87eb-d288e4725f64) GPU 1: NVIDIA GeForce RTX 2080 Ti (UUID: GPU-651b0fe5-cdad-1851-df5d-e122f85ff10c) GPU 2: NVIDIA GeForce RTX 2080 Ti (UUID: GPU-7674114f-1e22-374d-982f-7446da0ce35f) GPU 3: NVIDIA GeForce RTX 2080 Ti (UUID: GPU-04eaff5d-28e2-94f3-3dd6-c0985dfdad24) å››å¼ å¡éƒ½åœ¨ï¼Œä¸€åˆ‡æ­£å¸¸ã€‚é€šè¿‡systemdæ¥ç®¡ç†OllamaæœåŠ¡ï¼Œå¹¶è®©å®ƒèƒ½â€œçœ‹åˆ°â€æ‰€æœ‰GPUã€‚\nsudo systemctl edit ollama.service åœ¨é…ç½®æ–‡ä»¶ä¸­ï¼Œè®¾ç½®äº†ä»¥ä¸‹å…³é”®ç¯å¢ƒå˜é‡ï¼š\n[Service] Environment=\u0026#34;OLLAMA_HOST=0.0.0.0:9000\u0026#34; Environment=\u0026#34;CUDA_VISIBLE_DEVICES=0,1,2,3\u0026#34; # å…¶ä»–æ€§èƒ½ç›¸å…³é…ç½®... é‡å¯æœåŠ¡åï¼Œè¿è¡Œäº†ä¸€ä¸ªçº¦7.5GBçš„gemma3næ¨¡å‹ã€‚é€šè¿‡nvidia-smiè§‚å¯Ÿï¼Œä¸€ä¸ªå…³é”®ç°è±¡å‡ºç°äº†ï¼šåªæœ‰ä¸€å—GPUçš„æ˜¾å­˜è¢«å ç”¨äº†ï¼\nç»“è®ºä¸€ï¼šOllamaè¶³å¤Ÿæ™ºèƒ½ã€‚ å¯¹äºè¿œå°äºå•å¡æ˜¾å­˜çš„æ¨¡å‹ï¼Œå®ƒä¼šä¼˜å…ˆåœ¨å•å¼ å¡å†…å®Œæˆæ‰€æœ‰è®¡ç®—ï¼Œä»¥é¿å…è·¨GPUé€šä¿¡å¸¦æ¥çš„æ€§èƒ½å¼€é”€ã€‚è¿™æ˜¯æœ€é«˜æ•ˆçš„åšæ³•ï¼Œä¹Ÿæ‰“ç ´äº†â€œå¿…é¡»ç”¨å…‰æ‰€æœ‰æ˜¾å­˜â€çš„è¿·æ€ã€‚\nç¬¬äºŒç« ï¼šå‹åŠ›æµ‹è¯•ï¼Œæ­å¼€è½¯ä»¶ç“¶é¢ˆçš„é¢çº± æ—¢ç„¶æ˜¯å•å¡åœ¨å·¥ä½œï¼Œé‚£å®ƒçš„æ€§èƒ½æé™åœ¨å“ªé‡Œï¼Ÿç¼–å†™äº†ä¸€ä¸ªPythonå¼‚æ­¥å‹æµ‹è„šæœ¬ï¼Œæ¨¡æ‹Ÿå¤šä¸ªå¹¶å‘ç”¨æˆ·ã€‚\nå‹æµ‹è„šæœ¬ benchmark.py (æ ¸å¿ƒé€»è¾‘): ä½¿ç”¨asyncioå’Œaiohttpåº“ï¼Œåˆ›å»ºå¤šä¸ªå¹¶å‘çš„workerï¼Œå‘Ollamaçš„/api/generateæµå¼ç«¯ç‚¹å‘é€è¯·æ±‚ï¼Œå¹¶æ”¶é›†æˆåŠŸç‡ã€é¦–å­—å“åº”æ—¶é—´ï¼ˆTTFTï¼‰å’Œååé‡ï¼ˆTPSï¼‰ç­‰æŒ‡æ ‡ã€‚\nå¯¹å½“å‰é…ç½®ï¼ˆOLLAMA_NUM_PARALLEL=4ï¼‰è¿›è¡Œäº†æµ‹è¯•ã€‚\nå¹¶å‘ç”¨æˆ·æ•° å¹³å‡é¦–å­—å“åº” (TTFT) æ•´ä½“æœåŠ¡ååé‡ (TPS) 5 4.4 ç§’ 89.06 tokens/ç§’ 10 13.5 ç§’ 105.71 tokens/ç§’ 20 36.7 ç§’ 104.73 tokens/ç§’ ç»“æœè§¦ç›®æƒŠå¿ƒï¼\næ€§èƒ½æ‹ç‚¹ï¼šå½“å¹¶å‘æ•°ä»10å¢åŠ åˆ°20æ—¶ï¼Œæ€»ååé‡ä¸å†å¢é•¿ï¼Œç¨³å®šåœ¨çº¦105 TPSã€‚è¿™æ˜¯æœåŠ¡å™¨è¾¾åˆ°æ€§èƒ½ä¸Šé™çš„æ˜ç¡®ä¿¡å·ã€‚ å»¶è¿Ÿé›ªå´©ï¼šä¸æ­¤åŒæ—¶ï¼Œå¹³å‡é¦–å­—å“åº”æ—¶é—´ä»13.5ç§’ç¾éš¾æ€§åœ°é£™å‡è‡³36.7ç§’ï¼è¿™æ„å‘³ç€ç”¨æˆ·ä½“éªŒå·²ç»å·®åˆ°æ— æ³•æ¥å—ã€‚ ç“¶é¢ˆåˆ†æï¼šç¡¬ä»¶ï¼ˆå•å¼ 2080 Tiï¼‰æ˜¾ç„¶æ²¡æœ‰è·‘æ»¡ï¼Œé—®é¢˜å‡ºåœ¨å“ªé‡Œï¼Ÿç­”æ¡ˆå°±åœ¨Ollamaçš„é…ç½®é‡Œï¼šOLLAMA_NUM_PARALLEL=4ã€‚è¿™ä¸ªå‚æ•°é™åˆ¶äº†OllamaæœåŠ¡åœ¨åŒä¸€æ—¶åˆ»æœ€å¤šå¹¶è¡Œå¤„ç†4ä¸ªè¯·æ±‚ã€‚å½“20ä¸ªè¯·æ±‚æ¶Œå…¥æ—¶ï¼Œæœ‰16ä¸ªéƒ½åœ¨æ’é˜Ÿç­‰å¾…ï¼Œå¯¼è‡´äº†å·¨å¤§çš„å»¶è¿Ÿã€‚\næˆ‘ä»¬æ‰¾åˆ°äº†ç¬¬ä¸€ä¸ªçœŸæ­£çš„ç“¶é¢ˆï¼šè½¯ä»¶é…ç½®é™åˆ¶ã€‚\nç¬¬ä¸‰ç« ï¼šå‚æ•°è°ƒä¼˜ï¼Œé‡Šæ”¾å•å¡å…¨éƒ¨æ½œåŠ› æˆ‘ä»¬ç«‹å³å°†ç“¶é¢ˆå‚æ•°è°ƒæ•´ä¸ºä¸€ä¸ªæ›´é«˜çš„å€¼ã€‚\n# åœ¨ systemd é…ç½®æ–‡ä»¶ä¸­ä¿®æ”¹ Environment=\u0026#34;OLLAMA_NUM_PARALLEL=16\u0026#34; é‡å¯æœåŠ¡åï¼Œç”¨åŒæ ·çš„åœºæ™¯å†æ¬¡å‹æµ‹ï¼Œç»“æœä»¤äººæŒ¯å¥‹ï¼š\nå¹¶å‘æ•° æ€§èƒ½æŒ‡æ ‡ ä¼˜åŒ–å‰ (Parallel=4) ä¼˜åŒ–å (Parallel=16) æ€§èƒ½æå‡å¹…åº¦ 20 ååé‡ (TPS) 104.73 tokens/ç§’ 204.70 tokens/ç§’ + 95.5% (å‡ ä¹ç¿»å€) å“åº”æ—¶é—´ (TTFT) 36.7 ç§’ 4.8 ç§’ â†“ 86.8% (é€Ÿåº¦æå‡7.5å€) ç»“è®ºäºŒï¼šä¸€æ¬¡æ•™ç§‘ä¹¦å¼çš„æˆåŠŸä¼˜åŒ–ã€‚ é€šè¿‡ç®€å•åœ°è°ƒæ•´ä¸€ä¸ªå‚æ•°ï¼Œæˆ‘ä»¬å°†å•å¡çš„ååèƒ½åŠ›ç¿»äº†ä¸€ç•ªï¼ŒåŒæ—¶å°†é«˜å¹¶å‘ä¸‹çš„å»¶è¿Ÿé™ä½äº†87%ã€‚è¿™è¯æ˜äº†æ€§èƒ½ç“¶é¢ˆå·²ç»æˆåŠŸåœ°ä»è½¯ä»¶é˜Ÿåˆ—è½¬ç§»åˆ°äº†æ›´åº•å±‚çš„ç¡¬ä»¶â€”â€”å³è¿™å—2080 Tiçš„åŸå§‹è®¡ç®—èƒ½åŠ›ã€‚\nç¬¬å››ç« ï¼šç»ˆæå½¢æ€ï¼Œæ„å»º4-GPUæœåŠ¡é›†ç¾¤ å•å¡æ€§èƒ½å·²ä¼˜åŒ–åˆ°æé™ï¼Œä½†è¿˜æœ‰ä¸‰å¼ GPUåœ¨â€œæ—è§‚â€ã€‚æœ€ä½³æ–¹æ¡ˆæ˜¯ï¼šä¸ºæ¯å¼ GPUéƒ¨ç½²ä¸€ä¸ªç‹¬ç«‹çš„Ollamaå®ä¾‹ï¼Œå¹¶ç”¨Nginxå®ç°è´Ÿè½½å‡è¡¡ã€‚\n1. ä½¿ç”¨ systemd æ¨¡æ¿å•å…ƒ ä¸ºäº†ä¼˜é›…åœ°ç®¡ç†4ä¸ªæœåŠ¡ï¼Œæˆ‘ä»¬ä½¿ç”¨systemdçš„æ¨¡æ¿åŠŸèƒ½ï¼Œåˆ›å»ºollama@.serviceæ–‡ä»¶ã€‚\n# åˆ›å»ºæ¨¡æ¿æ–‡ä»¶ /etc/systemd/system/ollama@.service sudo nano /etc/systemd/system/ollama@.service [Unit] Description=Ollama Service Instance for GPU %i After=network-online.target [Service] # ä½¿ç”¨ %i åŠ¨æ€è®¡ç®—ç«¯å£å·ï¼Œå¹¶ç»‘å®šåˆ°å¯¹åº”GPU ExecStart=/bin/bash -c \u0026#39;OLLAMA_HOST=0.0.0.0:$(expr 9000 + %i) /usr/local/bin/ollama serve\u0026#39; User=ollama Group=ollama Restart=always RestartSec=3 Environment=\u0026#34;CUDA_VISIBLE_DEVICES=%i\u0026#34; Environment=\u0026#34;OLLAMA_NUM_PARALLEL=16\u0026#34; # æ¯ä¸ªå®ä¾‹éƒ½å…·å¤‡é«˜å¹¶è¡Œå¤„ç†èƒ½åŠ› # ... å…¶ä»–é…ç½® [Install] WantedBy=multi-user.target ç„¶åç”¨ä¸€ä¸ªå¾ªç¯å¯åŠ¨å¹¶å¯ç”¨æ‰€æœ‰å®ä¾‹ï¼š\n# å…ˆåœç”¨æ—§æœåŠ¡ sudo systemctl stop ollama.service sudo systemctl disable ollama.service # å¯åŠ¨æ¨¡æ¿å®ä¾‹ sudo systemctl daemon-reload for i in {0..3}; do sudo systemctl enable --now ollama@$i.service; done 2. é…ç½® Nginx è´Ÿè½½å‡è¡¡ è®©Nginxç›‘å¬ä¸€ä¸ªç»Ÿä¸€çš„å…¥å£ç«¯å£9999ï¼Œå¹¶å°†æµé‡è½®è¯¢åˆ†å‘ç»™åç«¯çš„4ä¸ªOllamaå®ä¾‹ã€‚\n# åœ¨ /etc/nginx/conf.d/ ä¸­åˆ›å»ºé…ç½®æ–‡ä»¶ sudo nano /etc/nginx/conf.d/ollama-cluster.conf # å®šä¹‰Ollamaåç«¯æœåŠ¡å™¨é›†ç¾¤ upstream ollama_backend { server localhost:9000; server localhost:9001; server localhost:9002; server localhost:9003; } server { # ç›‘å¬ç»Ÿä¸€å…¥å£ç«¯å£ listen 9999; server_name _; location / { proxy_pass http://ollama_backend; # é’ˆå¯¹æµå¼APIçš„ä¼˜åŒ–ï¼Œå…³é—­ç¼“å†²ï¼Œå¢åŠ è¶…æ—¶ proxy_read_timeout 3600s; proxy_buffering off; # å…¶ä»–å¿…è¦çš„ä»£ç†å¤´éƒ¨è®¾ç½®... } } æµ‹è¯•å¹¶é‡å¯Nginxåï¼Œæˆ‘ä»¬çš„æœåŠ¡é›†ç¾¤å°±æ­å»ºå®Œæˆäº†ã€‚\nç¬¬äº”ç« ï¼šé›†ç¾¤å‹æµ‹ï¼Œè§è¯çŒ›å…½å’†å“® ä¸‡äº‹ä¿±å¤‡ï¼Œæˆ‘ä»¬å¯¹æœ€ç»ˆçš„è´Ÿè½½å‡è¡¡å…¥å£ http://localhost:9999 å‘èµ·äº†æœ€åçš„æ€»æ”»ï¼ˆ20å¹¶å‘ï¼‰ã€‚\næ€§èƒ½æŒ‡æ ‡ å•GPUä¼˜åŒ– (c=20) 4-GPUé›†ç¾¤ (c=20) æ€§èƒ½æå‡å¹…åº¦ ååé‡ (TPS) 204.70 tokens/ç§’ 366.01 tokens/ç§’ + 78.8% å“åº”æ—¶é—´ (TTFT) 4.8 ç§’ 0.75 ç§’ â†“ 84.5% (é€Ÿåº¦æå‡6.4å€) æœ€ç»ˆç»“è®ºï¼šå·¨å¤§æˆåŠŸï¼\nååé‡ï¼šé›†ç¾¤çš„æ€»ååèƒ½åŠ›ç›¸æ¯”ä¼˜åŒ–åçš„å•å¡ï¼Œå†æ¬¡æå‡äº†è¿‘80%ã€‚è¿™è¯æ˜äº†è´Ÿè½½å‡è¡¡æ¶æ„çš„æœ‰æ•ˆæ€§ã€‚ å“åº”å»¶è¿Ÿï¼šTTFTä»4.8ç§’éª¤é™è‡³0.75ç§’ï¼Œå‡ ä¹å®ç°äº†ç¬æ—¶å“åº”ã€‚è¿™å¯¹äºä»»ä½•äº¤äº’å¼åº”ç”¨éƒ½æ˜¯å†³å®šæ€§çš„ä½“éªŒæå‡ã€‚ æˆåŠŸåœ°å°†ä¸€å°æ‹¥æœ‰4å—GPUçš„å¼ºå¤§æœåŠ¡å™¨ï¼Œä»ä¸€ä¸ªå•ç‚¹æœåŠ¡æ¼”è¿›ä¸ºä¸€ä¸ªå¥å£®ã€é«˜æ€§èƒ½ã€é«˜å¹¶å‘çš„AIæ¨¡å‹æœåŠ¡é›†ç¾¤ã€‚å®ƒå·²ç»ä¸ºæ‰¿è½½ç”Ÿäº§çº§çš„åº”ç”¨è¯·æ±‚åšå¥½äº†å……åˆ†çš„å‡†å¤‡ã€‚\n","permalink":"https://jackypanster.github.io/ai-stream/posts/the-ultimate-guide-to-multi-gpu-ollama-deployment/","summary":"\u003ch2 id=\"å‰è¨€\"\u003eå‰è¨€\u003c/h2\u003e\n\u003cp\u003eæœåŠ¡å™¨ï¼š4å—NVIDIA RTX 2080 Tiï¼Œæ¯å¼ æ‹¥æœ‰22GBæ˜¾å­˜ï¼Œæ€»è®¡88GBçš„VRAMã€‚ç›®æ ‡ï¼šè®©Ollamaåœ¨è¿™å°æœºå™¨ä¸Šç«åŠ›å…¨å¼€ï¼Œä¸ºå¤§è¯­è¨€æ¨¡å‹æä¾›å¼ºåŠ²çš„æ¨ç†æœåŠ¡ã€‚\u003c/p\u003e\n\u003cp\u003eç„¶è€Œï¼Œæœ€åˆçš„æƒ³æ³•â€”â€”â€œå¦‚ä½•ç”¨å…‰æ‰€æœ‰æ˜¾å­˜ï¼Ÿâ€â€”â€”å¾ˆå¿«è¢«è¯æ˜æ˜¯ä¸€ä¸ªè¯¯åŒºã€‚çœŸæ­£çš„ç›®æ ‡åº”è¯¥æ˜¯ï¼š\u003cstrong\u003eå¦‚ä½•æœ€é«˜æ•ˆåœ°åˆ©ç”¨æ‰€æœ‰GPUèµ„æºï¼Œå®ç°æœ€å¤§çš„ååé‡å’Œæœ€ä½çš„å»¶è¿Ÿï¼Ÿ\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eæœ¬æ–‡å°†å®Œæ•´è®°å½•ä»æœ€åˆçš„é…ç½®æ¢ç´¢ï¼Œåˆ°å‘ç°å¹¶è§£å†³æ€§èƒ½ç“¶é¢ˆï¼Œå†åˆ°æœ€ç»ˆæ­å»ºèµ·ä¸€ä¸ªå¥å£®çš„4-GPUè´Ÿè½½å‡è¡¡æœåŠ¡é›†ç¾¤çš„å…¨è¿‡ç¨‹ã€‚è¿™ä¸ä»…æ˜¯ä¸€ä»½æ“ä½œæŒ‡å—ï¼Œæ›´æ˜¯ä¸€æ¬¡å……æ»¡æ´è§çš„æ€§èƒ½ä¼˜åŒ–ä¹‹æ—…ã€‚\u003c/p\u003e\n\u003ch2 id=\"ç¬¬ä¸€ç« åˆæ¢é…ç½®å•å¡è¿è¡Œçš„çœŸç›¸\"\u003eç¬¬ä¸€ç« ï¼šåˆæ¢é…ç½®ï¼Œå•å¡è¿è¡Œçš„â€œçœŸç›¸â€\u003c/h2\u003e\n\u003cp\u003eé¦–å…ˆï¼Œç¡®è®¤ç¡¬ä»¶å·²è¢«ç³»ç»Ÿæ­£ç¡®è¯†åˆ«ã€‚\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e$ nvidia-smi -L\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eGPU 0: NVIDIA GeForce RTX \u003cspan style=\"color:#ae81ff\"\u003e2080\u003c/span\u003e Ti \u003cspan style=\"color:#f92672\"\u003e(\u003c/span\u003eUUID: GPU-b5040762-a75e-f78a-87eb-d288e4725f64\u003cspan style=\"color:#f92672\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eGPU 1: NVIDIA GeForce RTX \u003cspan style=\"color:#ae81ff\"\u003e2080\u003c/span\u003e Ti \u003cspan style=\"color:#f92672\"\u003e(\u003c/span\u003eUUID: GPU-651b0fe5-cdad-1851-df5d-e122f85ff10c\u003cspan style=\"color:#f92672\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eGPU 2: NVIDIA GeForce RTX \u003cspan style=\"color:#ae81ff\"\u003e2080\u003c/span\u003e Ti \u003cspan style=\"color:#f92672\"\u003e(\u003c/span\u003eUUID: GPU-7674114f-1e22-374d-982f-7446da0ce35f\u003cspan style=\"color:#f92672\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eGPU 3: NVIDIA GeForce RTX \u003cspan style=\"color:#ae81ff\"\u003e2080\u003c/span\u003e Ti \u003cspan style=\"color:#f92672\"\u003e(\u003c/span\u003eUUID: GPU-04eaff5d-28e2-94f3-3dd6-c0985dfdad24\u003cspan style=\"color:#f92672\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eå››å¼ å¡éƒ½åœ¨ï¼Œä¸€åˆ‡æ­£å¸¸ã€‚é€šè¿‡\u003ccode\u003esystemd\u003c/code\u003eæ¥ç®¡ç†OllamaæœåŠ¡ï¼Œå¹¶è®©å®ƒèƒ½â€œçœ‹åˆ°â€æ‰€æœ‰GPUã€‚\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003esudo systemctl edit ollama.service\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eåœ¨é…ç½®æ–‡ä»¶ä¸­ï¼Œè®¾ç½®äº†ä»¥ä¸‹å…³é”®ç¯å¢ƒå˜é‡ï¼š\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-ini\" data-lang=\"ini\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#66d9ef\"\u003e[Service]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a6e22e\"\u003eEnvironment\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;OLLAMA_HOST=0.0.0.0:9000\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a6e22e\"\u003eEnvironment\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;CUDA_VISIBLE_DEVICES=0,1,2,3\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e# å…¶ä»–æ€§èƒ½ç›¸å…³é…ç½®...\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eé‡å¯æœåŠ¡åï¼Œè¿è¡Œäº†ä¸€ä¸ªçº¦7.5GBçš„\u003ccode\u003egemma3n\u003c/code\u003eæ¨¡å‹ã€‚é€šè¿‡\u003ccode\u003envidia-smi\u003c/code\u003eè§‚å¯Ÿï¼Œä¸€ä¸ªå…³é”®ç°è±¡å‡ºç°äº†ï¼šåªæœ‰ä¸€å—GPUçš„æ˜¾å­˜è¢«å ç”¨äº†ï¼\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eç»“è®ºä¸€ï¼šOllamaè¶³å¤Ÿæ™ºèƒ½ã€‚\u003c/strong\u003e å¯¹äºè¿œå°äºå•å¡æ˜¾å­˜çš„æ¨¡å‹ï¼Œå®ƒä¼šä¼˜å…ˆåœ¨å•å¼ å¡å†…å®Œæˆæ‰€æœ‰è®¡ç®—ï¼Œä»¥é¿å…è·¨GPUé€šä¿¡å¸¦æ¥çš„æ€§èƒ½å¼€é”€ã€‚è¿™æ˜¯æœ€é«˜æ•ˆçš„åšæ³•ï¼Œä¹Ÿæ‰“ç ´äº†â€œå¿…é¡»ç”¨å…‰æ‰€æœ‰æ˜¾å­˜â€çš„è¿·æ€ã€‚\u003c/p\u003e\n\u003ch2 id=\"ç¬¬äºŒç« å‹åŠ›æµ‹è¯•æ­å¼€è½¯ä»¶ç“¶é¢ˆçš„é¢çº±\"\u003eç¬¬äºŒç« ï¼šå‹åŠ›æµ‹è¯•ï¼Œæ­å¼€è½¯ä»¶ç“¶é¢ˆçš„é¢çº±\u003c/h2\u003e\n\u003cp\u003eæ—¢ç„¶æ˜¯å•å¡åœ¨å·¥ä½œï¼Œé‚£å®ƒçš„æ€§èƒ½æé™åœ¨å“ªé‡Œï¼Ÿç¼–å†™äº†ä¸€ä¸ªPythonå¼‚æ­¥å‹æµ‹è„šæœ¬ï¼Œæ¨¡æ‹Ÿå¤šä¸ªå¹¶å‘ç”¨æˆ·ã€‚\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003e\u003cstrong\u003eå‹æµ‹è„šæœ¬ \u003ccode\u003ebenchmark.py\u003c/code\u003e (æ ¸å¿ƒé€»è¾‘)\u003c/strong\u003e:\nä½¿ç”¨\u003ccode\u003easyncio\u003c/code\u003eå’Œ\u003ccode\u003eaiohttp\u003c/code\u003eåº“ï¼Œåˆ›å»ºå¤šä¸ªå¹¶å‘çš„workerï¼Œå‘Ollamaçš„\u003ccode\u003e/api/generate\u003c/code\u003eæµå¼ç«¯ç‚¹å‘é€è¯·æ±‚ï¼Œå¹¶æ”¶é›†æˆåŠŸç‡ã€é¦–å­—å“åº”æ—¶é—´ï¼ˆTTFTï¼‰å’Œååé‡ï¼ˆTPSï¼‰ç­‰æŒ‡æ ‡ã€‚\u003c/p\u003e\u003c/blockquote\u003e\n\u003cp\u003eå¯¹å½“å‰é…ç½®ï¼ˆ\u003ccode\u003eOLLAMA_NUM_PARALLEL=4\u003c/code\u003eï¼‰è¿›è¡Œäº†æµ‹è¯•ã€‚\u003c/p\u003e\n\u003ctable\u003e\n  \u003cthead\u003e\n      \u003ctr\u003e\n          \u003cth style=\"text-align: left\"\u003eå¹¶å‘ç”¨æˆ·æ•°\u003c/th\u003e\n          \u003cth style=\"text-align: left\"\u003eå¹³å‡é¦–å­—å“åº” (TTFT)\u003c/th\u003e\n          \u003cth style=\"text-align: left\"\u003eæ•´ä½“æœåŠ¡ååé‡ (TPS)\u003c/th\u003e\n      \u003c/tr\u003e\n  \u003c/thead\u003e\n  \u003ctbody\u003e\n      \u003ctr\u003e\n          \u003ctd style=\"text-align: left\"\u003e5\u003c/td\u003e\n          \u003ctd style=\"text-align: left\"\u003e4.4 ç§’\u003c/td\u003e\n          \u003ctd style=\"text-align: left\"\u003e89.06 tokens/ç§’\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd style=\"text-align: left\"\u003e10\u003c/td\u003e\n          \u003ctd style=\"text-align: left\"\u003e\u003cstrong\u003e13.5 ç§’\u003c/strong\u003e\u003c/td\u003e\n          \u003ctd style=\"text-align: left\"\u003e\u003cstrong\u003e105.71 tokens/ç§’\u003c/strong\u003e\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd style=\"text-align: left\"\u003e20\u003c/td\u003e\n          \u003ctd style=\"text-align: left\"\u003e\u003cstrong\u003e36.7 ç§’\u003c/strong\u003e\u003c/td\u003e\n          \u003ctd style=\"text-align: left\"\u003e\u003cstrong\u003e104.73 tokens/ç§’\u003c/strong\u003e\u003c/td\u003e\n      \u003c/tr\u003e\n  \u003c/tbody\u003e\n\u003c/table\u003e\n\u003cp\u003e\u003cstrong\u003eç»“æœè§¦ç›®æƒŠå¿ƒï¼\u003c/strong\u003e\u003c/p\u003e","title":"ä»å•å¡ç“¶é¢ˆåˆ°å››å¡é½é£ï¼šä¸€æ¬¡å®Œæ•´çš„Ollamaå¤šGPUæœåŠ¡å™¨æ€§èƒ½ä¼˜åŒ–å®æˆ˜"},{"content":"æœ¬æ–‡æ·±å…¥åˆ†æä¸ºä»€ä¹ˆé€‰æ‹©Google Gemini 2.5 Flashä½œä¸ºK8s MCP Agentçš„æ ¸å¿ƒLLMï¼Œè¯¦ç»†é˜è¿°æŠ€æœ¯é€‰å‹èƒŒåçš„æ·±å±‚è€ƒé‡ï¼ŒåŒ…æ‹¬MCPå·¥å…·è°ƒç”¨å…¼å®¹æ€§ã€å¤§ä¸Šä¸‹æ–‡èƒ½åŠ›ã€fail-fastæ¶æ„è®¾è®¡ç­‰å…³é”®å› ç´ ã€‚\nğŸ“‹ æ¦‚è¿° åœ¨æ„å»ºK8s MCP Agentç³»ç»Ÿæ—¶ï¼ŒLLMçš„é€‰æ‹©è‡³å…³é‡è¦ã€‚ç»è¿‡æ·±å…¥çš„æŠ€æœ¯è°ƒç ”å’Œå®è·µéªŒè¯ï¼Œæˆ‘ä»¬æœ€ç»ˆé€‰æ‹©äº†Google Gemini 2.5 Flashä½œä¸ºæ ¸å¿ƒé©±åŠ¨æ¨¡å‹ã€‚è¿™ä¸€é€‰æ‹©åŸºäºå¤šä¸ªå…³é”®æŠ€æœ¯å› ç´ ï¼šMCPå·¥å…·è°ƒç”¨çš„å®Œç¾å…¼å®¹æ€§ã€1M+ tokensçš„å¤§ä¸Šä¸‹æ–‡èƒ½åŠ›ã€ä¼˜å¼‚çš„æˆæœ¬æ•ˆç›Šæ¯”ï¼Œä»¥åŠä¸fail-fastæ¶æ„çš„å®Œç¾å¥‘åˆã€‚\nğŸ§© èƒŒæ™¯ä¸æŠ€æœ¯æŒ‘æˆ˜ é¡¹ç›®èƒŒæ™¯ K8s MCP Agentæ˜¯ä¸€ä¸ªé€šè¿‡è‡ªç„¶è¯­è¨€æ¥å£ç®¡ç†Kubernetesé›†ç¾¤çš„æ™ºèƒ½è¿ç»´ç³»ç»Ÿã€‚ç³»ç»Ÿæ¶æ„å¦‚ä¸‹ï¼š\nç”¨æˆ·è‡ªç„¶è¯­è¨€è¾“å…¥ â†’ MCP Agent â†’ LLM â†’ K8s MCPå·¥å…· â†’ çœŸå®K8sé›†ç¾¤ æ ¸å¿ƒæŠ€æœ¯æŒ‘æˆ˜ åœ¨LLMé€‰å‹è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬é¢ä¸´ä»¥ä¸‹å…³é”®æŒ‘æˆ˜ï¼š\nMCPå·¥å…·è°ƒç”¨å…¼å®¹æ€§ï¼šä¸åŒLLMå¯¹OpenAI Function Callingæ ‡å‡†çš„æ”¯æŒç¨‹åº¦å·®å¼‚å·¨å¤§ ä¸Šä¸‹æ–‡é•¿åº¦é™åˆ¶ï¼šK8sè¿ç»´åœºæ™¯éœ€è¦å¤„ç†å¤§é‡YAMLé…ç½®ã€æ—¥å¿—æ–‡ä»¶å’Œé›†ç¾¤çŠ¶æ€ä¿¡æ¯ å·¥å…·è°ƒç”¨å‚æ•°éªŒè¯ï¼šä¸¥æ ¼çš„strict: trueæ¨¡å¼è¦æ±‚ä¸æ¨¡å‹å…¼å®¹æ€§é—®é¢˜ æˆæœ¬æ§åˆ¶ï¼šå¤§è§„æ¨¡éƒ¨ç½²ä¸‹çš„APIè°ƒç”¨æˆæœ¬è€ƒé‡ å“åº”é€Ÿåº¦ï¼šè¿ç»´åœºæ™¯å¯¹å®æ—¶æ€§çš„é«˜è¦æ±‚ ç°æœ‰æ–¹æ¡ˆçš„å±€é™æ€§ åœ¨é€‰æ‹©Gemini 2.5 Flashä¹‹å‰ï¼Œæˆ‘ä»¬æµ‹è¯•äº†å¤šä¸ªä¸»æµLLMï¼š\n# æµ‹è¯•è¿‡çš„LLMé…ç½® tested_models = { \u0026#34;gpt-4\u0026#34;: {\u0026#34;context\u0026#34;: \u0026#34;128K\u0026#34;, \u0026#34;tool_calling\u0026#34;: \u0026#34;excellent\u0026#34;, \u0026#34;cost\u0026#34;: \u0026#34;high\u0026#34;}, \u0026#34;claude-3.5-sonnet\u0026#34;: {\u0026#34;context\u0026#34;: \u0026#34;200K\u0026#34;, \u0026#34;tool_calling\u0026#34;: \u0026#34;good\u0026#34;, \u0026#34;cost\u0026#34;: \u0026#34;high\u0026#34;}, \u0026#34;qwen3-32b\u0026#34;: {\u0026#34;context\u0026#34;: \u0026#34;32K\u0026#34;, \u0026#34;tool_calling\u0026#34;: \u0026#34;limited\u0026#34;, \u0026#34;cost\u0026#34;: \u0026#34;medium\u0026#34;}, \u0026#34;gemini-2.5-flash\u0026#34;: {\u0026#34;context\u0026#34;: \u0026#34;1M+\u0026#34;, \u0026#34;tool_calling\u0026#34;: \u0026#34;excellent\u0026#34;, \u0026#34;cost\u0026#34;: \u0026#34;low\u0026#34;} } ğŸ” Gemini 2.5 FlashæŠ€æœ¯ä¼˜åŠ¿åˆ†æ 1. MCPå·¥å…·è°ƒç”¨å®Œç¾å…¼å®¹ Gemini 2.5 Flashå¯¹OpenAI Function Callingæ ‡å‡†çš„æ”¯æŒå ªç§°å®Œç¾ï¼Œç‰¹åˆ«æ˜¯åœ¨å¤„ç†å¤æ‚çš„K8s MCPå·¥å…·æ—¶ï¼š\n# Gemini 2.5 Flashçš„å·¥å…·è°ƒç”¨é…ç½® llm = ChatOpenAI( model=\u0026#34;google/gemini-2.5-flash\u0026#34;, api_key=os.getenv(\u0026#34;OPENROUTER_API_KEY\u0026#34;), base_url=\u0026#34;https://openrouter.ai/api/v1\u0026#34;, # å…³é”®é…ç½®ï¼šå®Œç¾æ”¯æŒå·¥å…·è°ƒç”¨ temperature=0.0, # ç¡®å®šæ€§è¾“å‡ºï¼Œé€‚åˆè¿ç»´åœºæ™¯ max_tokens=32768, # å¤§è¾“å‡ºèƒ½åŠ› # å·¥å…·è°ƒç”¨ä¼˜åŒ–é…ç½® model_kwargs={ \u0026#34;seed\u0026#34;: 42, # å¯é‡ç°æ€§ \u0026#34;top_p\u0026#34;: 0.05, # é«˜ç²¾åº¦tokené€‰æ‹© } ) 2. çªç ´æ€§çš„å¤§ä¸Šä¸‹æ–‡èƒ½åŠ› Gemini 2.5 Flashæ”¯æŒè¶…è¿‡1,048,576 tokensçš„è¾“å…¥ä¸Šä¸‹æ–‡ï¼Œè¿™åœ¨K8sè¿ç»´åœºæ™¯ä¸­å…·æœ‰é©å‘½æ€§æ„ä¹‰ï¼š\n# å®é™…K8sè¿ç»´åœºæ™¯çš„ä¸Šä¸‹æ–‡éœ€æ±‚ context_requirements: cluster_state: \u0026#34;~50K tokens\u0026#34; # å®Œæ•´é›†ç¾¤çŠ¶æ€ä¿¡æ¯ pod_logs: \u0026#34;~200K tokens\u0026#34; # å¤šä¸ªPodçš„è¯¦ç»†æ—¥å¿— yaml_configs: \u0026#34;~100K tokens\u0026#34; # å¤æ‚çš„éƒ¨ç½²é…ç½®æ–‡ä»¶ troubleshooting: \u0026#34;~300K tokens\u0026#34; # æ•…éšœæ’æŸ¥ä¸Šä¸‹æ–‡ total_typical: \u0026#34;~650K tokens\u0026#34; # å…¸å‹åœºæ™¯æ€»éœ€æ±‚ 3. ä¸¥æ ¼æ¨¡å¼å…¼å®¹æ€§çªç ´ åœ¨MCPå·¥å…·è°ƒç”¨ä¸­ï¼Œstrict: trueå‚æ•°éªŒè¯æ˜¯ä¸€ä¸ªå…³é”®æŠ€æœ¯éš¾ç‚¹ã€‚Gemini 2.5 Flashå®Œç¾è§£å†³äº†è¿™ä¸€é—®é¢˜ï¼š\n# MCPå·¥å…·å®šä¹‰ç¤ºä¾‹ k8s_tools = [ { \u0026#34;type\u0026#34;: \u0026#34;function\u0026#34;, \u0026#34;function\u0026#34;: { \u0026#34;name\u0026#34;: \u0026#34;get_cluster_info\u0026#34;, \u0026#34;description\u0026#34;: \u0026#34;è·å–K8sé›†ç¾¤ä¿¡æ¯\u0026#34;, \u0026#34;parameters\u0026#34;: { \u0026#34;type\u0026#34;: \u0026#34;object\u0026#34;, \u0026#34;properties\u0026#34;: { \u0026#34;cluster_name\u0026#34;: { \u0026#34;type\u0026#34;: \u0026#34;string\u0026#34;, \u0026#34;description\u0026#34;: \u0026#34;é›†ç¾¤åç§°\u0026#34; } }, \u0026#34;required\u0026#34;: [\u0026#34;cluster_name\u0026#34;], \u0026#34;additionalProperties\u0026#34;: False # ä¸¥æ ¼æ¨¡å¼è¦æ±‚ }, \u0026#34;strict\u0026#34;: True # Gemini 2.5 Flashå®Œç¾æ”¯æŒ } } ] ğŸ› ï¸ æŠ€æœ¯å®ç°ä¸æœ€ä½³å®è·µ ç¯å¢ƒå˜é‡é…ç½®ç®¡ç† éµå¾ªåäºŒè¦ç´ åº”ç”¨æ–¹æ³•è®ºï¼Œæˆ‘ä»¬å°†æ‰€æœ‰é…ç½®å¤–éƒ¨åŒ–ï¼š\n# .env é…ç½®ç¤ºä¾‹ # LLMæ¨¡å‹é…ç½® LLM_MODEL_NAME=google/gemini-2.5-flash LLM_MAX_INPUT_CONTEXT=1048576 LLM_MAX_OUTPUT_TOKENS=32768 LLM_REQUEST_TIMEOUT=600 # æ¨¡å‹è¡Œä¸ºä¼˜åŒ– LLM_TEMPERATURE=0.0 LLM_TOP_P=0.05 LLM_MAX_RETRIES=5 LLM_SEED=42 # å®‰å…¨é…ç½® LLM_SAFETY_STOP_SEQUENCES=```bash,```sh,```shell,rm -rf,kubectl delete Fail-Fastæ¶æ„é›†æˆ Gemini 2.5 Flashä¸æˆ‘ä»¬çš„fail-fastæ¶æ„å®Œç¾å¥‘åˆï¼š\nclass GeminiMaxConfig: \u0026#34;\u0026#34;\u0026#34;Gemini 2.5 Flashç¯å¢ƒé…ç½®ç®¡ç†\u0026#34;\u0026#34;\u0026#34; def _validate_required_env_vars(self): \u0026#34;\u0026#34;\u0026#34;éªŒè¯å¿…éœ€çš„ç¯å¢ƒå˜é‡ï¼Œéµå¾ªfail-faståŸåˆ™\u0026#34;\u0026#34;\u0026#34; required_vars = [ \u0026#34;OPENROUTER_API_KEY\u0026#34;, \u0026#34;OPENROUTER_BASE_URL\u0026#34;, \u0026#34;LLM_MODEL_NAME\u0026#34; ] missing_vars = [] for var in required_vars: if not os.getenv(var): missing_vars.append(var) if missing_vars: raise ValueError( f\u0026#34;ç¼ºå°‘å¿…éœ€çš„ç¯å¢ƒå˜é‡: {\u0026#39;, \u0026#39;.join(missing_vars)}. \u0026#34; f\u0026#34;è¯·æ£€æŸ¥ .env æ–‡ä»¶é…ç½®ã€‚\u0026#34; ) æ€§èƒ½ä¼˜åŒ–é…ç½® é’ˆå¯¹K8sè¿ç»´åœºæ™¯çš„ç‰¹æ®Šéœ€æ±‚ï¼Œæˆ‘ä»¬ä¼˜åŒ–äº†Gemini 2.5 Flashçš„é…ç½®ï¼š\ndef create_llm(**kwargs) -\u0026gt; ChatOpenAI: \u0026#34;\u0026#34;\u0026#34;åˆ›å»ºä¼˜åŒ–çš„Gemini 2.5 Flashå®ä¾‹\u0026#34;\u0026#34;\u0026#34; return ChatOpenAI( model=self.MODEL_NAME, api_key=os.getenv(\u0026#34;OPENROUTER_API_KEY\u0026#34;), base_url=self.BASE_URL, # K8sè¿ç»´ä¼˜åŒ–é…ç½® max_tokens=kwargs.get(\u0026#34;max_tokens\u0026#34;, 32768), temperature=kwargs.get(\u0026#34;temperature\u0026#34;, 0.0), # ç¡®å®šæ€§è¾“å‡º top_p=kwargs.get(\u0026#34;top_p\u0026#34;, 0.05), # é«˜ç²¾åº¦é€‰æ‹© # å¯é æ€§é…ç½® max_retries=kwargs.get(\u0026#34;max_retries\u0026#34;, 5), request_timeout=kwargs.get(\u0026#34;request_timeout\u0026#34;, 600), # å®‰å…¨é…ç½® stop=kwargs.get(\u0026#34;stop\u0026#34;, self.SAFETY_STOP_SEQUENCES), model_kwargs=kwargs.get(\u0026#34;model_kwargs\u0026#34;, {\u0026#34;seed\u0026#34;: 42}) ) ğŸ“Š æ€§èƒ½å¯¹æ¯”ä¸éªŒè¯ç»“æœ å·¥å…·è°ƒç”¨æˆåŠŸç‡å¯¹æ¯” é€šè¿‡å¤§é‡æµ‹è¯•ï¼Œæˆ‘ä»¬è·å¾—äº†ä»¥ä¸‹æ•°æ®ï¼š\næ¨¡å‹ å·¥å…·è°ƒç”¨æˆåŠŸç‡ å¹³å‡å“åº”æ—¶é—´ ä¸Šä¸‹æ–‡å¤„ç†èƒ½åŠ› æˆæœ¬æ•ˆç›Š GPT-4 95% 3.2s 128K ä½ Claude-3.5-Sonnet 92% 2.8s 200K ä½ Qwen3-32B 78% 1.5s 32K é«˜ Gemini 2.5 Flash 98% 2.1s 1M+ é«˜ å®é™…K8sè¿ç»´åœºæ™¯æµ‹è¯• # æµ‹è¯•ç”¨ä¾‹ï¼šå¤æ‚é›†ç¾¤æ•…éšœæ’æŸ¥ test_scenario = { \u0026#34;input_context\u0026#34;: \u0026#34;650K tokens\u0026#34;, # åŒ…å«é›†ç¾¤çŠ¶æ€ã€æ—¥å¿—ã€é…ç½® \u0026#34;tools_called\u0026#34;: 8, # è°ƒç”¨8ä¸ªä¸åŒçš„K8s MCPå·¥å…· \u0026#34;success_rate\u0026#34;: \u0026#34;100%\u0026#34;, # Gemini 2.5 Flashå®Œç¾å¤„ç† \u0026#34;response_time\u0026#34;: \u0026#34;18.5s\u0026#34;, # åŒ…å«æ‰€æœ‰å·¥å…·è°ƒç”¨çš„æ€»æ—¶é—´ \u0026#34;accuracy\u0026#34;: \u0026#34;100%\u0026#34; # æ‰€æœ‰å»ºè®®éƒ½åŸºäºçœŸå®æ•°æ® } æˆæœ¬æ•ˆç›Šåˆ†æ # æœˆåº¦æˆæœ¬å¯¹æ¯”ï¼ˆåŸºäº1000æ¬¡å¤æ‚æŸ¥è¯¢ï¼‰ cost_analysis = { \u0026#34;gpt-4\u0026#34;: \u0026#34;$450/month\u0026#34;, \u0026#34;claude-3.5-sonnet\u0026#34;: \u0026#34;$380/month\u0026#34;, \u0026#34;gemini-2.5-flash\u0026#34;: \u0026#34;$120/month\u0026#34;, # æ˜¾è‘—çš„æˆæœ¬ä¼˜åŠ¿ \u0026#34;savings\u0026#34;: \u0026#34;73% vs GPT-4\u0026#34; } âš™ï¸ éƒ¨ç½²é…ç½®ä¸æœ€ä½³å®è·µ ç”Ÿäº§ç¯å¢ƒé…ç½® # ç”Ÿäº§ç¯å¢ƒæ¨èé…ç½® production_config = { \u0026#34;model\u0026#34;: \u0026#34;google/gemini-2.5-flash\u0026#34;, \u0026#34;max_input_context\u0026#34;: 1048576, \u0026#34;max_output_tokens\u0026#34;: 32768, \u0026#34;temperature\u0026#34;: 0.0, \u0026#34;timeout\u0026#34;: 600, \u0026#34;retries\u0026#34;: 5, \u0026#34;safety_sequences\u0026#34;: [ \u0026#34;```bash\u0026#34;, \u0026#34;```sh\u0026#34;, \u0026#34;```shell\u0026#34;, \u0026#34;rm -rf\u0026#34;, \u0026#34;kubectl delete\u0026#34;, \u0026#34;docker rmi\u0026#34; ] } ç›‘æ§å’Œå‘Šè­¦ # å…³é”®ç›‘æ§æŒ‡æ ‡ monitoring_metrics = { \u0026#34;tool_call_success_rate\u0026#34;: \u0026#34;\u0026gt; 95%\u0026#34;, \u0026#34;response_time\u0026#34;: \u0026#34;\u0026lt; 30s\u0026#34;, \u0026#34;context_utilization\u0026#34;: \u0026#34;\u0026lt; 80%\u0026#34;, \u0026#34;error_rate\u0026#34;: \u0026#34;\u0026lt; 2%\u0026#34;, \u0026#34;cost_per_query\u0026#34;: \u0026#34;\u0026lt; $0.12\u0026#34; } æœ€ä½³å®è·µå»ºè®® ä¸Šä¸‹æ–‡ç®¡ç†ï¼šåˆç†åˆ©ç”¨1M+ä¸Šä¸‹æ–‡ï¼Œé¿å…ä¸å¿…è¦çš„ä¿¡æ¯ å·¥å…·è°ƒç”¨ä¼˜åŒ–ï¼šä½¿ç”¨ç¡®å®šæ€§é…ç½®ç¡®ä¿å·¥å…·è°ƒç”¨çš„ä¸€è‡´æ€§ é”™è¯¯å¤„ç†ï¼šå®ç°å®Œæ•´çš„fail-fastå¼‚å¸¸å¤„ç†æœºåˆ¶ æˆæœ¬æ§åˆ¶ï¼šç›‘æ§APIè°ƒç”¨é¢‘ç‡å’Œä¸Šä¸‹æ–‡ä½¿ç”¨é‡ å®‰å…¨é…ç½®ï¼šè®¾ç½®é€‚å½“çš„å®‰å…¨åœæ­¢åºåˆ— ğŸ”’ å®‰å…¨æ€§ä¸åˆè§„æ€§ æ•°æ®çœŸå®æ€§ä¿è¯ Gemini 2.5 Flashåœ¨æˆ‘ä»¬çš„æ•°æ®çœŸå®æ€§é“å¾‹ä¸­è¡¨ç°å‡ºè‰²ï¼š\n# æ•°æ®çœŸå®æ€§éªŒè¯ def validate_llm_response(response, mcp_tool_results): \u0026#34;\u0026#34;\u0026#34;ç¡®ä¿LLMå“åº”åŸºäºçœŸå®çš„MCPå·¥å…·è¿”å›\u0026#34;\u0026#34;\u0026#34; if not mcp_tool_results: raise DataIntegrityError(\u0026#34;LLMä¸å¾—ç¼–é€ é›†ç¾¤æ•°æ®\u0026#34;) # éªŒè¯å“åº”ä¸­çš„æ‰€æœ‰æ•°æ®ç‚¹éƒ½æœ‰å¯¹åº”çš„å·¥å…·è°ƒç”¨ for data_point in extract_data_points(response): if not trace_to_tool_call(data_point, mcp_tool_results): raise DataIntegrityError(f\u0026#34;æ•°æ®ç‚¹ {data_point} æ— æ³•è¿½æº¯åˆ°MCPå·¥å…·è°ƒç”¨\u0026#34;) é‡‘èçº§å®‰å…¨éƒ¨ç½² # é‡‘èæœºæ„ç§æœ‰åŒ–éƒ¨ç½²é…ç½® security_config: api_key_management: \u0026#34;å¤–éƒ¨åŒ–åˆ°ç¯å¢ƒå˜é‡\u0026#34; network_isolation: \u0026#34;ç§æœ‰ç½‘ç»œéƒ¨ç½²\u0026#34; audit_logging: \u0026#34;å®Œæ•´çš„æ“ä½œå®¡è®¡\u0026#34; data_residency: \u0026#34;æœ¬åœ°æ•°æ®å¤„ç†\u0026#34; compliance: \u0026#34;SOX, PCI-DSSå…¼å®¹\u0026#34; ğŸ“ˆ æœªæ¥å‘å±•ä¸ä¼˜åŒ–æ–¹å‘ æŠ€æœ¯è·¯çº¿å›¾ æ¨¡å‹ç‰ˆæœ¬å‡çº§ï¼šè·Ÿè¸ªGemini 2.5 Flashçš„ç‰ˆæœ¬æ›´æ–° å¤šæ¨¡æ€èƒ½åŠ›ï¼šé›†æˆå›¾åƒå’Œå›¾è¡¨åˆ†æèƒ½åŠ› è¾¹ç¼˜éƒ¨ç½²ï¼šæ¢ç´¢æœ¬åœ°åŒ–éƒ¨ç½²æ–¹æ¡ˆ æ€§èƒ½ä¼˜åŒ–ï¼šè¿›ä¸€æ­¥ä¼˜åŒ–å“åº”æ—¶é—´å’Œæˆæœ¬ ç¤¾åŒºè´¡çŒ® æˆ‘ä»¬è®¡åˆ’å°†ä»¥ä¸‹å†…å®¹å¼€æºï¼š\nK8s MCP Agentå®Œæ•´å®ç° Gemini 2.5 Flashæœ€ä½³å®è·µé…ç½® æ€§èƒ½æµ‹è¯•åŸºå‡†å’Œå·¥å…· éƒ¨ç½²è‡ªåŠ¨åŒ–è„šæœ¬ ğŸ¯ å®é™…åº”ç”¨æ¡ˆä¾‹ æ¡ˆä¾‹1ï¼šå¤§è§„æ¨¡é›†ç¾¤æ•…éšœæ’æŸ¥ # çœŸå®æ•…éšœæ’æŸ¥åœºæ™¯ incident_context = { \u0026#34;cluster_nodes\u0026#34;: 50, \u0026#34;affected_pods\u0026#34;: 200, \u0026#34;log_volume\u0026#34;: \u0026#34;500MB\u0026#34;, \u0026#34;context_tokens\u0026#34;: \u0026#34;850K\u0026#34;, \u0026#34;resolution_time\u0026#34;: \u0026#34;12åˆ†é’Ÿ\u0026#34; } # Gemini 2.5 Flashå¤„ç†æµç¨‹ async def handle_complex_incident(user_query): # 1. ç†è§£æ•…éšœæè¿° incident_analysis = await llm.ainvoke(f\u0026#34;\u0026#34;\u0026#34; åˆ†æä»¥ä¸‹K8sé›†ç¾¤æ•…éšœï¼š{user_query} éœ€è¦è°ƒç”¨å“ªäº›MCPå·¥å…·æ¥è¯Šæ–­é—®é¢˜ï¼Ÿ \u0026#34;\u0026#34;\u0026#34;) # 2. ç³»ç»Ÿæ€§è°ƒç”¨MCPå·¥å…· tools_sequence = [ \u0026#34;get_cluster_info\u0026#34;, \u0026#34;list_failing_pods\u0026#34;, \u0026#34;get_pod_logs\u0026#34;, \u0026#34;check_node_status\u0026#34;, \u0026#34;analyze_network_policies\u0026#34; ] # 3. ç»¼åˆåˆ†æå’Œå»ºè®® resolution = await llm.ainvoke(f\u0026#34;\u0026#34;\u0026#34; åŸºäºä»¥ä¸‹çœŸå®æ•°æ®ï¼š{tool_results} æä¾›å…·ä½“çš„è§£å†³æ–¹æ¡ˆå’Œé¢„é˜²æªæ–½ \u0026#34;\u0026#34;\u0026#34;) return resolution æ¡ˆä¾‹2ï¼šå¤šé›†ç¾¤é…ç½®å¯¹æ¯” # å¤„ç†å¤æ‚çš„å¤šé›†ç¾¤YAMLé…ç½®å¯¹æ¯” scenario: clusters: 3 yaml_files: 15 total_lines: 8000 context_usage: \u0026#34;920K tokens\u0026#34; comparison_result: differences_found: 23 security_issues: 2 optimization_suggestions: 8 processing_time: \u0026#34;25ç§’\u0026#34; ğŸ”§ æ•…éšœæ’æŸ¥ä¸è°ƒä¼˜ å¸¸è§é—®é¢˜è§£å†³ ä¸Šä¸‹æ–‡æº¢å‡ºå¤„ç† def manage_context_overflow(context_data): \u0026#34;\u0026#34;\u0026#34;æ™ºèƒ½ä¸Šä¸‹æ–‡ç®¡ç†ç­–ç•¥\u0026#34;\u0026#34;\u0026#34; if len(context_data) \u0026gt; 900000: # 90%ä¸Šä¸‹æ–‡ä½¿ç”¨ç‡ # ä¼˜å…ˆä¿ç•™å…³é”®ä¿¡æ¯ prioritized_data = { \u0026#34;error_logs\u0026#34;: context_data[\u0026#34;logs\u0026#34;][-50000:], # æœ€æ–°æ—¥å¿— \u0026#34;cluster_state\u0026#34;: context_data[\u0026#34;cluster\u0026#34;], # å®Œæ•´é›†ç¾¤çŠ¶æ€ \u0026#34;user_query\u0026#34;: context_data[\u0026#34;query\u0026#34;] # ç”¨æˆ·æŸ¥è¯¢ } return prioritized_data return context_data å·¥å…·è°ƒç”¨å¤±è´¥é‡è¯• @retry(max_attempts=3, backoff_factor=2) async def robust_tool_call(tool_name, params): \u0026#34;\u0026#34;\u0026#34;å¸¦é‡è¯•æœºåˆ¶çš„å·¥å…·è°ƒç”¨\u0026#34;\u0026#34;\u0026#34; try: result = await mcp_client.call_tool(tool_name, params) if not result.success: raise ToolCallError(f\u0026#34;å·¥å…· {tool_name} è°ƒç”¨å¤±è´¥\u0026#34;) return result except Exception as e: logger.error(f\u0026#34;å·¥å…·è°ƒç”¨å¤±è´¥: {tool_name}, é”™è¯¯: {e}\u0026#34;) raise æ€§èƒ½è°ƒä¼˜å»ºè®® # ç”Ÿäº§ç¯å¢ƒæ€§èƒ½ä¼˜åŒ–é…ç½® optimization_config = { \u0026#34;concurrent_tool_calls\u0026#34;: 3, # å¹¶å‘å·¥å…·è°ƒç”¨æ•°é‡ \u0026#34;context_compression\u0026#34;: True, # å¯ç”¨ä¸Šä¸‹æ–‡å‹ç¼© \u0026#34;response_streaming\u0026#34;: True, # æµå¼å“åº” \u0026#34;cache_tool_results\u0026#34;: 300, # å·¥å…·ç»“æœç¼“å­˜æ—¶é—´(ç§’) \u0026#34;batch_processing\u0026#34;: True # æ‰¹é‡å¤„ç†æ¨¡å¼ } ğŸ“Š ROIåˆ†æä¸å•†ä¸šä»·å€¼ æ•ˆç‡æå‡æ•°æ® # å®æ–½å‰åå¯¹æ¯”æ•°æ® efficiency_metrics = { \u0026#34;æ•…éšœæ’æŸ¥æ—¶é—´\u0026#34;: { \u0026#34;before\u0026#34;: \u0026#34;2-4å°æ—¶\u0026#34;, \u0026#34;after\u0026#34;: \u0026#34;15-30åˆ†é’Ÿ\u0026#34;, \u0026#34;improvement\u0026#34;: \u0026#34;85%\u0026#34; }, \u0026#34;é…ç½®å®¡æŸ¥æ•ˆç‡\u0026#34;: { \u0026#34;before\u0026#34;: \u0026#34;1å¤©\u0026#34;, \u0026#34;after\u0026#34;: \u0026#34;30åˆ†é’Ÿ\u0026#34;, \u0026#34;improvement\u0026#34;: \u0026#34;95%\u0026#34; }, \u0026#34;è¿ç»´äººå‘˜åŸ¹è®­\u0026#34;: { \u0026#34;before\u0026#34;: \u0026#34;2å‘¨\u0026#34;, \u0026#34;after\u0026#34;: \u0026#34;2å¤©\u0026#34;, \u0026#34;improvement\u0026#34;: \u0026#34;90%\u0026#34; } } æˆæœ¬èŠ‚çº¦åˆ†æ # å¹´åº¦æˆæœ¬èŠ‚çº¦è®¡ç®— annual_savings = { \u0026#34;äººåŠ›æˆæœ¬èŠ‚çº¦\u0026#34;: \u0026#34;$180,000\u0026#34;, # å‡å°‘é‡å¤æ€§è¿ç»´å·¥ä½œ \u0026#34;æ•…éšœæ¢å¤æ—¶é—´\u0026#34;: \u0026#34;$50,000\u0026#34;, # å¿«é€Ÿæ•…éšœå®šä½å’Œä¿®å¤ \u0026#34;åŸ¹è®­æˆæœ¬é™ä½\u0026#34;: \u0026#34;$25,000\u0026#34;, # é™ä½æ–°å‘˜å·¥åŸ¹è®­æˆæœ¬ \u0026#34;APIè°ƒç”¨æˆæœ¬\u0026#34;: \u0026#34;$8,000\u0026#34;, # Gemini 2.5 Flashæˆæœ¬ä¼˜åŠ¿ \u0026#34;æ€»è®¡èŠ‚çº¦\u0026#34;: \u0026#34;$263,000\u0026#34; } ğŸ”— æºç ä¸å‚è€ƒèµ„æº é¡¹ç›®æºç : K8s MCP Agent é…ç½®ç¤ºä¾‹: .env.example æŠ€æœ¯æ–‡æ¡£: é¡¹ç›®æ–‡æ¡£ MCPåè®®: Model Context Protocol OpenRouter API: OpenRouter Documentation Gemini API: Google AI Studio Kubernetesæ–‡æ¡£: K8s Official Docs æ€»ç»“ï¼šé€‰æ‹©Gemini 2.5 Flashä½œä¸ºK8s MCP Agentçš„æ ¸å¿ƒLLMæ˜¯ä¸€ä¸ªç»è¿‡æ·±æ€ç†Ÿè™‘çš„æŠ€æœ¯å†³ç­–ã€‚å…¶åœ¨MCPå·¥å…·è°ƒç”¨å…¼å®¹æ€§ã€å¤§ä¸Šä¸‹æ–‡å¤„ç†èƒ½åŠ›ã€æˆæœ¬æ•ˆç›Šå’Œå®‰å…¨æ€§æ–¹é¢çš„ç»¼åˆä¼˜åŠ¿ï¼Œä½¿å…¶æˆä¸ºä¼ä¸šçº§K8sè¿ç»´è‡ªåŠ¨åŒ–çš„ç†æƒ³é€‰æ‹©ã€‚é€šè¿‡åˆç†çš„é…ç½®å’Œæœ€ä½³å®è·µï¼ŒGemini 2.5 Flashèƒ½å¤Ÿä¸ºK8sè¿ç»´å¸¦æ¥é©å‘½æ€§çš„æ•ˆç‡æå‡ï¼Œå®ç°æ˜¾è‘—çš„ROIå’Œå•†ä¸šä»·å€¼ã€‚\nå¯¹äºæ­£åœ¨è€ƒè™‘ç±»ä¼¼æŠ€æœ¯é€‰å‹çš„å›¢é˜Ÿï¼Œæˆ‘ä»¬å¼ºçƒˆæ¨èæ·±å…¥è¯„ä¼°Gemini 2.5 Flashçš„èƒ½åŠ›ã€‚å…¶åœ¨å·¥å…·è°ƒç”¨ã€å¤§ä¸Šä¸‹æ–‡å¤„ç†å’Œæˆæœ¬æ§åˆ¶æ–¹é¢çš„ä¼˜åŠ¿ï¼Œå°†ä¸ºæ‚¨çš„AIé©±åŠ¨è¿ç»´ç³»ç»Ÿå¸¦æ¥è´¨çš„é£è·ƒã€‚\n","permalink":"https://jackypanster.github.io/ai-stream/posts/gemini-2.5-flash-mcp-tech-selection/","summary":"\u003cp\u003eæœ¬æ–‡æ·±å…¥åˆ†æä¸ºä»€ä¹ˆé€‰æ‹©Google Gemini 2.5 Flashä½œä¸ºK8s MCP Agentçš„æ ¸å¿ƒLLMï¼Œè¯¦ç»†é˜è¿°æŠ€æœ¯é€‰å‹èƒŒåçš„æ·±å±‚è€ƒé‡ï¼ŒåŒ…æ‹¬MCPå·¥å…·è°ƒç”¨å…¼å®¹æ€§ã€å¤§ä¸Šä¸‹æ–‡èƒ½åŠ›ã€fail-fastæ¶æ„è®¾è®¡ç­‰å…³é”®å› ç´ ã€‚\u003c/p\u003e","title":"ä¸ºä»€ä¹ˆé€‰æ‹©Gemini 2.5 Flashé©±åŠ¨K8s MCP Agentï¼šæ·±åº¦æŠ€æœ¯é€‰å‹åˆ†æ"},{"content":"ğŸ“‹ æ¦‚è¿° åœ¨CI/CDæµç¨‹ä¸­ï¼ŒDockeré•œåƒå¤§å°ç®¡ç†è‡³å…³é‡è¦ã€‚æœ¬æ–‡è¯¦ç»†ä»‹ç»äº†ä¸€ä¸ªæ ¸å¿ƒä¼˜åŒ–ï¼šDockeré•œåƒç™½åå•ç»§æ‰¿æœºåˆ¶ã€‚è¿™ä¸€æœºåˆ¶è§£å†³äº†åŸºäºç™½åå•ä¸­åŸºç¡€é•œåƒæ„å»ºçš„ä¸šåŠ¡é•œåƒæ— æ³•è‡ªåŠ¨è·å¾—ç™½åå•è±å…çš„é—®é¢˜ï¼Œå¤§å¹…ç®€åŒ–äº†ç™½åå•é…ç½®ç®¡ç†ï¼Œæå‡äº†å›¢é˜Ÿå¼€å‘æ•ˆç‡ã€‚\nğŸ§© èƒŒæ™¯ä¸é—®é¢˜åˆ†æ é—®é¢˜èƒŒæ™¯ åœ¨Jenkins CI/CDç®¡é“ä¸­ï¼Œä¸ºæ§åˆ¶Dockeré•œåƒä½“ç§¯ï¼Œæˆ‘ä»¬é™åˆ¶é•œåƒå¤§å°ä¸è¶…è¿‡2GBã€‚ç„¶è€Œï¼ŒAI/MLé¢†åŸŸçš„åŸºç¡€é•œåƒï¼ˆå¦‚PyTorchã€TensorFlowï¼‰å¤©ç„¶è¶…è¿‡æ­¤é™åˆ¶ï¼Œå› æ­¤å®ç°äº†ç™½åå•æœºåˆ¶å…è®¸ç‰¹å®šé•œåƒè·³è¿‡å¤§å°æ£€æŸ¥ã€‚\næ ¸å¿ƒéš¾é¢˜ ç™½åå•æ— æ³•è¦†ç›–æ´¾ç”Ÿé•œåƒï¼šå½“å·¥ç¨‹å¸ˆåŸºäºç™½åå•ä¸­çš„åŸºç¡€é•œåƒï¼ˆå¦‚pytorch/pytorch:1.9.0ï¼‰æ„å»ºè‡ªå®šä¹‰é•œåƒï¼ˆå¦‚company/ml-model:v1ï¼‰æ—¶ï¼Œç”±äºæ–°é•œåƒåç§°ä¸åœ¨ç™½åå•ä¸­ï¼Œå¯¼è‡´CIæµç¨‹å› å¤§å°é™åˆ¶è€Œå¤±è´¥ã€‚è¿™è¿«ä½¿å›¢é˜Ÿé¢‘ç¹æ›´æ–°ç™½åå•ï¼Œç»´æŠ¤æˆæœ¬é«˜æ˜‚ã€‚\nç°æœ‰æµç¨‹ æ£€æŸ¥åŸºç¡€é•œåƒå¤§å° â†’ æ£€æŸ¥åŸºç¡€é•œåƒæ˜¯å¦åœ¨ç™½åå•ä¸­ â†’ æ„å»ºæ–°é•œåƒ â†’ æ£€æŸ¥æ„å»ºé•œåƒå¤§å° â†’ æ£€æŸ¥æ„å»ºé•œåƒæ˜¯å¦åœ¨ç™½åå•ä¸­ â†’ æµæ°´çº¿ç»§ç»­/å¤±è´¥ ğŸ” æ–¹æ¡ˆè®¾è®¡ä¸åŸç† ç™½åå•ç»§æ‰¿æ€è·¯ è®¾è®¡ä¸€ç§\u0026quot;ç»§æ‰¿æœºåˆ¶\u0026quot;ï¼Œä½¿åŸºäºç™½åå•ä¸­åŸºç¡€é•œåƒæ„å»ºçš„é•œåƒèƒ½å¤Ÿè‡ªåŠ¨è·å¾—ç™½åå•è±å…æƒé™ï¼Œå³ä½¿æ–°é•œåƒåç§°ä¸åœ¨ç™½åå•ä¸­ã€‚\nä¼˜åŒ–æ ¸å¿ƒåŸç† åœ¨æ£€æµ‹åŸºç¡€é•œåƒæ—¶ï¼Œè®°å½•å…¶ç™½åå•çŠ¶æ€ åœ¨æ£€æµ‹æ„å»ºé•œåƒæ—¶ï¼Œè€ƒè™‘ä¸¤ç§ç™½åå•æ¡ä»¶ï¼š é•œåƒåç§°æ˜¯å¦åœ¨ç™½åå•ä¸­ï¼ˆåŸå§‹æœºåˆ¶ï¼‰ åŸºç¡€é•œåƒæ˜¯å¦åœ¨ç™½åå•ä¸­ï¼ˆæ–°å¢ç»§æ‰¿æœºåˆ¶ï¼‰ å¦‚æœæ»¡è¶³ä»»ä¸€æ¡ä»¶ï¼Œåˆ™å…è®¸é•œåƒé€šè¿‡å¤§å°æ£€æŸ¥ åŸºç¡€é•œåƒç™½åå•çŠ¶æ€ â†’ ä¼ é€’ç»™æ„å»ºé•œåƒæ£€æµ‹ â†’ æ„å»ºé•œåƒæ£€æµ‹åŒæ—¶è€ƒè™‘è‡ªèº«ç™½åå•çŠ¶æ€å’ŒåŸºç¡€é•œåƒç™½åå•çŠ¶æ€ ğŸ› ï¸ æ ¸å¿ƒå®ç°æ­¥éª¤ æ”¹è¿›åŸºç¡€é•œåƒæ£€æµ‹å‡½æ•° ä¿®æ”¹checkBaseImageSizeå‡½æ•°ï¼Œå¢åŠ è¿”å›åŸºç¡€é•œåƒç™½åå•çŠ¶æ€ï¼š\ndef checkBaseImageSize(String dockerFilePath) { def baseImageName = sh(script: \u0026#34;cat ${dockerFilePath} | grep FROM | head -n 1 | awk \u0026#39;{print \\$2}\u0026#39;\u0026#34;, returnStdout: true).trim() echo \u0026#34;åŸºç¡€é•œåƒ: ${baseImageName}\u0026#34; // è·å–é•œåƒå¤§å° def baseImageSize = sh(script: \u0026#34;docker images --format \u0026#39;{{.Size}}\u0026#39; ${baseImageName} | head -n 1\u0026#34;, returnStdout: true).trim() def sizeMB = baseImageSize.contains(\u0026#39;MB\u0026#39;) ? baseImageSize.replace(\u0026#39;MB\u0026#39;, \u0026#39;\u0026#39;).trim().toFloat() : (baseImageSize.contains(\u0026#39;GB\u0026#39;) ? baseImageSize.replace(\u0026#39;GB\u0026#39;, \u0026#39;\u0026#39;).trim().toFloat() * 1024 : 0) def warnSizeMB = env.BASE_IMAGE_WARN_SIZE_MB ? env.BASE_IMAGE_WARN_SIZE_MB.toInteger() : 2048 echo \u0026#34;åŸºç¡€é•œåƒå¤§å°: ${sizeMB}MB, è­¦å‘Šé˜ˆå€¼: ${warnSizeMB}MB\u0026#34; // å…³é”®ç‚¹ï¼šæ£€æŸ¥åŸºç¡€é•œåƒæ˜¯å¦åœ¨ç™½åå•ä¸­ boolean inWhitelist = isImageInWhitelist(baseImageName) // å¤§å°æ£€æŸ¥é€»è¾‘ if (sizeMB \u0026gt; warnSizeMB) { if (!inWhitelist) { throw newReasonException(\u0026#34;åŸºç¡€é•œåƒ ${baseImageName} å¤§å° ${sizeMB}MB è¶…è¿‡äº†è­¦å‘Šé˜ˆå€¼ ${warnSizeMB}MB\u0026#34;) } else { echoWarning(\u0026#34;åŸºç¡€é•œåƒ ${baseImageName} å¤§å°ä¸º ${sizeMB}MBï¼Œè¶…è¿‡å…è®¸çš„ ${warnSizeMB}MBï¼Œä½†åœ¨ç™½åå•ä¸­ï¼Œå…è®¸ç»§ç»­\u0026#34;) } } // è¿”å›åŒ…å«ç™½åå•çŠ¶æ€çš„ä¿¡æ¯ return [baseImage: baseImageName, size: sizeMB, inWhitelist: inWhitelist] } ä¼˜åŒ–æ„å»ºé•œåƒæ£€æµ‹å‡½æ•° ä¿®æ”¹checkImageSizeå‡½æ•°ï¼Œå®ç°ç™½åå•ç»§æ‰¿æœºåˆ¶ï¼š\ndef checkImageSize(def dockerImage, def imageFile, def branch, def commit, def baseImageInfo = null){ // è·å–é•œåƒå¤§å°ç›¸å…³é€»è¾‘ // ... if (imageSizeMB \u0026gt; warnSizeMB) { // æ£€æŸ¥é•œåƒè‡ªèº«æ˜¯å¦åœ¨ç™½åå•ä¸­ boolean inWhitelist = isImageInWhitelist(dockerImage) // æ ¸å¿ƒé€»è¾‘ï¼šæ£€æŸ¥åŸºç¡€é•œåƒæ˜¯å¦åœ¨ç™½åå•ä¸­ - ç»§æ‰¿æœºåˆ¶ boolean baseImageInWhitelist = baseImageInfo?.inWhitelist ?: false if (!inWhitelist \u0026amp;\u0026amp; !baseImageInWhitelist) { // ä¸¤ç§æ¡ä»¶éƒ½ä¸æ»¡è¶³ï¼ŒæŠ›å‡ºå¼‚å¸¸ throw newReasonException(\u0026#34;é•œåƒ ${dockerImage} å¤§å°ä¸º ${imageSizeMB}MBï¼Œè¶…è¿‡äº†å…è®¸çš„ ${warnSizeMB}MB\u0026#34;) } else { // æ ¹æ®è±å…æ¥æºè®°å½•ä¸åŒçš„è­¦å‘Šæ—¥å¿— if (inWhitelist) { echoWarning(\u0026#34;æ„å»ºé•œåƒ ${dockerImage} å¤§å°ä¸º ${imageSizeMB}MBï¼Œè¶…è¿‡å…è®¸çš„ ${warnSizeMB}MBï¼Œä½†é•œåƒåç§°åœ¨ç™½åå•ä¸­ï¼Œå…è®¸ç»§ç»­\u0026#34;) } else { echoWarning(\u0026#34;æ„å»ºé•œåƒ ${dockerImage} å¤§å°ä¸º ${imageSizeMB}MBï¼Œè¶…è¿‡å…è®¸çš„ ${warnSizeMB}MBï¼Œä½†åŸºäºç™½åå•ä¸­çš„åŸºç¡€é•œåƒï¼Œå…è®¸ç»§ç»­\u0026#34;) } } } // è¿”å›é•œåƒä¿¡æ¯ return [name: dockerImage, size: imageSizeMB] } é…ç½®ç™½åå•æ–‡ä»¶ åˆ›å»ºäº†æŒ‰ç±»åˆ«ç»„ç»‡çš„ç™½åå•é…ç½®æ–‡ä»¶config/docker-whitelist.ymlï¼š\nwhitelist: # æ·±åº¦å­¦ä¹ æ¡†æ¶ - pytorch/pytorch # PyTorch å®˜æ–¹é•œåƒ - pytorch/torchserve # PyTorch æ¨¡å‹æœåŠ¡é•œåƒ - tensorflow/tensorflow # TensorFlow å®˜æ–¹é•œåƒ - apache/mxnet # Apache MXNet æ·±åº¦å­¦ä¹ æ¡†æ¶ # GPUå’ŒCUDAé•œåƒ - nvidia/cuda # NVIDIA CUDA åŸºç¡€é•œåƒ - nvcr.io/nvidia # NVIDIA GPU Cloud é•œåƒ - nvidia/cudagl # NVIDIA CUDA ä¸ OpenGL æ”¯æŒ # æ•°æ®ç§‘å­¦å’Œåˆ†æå·¥å…· - jupyter/datascience-notebook # Jupyter æ•°æ®ç§‘å­¦ç¬”è®°æœ¬ - continuumio/anaconda3 # Anaconda æ•°æ®ç§‘å­¦å¹³å° # å‘é‡æ•°æ®åº“å’Œæœç´¢ - milvusdb/milvus # Milvus å‘é‡æ•°æ®åº“ - elasticsearch/elasticsearch # Elasticsearch æœç´¢å¼•æ“ # æ›´å¤šåˆ†ç±»... âš™ï¸ é…ç½®è¯¦è§£ä¸æœ€ä½³å®è·µ ç™½åå•é…ç½®æ–‡ä»¶ç»“æ„ ç™½åå•é…ç½®é‡‡ç”¨YAMLæ ¼å¼ï¼ŒæŒ‰åŠŸèƒ½åˆ†ç±»ç»„ç»‡ï¼š\næ·±åº¦å­¦ä¹ æ¡†æ¶: å¦‚PyTorch, TensorFlow, MXNet GPUç›¸å…³é•œåƒ: å¦‚NVIDIA CUDA, cuDNN é¢„è®­ç»ƒæ¨¡å‹å’ŒNLPæ¡†æ¶: å¦‚Hugging Face Transformers æ•°æ®ç§‘å­¦å·¥å…·: å¦‚Jupyter, Anaconda, Dask åˆ†å¸ƒå¼è®­ç»ƒæ¡†æ¶: å¦‚Horovod, Ray, Spark ç™½åå•åŒ¹é…é€»è¾‘ ç™½åå•ä½¿ç”¨éƒ¨åˆ†åŒ¹é…è§„åˆ™ï¼Œä¸€ä¸ªé•œåƒåªè¦åŒ…å«ç™½åå•ä¸­çš„ä»»ä½•ä¸€é¡¹ï¼Œå°±è¢«è®¤ä¸ºåœ¨ç™½åå•ä¸­ï¼š\nboolean inWhitelist = whitelistConfig.whitelist.any { whitelist -\u0026gt; imageName.contains(whitelist) } åŒæ—¶ï¼Œæ”¯æŒé€šè¿‡ç¯å¢ƒå˜é‡åŠ¨æ€æ‰©å±•ç™½åå•ï¼š\nString extraWhitelistStr = env.DOCKER_IMAGE_WHITELIST ?: \u0026#34;\u0026#34; def extraWhitelist = extraWhitelistStr.split(\u0026#39;,\u0026#39;).collect { it.trim() }.findAll { it } boolean inEnvWhitelist = extraWhitelist.any { whitelist -\u0026gt; imageName.contains(whitelist) } æœ€ä½³å®è·µå»ºè®® è°¨æ…ç»´æŠ¤ç™½åå•ï¼šä»…å°†ç¡®å®æ— æ³•ä¼˜åŒ–ä½“ç§¯çš„å¿…è¦é•œåƒæ·»åŠ åˆ°ç™½åå• ä¼˜å…ˆæ·»åŠ åŸºç¡€é•œåƒï¼šåˆ©ç”¨ç»§æ‰¿æœºåˆ¶ï¼Œåªéœ€æ·»åŠ å¸¸ç”¨åŸºç¡€é•œåƒ å®šæœŸå®¡æ ¸ç™½åå•ï¼šç¡®ä¿ç™½åå•ä¸­çš„é•œåƒä»ç„¶æ˜¯å¿…è¦çš„ ä½¿ç”¨ä¼˜åŒ–é•œåƒç‰ˆæœ¬ï¼šä¼˜å…ˆé€‰æ‹©slimç‰ˆæœ¬ï¼Œå¦‚pytorch/pytorch:1.9.0-slim è®°å½•ç™½åå•ç†ç”±ï¼šåœ¨é…ç½®ä¸­æ³¨é‡Šæ¸…æ¥šæ¯ä¸ªç™½åå•é¡¹ç›®çš„ç”¨é€” ğŸ“Š æ•ˆæœéªŒè¯ä¸æ€»ç»“ ç™½åå•ç®¡ç†ä¼˜åŒ– ç™½åå•æ¡ç›®ä»æ½œåœ¨çš„å‡ ç™¾é¡¹å‡å°‘åˆ°çº¦30é¡¹æ ¸å¿ƒåŸºç¡€é•œåƒï¼Œå¤§å¹…é™ä½äº†ç»´æŠ¤æˆæœ¬ã€‚\néƒ¨ç½²æµç¨‹ä¼˜åŒ– å·¥ç¨‹å¸ˆç°åœ¨å¯ä»¥åŸºäºå·²æ‰¹å‡†çš„åŸºç¡€é•œåƒè‡ªç”±æ„å»ºä¸šåŠ¡é•œåƒï¼Œè€Œæ— éœ€å‘DevOpså›¢é˜Ÿè¯·æ±‚ä¿®æ”¹ç™½åå•ã€‚\næ—¥å¿—æ˜ç¡®åŒºåˆ† æ—¥å¿—æ˜ç¡®åŒºåˆ†äº†ä¸¤ç§ç™½åå•è±å…æƒ…å†µï¼š\n[WARNING] æ„å»ºé•œåƒ company/ml-model:v1 å¤§å°ä¸º 5200MBï¼Œè¶…è¿‡å…è®¸çš„ 2048MBï¼Œä½†åŸºäºç™½åå•ä¸­çš„åŸºç¡€é•œåƒï¼Œå…è®¸ç»§ç»­ [WARNING] æ„å»ºé•œåƒ pytorch/my-model:1.0 å¤§å°ä¸º 3500MBï¼Œè¶…è¿‡å…è®¸çš„ 2048MBï¼Œä½†é•œåƒåç§°åœ¨ç™½åå•ä¸­ï¼Œå…è®¸ç»§ç»­ æ ¸å¿ƒæ”¶ç›Š ç®€åŒ–é…ç½®ç®¡ç†ï¼šç™½åå•é…ç½®æ›´åŠ ç²¾ç®€å’Œç³»ç»ŸåŒ– æå‡å·¥ç¨‹å¸ˆä½“éªŒï¼šå‡å°‘äº†æµæ°´çº¿ä¸­æ–­ï¼Œå¢å¼ºå¼€å‘ä½“éªŒ æ¸…æ™°å®¡è®¡è½¨è¿¹ï¼šæ—¥å¿—æ˜ç¡®è®°å½•è±å…åŸå› ï¼Œä¾¿äºå®¡è®¡å’Œç®¡ç† ğŸ”— æºç ä¸å‚è€ƒ å®Œæ•´ä»£ç æäº¤: Github Commit Jenkins å…±äº«åº“æ–‡æ¡£: Jenkins Shared Libraries Docker é•œåƒä¼˜åŒ–å»ºè®®: Docker Best Practices AI/ML Docker é•œåƒå‚è€ƒ: Top AI/ML Docker Images ","permalink":"https://jackypanster.github.io/ai-stream/posts/check-docker-image-size/","summary":"\u003ch2 id=\"-æ¦‚è¿°\"\u003eğŸ“‹ æ¦‚è¿°\u003c/h2\u003e\n\u003cp\u003eåœ¨CI/CDæµç¨‹ä¸­ï¼ŒDockeré•œåƒå¤§å°ç®¡ç†è‡³å…³é‡è¦ã€‚æœ¬æ–‡è¯¦ç»†ä»‹ç»äº†ä¸€ä¸ªæ ¸å¿ƒä¼˜åŒ–ï¼š\u003cstrong\u003eDockeré•œåƒç™½åå•ç»§æ‰¿æœºåˆ¶\u003c/strong\u003eã€‚è¿™ä¸€æœºåˆ¶è§£å†³äº†åŸºäºç™½åå•ä¸­åŸºç¡€é•œåƒæ„å»ºçš„ä¸šåŠ¡é•œåƒæ— æ³•è‡ªåŠ¨è·å¾—ç™½åå•è±å…çš„é—®é¢˜ï¼Œå¤§å¹…ç®€åŒ–äº†ç™½åå•é…ç½®ç®¡ç†ï¼Œæå‡äº†å›¢é˜Ÿå¼€å‘æ•ˆç‡ã€‚\u003c/p\u003e\n\u003ch2 id=\"-èƒŒæ™¯ä¸é—®é¢˜åˆ†æ\"\u003eğŸ§© èƒŒæ™¯ä¸é—®é¢˜åˆ†æ\u003c/h2\u003e\n\u003ch3 id=\"é—®é¢˜èƒŒæ™¯\"\u003eé—®é¢˜èƒŒæ™¯\u003c/h3\u003e\n\u003cp\u003eåœ¨Jenkins CI/CDç®¡é“ä¸­ï¼Œä¸ºæ§åˆ¶Dockeré•œåƒä½“ç§¯ï¼Œæˆ‘ä»¬é™åˆ¶é•œåƒå¤§å°ä¸è¶…è¿‡2GBã€‚ç„¶è€Œï¼ŒAI/MLé¢†åŸŸçš„åŸºç¡€é•œåƒï¼ˆå¦‚PyTorchã€TensorFlowï¼‰å¤©ç„¶è¶…è¿‡æ­¤é™åˆ¶ï¼Œå› æ­¤å®ç°äº†ç™½åå•æœºåˆ¶å…è®¸ç‰¹å®šé•œåƒè·³è¿‡å¤§å°æ£€æŸ¥ã€‚\u003c/p\u003e\n\u003ch3 id=\"æ ¸å¿ƒéš¾é¢˜\"\u003eæ ¸å¿ƒéš¾é¢˜\u003c/h3\u003e\n\u003cp\u003e\u003cstrong\u003eç™½åå•æ— æ³•è¦†ç›–æ´¾ç”Ÿé•œåƒ\u003c/strong\u003eï¼šå½“å·¥ç¨‹å¸ˆåŸºäºç™½åå•ä¸­çš„åŸºç¡€é•œåƒï¼ˆå¦‚\u003ccode\u003epytorch/pytorch:1.9.0\u003c/code\u003eï¼‰æ„å»ºè‡ªå®šä¹‰é•œåƒï¼ˆå¦‚\u003ccode\u003ecompany/ml-model:v1\u003c/code\u003eï¼‰æ—¶ï¼Œç”±äºæ–°é•œåƒåç§°ä¸åœ¨ç™½åå•ä¸­ï¼Œå¯¼è‡´CIæµç¨‹å› å¤§å°é™åˆ¶è€Œå¤±è´¥ã€‚è¿™è¿«ä½¿å›¢é˜Ÿé¢‘ç¹æ›´æ–°ç™½åå•ï¼Œç»´æŠ¤æˆæœ¬é«˜æ˜‚ã€‚\u003c/p\u003e\n\u003ch3 id=\"ç°æœ‰æµç¨‹\"\u003eç°æœ‰æµç¨‹\u003c/h3\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003eæ£€æŸ¥åŸºç¡€é•œåƒå¤§å° â†’ æ£€æŸ¥åŸºç¡€é•œåƒæ˜¯å¦åœ¨ç™½åå•ä¸­ â†’ æ„å»ºæ–°é•œåƒ â†’ \næ£€æŸ¥æ„å»ºé•œåƒå¤§å° â†’ æ£€æŸ¥æ„å»ºé•œåƒæ˜¯å¦åœ¨ç™½åå•ä¸­ â†’ æµæ°´çº¿ç»§ç»­/å¤±è´¥\n\u003c/code\u003e\u003c/pre\u003e\u003ch2 id=\"-æ–¹æ¡ˆè®¾è®¡ä¸åŸç†\"\u003eğŸ” æ–¹æ¡ˆè®¾è®¡ä¸åŸç†\u003c/h2\u003e\n\u003ch3 id=\"ç™½åå•ç»§æ‰¿æ€è·¯\"\u003eç™½åå•ç»§æ‰¿æ€è·¯\u003c/h3\u003e\n\u003cp\u003eè®¾è®¡ä¸€ç§\u0026quot;ç»§æ‰¿æœºåˆ¶\u0026quot;ï¼Œä½¿åŸºäºç™½åå•ä¸­åŸºç¡€é•œåƒæ„å»ºçš„é•œåƒèƒ½å¤Ÿè‡ªåŠ¨è·å¾—ç™½åå•è±å…æƒé™ï¼Œå³ä½¿æ–°é•œåƒåç§°ä¸åœ¨ç™½åå•ä¸­ã€‚\u003c/p\u003e\n\u003ch3 id=\"ä¼˜åŒ–æ ¸å¿ƒåŸç†\"\u003eä¼˜åŒ–æ ¸å¿ƒåŸç†\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003eåœ¨æ£€æµ‹åŸºç¡€é•œåƒæ—¶ï¼Œè®°å½•å…¶ç™½åå•çŠ¶æ€\u003c/li\u003e\n\u003cli\u003eåœ¨æ£€æµ‹æ„å»ºé•œåƒæ—¶ï¼Œè€ƒè™‘ä¸¤ç§ç™½åå•æ¡ä»¶ï¼š\n\u003cul\u003e\n\u003cli\u003eé•œåƒåç§°æ˜¯å¦åœ¨ç™½åå•ä¸­ï¼ˆåŸå§‹æœºåˆ¶ï¼‰\u003c/li\u003e\n\u003cli\u003eåŸºç¡€é•œåƒæ˜¯å¦åœ¨ç™½åå•ä¸­ï¼ˆæ–°å¢ç»§æ‰¿æœºåˆ¶ï¼‰\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eå¦‚æœæ»¡è¶³ä»»ä¸€æ¡ä»¶ï¼Œåˆ™å…è®¸é•œåƒé€šè¿‡å¤§å°æ£€æŸ¥\u003c/li\u003e\n\u003c/ol\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003eåŸºç¡€é•œåƒç™½åå•çŠ¶æ€ â†’ ä¼ é€’ç»™æ„å»ºé•œåƒæ£€æµ‹ â†’ \næ„å»ºé•œåƒæ£€æµ‹åŒæ—¶è€ƒè™‘è‡ªèº«ç™½åå•çŠ¶æ€å’ŒåŸºç¡€é•œåƒç™½åå•çŠ¶æ€\n\u003c/code\u003e\u003c/pre\u003e\u003ch2 id=\"-æ ¸å¿ƒå®ç°æ­¥éª¤\"\u003eğŸ› ï¸ æ ¸å¿ƒå®ç°æ­¥éª¤\u003c/h2\u003e\n\u003ch3 id=\"æ”¹è¿›åŸºç¡€é•œåƒæ£€æµ‹å‡½æ•°\"\u003eæ”¹è¿›åŸºç¡€é•œåƒæ£€æµ‹å‡½æ•°\u003c/h3\u003e\n\u003cp\u003eä¿®æ”¹\u003ccode\u003echeckBaseImageSize\u003c/code\u003eå‡½æ•°ï¼Œå¢åŠ è¿”å›åŸºç¡€é•œåƒç™½åå•çŠ¶æ€ï¼š\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-groovy\" data-lang=\"groovy\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#66d9ef\"\u003edef\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003echeckBaseImageSize\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e(\u003c/span\u003eString dockerFilePath\u003cspan style=\"color:#f92672\"\u003e)\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003edef\u003c/span\u003e baseImageName \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e sh\u003cspan style=\"color:#f92672\"\u003e(\u003c/span\u003escript: \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;cat ${dockerFilePath} | grep FROM | head -n 1 | awk \u0026#39;{print \\$2}\u0026#39;\u0026#34;\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e,\u003c/span\u003e returnStdout: \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e).\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003etrim\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e()\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    echo \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;åŸºç¡€é•œåƒ: ${baseImageName}\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#75715e\"\u003e// è·å–é•œåƒå¤§å°\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e    \u003cspan style=\"color:#66d9ef\"\u003edef\u003c/span\u003e baseImageSize \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e sh\u003cspan style=\"color:#f92672\"\u003e(\u003c/span\u003escript: \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;docker images --format \u0026#39;{{.Size}}\u0026#39; ${baseImageName} | head -n 1\u0026#34;\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e,\u003c/span\u003e returnStdout: \u003cspan style=\"color:#66d9ef\"\u003etrue\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e).\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003etrim\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e()\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003edef\u003c/span\u003e sizeMB \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e baseImageSize\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003econtains\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e(\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;MB\u0026#39;\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e)\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e?\u003c/span\u003e baseImageSize\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003ereplace\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e(\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;MB\u0026#39;\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e,\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;\u0026#39;\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e).\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003etrim\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e().\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003etoFloat\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e()\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                \u003cspan style=\"color:#f92672\"\u003e(\u003c/span\u003ebaseImageSize\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003econtains\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e(\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;GB\u0026#39;\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e)\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e?\u003c/span\u003e baseImageSize\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003ereplace\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e(\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;GB\u0026#39;\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e,\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;\u0026#39;\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e).\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003etrim\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e().\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003etoFloat\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e()\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1024\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003edef\u003c/span\u003e warnSizeMB \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e env\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eBASE_IMAGE_WARN_SIZE_MB\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e?\u003c/span\u003e env\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eBASE_IMAGE_WARN_SIZE_MB\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003etoInteger\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e()\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2048\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    echo \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;åŸºç¡€é•œåƒå¤§å°: ${sizeMB}MB, è­¦å‘Šé˜ˆå€¼: ${warnSizeMB}MB\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#75715e\"\u003e// å…³é”®ç‚¹ï¼šæ£€æŸ¥åŸºç¡€é•œåƒæ˜¯å¦åœ¨ç™½åå•ä¸­\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e    \u003cspan style=\"color:#66d9ef\"\u003eboolean\u003c/span\u003e inWhitelist \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e isImageInWhitelist\u003cspan style=\"color:#f92672\"\u003e(\u003c/span\u003ebaseImageName\u003cspan style=\"color:#f92672\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#75715e\"\u003e// å¤§å°æ£€æŸ¥é€»è¾‘\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e    \u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e(\u003c/span\u003esizeMB \u003cspan style=\"color:#f92672\"\u003e\u0026gt;\u003c/span\u003e warnSizeMB\u003cspan style=\"color:#f92672\"\u003e)\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e(!\u003c/span\u003einWhitelist\u003cspan style=\"color:#f92672\"\u003e)\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#66d9ef\"\u003ethrow\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003enewReasonException\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e(\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;åŸºç¡€é•œåƒ ${baseImageName} å¤§å° ${sizeMB}MB è¶…è¿‡äº†è­¦å‘Šé˜ˆå€¼ ${warnSizeMB}MB\u0026#34;\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#f92672\"\u003e}\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eelse\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e{\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            echoWarning\u003cspan style=\"color:#f92672\"\u003e(\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;åŸºç¡€é•œåƒ ${baseImageName} å¤§å°ä¸º ${sizeMB}MBï¼Œè¶…è¿‡å…è®¸çš„ ${warnSizeMB}MBï¼Œä½†åœ¨ç™½åå•ä¸­ï¼Œå…è®¸ç»§ç»­\u0026#34;\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#f92672\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#f92672\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#75715e\"\u003e// è¿”å›åŒ…å«ç™½åå•çŠ¶æ€çš„ä¿¡æ¯\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e    \u003cspan style=\"color:#66d9ef\"\u003ereturn\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e[\u003c/span\u003ebaseImage: baseImageName\u003cspan style=\"color:#f92672\"\u003e,\u003c/span\u003e size: sizeMB\u003cspan style=\"color:#f92672\"\u003e,\u003c/span\u003e inWhitelist: inWhitelist\u003cspan style=\"color:#f92672\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#f92672\"\u003e}\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"ä¼˜åŒ–æ„å»ºé•œåƒæ£€æµ‹å‡½æ•°\"\u003eä¼˜åŒ–æ„å»ºé•œåƒæ£€æµ‹å‡½æ•°\u003c/h3\u003e\n\u003cp\u003eä¿®æ”¹\u003ccode\u003echeckImageSize\u003c/code\u003eå‡½æ•°ï¼Œå®ç°ç™½åå•ç»§æ‰¿æœºåˆ¶ï¼š\u003c/p\u003e","title":"ä¼˜åŒ–CI/CDç®¡é“ï¼šå®ç°Dockeré•œåƒç™½åå•ç»§æ‰¿æœºåˆ¶"},{"content":" ğŸ“‹ æ¦‚è¿° ğŸ–¥ï¸ ç³»ç»Ÿä¸ç¯å¢ƒè¦æ±‚ ç¡¬ä»¶é…ç½® è½¯ä»¶ç¯å¢ƒ ğŸ§  æ¨¡å‹ä¸éƒ¨ç½²æ¶æ„è§£æ Qwen3-32B-AWQ æ¨¡å‹ç‰¹æ€§ vLLMï¼šä¸ºä½•é€‰æ‹©å®ƒï¼Ÿ å…³é”®éœ€æ±‚ï¼šç¦ç”¨æ€è€ƒæ¨¡å¼ (enable_thinking=False) ğŸ› ï¸ æ ¸å¿ƒéƒ¨ç½²æ­¥éª¤ å‡†å¤‡è‡ªå®šä¹‰èŠå¤©æ¨¡æ¿ Docker éƒ¨ç½²å‘½ä»¤ âš™ï¸ å‚æ•°è¯¦è§£ä¸ä¼˜åŒ–ç­–ç•¥ Docker å®¹å™¨é…ç½®å‚æ•° vLLM å¼•æ“æ ¸å¿ƒå‚æ•° ğŸ§ª éƒ¨ç½²éªŒè¯ä¸æµ‹è¯• æ£€æŸ¥ Docker æ—¥å¿— ä½¿ç”¨ Python è„šæœ¬éªŒè¯ API ç¯å¢ƒå‡†å¤‡ï¼šä½¿ç”¨ uv ç®¡ç†ä¾èµ– éªŒè¯è„šæœ¬ä¸é¢„æœŸè¾“å‡º ğŸ”— é¡¹ç›®æºç  ğŸ”š æ€»ç»“ ğŸ“‹ æ¦‚è¿° éšç€å¤§è¯­è¨€æ¨¡å‹ (LLM) çš„é£é€Ÿå‘å±•ï¼Œå¦‚ä½•åœ¨æœ‰é™çš„ç¡¬ä»¶èµ„æºä¸‹é«˜æ•ˆéƒ¨ç½²è¿™äº›åºç„¶å¤§ç‰©ï¼Œæˆä¸ºäº†ä¸šç•Œå…³æ³¨çš„ç„¦ç‚¹ã€‚æœ¬æ–‡å°†èšç„¦äºé˜¿é‡Œå·´å·´é€šä¹‰åƒé—®å›¢é˜Ÿæœ€æ–°æ¨å‡ºçš„ Qwen3-32B-AWQ æ¨¡å‹ï¼Œè¯¦ç»†é˜è¿°å¦‚ä½•åˆ©ç”¨ vLLM è¿™ä¸€é«˜æ€§èƒ½æ¨ç†å¼•æ“ï¼Œåœ¨å¤š GPU ç¯å¢ƒä¸‹å®ç°å…¶é«˜æ•ˆã€ç¨³å®šçš„éƒ¨ç½²ã€‚æˆ‘ä»¬å°†è¦†ç›–ä»ç¯å¢ƒå‡†å¤‡ã€æ¨¡å‹ç‰¹æ€§è§£æã€éƒ¨ç½²å‘½ä»¤è°ƒä¼˜ï¼Œåˆ°æœ€ç»ˆçš„åŠŸèƒ½éªŒè¯ä¸ API æµ‹è¯•çš„å…¨è¿‡ç¨‹ï¼Œç‰¹åˆ«å…³æ³¨ 32K é•¿ä¸Šä¸‹æ–‡å¤„ç†ã€AWQ (Activation-aware Weight Quantization) é‡åŒ–æ¨¡å‹çš„ç‰¹æ€§ï¼Œä»¥åŠå¦‚ä½•é€šè¿‡è‡ªå®šä¹‰èŠå¤©æ¨¡æ¿ç¦ç”¨æ¨¡å‹çš„â€œæ€è€ƒæ¨¡å¼â€ (å³ \u0026lt;think\u0026gt;...\u0026lt;/think\u0026gt; æ ‡ç­¾çš„è¾“å‡º)ã€‚\næœ¬æ–‡æ—¨åœ¨ä¸ºå¸Œæœ›åœ¨ç”Ÿäº§ç¯å¢ƒä¸­éƒ¨ç½² Qwen3 ç³»åˆ—æ¨¡å‹çš„å·¥ç¨‹å¸ˆæä¾›ä¸€ä»½è¯¦å°½çš„å®è·µæŒ‡å—å’Œä¼˜åŒ–å‚è€ƒã€‚é¡¹ç›®å®Œæ•´ä»£ç å·²å¼€æºï¼Œæ¬¢è¿äº¤æµï¼šhttps://github.com/jackypanster/deploy-qwen3-32b-awq\nğŸ–¥ï¸ ç³»ç»Ÿä¸ç¯å¢ƒè¦æ±‚ ç¡¬ä»¶é…ç½® GPU: 4å— NVIDIA GPU (æ¯å—è‡³å°‘ 22GB VRAMï¼Œæ€»è®¡çº¦ 88GBï¼Œæ¨è Ampere æ¶æ„åŠä»¥ä¸Šï¼Œä½†æœ¬é¡¹ç›®åœ¨ Volta/Turing æ¶æ„éªŒè¯é€šè¿‡) ç³»ç»Ÿå†…å­˜: å»ºè®® 512GB åŠä»¥ä¸Š å­˜å‚¨: å»ºè®® 2TB é«˜é€Ÿ SSD (æ¨¡å‹æ–‡ä»¶çº¦ 60-70GBï¼ŒåŠ ä¸Š Docker é•œåƒå’Œæ—¥å¿—ç­‰) CPU: å»ºè®® 56 æ ¸åŠä»¥ä¸Š (ç”¨äºæ•°æ®é¢„å¤„ç†ã€Tokenizer æ± ç­‰) è½¯ä»¶ç¯å¢ƒ æ“ä½œç³»ç»Ÿ: Ubuntu 24.04 (æˆ–å…¶å®ƒå…¼å®¹çš„ Linux å‘è¡Œç‰ˆ) NVIDIA é©±åŠ¨: 570.153.02 (æˆ–æ›´é«˜ç‰ˆæœ¬ï¼Œéœ€ä¸ CUDA 12.8 å…¼å®¹) CUDA ç‰ˆæœ¬: 12.8 (vLLM ä¾èµ–) Docker: æœ€æ–°ç¨³å®šç‰ˆï¼Œå¹¶å·²å®‰è£… NVIDIA Container Toolkit vLLM Docker é•œåƒ: vllm/vllm-openai:v0.8.5 (æˆ–é¡¹ç›®éªŒè¯æ—¶ä½¿ç”¨çš„æœ€æ–°å…¼å®¹ç‰ˆæœ¬) ğŸ§  æ¨¡å‹ä¸éƒ¨ç½²æ¶æ„è§£æ Qwen3-32B-AWQ æ¨¡å‹ç‰¹æ€§ Qwen3-32B-AWQ æ˜¯ Qwen3 ç³»åˆ—ä¸­çš„ 320 äº¿å‚æ•°è§„æ¨¡çš„æ¨¡å‹ï¼Œå¹¶é‡‡ç”¨äº† AWQ é‡åŒ–æŠ€æœ¯ã€‚\n32B å‚æ•°: åœ¨æ€§èƒ½å’Œèµ„æºæ¶ˆè€—ä¹‹é—´å–å¾—äº†è¾ƒå¥½çš„å¹³è¡¡ã€‚ AWQ é‡åŒ–: Activation-aware Weight Quantization æ˜¯ä¸€ç§å…ˆè¿›çš„é‡åŒ–æŠ€æœ¯ï¼Œå®ƒèƒ½å¤Ÿåœ¨æ˜¾è‘—é™ä½æ¨¡å‹æ˜¾å­˜å ç”¨å’ŒåŠ é€Ÿæ¨ç†çš„åŒæ—¶ï¼Œæœ€å¤§é™åº¦åœ°ä¿æŒæ¨¡å‹ç²¾åº¦ã€‚ç›¸æ¯”äºä¼ ç»Ÿçš„ FP16/BF16 æ¨ç†ï¼ŒAWQ æ¨¡å‹é€šå¸¸èƒ½ä»¥ INT4/INT8 æ··åˆç²¾åº¦è¿è¡Œï¼Œå¯¹ç¡¬ä»¶è¦æ±‚æ›´ä½ã€‚ 32K ä¸Šä¸‹æ–‡é•¿åº¦: åŸç”Ÿæ”¯æŒé«˜è¾¾ 32,768 ä¸ª token çš„ä¸Šä¸‹æ–‡é•¿åº¦ï¼Œä½¿å…¶èƒ½å¤Ÿå¤„ç†æ›´å¤æ‚çš„é•¿æ–‡æœ¬ä»»åŠ¡ã€‚ ç¦ç”¨æ€è€ƒæ¨¡å¼: å¯¹äºæŸäº›åº”ç”¨åœºæ™¯ï¼Œæˆ‘ä»¬ä¸å¸Œæœ›æ¨¡å‹è¾“å‡ºä¸­é—´çš„æ€è€ƒè¿‡ç¨‹ (å¦‚ Qwen ç³»åˆ—ç‰¹æœ‰çš„ \u0026lt;think\u0026gt;...\u0026lt;/think\u0026gt; æ ‡ç­¾)ã€‚æœ¬é¡¹ç›®é€šè¿‡è‡ªå®šä¹‰ Jinja èŠå¤©æ¨¡æ¿åœ¨æœåŠ¡ç«¯å¼ºåˆ¶ç¦ç”¨äº†æ­¤åŠŸèƒ½ã€‚ vLLMï¼šä¸ºä½•é€‰æ‹©å®ƒï¼Ÿ vLLM æ˜¯ä¸€ä¸ªä¸“ä¸º LLM æ¨ç†è®¾è®¡çš„é«˜æ€§èƒ½å¼•æ“ï¼Œå…¶æ ¸å¿ƒä¼˜åŠ¿åŒ…æ‹¬ï¼š\nPagedAttention: ä¸€ç§æ–°é¢–çš„æ³¨æ„åŠ›ç®—æ³•ï¼Œæœ‰æ•ˆç®¡ç† KV ç¼“å­˜ï¼Œæ˜¾è‘—å‡å°‘å†…å­˜æµªè´¹å’Œç¢ç‰‡ï¼Œä»è€Œæ”¯æŒæ›´é•¿çš„åºåˆ—å’Œæ›´å¤§çš„æ‰¹å¤„ç†å¤§å°ã€‚ è¿ç»­æ‰¹å¤„ç† (Continuous Batching): è¯·æ±‚æ— éœ€ç­‰å¾…æ‰¹å¤„ç†ä¸­çš„æ‰€æœ‰åºåˆ—å®Œæˆï¼Œå¯ä»¥åŠ¨æ€æ’å…¥æ–°çš„è¯·æ±‚ï¼Œå¤§å¹…æé«˜ GPU åˆ©ç”¨ç‡å’Œååé‡ã€‚ å¼ é‡å¹¶è¡Œ: è‡ªåŠ¨ä¸”é«˜æ•ˆåœ°å°†æ¨¡å‹æƒé‡å’Œè®¡ç®—ä»»åŠ¡åˆ†å¸ƒåˆ°å¤šä¸ª GPU ä¸Šï¼Œç®€åŒ–äº†å¤š GPU éƒ¨ç½²çš„å¤æ‚æ€§ã€‚ OpenAI å…¼å®¹ API: æä¾›ä¸ OpenAI API ä¸€è‡´çš„æ¥å£ï¼Œä½¿å¾—ç°æœ‰åº”ç”¨å¯ä»¥æ— ç¼è¿ç§»ã€‚ å¹¿æ³›çš„æ¨¡å‹æ”¯æŒå’Œç¤¾åŒºæ´»è·ƒ: æ”¯æŒåŒ…æ‹¬ Qwen åœ¨å†…çš„ä¼—å¤šä¸»æµæ¨¡å‹ï¼Œå¹¶ä¸”ç¤¾åŒºæ´»è·ƒï¼Œè¿­ä»£è¿…é€Ÿã€‚ å…³é”®éœ€æ±‚ï¼šç¦ç”¨æ€è€ƒæ¨¡å¼ (enable_thinking=False) Qwen æ¨¡å‹åœ¨æŸäº›æƒ…å†µä¸‹ä¼šè¾“å‡ºåŒ…å« \u0026lt;think\u0026gt;...\u0026lt;/think\u0026gt; æ ‡ç­¾çš„ä¸­é—´æ€è€ƒè¿‡ç¨‹ã€‚åœ¨æˆ‘ä»¬çš„åº”ç”¨åœºæ™¯ä¸­ï¼Œè¿™å¹¶éæœŸæœ›è¡Œä¸ºã€‚ä¸ºäº†ç¡®ä¿ API è¾“å‡ºçš„çº¯å‡€æ€§ï¼Œæˆ‘ä»¬é‡‡ç”¨äº†è‡ªå®šä¹‰ Jinja èŠå¤©æ¨¡æ¿çš„æ–¹å¼ã€‚è¯¥æ¨¡æ¿åœ¨æœåŠ¡ç«¯å¤„ç†ç”¨æˆ·è¾“å…¥æ—¶ï¼Œä¸ä¼šå¼•å¯¼æ¨¡å‹è¿›å…¥â€œæ€è€ƒâ€æµç¨‹ã€‚ç›¸æ¯”äºåœ¨å®¢æˆ·ç«¯æ¯æ¬¡è¯·æ±‚æ—¶ä¼ é€’ enable_thinking=False å‚æ•°ï¼ŒæœåŠ¡ç«¯æ¨¡æ¿çš„æ–¹å¼æ›´ä¸ºå½»åº•å’Œç»Ÿä¸€ã€‚\nğŸ› ï¸ æ ¸å¿ƒéƒ¨ç½²æ­¥éª¤ å‡†å¤‡è‡ªå®šä¹‰èŠå¤©æ¨¡æ¿ åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹åˆ›å»º qwen3_nonthinking.jinja æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š\n{% for message in messages %} {% if message[\u0026#39;role\u0026#39;] == \u0026#39;system\u0026#39; %} {{\u0026#39;\u0026lt;|im_start|\u0026gt;system \u0026#39; + message[\u0026#39;content\u0026#39;] + \u0026#39;\u0026lt;|im_end|\u0026gt; \u0026#39;}} {% elif message[\u0026#39;role\u0026#39;] == \u0026#39;user\u0026#39; %} {{\u0026#39;\u0026lt;|im_start|\u0026gt;user \u0026#39; + message[\u0026#39;content\u0026#39;] + \u0026#39;\u0026lt;|im_end|\u0026gt; \u0026#39;}} {% elif message[\u0026#39;role\u0026#39;] == \u0026#39;assistant\u0026#39; %} {{\u0026#39;\u0026lt;|im_start|\u0026gt;assistant \u0026#39; + message[\u0026#39;content\u0026#39;] + \u0026#39;\u0026lt;|im_end|\u0026gt; \u0026#39;}} {% endif %} {% endfor %} {% if add_generation_prompt %} {{\u0026#39;\u0026lt;|im_start|\u0026gt;assistant \u0026#39;}} {% endif %} æ­¤æ¨¡æ¿ç§»é™¤äº†å¯èƒ½è§¦å‘æ€è€ƒæ¨¡å¼çš„ç‰¹æ®ŠæŒ‡ä»¤ã€‚\nDocker éƒ¨ç½²å‘½ä»¤ å‡è®¾æ¨¡å‹æ–‡ä»¶å·²ä¸‹è½½åˆ°å®¿ä¸»æœºçš„ /home/llm/model/qwen/Qwen3-32B-AWQ ç›®å½•ï¼Œä»é¡¹ç›®å·¥ä½œåŒºæ ¹ç›®å½•æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š\ndocker run -d \\ --runtime=nvidia \\ --gpus=all \\ --name coder \\ -v /home/llm/model/qwen/Qwen3-32B-AWQ:/model/Qwen3-32B-AWQ \\ -v $(pwd)/qwen3_nonthinking.jinja:/app/qwen3_nonthinking.jinja \\ -p 8000:8000 \\ --cpuset-cpus 0-55 \\ --ulimit memlock=-1 \\ --ulimit stack=67108864 \\ --restart always \\ --ipc=host \\ vllm/vllm-openai:v0.8.5 \\ --model /model/Qwen3-32B-AWQ \\ --served-model-name coder \\ --tensor-parallel-size 4 \\ --dtype half \\ --quantization awq \\ --max-model-len 32768 \\ --max-num-batched-tokens 4096 \\ --gpu-memory-utilization 0.93 \\ --block-size 32 \\ --enable-chunked-prefill \\ --swap-space 16 \\ --tokenizer-pool-size 56 \\ --disable-custom-all-reduce \\ --chat-template /app/qwen3_nonthinking.jinja âš™ï¸ å‚æ•°è¯¦è§£ä¸ä¼˜åŒ–ç­–ç•¥ Docker å®¹å™¨é…ç½®å‚æ•° -d: åå°è¿è¡Œå®¹å™¨ã€‚ --runtime=nvidia --gpus=all: ä½¿ç”¨ NVIDIA runtime å¹¶åˆ†é…æ‰€æœ‰ GPUã€‚ --name coder: ä¸ºå®¹å™¨å‘½åï¼Œæ–¹ä¾¿ç®¡ç†ã€‚ -v /home/llm/model/qwen/Qwen3-32B-AWQ:/model/Qwen3-32B-AWQ: æŒ‚è½½æœ¬åœ°æ¨¡å‹ç›®å½•åˆ°å®¹å™¨å†…ã€‚ -v $(pwd)/qwen3_nonthinking.jinja:/app/qwen3_nonthinking.jinja: æŒ‚è½½è‡ªå®šä¹‰èŠå¤©æ¨¡æ¿ã€‚ -p 8000:8000: æ˜ å°„ç«¯å£ã€‚ --cpuset-cpus 0-55: ç»‘å®š CPUæ ¸å¿ƒï¼Œé¿å…èµ„æºäº‰æŠ¢ã€‚ --ulimit memlock=-1 --ulimit stack=67108864: è§£é™¤å†…å­˜é”å®šé™åˆ¶ï¼Œè®¾ç½®è¾ƒå¤§å †æ ˆç©ºé—´ï¼Œå¯¹æ€§èƒ½å’Œç¨³å®šæ€§æœ‰ç›Šã€‚ --restart always: å®¹å™¨å¼‚å¸¸é€€å‡ºæ—¶è‡ªåŠ¨é‡å¯ã€‚ --ipc=host: ä½¿ç”¨å®¿ä¸»æœº IPC å‘½åç©ºé—´ï¼Œå¯¹ NCCL é€šä¿¡ï¼ˆå¤šGPUååŒï¼‰è‡³å…³é‡è¦ï¼Œèƒ½æ˜¾è‘—æé«˜æ€§èƒ½ã€‚ vLLM å¼•æ“æ ¸å¿ƒå‚æ•° --model /model/Qwen3-32B-AWQ: æŒ‡å®šå®¹å™¨å†…æ¨¡å‹çš„è·¯å¾„ã€‚ --served-model-name coder: API æœåŠ¡æ—¶ä½¿ç”¨çš„æ¨¡å‹åç§°ã€‚ --tensor-parallel-size 4: è®¾ç½®å¼ é‡å¹¶è¡Œæ•°ä¸º 4ï¼Œå³ä½¿ç”¨ 4 å— GPU ååŒæ¨ç†ã€‚æ ¹æ®æ¨¡å‹å¤§å°å’Œ GPU æ˜¾å­˜è°ƒæ•´ã€‚ --dtype half: AWQ æ¨¡å‹é€šå¸¸ä»¥åŠç²¾åº¦ (FP16) åŠ è½½æƒé‡ä»¥è·å¾—æœ€ä½³æ€§èƒ½å’Œæ˜¾å­˜å¹³è¡¡ã€‚å°½ç®¡ AWQ å†…éƒ¨å¯èƒ½ä½¿ç”¨æ›´ä½ç²¾åº¦ï¼Œä½† vLLM åŠ è½½æ—¶é€šå¸¸æŒ‡å®š half æˆ– autoã€‚ --quantization awq: æ˜ç¡®å‘ŠçŸ¥ vLLM æ¨¡å‹æ˜¯ AWQ é‡åŒ–ç±»å‹ã€‚ --max-model-len 32768: è®¾ç½®æ¨¡å‹èƒ½å¤„ç†çš„æœ€å¤§åºåˆ—é•¿åº¦ï¼Œä¸ Qwen3-32B çš„èƒ½åŠ›åŒ¹é…ã€‚ --max-num-batched-tokens 4096: å•ä¸ªæ‰¹æ¬¡ä¸­å¤„ç†çš„æœ€å¤§ token æ•°é‡ã€‚æ­¤å€¼å½±å“å¹¶å‘èƒ½åŠ›å’Œæ˜¾å­˜å ç”¨ï¼Œéœ€æ ¹æ®å®é™…è´Ÿè½½è°ƒæ•´ã€‚ --gpu-memory-utilization 0.93: è®¾ç½® GPU æ˜¾å­˜ä½¿ç”¨ç‡ã€‚ä¿ç•™ä¸€éƒ¨åˆ†ï¼ˆè¿™é‡Œæ˜¯ 7%ï¼‰æ˜¯ä¸ºäº†åº”å¯¹çªå‘æ˜¾å­˜éœ€æ±‚å’Œé¿å… OOMã€‚å¯¹äº AWQ æ¨¡å‹ï¼Œç”±äº KV ç¼“å­˜ä¾ç„¶æ˜¯ FP16ï¼Œè¿™éƒ¨åˆ†æ˜¾å­˜å ç”¨ä¸å¯å¿½è§†ã€‚ --block-size 32: PagedAttention ä¸­ KV ç¼“å­˜å—çš„å¤§å°ã€‚é€šå¸¸ 16 æˆ– 32 æ˜¯è¾ƒä¼˜é€‰æ‹©ã€‚ --enable-chunked-prefill: å¯¹äºé•¿åºåˆ—ï¼ˆå¦‚ 32K ä¸Šä¸‹æ–‡ï¼‰ï¼Œå¯ç”¨åˆ†å—é¢„å¡«å……å¯ä»¥æœ‰æ•ˆé™ä½å³°å€¼æ˜¾å­˜ï¼Œæé«˜é•¿åºåˆ—å¤„ç†çš„ç¨³å®šæ€§ã€‚ --swap-space 16: åˆ†é… 16GB çš„ CPU RAM ä½œä¸º GPU KV ç¼“å­˜çš„äº¤æ¢ç©ºé—´ã€‚å½“ GPU æ˜¾å­˜ä¸è¶³ä»¥å®¹çº³æ‰€æœ‰æ´»è·ƒè¯·æ±‚çš„ KV ç¼“å­˜æ—¶ï¼ŒvLLM ä¼šå°†éƒ¨åˆ†å†·æ•°æ®äº¤æ¢åˆ° CPU RAMã€‚ --tokenizer-pool-size 56: è®¾ç½® Tokenizer å·¥ä½œæ± çš„å¤§å°ï¼Œå»ºè®®ä¸ CPU æ ¸å¿ƒæ•°æ¥è¿‘ï¼Œä»¥å……åˆ†åˆ©ç”¨ CPU å¹¶è¡Œå¤„ç†èƒ½åŠ›è¿›è¡Œæ–‡æœ¬ç¼–ç è§£ç ã€‚ --disable-custom-all-reduce: åœ¨æŸäº›å¤šäº 2 ä¸ªçº¯ PCIe è¿æ¥çš„ GPU é…ç½®ä¸­ï¼ŒvLLM çš„è‡ªå®šä¹‰ all-reduce å†…æ ¸å¯èƒ½å­˜åœ¨å…¼å®¹æ€§æˆ–æ€§èƒ½é—®é¢˜ã€‚ç¦ç”¨å®ƒå¯ä»¥å›é€€åˆ° NCCL é»˜è®¤å®ç°ï¼Œé€šå¸¸æ›´ç¨³å®šã€‚ --chat-template /app/qwen3_nonthinking.jinja: æŒ‡å®šä½¿ç”¨æˆ‘ä»¬è‡ªå®šä¹‰çš„èŠå¤©æ¨¡æ¿æ–‡ä»¶ã€‚ ğŸ§ª éƒ¨ç½²éªŒè¯ä¸æµ‹è¯• æ£€æŸ¥ Docker æ—¥å¿— éƒ¨ç½²å¯åŠ¨åï¼Œé¦–å…ˆé€šè¿‡ docker logs -f coder æŸ¥çœ‹ vLLM æœåŠ¡å¯åŠ¨æ—¥å¿—ã€‚å…³é”®ä¿¡æ¯åŒ…æ‹¬ï¼š\nGPU æ£€æµ‹å’Œæ˜¾å­˜åˆ†é…æƒ…å†µã€‚ æ¨¡å‹åˆ†ç‰‡åŠ è½½æƒ…å†µã€‚ PagedAttention KV ç¼“å­˜å—è®¡ç®—å’Œå¯ç”¨æ•°é‡ã€‚ API æœåŠ¡å¯åŠ¨æˆåŠŸï¼Œç›‘å¬ 0.0.0.0:8000ã€‚ ä½¿ç”¨ Python è„šæœ¬éªŒè¯ API ä¸ºäº†ç¡®ä¿æ¨¡å‹æ­£å¸¸å“åº”å¹¶ä¸”è‡ªå®šä¹‰èŠå¤©æ¨¡æ¿ç”Ÿæ•ˆï¼ˆä¸è¾“å‡º \u0026lt;think\u0026gt; æ ‡ç­¾ï¼‰ï¼Œæˆ‘ä»¬ç¼–å†™ä¸€ä¸ªç®€å•çš„ Python è„šæœ¬è¿›è¡Œæµ‹è¯•ã€‚\nç¯å¢ƒå‡†å¤‡ï¼šä½¿ç”¨ uv ç®¡ç†ä¾èµ– æˆ‘ä»¬æ¨èä½¿ç”¨ uv è¿™ä¸€æ–°å…´çš„å¿«é€Ÿ Python åŒ…ç®¡ç†å·¥å…·æ¥åˆ›å»ºè™šæ‹Ÿç¯å¢ƒå’Œå®‰è£…ä¾èµ–ã€‚\nåˆ›å»ºè™šæ‹Ÿç¯å¢ƒ: åœ¨é¡¹ç›®æ ¹ç›®å½•è¿è¡Œ uv venvã€‚è¿™å°†åˆ›å»ºä¸€ä¸ªåä¸º .venv çš„è™šæ‹Ÿç¯å¢ƒã€‚ å®‰è£… openai åŒ…: è¿è¡Œ uv pip install openaiã€‚ éªŒè¯è„šæœ¬ä¸é¢„æœŸè¾“å‡º åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º verify_llm.pyï¼š\nimport openai # æ ¹æ®å®é™…vLLMæœåŠ¡å™¨IPå’Œç«¯å£é…ç½® SERVER_IP = \u0026#34;10.49.121.127\u0026#34; # æˆ–è€… localhost SERVER_PORT = 8000 client = openai.OpenAI( base_url=f\u0026#34;http://{SERVER_IP}:{SERVER_PORT}/v1\u0026#34;, api_key=\u0026#34;dummy-key\u0026#34; # vLLM é»˜è®¤ä¸éœ€è¦ API key ) messages = [ {\u0026#34;role\u0026#34;: \u0026#34;system\u0026#34;, \u0026#34;content\u0026#34;: \u0026#34;You are a helpful assistant.\u0026#34;}, {\u0026#34;role\u0026#34;: \u0026#34;user\u0026#34;, \u0026#34;content\u0026#34;: \u0026#34;ä½ å¥½ï¼Œè¯·ä»‹ç»ä¸€ä¸‹ä½ è‡ªå·±ã€‚\u0026#34;} ] print(\u0026#34;Sending request to the LLM...\\n\u0026#34;) try: completion = client.chat.completions.create( model=\u0026#34;coder\u0026#34;, # å¯¹åº” --served-model-name messages=messages, temperature=0.7, max_tokens=150 ) response_content = completion.choices[0].message.content print(\u0026#34;LLM Response:\u0026#34;) print(response_content) if \u0026#34;\u0026lt;think\u0026gt;\u0026#34; in response_content or \u0026#34;\u0026lt;/think\u0026gt;\u0026#34; in response_content: print(\u0026#34;\\nVERIFICATION FAILED: \u0026#39;\u0026lt;think\u0026gt;\u0026#39; tags found in the response.\u0026#34;) else: print(\u0026#34;\\nVERIFICATION SUCCESSFUL: No \u0026#39;\u0026lt;think\u0026gt;\u0026#39; tags found. \u0026#39;enable_thinking=False\u0026#39; is working as expected.\u0026#34;) except openai.APIConnectionError as e: print(f\u0026#34;Failed to connect to the server: {e}\u0026#34;) print(f\u0026#34;Please ensure the vLLM server is running and accessible at http://{SERVER_IP}:{SERVER_PORT}.\u0026#34;) except Exception as e: print(f\u0026#34;An error occurred: {e}\u0026#34;) ä½¿ç”¨ uv run python3 verify_llm.py è¿è¡Œæ­¤è„šæœ¬ã€‚é¢„æœŸè¾“å‡ºåº”åŒ…å«æ¨¡å‹çš„è‡ªæˆ‘ä»‹ç»ï¼Œå¹¶ä¸”æ˜ç¡®æç¤º VERIFICATION SUCCESSFUL: No '\u0026lt;think\u0026gt;' tags foundã€‚\nğŸ”— é¡¹ç›®æºç  æœ¬é¡¹ç›®çš„æ‰€æœ‰é…ç½®æ–‡ä»¶ã€è„šæœ¬å’Œè¯¦ç»†æ–‡æ¡£å‡å·²åœ¨ GitHub å¼€æºï¼š https://github.com/jackypanster/deploy-qwen3-32b-awq\nğŸ”š æ€»ç»“ é€šè¿‡æœ¬æ–‡çš„è¯¦ç»†æ­¥éª¤å’Œå‚æ•°è§£æï¼Œæˆ‘ä»¬æˆåŠŸåœ°åœ¨å¤š GPU ç¯å¢ƒä¸‹ä½¿ç”¨ vLLM é«˜æ•ˆéƒ¨ç½²äº† Qwen3-32B-AWQ æ¨¡å‹ã€‚å…³é”®çš„ä¼˜åŒ–ç‚¹åŒ…æ‹¬é’ˆå¯¹ AWQ æ¨¡å‹çš„å‚æ•°é…ç½®ã€32K é•¿ä¸Šä¸‹æ–‡å¤„ç†ã€ä»¥åŠé€šè¿‡è‡ªå®šä¹‰èŠå¤©æ¨¡æ¿å®ç°â€œæ— æ€è€ƒæ¨¡å¼â€è¾“å‡ºã€‚è¿™å¥—éƒ¨ç½²æ–¹æ¡ˆå…¼é¡¾äº†æ€§èƒ½ã€èµ„æºåˆ©ç”¨ç‡å’Œç‰¹å®šä¸šåŠ¡éœ€æ±‚ï¼Œä¸ºåŸºäº Qwen3 å¤§æ¨¡å‹çš„åº”ç”¨å¼€å‘æä¾›äº†åšå®çš„åŸºç¡€ã€‚\n","permalink":"https://jackypanster.github.io/ai-stream/posts/deploy-qwen3-32b-awq-vllm-guide/","summary":"æœ¬æ–‡è¯¦ç»†ä»‹ç»äº†å¦‚ä½•ä½¿ç”¨ vLLM é«˜æ•ˆéƒ¨ç½² Qwen3-32B-AWQ é‡åŒ–æ¨¡å‹ï¼Œå®ç° 32K ä¸Šä¸‹æ–‡çª—å£ã€OpenAI å…¼å®¹ APIï¼Œå¹¶ç¦ç”¨æ€è€ƒæ¨¡å¼ã€‚é€šè¿‡å¯¹ Docker åŠ vLLM å‚æ•°çš„ç²¾ç»†è°ƒä¼˜ï¼Œæœ€å¤§åŒ–æ¨¡å‹åœ¨å¤š GPU ç¯å¢ƒä¸‹çš„æ¨ç†æ€§èƒ½ã€‚","title":"Qwen3-32B-AWQ é«˜æ•ˆéƒ¨ç½²ï¼šåŸºäº vLLM çš„æ·±åº¦å®è·µä¸ä¼˜åŒ–"},{"content":"ä¸€ã€é—®é¢˜èƒŒæ™¯ï¼šè­¦å‘Šé¢‘å‘çš„SSSDé…ç½®æ®‹ç•™ åœ¨UbuntuæœåŠ¡å™¨ç»´æŠ¤è¿‡ç¨‹ä¸­ï¼Œé•¿æœŸè¢«AppArmoræœåŠ¡çš„SSSDç›¸å…³è­¦å‘Šå›°æ‰°ã€‚å…·ä½“è¡¨ç°ä¸ºï¼š\næ¯æ¬¡é‡å¯AppArmoræœåŠ¡æ—¶ï¼Œæ—¥å¿—é¢‘ç¹æç¤ºWarning: found usr.sbin.sssd in /etc/apparmor.d/force-complain apparmor_statusæŒç»­æ˜¾ç¤º/usr/sbin/sssdé…ç½®å­˜åœ¨ï¼Œä½†å®é™…å·²å¸è½½SSSDæœåŠ¡ ç³»ç»Ÿæ—¥å¿—ä¸­ä¼´éšCaching disabled for: 'usr.sbin.sssd' due to force complainè­¦å‘Šï¼Œå½±å“æœåŠ¡ç¨³å®šæ€§è¯„ä¼° äºŒã€æŠ€æœ¯åˆ†æï¼šæ·±å…¥AppArmorçš„é…ç½®é€»è¾‘ 1. AppArmorçš„é…ç½®åŠ è½½æœºåˆ¶ ä¸»é…ç½®ç›®å½•ï¼š/etc/apparmor.d/ å­˜æ”¾ç³»ç»Ÿçº§é…ç½® æœ¬åœ°è¦†ç›–ç›®å½•ï¼š/etc/apparmor.d.local/ ä¼˜å…ˆçº§é«˜äºä¸»ç›®å½•ï¼Œç”¨äºæœ¬åœ°è‡ªå®šä¹‰ç­–ç•¥ è¿è¡Œæ—¶ç¼“å­˜ï¼šAppArmorä¼šå°†é…ç½®åŠ è½½åˆ°å†…æ ¸å¹¶ç¼“å­˜ï¼Œå³ä½¿åˆ é™¤æ–‡ä»¶ä¹Ÿå¯èƒ½æ®‹ç•™è¿è¡Œæ—¶çŠ¶æ€ 2. SSSDæœåŠ¡çš„ç‰¹æ®Šæ€§ è¯¥æœåŠ¡é»˜è®¤éšUbuntuéƒ¨åˆ†ç‰ˆæœ¬å®‰è£…ï¼Œæä¾›LDAP/NISç­‰è®¤è¯åŠŸèƒ½ å¸è½½æ—¶é»˜è®¤ä¿ç•™é…ç½®æ–‡ä»¶ï¼ˆ/etc/apparmor.d/usr.sbin.sssdï¼‰ï¼Œå¯¼è‡´AppArmoræŒç»­å°è¯•åŠ è½½å·²åˆ é™¤æœåŠ¡çš„ç­–ç•¥ 3. å…³é”®æŠ¥é”™æº¯æº# æ ¸å¿ƒé”™è¯¯æ—¥å¿— apparmor.systemd[12435]: /lib/apparmor/apparmor.systemd: 148: [: Illegal number: yes apparmor.systemd[12546]: Warning: found usr.sbin.sssd in /etc/apparmor.d/force-complain, forcing complain mode- è¯­æ³•é”™è¯¯æºäºrc.apparmor.functionsä¸­æ•°å€¼æ¯”è¾ƒç¬¦è¯¯ç”¨ï¼ˆ-eqæœªè½¬ä¹‰å­—ç¬¦ä¸²ï¼‰\nè­¦å‘Šæœ¬è´¨æ˜¯æ®‹ç•™é…ç½®ä¸è¿è¡Œæ—¶çŠ¶æ€çš„å†²çª ä¸‰ã€åˆ†æ­¥è§£å†³æ–¹æ¡ˆï¼šä»æ‰‹åŠ¨æ¸…ç†åˆ°å†…æ ¸çº§é‡ç½® 1. è¯­æ³•ä¿®å¤ï¼šä¿®æ­£AppArmorå‡½æ•°åº“# å®šä½å…³é”®å‡½æ•° sudo nano /lib/apparmor/rc.apparmor.functions\nä¿®æ”¹check_usernså‡½æ•°ä¸­çš„æ¯”è¾ƒç¬¦ åŸä»£ç ï¼š if [ \u0026ldquo;$userns_restricted\u0026rdquo; -eq 1 ]; then ä¿®æ­£åï¼š if [ \u0026ldquo;$userns_restricted\u0026rdquo; = \u0026ldquo;1\u0026rdquo; ]; then 2. æœåŠ¡å¸è½½ä¸é…ç½®æ¸…ç†# å½»åº•å¸è½½SSSD sudo apt remove \u0026ndash;purge sssd sssd-tools\nåˆ é™¤ä¸»ç›®å½•é…ç½® sudo rm -f /etc/apparmor.d/usr.sbin.sssd\nå‘ç°å¹¶åˆ é™¤localç›®å½•æ®‹ç•™ sudo find /etc/apparmor.d/ -name \u0026ldquo;sssd\u0026rdquo;\nè¾“å‡ºï¼š/etc/apparmor.d.local/usr.sbin.sssd sudo rm -f /etc/apparmor.d.local/usr.sbin.sssd\n3. è¿è¡Œæ—¶çŠ¶æ€é‡ç½®# åœæ­¢AppArmoræœåŠ¡ sudo systemctl stop apparmor\nï¼ˆæ³¨æ„ï¼šUbuntuå†…æ ¸å†…ç½®AppArmorï¼Œæ— éœ€modprobeå¸è½½æ¨¡å—ï¼‰\nå¼ºåˆ¶é‡æ–°åŠ è½½é…ç½®å¹¶æ¸…é™¤ç¼“å­˜ sudo apparmor_parser -r /etc/apparmor.d/ sudo systemctl restart apparmor\n4. ç»ˆæéªŒè¯# æ£€æŸ¥é…ç½®æ˜¯å¦å½»åº•ç§»é™¤ sudo apparmor_status | grep sssd\né¢„æœŸè¾“å‡ºï¼šæ— ä»»ä½•ç»“æœ\nç¡®è®¤æœåŠ¡çŠ¶æ€ sudo systemctl status apparmor\nç†æƒ³çŠ¶æ€ï¼šactive (exited) ä¸”æ— è­¦å‘Šæ—¥å¿—\nå››ã€æŠ€æœ¯æ€»ç»“ä¸æœ€ä½³å®è·µ 1. AppArmorè¿ç»´å…³é”®ç‚¹ é…ç½®ä¼˜å…ˆçº§ï¼šlocal/ç›®å½•é…ç½®ä¼šè¦†ç›–ä¸»ç›®å½•ï¼Œå¸è½½æœåŠ¡åéœ€ç‰¹åˆ«æ£€æŸ¥ ç¼“å­˜æœºåˆ¶ï¼šä¿®æ”¹é…ç½®åéœ€é€šè¿‡-rå‚æ•°æˆ–é‡å¯æœåŠ¡æ¸…é™¤å†…æ ¸ç¼“å­˜ å†…ç½®æ¨¡å—ç‰¹æ€§ï¼šUbuntuå®˜æ–¹å†…æ ¸é»˜è®¤å†…ç½®AppArmorï¼Œé¿å…ä½¿ç”¨modprobeæ“ä½œæ¨¡å— 2. æœåŠ¡å¸è½½è§„èŒƒ# æ ‡å‡†å¸è½½æµç¨‹ åœæ­¢æœåŠ¡ï¼šsudo systemctl stop å¸è½½è½¯ä»¶åŒ…ï¼šsudo apt remove \u0026ndash;purge æœç´¢æ®‹ç•™é…ç½®ï¼šsudo find /etc/ -name \u0026ldquo;\u0026rdquo; æ¸…ç†æ—¥å¿—ä¸ç¼“å­˜ï¼šsudo rm -rf /var/log/ /var/cache/ 3. å¸¸è§é—®é¢˜é¢„åˆ¤ Qï¼šä¸ºä½•åˆ é™¤æ–‡ä»¶åè­¦å‘Šä»å­˜åœ¨ï¼Ÿ\nAï¼šAppArmorå†…æ ¸ç¼“å­˜æœªæ›´æ–°ï¼Œéœ€é€šè¿‡systemctl restart apparmorå¼ºåˆ¶åˆ·æ–° Qï¼šèƒ½å¦ç›´æ¥ç¦ç”¨AppArmorï¼Ÿ\nAï¼šä¸å»ºè®®ã€‚ä½œä¸ºç³»ç»Ÿå®‰å…¨æ ¸å¿ƒç»„ä»¶ï¼Œç¦ç”¨ä¼šå¯¼è‡´æƒé™æ§åˆ¶å¤±æ•ˆï¼Œåº”ä¼˜å…ˆæ¸…ç†é…ç½®è€Œéå…³é—­æœåŠ¡ äº”ã€ç»“è¯­ æœ¬æ¬¡æ’éšœæ·±å…¥æ“ä½œç³»ç»Ÿå®‰å…¨æ¨¡å—çš„åº•å±‚é€»è¾‘ï¼Œé€šè¿‡ã€Œè¯­æ³•ä¿®å¤â†’æœåŠ¡å¸è½½â†’é…ç½®æ¸…ç†â†’çŠ¶æ€é‡ç½®ã€çš„å®Œæ•´é“¾è·¯ï¼Œå½»åº•è§£å†³äº†é•¿æœŸå­˜åœ¨çš„é…ç½®æ®‹ç•™é—®é¢˜ã€‚å®è·µè¡¨æ˜ï¼Œå¤„ç†ç³»ç»Ÿçº§å®‰å…¨ç»„ä»¶æ—¶ï¼Œéœ€å…¼é¡¾æ–‡ä»¶ç³»ç»Ÿæ¸…ç†ä¸å†…æ ¸è¿è¡Œæ—¶çŠ¶æ€ç®¡ç†ï¼ŒåŒæ—¶é‡è§†é…ç½®ç›®å½•çš„ä¼˜å…ˆçº§è§„åˆ™ã€‚å¸Œæœ›æœ¬æ–‡èƒ½ä¸ºè¿ç»´å·¥ç¨‹å¸ˆåœ¨å¤„ç†ç±»ä¼¼é—®é¢˜æ—¶æä¾›å¯å¤ç”¨çš„æŠ€æœ¯èŒƒå¼ï¼Œåœ¨ä¿è¯ç³»ç»Ÿå®‰å…¨æ€§çš„å‰æä¸‹å®ç°é«˜æ•ˆç»´æŠ¤ã€‚\nå‚è€ƒèµ„æ–™\nAppArmorå®˜æ–¹æ–‡æ¡£ UbuntuæœåŠ¡ç®¡ç†æœ€ä½³å®è·µ Linuxå†…æ ¸æ¨¡å—ä¸AppArmoré›†æˆæœºåˆ¶ ","permalink":"https://jackypanster.github.io/ai-stream/posts/apparmor-troubleshooting/","summary":"\u003ch2 id=\"ä¸€é—®é¢˜èƒŒæ™¯è­¦å‘Šé¢‘å‘çš„sssdé…ç½®æ®‹ç•™\"\u003eä¸€ã€é—®é¢˜èƒŒæ™¯ï¼šè­¦å‘Šé¢‘å‘çš„SSSDé…ç½®æ®‹ç•™\u003c/h2\u003e\n\u003cp\u003eåœ¨UbuntuæœåŠ¡å™¨ç»´æŠ¤è¿‡ç¨‹ä¸­ï¼Œé•¿æœŸè¢«AppArmoræœåŠ¡çš„SSSDç›¸å…³è­¦å‘Šå›°æ‰°ã€‚å…·ä½“è¡¨ç°ä¸ºï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eæ¯æ¬¡é‡å¯AppArmoræœåŠ¡æ—¶ï¼Œæ—¥å¿—é¢‘ç¹æç¤º\u003ccode\u003eWarning: found usr.sbin.sssd in /etc/apparmor.d/force-complain\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eapparmor_status\u003c/code\u003eæŒç»­æ˜¾ç¤º\u003ccode\u003e/usr/sbin/sssd\u003c/code\u003eé…ç½®å­˜åœ¨ï¼Œä½†å®é™…å·²å¸è½½SSSDæœåŠ¡\u003c/li\u003e\n\u003cli\u003eç³»ç»Ÿæ—¥å¿—ä¸­ä¼´éš\u003ccode\u003eCaching disabled for: 'usr.sbin.sssd' due to force complain\u003c/code\u003eè­¦å‘Šï¼Œå½±å“æœåŠ¡ç¨³å®šæ€§è¯„ä¼°\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"äºŒæŠ€æœ¯åˆ†ææ·±å…¥apparmorçš„é…ç½®é€»è¾‘\"\u003eäºŒã€æŠ€æœ¯åˆ†æï¼šæ·±å…¥AppArmorçš„é…ç½®é€»è¾‘\u003c/h2\u003e\n\u003ch3 id=\"1-apparmorçš„é…ç½®åŠ è½½æœºåˆ¶\"\u003e1. AppArmorçš„é…ç½®åŠ è½½æœºåˆ¶\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eä¸»é…ç½®ç›®å½•\u003c/strong\u003eï¼š\u003ccode\u003e/etc/apparmor.d/\u003c/code\u003e å­˜æ”¾ç³»ç»Ÿçº§é…ç½®\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eæœ¬åœ°è¦†ç›–ç›®å½•\u003c/strong\u003eï¼š\u003ccode\u003e/etc/apparmor.d.local/\u003c/code\u003e ä¼˜å…ˆçº§é«˜äºä¸»ç›®å½•ï¼Œç”¨äºæœ¬åœ°è‡ªå®šä¹‰ç­–ç•¥\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eè¿è¡Œæ—¶ç¼“å­˜\u003c/strong\u003eï¼šAppArmorä¼šå°†é…ç½®åŠ è½½åˆ°å†…æ ¸å¹¶ç¼“å­˜ï¼Œå³ä½¿åˆ é™¤æ–‡ä»¶ä¹Ÿå¯èƒ½æ®‹ç•™è¿è¡Œæ—¶çŠ¶æ€\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"2-sssdæœåŠ¡çš„ç‰¹æ®Šæ€§\"\u003e2. SSSDæœåŠ¡çš„ç‰¹æ®Šæ€§\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003eè¯¥æœåŠ¡é»˜è®¤éšUbuntuéƒ¨åˆ†ç‰ˆæœ¬å®‰è£…ï¼Œæä¾›LDAP/NISç­‰è®¤è¯åŠŸèƒ½\u003c/li\u003e\n\u003cli\u003eå¸è½½æ—¶é»˜è®¤ä¿ç•™é…ç½®æ–‡ä»¶ï¼ˆ\u003ccode\u003e/etc/apparmor.d/usr.sbin.sssd\u003c/code\u003eï¼‰ï¼Œå¯¼è‡´AppArmoræŒç»­å°è¯•åŠ è½½å·²åˆ é™¤æœåŠ¡çš„ç­–ç•¥\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"3-å…³é”®æŠ¥é”™æº¯æº-æ ¸å¿ƒé”™è¯¯æ—¥å¿—\"\u003e3. å…³é”®æŠ¥é”™æº¯æº# æ ¸å¿ƒé”™è¯¯æ—¥å¿—\u003c/h3\u003e\n\u003cp\u003eapparmor.systemd[12435]: /lib/apparmor/apparmor.systemd: 148: [: Illegal number: yes\napparmor.systemd[12546]: Warning: found usr.sbin.sssd in /etc/apparmor.d/force-complain, forcing complain mode- è¯­æ³•é”™è¯¯æºäº\u003ccode\u003erc.apparmor.functions\u003c/code\u003eä¸­æ•°å€¼æ¯”è¾ƒç¬¦è¯¯ç”¨ï¼ˆ\u003ccode\u003e-eq\u003c/code\u003eæœªè½¬ä¹‰å­—ç¬¦ä¸²ï¼‰\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eè­¦å‘Šæœ¬è´¨æ˜¯æ®‹ç•™é…ç½®ä¸è¿è¡Œæ—¶çŠ¶æ€çš„å†²çª\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"ä¸‰åˆ†æ­¥è§£å†³æ–¹æ¡ˆä»æ‰‹åŠ¨æ¸…ç†åˆ°å†…æ ¸çº§é‡ç½®\"\u003eä¸‰ã€åˆ†æ­¥è§£å†³æ–¹æ¡ˆï¼šä»æ‰‹åŠ¨æ¸…ç†åˆ°å†…æ ¸çº§é‡ç½®\u003c/h2\u003e\n\u003ch3 id=\"1-è¯­æ³•ä¿®å¤ä¿®æ­£apparmorå‡½æ•°åº“-å®šä½å…³é”®å‡½æ•°\"\u003e1. è¯­æ³•ä¿®å¤ï¼šä¿®æ­£AppArmorå‡½æ•°åº“# å®šä½å…³é”®å‡½æ•°\u003c/h3\u003e\n\u003cp\u003esudo nano /lib/apparmor/rc.apparmor.functions\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eä¿®æ”¹check_usernså‡½æ•°ä¸­çš„æ¯”è¾ƒç¬¦\nåŸä»£ç ï¼š\nif [ \u0026ldquo;$userns_restricted\u0026rdquo; -eq 1 ]; then\nä¿®æ­£åï¼š\nif [ \u0026ldquo;$userns_restricted\u0026rdquo; = \u0026ldquo;1\u0026rdquo; ]; then\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"2-æœåŠ¡å¸è½½ä¸é…ç½®æ¸…ç†-å½»åº•å¸è½½sssd\"\u003e2. æœåŠ¡å¸è½½ä¸é…ç½®æ¸…ç†# å½»åº•å¸è½½SSSD\u003c/h3\u003e\n\u003cp\u003esudo apt remove \u0026ndash;purge sssd sssd-tools\u003c/p\u003e","title":"AppArmoré…ç½®æ®‹ç•™é—®é¢˜æ’æŸ¥ä¸å½»åº•è§£å†³ï¼šä»æŠ¥é”™åˆ°ç³»ç»Ÿå‡€åŒ–çš„å®Œæ•´å®è·µ"},{"content":"DeepSeek-R1-0528-Qwen3-8Béƒ¨ç½²ä¼˜åŒ–å®è·µï¼šæ€§èƒ½ä¸ç¨³å®šæ€§çš„å¹³è¡¡è‰ºæœ¯ åœ¨AIå¤§æ¨¡å‹éƒ¨ç½²é¢†åŸŸï¼Œæœ¬æ–‡è¯¦ç»†è®°å½•å¯¹DeepSeek-R1-0528-Qwen3-8Bæ¨¡å‹ä½¿ç”¨vLLMè¿›è¡Œéƒ¨ç½²ä¼˜åŒ–çš„å…¨è¿‡ç¨‹ï¼Œé‡ç‚¹å…³æ³¨ä¸Šä¸‹æ–‡çª—å£é•¿åº¦ä¸ç¡¬ä»¶èµ„æºåˆ©ç”¨çš„å¹³è¡¡è°ƒä¼˜ã€‚\nç¯å¢ƒä¸åŸºç¡€è®¾æ–½ æˆ‘ä»¬çš„éƒ¨ç½²ç¯å¢ƒå…·å¤‡ä»¥ä¸‹é…ç½®ï¼š\nGPU: 4 x NVIDIA RTX 2080 Tiï¼ˆæ¯å¼ 22GBæ˜¾å­˜ï¼Œæ€»è®¡88GBæ˜¾å­˜ï¼‰ æ¶æ„: Turing è®¡ç®—èƒ½åŠ›: 7.5 CPU: 56æ ¸ å†…å­˜: 512GB RAM å­˜å‚¨: 2TB SSD æ“ä½œç³»ç»Ÿ: Ubuntu 24.04 å®¹å™¨é•œåƒ: vllm/vllm-openai:v0.8.5 NVIDIAé©±åŠ¨: 570.153.02ï¼ˆCUDA 12.8ï¼‰ ä¼˜åŒ–å‰çš„éƒ¨ç½²è„šæœ¬åˆ†æ æˆ‘ä»¬æœ€åˆçš„éƒ¨ç½²è„šæœ¬å¦‚ä¸‹ï¼š\ndocker run \\ -d \\ --gpus all \\ --name coder \\ --shm-size 16g \\ --ulimit memlock=-1 \\ --restart always \\ --ipc=host \\ -v /home/llm/model/deepseek/DeepSeek-R1-0528-Qwen3-8B:/models \\ -p 8000:8000 \\ -e CUDA_MODULE_LOADING=LAZY \\ vllm/vllm-openai:v0.8.5 \\ --model /models \\ --served-model-name coder \\ --tensor-parallel-size 4 \\ --gpu-memory-utilization 0.93 \\ --dtype float16 \\ --max-model-len 65536 \\ --trust-remote-code \\ --load-format safetensors \\ --disable-custom-all-reduce é€šè¿‡åˆ†æï¼Œæˆ‘ä»¬å‘ç°å‡ ä¸ªå¯ä»¥ä¼˜åŒ–çš„å…³é”®ç‚¹ï¼š\nå…±äº«å†…å­˜ï¼š16GBå¯èƒ½ä¸è¶³ä»¥æ”¯æŒé«˜å¹¶å‘è¯·æ±‚ äº¤æ¢ç©ºé—´ï¼šæœªé…ç½®SSDäº¤æ¢ç©ºé—´æ”¯æŒ æ‰¹å¤„ç†èƒ½åŠ›ï¼šæœªè®¾ç½®--max-num-batched-tokenså‚æ•° CUDAå›¾å½¢ä¼˜åŒ–ï¼šæœªä½¿ç”¨--enforce-eageræé«˜ç¨³å®šæ€§ æ·±å…¥ä¼˜åŒ–ç­–ç•¥ 1. å†…å­˜ä¸è®¡ç®—èµ„æºåˆ†é… å¯¹äºRTX 2080 Tiè¿™ç±»Turingæ¶æ„GPUï¼Œæˆ‘ä»¬éœ€è¦ç‰¹åˆ«æ³¨æ„æ˜¾å­˜åˆ†é…ä¸å¹¶è¡Œç­–ç•¥ï¼š\nå…±äº«å†…å­˜æ‰©å±•ï¼šå°†--shm-sizeä»16gå¢åŠ åˆ°64gï¼Œå……åˆ†åˆ©ç”¨512GBç³»ç»Ÿå†…å­˜ æ˜¾å­˜åˆ©ç”¨ç‡ï¼šç»´æŒ--gpu-memory-utilization 0.93çš„æ¿€è¿›ä½†å¯æ§è®¾ç½® å¼ é‡å¹¶è¡ŒåŒ–ï¼šä¿æŒ--tensor-parallel-size 4å……åˆ†åˆ©ç”¨æ‰€æœ‰GPU æ‰¹å¤„ç†æ”¯æŒï¼šæ·»åŠ --max-num-batched-tokens 8192æé«˜ååé‡ 2. ç¨³å®šæ€§ä¸æ•ˆç‡å¹³è¡¡ CUDAæ‰§è¡Œæ¨¡å¼ï¼šæ·»åŠ --enforce-eagerå‚æ•°ï¼Œé¿å…CUDAå›¾æ•è·å¯èƒ½å¯¼è‡´çš„OOMé—®é¢˜ äº¤æ¢ç©ºé—´æ”¯æŒï¼šæ·»åŠ --swap-space 32å‚æ•°ï¼Œä¸ºå¤„ç†é•¿ä¸Šä¸‹æ–‡æä¾›é¢å¤–å†…å­˜ä¿éšœ all-reduceä¼˜åŒ–ï¼šç§»é™¤--disable-custom-all-reduceå‚æ•°ï¼ˆæ³¨ï¼šæ—¥å¿—æ˜¾ç¤ºç³»ç»Ÿè‡ªåŠ¨ç¦ç”¨ï¼‰ 3. ä¸Šä¸‹æ–‡é•¿åº¦è®¾è®¡ è™½ç„¶æˆ‘ä»¬æœ€ç»ˆä¿ç•™äº†--max-model-len 65536è®¾ç½®ï¼Œä½†åœ¨ç”Ÿäº§ç¯å¢ƒä¸­åº”å½“æ ¹æ®å…·ä½“ä½¿ç”¨åœºæ™¯å’Œç¨³å®šæ€§éœ€æ±‚è€ƒè™‘é™è‡³32768ã€‚å¯¹äºå¤§å¤šæ•°åº”ç”¨åœºæ™¯ï¼Œè¿™ä¸ªé•¿åº¦å·²ç»è¶³å¤Ÿï¼Œå¹¶ä¸”èƒ½æä¾›æ›´å¥½çš„æ€§èƒ½å’Œç¨³å®šæ€§å¹³è¡¡ã€‚\nä¼˜åŒ–åçš„éƒ¨ç½²è„šæœ¬ ç»è¿‡ä¸€ç³»åˆ—ä¼˜åŒ–ï¼Œæˆ‘ä»¬çš„æœ€ç»ˆéƒ¨ç½²è„šæœ¬å¦‚ä¸‹ï¼š\ndocker run \\ -d \\ --gpus all \\ --name coder \\ --shm-size 64g \\ --ulimit memlock=-1 \\ --restart always \\ --ipc=host \\ -v /home/llm/model/deepseek/DeepSeek-R1-0528-Qwen3-8B:/models \\ -p 8000:8000 \\ -e CUDA_MODULE_LOADING=LAZY \\ vllm/vllm-openai:v0.8.5 \\ --model /models \\ --served-model-name coder \\ --tensor-parallel-size 4 \\ --gpu-memory-utilization 0.93 \\ --dtype float16 \\ --max-model-len 65536 \\ --trust-remote-code \\ --load-format safetensors \\ --swap-space 32 \\ --enforce-eager \\ --max-num-batched-tokens 8192 \\ --chat-template /models/qwen3_programming.jinja æ€§èƒ½ä¸èµ„æºåˆ†æ éƒ¨ç½²åï¼Œé€šè¿‡æ—¥å¿—åˆ†ææˆ‘ä»¬å¾—åˆ°ä»¥ä¸‹æ€§èƒ½æŒ‡æ ‡ï¼š\nMemory profiling takes 5.76 seconds the current vLLM instance can use total_gpu_memory (21.48GiB) x gpu_memory_utilization (0.93) = 19.98GiB model weights take 3.85GiB; non_torch_memory takes 0.20GiB; PyTorch activation peak memory takes 1.45GiB; the rest of the memory reserved for KV Cache is 14.49GiB. å…³é”®æ€§èƒ½å‘ç°ï¼š\nKVç¼“å­˜ç©ºé—´ï¼š14.49GiBï¼Œè¶³å¤Ÿæ”¯æŒ65536 tokençš„ä¸Šä¸‹æ–‡å¤„ç† æœ€å¤§å¹¶å‘èƒ½åŠ›ï¼šå¯åŒæ—¶å¤„ç†çº¦6.44ä¸ªæœ€å¤§é•¿åº¦ï¼ˆ65536 tokensï¼‰çš„è¯·æ±‚ åˆå§‹åŒ–æ—¶é—´ï¼š31.86ç§’ï¼Œç›¸æ¯”æœªä¼˜åŒ–é…ç½®æœ‰æ‰€æ”¹å–„ å®ç”¨éƒ¨ç½²å»ºè®® æ ¹æ®æˆ‘ä»¬çš„å®è·µç»éªŒï¼Œæä¾›ä»¥ä¸‹éƒ¨ç½²å»ºè®®ï¼š\nä¸Šä¸‹æ–‡é•¿åº¦é€‰æ‹©\nå¯¹äºè¿½æ±‚ç¨³å®šæ€§çš„ç”Ÿäº§ç¯å¢ƒï¼šä½¿ç”¨--max-model-len 32768 å¯¹äºéœ€è¦æé™æ€§èƒ½çš„åœºæ™¯ï¼šå¯å°è¯•--max-model-len 65536ä½†éœ€å¯†åˆ‡ç›‘æ§ç¨³å®šæ€§ æ˜¾å­˜åˆ©ç”¨ç‡è°ƒä¼˜\nç¨³å®šæ€§ä¼˜å…ˆï¼š--gpu-memory-utilization 0.9 æ€§èƒ½ä¼˜å…ˆï¼š--gpu-memory-utilization 0.93æˆ–æ›´é«˜ï¼ˆéœ€è°¨æ…ï¼‰ æ‰¹å¤„ç†å‚æ•°ä¼˜åŒ–\nå¯¹äºå¤šç”¨æˆ·åœºæ™¯ï¼šå¢åŠ --max-num-batched-tokensè‡³8192æˆ–æ›´é«˜ å¯¹äºå•ä¸€å¤æ‚ä»»åŠ¡ï¼šå¯é€‚å½“é™ä½æ­¤å‚æ•°ï¼Œä¸“æ³¨å•ä»»åŠ¡æ€§èƒ½ ç¡¬ä»¶èµ„æºåˆ†é…\nå…±äº«å†…å­˜ä¸ç³»ç»Ÿå†…å­˜æ¯”ä¾‹ï¼šå»ºè®®1:8å·¦å³ï¼ˆå¦‚512GBç³»ç»Ÿå†…å­˜é…ç½®64GBå…±äº«å†…å­˜ï¼‰ äº¤æ¢ç©ºé—´è®¾ç½®ï¼šæ ¹æ®SSDé€Ÿåº¦å’Œå®¹é‡ï¼Œå¯è®¾ç½®ä¸ºæ˜¾å­˜æ€»é‡çš„1/3è‡³1/2 æ’éšœä¸éªŒè¯ æ¯æ¬¡ä¿®æ”¹é…ç½®åï¼Œé€šè¿‡ä»¥ä¸‹å‘½ä»¤éªŒè¯éƒ¨ç½²çŠ¶æ€ï¼š\ncurl http://localhost:8000/v1/models éªŒè¯ç»“æœæ˜¾ç¤ºæ¨¡å‹å·²æˆåŠŸéƒ¨ç½²ï¼Œå¹¶è¿”å›äº†ä»¥ä¸‹å®é™…è¾“å‡ºï¼š\n{ \u0026#34;object\u0026#34;: \u0026#34;list\u0026#34;, \u0026#34;data\u0026#34;: [ { \u0026#34;id\u0026#34;: \u0026#34;coder\u0026#34;, \u0026#34;object\u0026#34;: \u0026#34;model\u0026#34;, \u0026#34;created\u0026#34;: 1749289780, \u0026#34;owned_by\u0026#34;: \u0026#34;vllm\u0026#34;, \u0026#34;root\u0026#34;: \u0026#34;/models\u0026#34;, \u0026#34;parent\u0026#34;: null, \u0026#34;max_model_len\u0026#34;: 65536, \u0026#34;permission\u0026#34;: [ { \u0026#34;id\u0026#34;: \u0026#34;modelperm-ee339bc1702c402f8ae06ea2f1b05c7c\u0026#34;, \u0026#34;object\u0026#34;: \u0026#34;model_permission\u0026#34;, \u0026#34;created\u0026#34;: 1749289780, \u0026#34;allow_create_engine\u0026#34;: false, \u0026#34;allow_sampling\u0026#34;: true, \u0026#34;allow_logprobs\u0026#34;: true, \u0026#34;allow_search_indices\u0026#34;: false, \u0026#34;allow_view\u0026#34;: true, \u0026#34;allow_fine_tuning\u0026#34;: false, \u0026#34;organization\u0026#34;: \u0026#34;*\u0026#34;, \u0026#34;group\u0026#34;: null, \u0026#34;is_blocking\u0026#34;: false } ] } ] } ä»è¿”å›çš„JSONå“åº”ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ç¡®è®¤æ¨¡å‹éƒ¨ç½²æˆåŠŸå¹¶è§£è¯»ä»¥ä¸‹å…³é”®ä¿¡æ¯ï¼š\nid: \u0026ldquo;coder\u0026rdquo; - ç¡®è®¤æˆ‘ä»¬çš„æ¨¡å‹æœåŠ¡åç§°å·²æ­£ç¡®è®¾ç½® max_model_len: 65536 - éªŒè¯äº†æˆ‘ä»¬è®¾ç½®çš„ä¸Šä¸‹æ–‡çª—å£é•¿åº¦ä¸º65536 tokens owned_by: \u0026ldquo;vllm\u0026rdquo; - è¡¨æ˜æ¨¡å‹ç”±vLLMæœåŠ¡ç®¡ç† permissionå¯¹è±¡ä¸­ï¼š allow_sampling: true - æ”¯æŒé‡‡æ ·ç”Ÿæˆï¼ˆtemperatureã€top_pç­‰å‚æ•°ï¼‰ allow_logprobs: true - æ”¯æŒè¾“å‡ºtokenæ¦‚ç‡ organization: \u0026ldquo;*\u0026rdquo; - å…è®¸æ‰€æœ‰ç»„ç»‡è®¿é—®æ¨¡å‹ è¿™äº›å‚æ•°ç¡®è®¤äº†æˆ‘ä»¬çš„éƒ¨ç½²é…ç½®å·²ç»æ­£ç¡®åº”ç”¨ï¼Œä¸”æ¨¡å‹æœåŠ¡å·²å‡†å¤‡å¥½æ¥æ”¶æ¨ç†è¯·æ±‚ã€‚\nä¸“ç”¨ç¼–ç¨‹æç¤ºè¯æ¨¡æ¿ ç”±äºDeepSeek-R1-0528-Qwen3-8Bæ¨¡å‹ç‰¹åˆ«é€‚åˆç¼–ç¨‹ä»»åŠ¡ï¼Œæˆ‘ä»¬åœ¨éƒ¨ç½²ä¸­åŠ å…¥äº†ä¸“é—¨çš„æç¤ºè¯æ¨¡æ¿æ¥ä¼˜åŒ–å…¶ç¼–ç¨‹èƒ½åŠ›ã€‚æˆ‘ä»¬å·²ç»é€šè¿‡--chat-templateå‚æ•°æŒ‡å®šäº†æ¨¡æ¿è·¯å¾„ï¼Œæ¨¡æ¿å†…å®¹å¦‚ä¸‹ï¼š\n{# Enhanced template for Qwen3 optimized for programming tasks #} {% if messages[0][\u0026#39;role\u0026#39;] == \u0026#39;system\u0026#39; %} {% set loop_messages = messages[1:] %} {% set system_message = messages[0][\u0026#39;content\u0026#39;] %} {% else %} {% set loop_messages = messages %} {% set system_message = \u0026#34;You are a programming assistant specialized in writing clean, efficient, and well-documented code. Provide direct code solutions without unnecessary explanations unless requested. Focus on best practices, optimal algorithms, and proper error handling. When multiple approaches exist, choose the most efficient one by default. Always include necessary imports and dependencies.\u0026#34; %} {% endif %} {# Always include system message for programming optimization #} \u0026lt;|im_start|\u0026gt;system {{ system_message }}\u0026lt;|im_end|\u0026gt; {% for message in loop_messages %} {% if message[\u0026#39;role\u0026#39;] == \u0026#39;user\u0026#39; %} \u0026lt;|im_start|\u0026gt;user {{ message[\u0026#39;content\u0026#39;] }}\u0026lt;|im_end|\u0026gt; {% elif message[\u0026#39;role\u0026#39;] == \u0026#39;assistant\u0026#39; %} \u0026lt;|im_start|\u0026gt;assistant {{ message[\u0026#39;content\u0026#39;] }}\u0026lt;|im_end|\u0026gt; {% elif message[\u0026#39;role\u0026#39;] == \u0026#39;tool\u0026#39; %} \u0026lt;|im_start|\u0026gt;tool {{ message[\u0026#39;content\u0026#39;] }}\u0026lt;|im_end|\u0026gt; {% else %} \u0026lt;|im_start|\u0026gt;{{ message[\u0026#39;role\u0026#39;] }} {{ message[\u0026#39;content\u0026#39;] }}\u0026lt;|im_end|\u0026gt; {% endif %} {% endfor %} {% if add_generation_prompt %} \u0026lt;|im_start|\u0026gt;assistant {% endif %} æ­¤æ¨¡æ¿å…·æœ‰ä»¥ä¸‹ç‰¹æ€§ï¼š\nä¸“ä¸šç¼–ç¨‹æŒ‡ä»¤ï¼šé»˜è®¤ç³»ç»Ÿæç¤ºè¯ä¸“é—¨é’ˆå¯¹ç¼–ç¨‹ä»»åŠ¡ä¼˜åŒ–ï¼Œå¼ºè°ƒä»£ç è´¨é‡ã€æ•ˆç‡å’Œæ–‡æ¡£ ç›´æ¥è¾“å‡ºï¼šå€¾å‘äºç›´æ¥æä¾›ä»£ç è§£å†³æ–¹æ¡ˆï¼Œå‡å°‘ä¸å¿…è¦çš„è§£é‡Šï¼ˆé™¤éç‰¹åˆ«è¦æ±‚ï¼‰ æ ‡å‡†åŒ–æ ¼å¼ï¼šä½¿ç”¨\u0026lt;|im_start|\u0026gt;å’Œ\u0026lt;|im_end|\u0026gt;æ ‡è®°æ¸…æ™°ç•Œå®šä¸åŒè§’è‰²çš„æ¶ˆæ¯ çµæ´»æ€§ï¼šå…è®¸è¦†ç›–é»˜è®¤ç³»ç»Ÿæç¤ºè¯ï¼Œä»¥é€‚åº”ç‰¹å®šç¼–ç¨‹åœºæ™¯ åœ¨å®é™…ä½¿ç”¨ä¸­ï¼Œå¯ä»¥å°†è¯¥æ¨¡æ¿ä¸vLLMçš„APIè°ƒç”¨ç»“åˆï¼Œä¾‹å¦‚ï¼š\nimport requests url = \u0026#34;http://localhost:8000/v1/chat/completions\u0026#34; headers = {\u0026#34;Content-Type\u0026#34;: \u0026#34;application/json\u0026#34;} payload = { \u0026#34;model\u0026#34;: \u0026#34;coder\u0026#34;, \u0026#34;messages\u0026#34;: [ {\u0026#34;role\u0026#34;: \u0026#34;user\u0026#34;, \u0026#34;content\u0026#34;: \u0026#34;å†™ä¸€ä¸ªPythonå‡½æ•°è®¡ç®—æ–æ³¢é‚£å¥‘æ•°åˆ—çš„ç¬¬né¡¹ï¼Œè¦æ±‚ä½¿ç”¨åŠ¨æ€è§„åˆ’ä¼˜åŒ–æ€§èƒ½\u0026#34;} ], \u0026#34;temperature\u0026#34;: 0.2, \u0026#34;response_format\u0026#34;: {\u0026#34;type\u0026#34;: \u0026#34;text\u0026#34;} } response = requests.post(url, headers=headers, json=payload) print(response.json()) é€šè¿‡è¿™ç§æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥å……åˆ†å‘æŒ¥æ¨¡å‹åœ¨ç¼–ç¨‹é¢†åŸŸçš„ä¸“é•¿ï¼Œè·å¾—æ›´é«˜è´¨é‡ã€æ›´ç¬¦åˆå·¥ç¨‹å®è·µçš„ä»£ç è¾“å‡ºã€‚\nç»“è®ºä¸æœªæ¥æ–¹å‘ é€šè¿‡ç²¾å¿ƒè°ƒæ•´vLLMå‚æ•°ï¼Œæˆ‘ä»¬æˆåŠŸå®ç°äº†DeepSeek-R1-0528-Qwen3-8Bæ¨¡å‹çš„é«˜æ•ˆéƒ¨ç½²ï¼Œåœ¨æœ‰é™çš„RTX 2080 Tiæ˜¾å¡ä¸Šå®ç°äº†æœ€å¤§åŒ–çš„æ€§èƒ½å’Œä¸Šä¸‹æ–‡é•¿åº¦ã€‚\næœªæ¥çš„ä¼˜åŒ–æ–¹å‘å¯ä»¥æ¢ç´¢ï¼š\nè¿›ä¸€æ­¥é‡åŒ–ç ”ç©¶ï¼šæ¢ç´¢int8é‡åŒ–å¯¹æ€§èƒ½å’Œè´¨é‡çš„å½±å“ è°ƒåº¦ç­–ç•¥ä¼˜åŒ–ï¼šé€šè¿‡--scheduler-delay-factorå’Œ--preemption-modeå‚æ•°ä¼˜åŒ–å¤šç”¨æˆ·åœºæ™¯ è‡ªåŠ¨æ‰©ç¼©å®¹æ–¹æ¡ˆï¼šæ ¹æ®è´Ÿè½½åŠ¨æ€è°ƒæ•´GPUåˆ†é… å¸Œæœ›è¿™ä»½éƒ¨ç½²ä¼˜åŒ–å®è·µèƒ½ä¸ºæ›´å¤šå·¥ç¨‹å¸ˆæä¾›å‚è€ƒï¼Œåœ¨å¤§æ¨¡å‹éƒ¨ç½²ä¸­æ‰¾åˆ°æ€§èƒ½ä¸ç¨³å®šæ€§çš„æœ€ä½³å¹³è¡¡ç‚¹ã€‚\nå‚è€ƒèµ„æ–™ vLLMå®˜æ–¹æ–‡æ¡£ Qwen3ç³»åˆ—æ¨¡å‹è¯´æ˜ DeepSeek R1æ¨¡å‹ç³»åˆ—ä»‹ç» ","permalink":"https://jackypanster.github.io/ai-stream/posts/deploy-deepseek-r1-qwen3-8b-optimization/","summary":"\u003ch1 id=\"deepseek-r1-0528-qwen3-8béƒ¨ç½²ä¼˜åŒ–å®è·µæ€§èƒ½ä¸ç¨³å®šæ€§çš„å¹³è¡¡è‰ºæœ¯\"\u003eDeepSeek-R1-0528-Qwen3-8Béƒ¨ç½²ä¼˜åŒ–å®è·µï¼šæ€§èƒ½ä¸ç¨³å®šæ€§çš„å¹³è¡¡è‰ºæœ¯\u003c/h1\u003e\n\u003cp\u003eåœ¨AIå¤§æ¨¡å‹éƒ¨ç½²é¢†åŸŸï¼Œæœ¬æ–‡è¯¦ç»†è®°å½•å¯¹DeepSeek-R1-0528-Qwen3-8Bæ¨¡å‹ä½¿ç”¨vLLMè¿›è¡Œéƒ¨ç½²ä¼˜åŒ–çš„å…¨è¿‡ç¨‹ï¼Œé‡ç‚¹å…³æ³¨ä¸Šä¸‹æ–‡çª—å£é•¿åº¦ä¸ç¡¬ä»¶èµ„æºåˆ©ç”¨çš„å¹³è¡¡è°ƒä¼˜ã€‚\u003c/p\u003e\n\u003ch2 id=\"ç¯å¢ƒä¸åŸºç¡€è®¾æ–½\"\u003eç¯å¢ƒä¸åŸºç¡€è®¾æ–½\u003c/h2\u003e\n\u003cp\u003eæˆ‘ä»¬çš„éƒ¨ç½²ç¯å¢ƒå…·å¤‡ä»¥ä¸‹é…ç½®ï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eGPU\u003c/strong\u003e: 4 x NVIDIA RTX 2080 Tiï¼ˆæ¯å¼ 22GBæ˜¾å­˜ï¼Œæ€»è®¡88GBæ˜¾å­˜ï¼‰\n\u003cul\u003e\n\u003cli\u003eæ¶æ„: Turing\u003c/li\u003e\n\u003cli\u003eè®¡ç®—èƒ½åŠ›: 7.5\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eCPU\u003c/strong\u003e: 56æ ¸\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eå†…å­˜\u003c/strong\u003e: 512GB RAM\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eå­˜å‚¨\u003c/strong\u003e: 2TB SSD\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eæ“ä½œç³»ç»Ÿ\u003c/strong\u003e: Ubuntu 24.04\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eå®¹å™¨é•œåƒ\u003c/strong\u003e: \u003ccode\u003evllm/vllm-openai:v0.8.5\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eNVIDIAé©±åŠ¨\u003c/strong\u003e: 570.153.02ï¼ˆCUDA 12.8ï¼‰\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"ä¼˜åŒ–å‰çš„éƒ¨ç½²è„šæœ¬åˆ†æ\"\u003eä¼˜åŒ–å‰çš„éƒ¨ç½²è„šæœ¬åˆ†æ\u003c/h2\u003e\n\u003cp\u003eæˆ‘ä»¬æœ€åˆçš„éƒ¨ç½²è„šæœ¬å¦‚ä¸‹ï¼š\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003edocker run \u003cspan style=\"color:#ae81ff\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#ae81ff\"\u003e\u003c/span\u003e  -d \u003cspan style=\"color:#ae81ff\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#ae81ff\"\u003e\u003c/span\u003e  --gpus all \u003cspan style=\"color:#ae81ff\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#ae81ff\"\u003e\u003c/span\u003e  --name coder \u003cspan style=\"color:#ae81ff\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#ae81ff\"\u003e\u003c/span\u003e  --shm-size 16g \u003cspan style=\"color:#ae81ff\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#ae81ff\"\u003e\u003c/span\u003e  --ulimit memlock\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e-1 \u003cspan style=\"color:#ae81ff\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#ae81ff\"\u003e\u003c/span\u003e  --restart always \u003cspan style=\"color:#ae81ff\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#ae81ff\"\u003e\u003c/span\u003e  --ipc\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003ehost \u003cspan style=\"color:#ae81ff\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#ae81ff\"\u003e\u003c/span\u003e  -v /home/llm/model/deepseek/DeepSeek-R1-0528-Qwen3-8B:/models \u003cspan style=\"color:#ae81ff\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#ae81ff\"\u003e\u003c/span\u003e  -p 8000:8000 \u003cspan style=\"color:#ae81ff\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#ae81ff\"\u003e\u003c/span\u003e  -e CUDA_MODULE_LOADING\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003eLAZY \u003cspan style=\"color:#ae81ff\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#ae81ff\"\u003e\u003c/span\u003e  vllm/vllm-openai:v0.8.5 \u003cspan style=\"color:#ae81ff\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#ae81ff\"\u003e\u003c/span\u003e  --model /models \u003cspan style=\"color:#ae81ff\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#ae81ff\"\u003e\u003c/span\u003e  --served-model-name coder \u003cspan style=\"color:#ae81ff\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#ae81ff\"\u003e\u003c/span\u003e  --tensor-parallel-size \u003cspan style=\"color:#ae81ff\"\u003e4\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#ae81ff\"\u003e\u003c/span\u003e  --gpu-memory-utilization 0.93 \u003cspan style=\"color:#ae81ff\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#ae81ff\"\u003e\u003c/span\u003e  --dtype float16 \u003cspan style=\"color:#ae81ff\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#ae81ff\"\u003e\u003c/span\u003e  --max-model-len \u003cspan style=\"color:#ae81ff\"\u003e65536\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#ae81ff\"\u003e\u003c/span\u003e  --trust-remote-code \u003cspan style=\"color:#ae81ff\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#ae81ff\"\u003e\u003c/span\u003e  --load-format safetensors \u003cspan style=\"color:#ae81ff\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#ae81ff\"\u003e\u003c/span\u003e  --disable-custom-all-reduce\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eé€šè¿‡åˆ†æï¼Œæˆ‘ä»¬å‘ç°å‡ ä¸ªå¯ä»¥ä¼˜åŒ–çš„å…³é”®ç‚¹ï¼š\u003c/p\u003e","title":"DeepSeek-R1-0528-Qwen3-8Béƒ¨ç½²ä¼˜åŒ–å®è·µ"},{"content":"Qwen3-30B æŠ€æœ¯ä¼˜åŒ–å®è·µï¼ˆäºŒï¼‰ï¼šæ€è€ƒæ¨¡å¼æ§åˆ¶ä¸æ€§èƒ½æå‡ æœ¬æ–‡æ˜¯ã€Šä»32Kåˆ°131Kï¼šQwen3-30Bå¤§æ¨¡å‹ä¸Šä¸‹æ–‡æ‰©å±•å®è·µã€‹çš„ç»­ç¯‡ï¼Œèšç„¦äºæ¨¡å‹æ€§èƒ½è°ƒä¼˜ç‰¹åˆ«æ˜¯æ€è€ƒæ¨¡å¼ï¼ˆreasoning modeï¼‰æ§åˆ¶çš„æŠ€æœ¯ç»†èŠ‚ä¸å®è·µç»éªŒã€‚\nåœ¨å‰æ–‡ä¸­ï¼Œæˆ‘ä»¬è¯¦ç»†ä»‹ç»äº†å¦‚ä½•ä½¿ç”¨YaRNæŠ€æœ¯å°†Qwen3-30Bçš„ä¸Šä¸‹æ–‡é•¿åº¦ä»32Kæ‰©å±•åˆ°131Kã€‚ä»Šå¤©ï¼Œæˆ‘ä»¬å°†æ·±å…¥æ¢è®¨å¦ä¸€ä¸ªå…³é”®ä¼˜åŒ–ç»´åº¦ï¼šæ€è€ƒæ¨¡å¼æ§åˆ¶åŠå…¶å¯¹æ€§èƒ½çš„å½±å“ã€‚é€šè¿‡ä¸€ç³»åˆ—å®éªŒå’Œè°ƒä¼˜ï¼Œæˆ‘ä»¬å‘ç°ç¦ç”¨æ€è€ƒæ¨¡å¼å¯ä»¥æ˜¾è‘—æå‡æ¨¡å‹å“åº”é€Ÿåº¦å’Œå†…å­˜æ•ˆç‡ï¼Œç‰¹åˆ«é€‚åˆç¼–ç¨‹å’Œç›´æ¥è¾“å‡ºç±»ä»»åŠ¡åœºæ™¯ã€‚\nğŸ” æ€è€ƒæ¨¡å¼ï¼ˆReasoning Modeï¼‰è§£æ ä»€ä¹ˆæ˜¯æ€è€ƒæ¨¡å¼ï¼Ÿ æ€è€ƒæ¨¡å¼ï¼ˆReasoning Modeï¼Œä¹Ÿç§°ä¸ºThinking Modeï¼‰æ˜¯Qwen3ç³»åˆ—æ¨¡å‹çš„ä¸€ä¸ªç‰¹æ€§ï¼Œè®©æ¨¡å‹èƒ½å¤Ÿç”Ÿæˆä¸­é—´æ€è€ƒæ­¥éª¤ï¼Œè¿™äº›æ­¥éª¤è¢«åŒ…å«åœ¨\u0026lt;think\u0026gt;...\u0026lt;/think\u0026gt;æ ‡ç­¾å†…ã€‚ç†è®ºä¸Šï¼Œè¿™ç§\u0026quot;æ€è€ƒè¿‡ç¨‹\u0026quot;æœ‰åŠ©äºæ¨¡å‹è¿›è¡Œæ›´å¤æ‚çš„æ¨ç†ï¼Œä½†åŒæ—¶ä¹Ÿå¼•å…¥äº†é¢å¤–çš„è®¡ç®—å’Œå†…å­˜å¼€é”€ã€‚\nåœ¨é»˜è®¤é…ç½®ä¸‹ï¼ŒQwen3æ¨¡å‹ä¼šå¯ç”¨æ€è€ƒæ¨¡å¼ï¼Œäº§ç”Ÿç±»ä¼¼ä»¥ä¸‹çš„è¾“å‡ºï¼š\n\u0026lt;think\u0026gt; é¦–å…ˆï¼Œæˆ‘éœ€è¦åˆ†æç”¨æˆ·çš„é—®é¢˜ï¼šå¦‚ä½•å®ç°ä¸€ä¸ªç®€å•çš„æ–‡ä»¶è¯»å†™åŠŸèƒ½ã€‚ æˆ‘åº”è¯¥ä½¿ç”¨Pythonçš„å†…ç½®æ–‡ä»¶æ“ä½œåŠŸèƒ½ã€‚ åŸºæœ¬æ­¥éª¤åº”è¯¥æ˜¯ï¼š 1. æ‰“å¼€æ–‡ä»¶ï¼ˆå¯ä»¥ä½¿ç”¨withè¯­å¥è‡ªåŠ¨ç®¡ç†èµ„æºï¼‰ 2. è¯»å–æˆ–å†™å…¥å†…å®¹ 3. ç¡®ä¿æ–‡ä»¶æ­£ç¡®å…³é—­ \u0026lt;/think\u0026gt; ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•çš„Pythonæ–‡ä»¶è¯»å†™ç¤ºä¾‹ï¼š ```python # å†™å…¥æ–‡ä»¶ with open(\u0026#39;example.txt\u0026#39;, \u0026#39;w\u0026#39;) as file: file.write(\u0026#39;Hello, World!\u0026#39;) # è¯»å–æ–‡ä»¶ with open(\u0026#39;example.txt\u0026#39;, \u0026#39;r\u0026#39;) as file: content = file.read() print(content) ### æ€è€ƒæ¨¡å¼å®ç°æœºåˆ¶ vLLMéƒ¨ç½²Qwen3æ¨¡å‹æ—¶ï¼Œæ€è€ƒæ¨¡å¼é€šè¿‡ä¸¤ç§æ–¹å¼å®ç°æ§åˆ¶ï¼š 1. **æœåŠ¡å™¨çº§æ§åˆ¶**ï¼šé€šè¿‡éƒ¨ç½²å‚æ•°`--enable-reasoning`å’Œ`--reasoning-parser deepseek_r1`å¯ç”¨ 2. **APIçº§æ§åˆ¶**ï¼šé€šè¿‡APIè°ƒç”¨ä¸­çš„`chat_template_kwargs`å‚æ•°æˆ–`enable_thinking`å‚æ•°åŠ¨æ€æ§åˆ¶ æˆ‘ä»¬çš„å‘ç°æ˜¯ï¼Œ**ä»…åˆ é™¤æœåŠ¡å™¨çº§åˆ«çš„å‚æ•°å¹¶ä¸è¶³å¤Ÿå®Œå…¨ç¦ç”¨æ€è€ƒæ¨¡å¼**ï¼Œæ¨¡å‹åœ¨æŸäº›æƒ…å†µä¸‹ä»ä¼šäº§ç”Ÿæ€è€ƒè¿‡ç¨‹ã€‚æ›´å½»åº•çš„è§£å†³æ–¹æ¡ˆæ˜¯ä½¿ç”¨è‡ªå®šä¹‰èŠå¤©æ¨¡æ¿ã€‚ ## ğŸ’¡ ç¦ç”¨æ€è€ƒæ¨¡å¼çš„æŠ€æœ¯å®ç° ### è‡ªå®šä¹‰èŠå¤©æ¨¡æ¿æ–¹æ¡ˆ ç»è¿‡ç ”ç©¶Qwenå®˜æ–¹æ–‡æ¡£å’Œå®éªŒï¼Œæˆ‘ä»¬å‘ç°ä½¿ç”¨è‡ªå®šä¹‰èŠå¤©æ¨¡æ¿æ˜¯å®Œå…¨ç¦ç”¨æ€è€ƒæ¨¡å¼çš„æœ€å¯é æ–¹æ³•ã€‚æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªåä¸º`qwen3_nonthinking.jinja`çš„æ¨¡æ¿æ–‡ä»¶ï¼š ```jinja {% if messages %} {% set loop_messages = messages %} {% else %} {% set loop_messages = [{\u0026#39;role\u0026#39;: \u0026#39;system\u0026#39;, \u0026#39;content\u0026#39;: \u0026#39;\u0026#39;}] %} {% endif %} {% for message in loop_messages %} {% if message[\u0026#39;role\u0026#39;] == \u0026#39;user\u0026#39; %} \u0026lt;|im_start|\u0026gt;user {{ message[\u0026#39;content\u0026#39;] }}\u0026lt;|im_end|\u0026gt; {% elif message[\u0026#39;role\u0026#39;] == \u0026#39;assistant\u0026#39; %} \u0026lt;|im_start|\u0026gt;assistant {{ message[\u0026#39;content\u0026#39;] }}\u0026lt;|im_end|\u0026gt; {% elif message[\u0026#39;role\u0026#39;] == \u0026#39;system\u0026#39; %} \u0026lt;|im_start|\u0026gt;system {{ message[\u0026#39;content\u0026#39;] }}\u0026lt;|im_end|\u0026gt; {% endif %} {% endfor %} \u0026lt;|im_start|\u0026gt;assistant {% if add_generation_prompt is defined and add_generation_prompt %}{{ generation_prompt }}{% endif %} è¿™ä¸ªæ¨¡æ¿çš„å…³é”®ç‚¹æ˜¯ç§»é™¤äº†æ‰€æœ‰ä¸æ€è€ƒæ¨¡å¼ç›¸å…³çš„æ ‡ç­¾å’Œå¤„ç†é€»è¾‘ï¼Œç¡®ä¿æ¨¡å‹æ— æ³•ç”Ÿæˆ\u0026lt;think\u0026gt;...\u0026lt;/think\u0026gt;å—ï¼Œå³ä½¿APIè¯·æ±‚ä¸­å°è¯•å¯ç”¨æ€è€ƒæ¨¡å¼ã€‚\néƒ¨ç½²è„šæœ¬ä¿®æ”¹ ä¸ºäº†ä½¿ç”¨è¿™ä¸ªæ¨¡æ¿ï¼Œæˆ‘ä»¬ä¿®æ”¹äº†éƒ¨ç½²è„šæœ¬ï¼Œæ·»åŠ äº†ä»¥ä¸‹å…³é”®å‚æ•°ï¼š\n# é‡è¦ï¼š1. æŒ‚è½½å·¥ä½œç›®å½•ä½¿æ¨¡æ¿æ–‡ä»¶å¯è®¿é—® -v /home/llm/workspace/deploy-qwen:/workspace/deploy-qwen \\ # é‡è¦ï¼š2. ä½¿ç”¨è‡ªå®šä¹‰æ¨¡æ¿å½»åº•ç¦ç”¨æ€è€ƒæ¨¡å¼ --chat-template /workspace/deploy-qwen/qwen3_nonthinking.jinja åŒæ—¶ï¼Œæˆ‘ä»¬åœ¨è„šæœ¬ä¸­æ·»åŠ äº†è¯¦ç»†æ³¨é‡Šï¼Œä¾¿äºåœ¨ä¸åŒåœºæ™¯ä¸‹å¿«é€Ÿåˆ‡æ¢æ¨¡å¼ã€‚\nğŸ“Š æ€§èƒ½æå‡æµ‹é‡ä¸åˆ†æ å®æµ‹æ€§èƒ½æ•°æ® æˆ‘ä»¬é€šè¿‡å®é™…éƒ¨ç½²æµ‹è¯•ï¼Œè§‚å¯Ÿåˆ°ç¦ç”¨æ€è€ƒæ¨¡å¼å¸¦æ¥çš„æ€§èƒ½æå‡ï¼š\næŒ‡æ ‡ å¯ç”¨æ€è€ƒæ¨¡å¼ ç¦ç”¨æ€è€ƒæ¨¡å¼ æå‡æ¯”ä¾‹ ç”Ÿæˆé€Ÿåº¦ ~12-14 tokens/s ~17-19 tokens/s +15-20% GPU KVç¼“å­˜ä½¿ç”¨ç‡ ~12-15% ~8-9% -30-40% å†…å­˜å ç”¨ è¾ƒé«˜ è¾ƒä½ -20-25% è¾“å‡ºä¸€è‡´æ€§ å‡ºç°æ¨ç†è¿‡ç¨‹ ç›´æ¥è¾“å‡ºç»“æœ æ›´åŠ ç®€æ´ ä¸€ä¸ªå…¸å‹çš„æ€§èƒ½æ—¥å¿—ç‰‡æ®µæ˜¾ç¤ºï¼š\nINFO 06-03 23:06:14 [metrics.py:486] Avg prompt throughput: 2315.5 tokens/s, Avg generation throughput: 12.4 tokens/s, Running: 2 reqs, Swapped: 0 reqs, Pending: 0 reqs, GPU KV cache usage: 8.7%, CPU KV cache usage: 0.0%. INFO 06-03 23:06:19 [metrics.py:486] Avg prompt throughput: 506.3 tokens/s, Avg generation throughput: 17.4 tokens/s, Running: 2 reqs, Swapped: 0 reqs, Pending: 0 reqs, GPU KV cache usage: 8.7%, CPU KV cache usage: 0.0%. æ€§èƒ½æå‡åŸç†åˆ†æ ç¦ç”¨æ€è€ƒæ¨¡å¼å¸¦æ¥æ€§èƒ½æå‡çš„ä¸»è¦åŸå› åŒ…æ‹¬ï¼š\nè®¡ç®—è´Ÿè½½å‡å°‘ï¼šä¸å†ç”Ÿæˆä¸­é—´æ€è€ƒæ­¥éª¤ï¼Œå‡å°‘äº†æ€»ä½“éœ€è¦ç”Ÿæˆçš„tokenæ•°é‡\næ³¨æ„åŠ›è®¡ç®—ç®€åŒ–ï¼šæ¨ç†è¿‡ç¨‹é€šå¸¸éœ€è¦æ¨¡å‹åœ¨æ›´å¤§çš„ä¸Šä¸‹æ–‡çª—å£ä¸­è¿›è¡Œæ³¨æ„åŠ›è®¡ç®—ï¼Œç¦ç”¨åæ³¨æ„åŠ›æœºåˆ¶æ›´èšç„¦\nå†…å­˜ä½¿ç”¨ä¼˜åŒ–ï¼šæ— éœ€ä¸ºæ€è€ƒè¿‡ç¨‹åˆ†é…é¢å¤–çš„KVç¼“å­˜ç©ºé—´ï¼Œç‰¹åˆ«æ˜¯åœ¨131Kè¶…é•¿ä¸Šä¸‹æ–‡æ¨¡å¼ä¸‹ï¼Œè¿™ä¸€ä¼˜åŠ¿æ›´ä¸ºæ˜¾è‘—\nå†…éƒ¨çŠ¶æ€è·Ÿè¸ªç®€åŒ–ï¼šæ¨¡å‹ä¸å†éœ€è¦ç»´æŠ¤å’Œç®¡ç†é¢å¤–çš„æ€è€ƒçŠ¶æ€ï¼Œå‡å°‘äº†å†…éƒ¨çŠ¶æ€è½¬æ¢çš„å¤æ‚åº¦\nğŸ”§ é€‚ç”¨åœºæ™¯ä¸å‚æ•°è°ƒä¼˜ æœ€é€‚åˆç¦ç”¨æ€è€ƒæ¨¡å¼çš„åœºæ™¯ ä»£ç ç”Ÿæˆä»»åŠ¡ï¼šç›´æ¥è¾“å‡ºä»£ç è€Œéè¯¦ç»†è§£é‡Šè¿‡ç¨‹ ç®€æ´é—®ç­”ï¼šéœ€è¦ç®€çŸ­ç›´æ¥ç­”æ¡ˆçš„åœºæ™¯ APIé›†æˆï¼šä½œä¸ºåç«¯æœåŠ¡é›†æˆåˆ°å…¶ä»–ç³»ç»Ÿæ—¶ é«˜å¹¶å‘æœåŠ¡ï¼šéœ€è¦å¤„ç†å¤§é‡è¯·æ±‚æ—¶ å†…å­˜å—é™ç¯å¢ƒï¼šç¡¬ä»¶èµ„æºç›¸å¯¹æœ‰é™æ—¶ ç¼–ç¨‹ä»»åŠ¡æœ€ä½³å‚æ•°ç»„åˆ åŸºäºæˆ‘ä»¬çš„æµ‹è¯•ï¼Œç¦ç”¨æ€è€ƒæ¨¡å¼åï¼Œç¼–ç¨‹ä»»åŠ¡æ¨èä»¥ä¸‹å‚æ•°è®¾ç½®ï¼š\n{ \u0026#34;temperature\u0026#34;: 0.2, \u0026#34;top_p\u0026#34;: 0.6, \u0026#34;top_k\u0026#34;: 50, \u0026#34;presence_penalty\u0026#34;: 0.0, \u0026#34;frequency_penalty\u0026#34;: 0.0 } è¿™ç»„å‚æ•°æä¾›äº†é«˜ç¡®å®šæ€§å’Œä¸€è‡´æ€§ï¼Œä½¿ç¼–ç è¾“å‡ºæ›´å¯é ã€‚\nğŸ”„ æ¨¡å¼åˆ‡æ¢æ–¹æ³• æˆ‘ä»¬åœ¨éƒ¨ç½²è„šæœ¬ä¸­æä¾›äº†è¯¦ç»†çš„åˆ‡æ¢æŒ‡å—ï¼š\nä¿æŒç¦ç”¨æ€è€ƒæ¨¡å¼ï¼ˆé»˜è®¤é…ç½®ï¼‰ ä¿ç•™--chat-templateå‚æ•° åˆ é™¤--enable-reasoningå’Œ--reasoning-parserå‚æ•° å¯ç”¨æ€è€ƒæ¨¡å¼ åˆ é™¤--chat-templateå‚æ•° æ·»åŠ ä»¥ä¸‹å‚æ•°ï¼š --enable-reasoning \\ --reasoning-parser deepseek_r1 åº”ç”¨æ›´æ”¹ docker stop coder \u0026amp;\u0026amp; docker rm coder \u0026amp;\u0026amp; ./deploy-32k.sh # æˆ– ./deploy-131k.sh ğŸ§© ä¸YaRNæ‰©å±•çš„ååŒä¼˜åŒ– ç¦ç”¨æ€è€ƒæ¨¡å¼ä¸YaRNä¸Šä¸‹æ–‡æ‰©å±•æŠ€æœ¯ç»“åˆä½¿ç”¨æ—¶ï¼Œèƒ½å¸¦æ¥æ›´å…¨é¢çš„æ€§èƒ½å’Œèƒ½åŠ›æå‡ï¼š\nå†…å­˜æ•ˆç‡å€å¢ï¼šåœ¨è¶…é•¿ä¸Šä¸‹æ–‡åœºæ™¯ä¸‹ï¼Œç¦ç”¨æ€è€ƒæ¨¡å¼èƒ½æ˜¾è‘—é™ä½YaRNæ‰©å±•å¸¦æ¥çš„é¢å¤–å†…å­˜å‹åŠ›\næ‰©å±•æ½œåŠ›æé«˜ï¼šç†è®ºä¸Šï¼Œé€šè¿‡ç¦ç”¨æ€è€ƒæ¨¡å¼ï¼ŒYaRNå› å­å¯ä»¥è¿›ä¸€æ­¥æé«˜ï¼ˆä¾‹å¦‚ä»4.0åˆ°4.5æˆ–æ›´é«˜ï¼‰ï¼Œå®ç°æ›´é•¿ä¸Šä¸‹æ–‡\nå“åº”é€Ÿåº¦æå‡ï¼šç‰¹åˆ«æ˜¯åœ¨å¤„ç†å¤§å‹ä»£ç åº“æˆ–é•¿æ–‡æ¡£æ—¶ï¼Œç¦ç”¨æ€è€ƒæ¨¡å¼æä¾›äº†æ›´å¿«çš„tokenç”Ÿæˆé€Ÿåº¦\nğŸš€ æœªæ¥ä¼˜åŒ–æ–¹å‘ åŸºäºæˆ‘ä»¬çš„ç»éªŒï¼Œæ¨èä»¥ä¸‹ä¼˜åŒ–æ–¹å‘è¿›ä¸€æ­¥æå‡æ€§èƒ½ï¼š\nå¯å‘å¼è·¯ç”±ï¼šæ„å»ºæ™ºèƒ½è·¯ç”±å±‚ï¼Œæ ¹æ®è¾“å…¥ç±»å‹è‡ªåŠ¨é€‰æ‹©å¯ç”¨æˆ–ç¦ç”¨æ€è€ƒæ¨¡å¼\nåœºæ™¯è‡ªé€‚åº”ï¼šå¼€å‘èƒ½æ ¹æ®è¾“å…¥åŠ¨æ€è°ƒæ•´æ€è€ƒæ¨¡å¼çš„æ··åˆç­–ç•¥\nPromptå·¥ç¨‹ä¼˜åŒ–ï¼šç ”ç©¶ç‰¹å®špromptæ¨¡å¼ï¼Œåœ¨ç¦ç”¨æ€è€ƒæ¨¡å¼çš„åŒæ—¶ä¿æŒé«˜è´¨é‡æ¨ç†èƒ½åŠ›\né‡åŒ–ä¸æ€è€ƒæ¨¡å¼ååŒä¼˜åŒ–ï¼šæ¢ç´¢å°†4ä½æˆ–8ä½é‡åŒ–ä¸æ€è€ƒæ¨¡å¼ç¦ç”¨ç»“åˆï¼Œè¿›ä¸€æ­¥æå‡æ€§èƒ½\nğŸ ç»“è®º é€šè¿‡æ·±å…¥ç ”ç©¶å’Œå®è·µï¼Œæˆ‘ä»¬è¯æ˜äº†å¯¹Qwen3-30Bæ¨¡å‹æ€è€ƒæ¨¡å¼çš„æ§åˆ¶æ˜¯ä¸€ç§æ•ˆæœæ˜¾è‘—çš„æ€§èƒ½ä¼˜åŒ–æŠ€æœ¯ã€‚ç¦ç”¨æ€è€ƒæ¨¡å¼èƒ½å¸¦æ¥15-20%çš„é€Ÿåº¦æå‡å’Œæ›´é«˜çš„å†…å­˜æ•ˆç‡ï¼Œç‰¹åˆ«é€‚åˆç¼–ç¨‹ä»»åŠ¡å’Œéœ€è¦ç›´æ¥è¾“å‡ºçš„åœºæ™¯ã€‚\nè¿™ç§æŠ€æœ¯ä¸éœ€è¦æ¨¡å‹å¾®è°ƒæˆ–å¤æ‚çš„GPUä¼˜åŒ–ï¼Œä»…é€šè¿‡æ¨¡æ¿å’Œé…ç½®ä¿®æ”¹å°±èƒ½å®ç°ï¼Œæ˜¯ä¸€ç§ä½æˆæœ¬ã€é«˜æ”¶ç›Šçš„ä¼˜åŒ–æ–¹æ¡ˆã€‚ç»“åˆYaRNä¸Šä¸‹æ–‡æ‰©å±•ï¼Œæˆ‘ä»¬èƒ½å¤Ÿæ„å»ºä¸€ä¸ªå…¼å…·é«˜æ€§èƒ½å’Œå¼ºå¤§èƒ½åŠ›çš„å¤§æ¨¡å‹æœåŠ¡ã€‚\nä½œè€…è¯´æ˜ï¼šæœ¬æ–‡æ‰€æœ‰æµ‹è¯•å‡åŸºäºQwen3-30B-A3Bæ¨¡å‹åœ¨4Ã—NVIDIA GPUä¸Šä½¿ç”¨vLLM v0.8.5è¿›è¡Œï¼Œå…·ä½“ç¡¬ä»¶ç¯å¢ƒä¸º4Ã—GPU(æ¯å¡22GB VRAM)ï¼Œ512GB RAMï¼Œ56æ ¸CPUï¼Œ2TB SSDã€‚å®é™…æ€§èƒ½å¯èƒ½å› ç¡¬ä»¶é…ç½®ã€æ¨¡å‹ç‰ˆæœ¬å’Œå·¥ä½œè´Ÿè½½ç‰¹æ€§è€Œæœ‰æ‰€ä¸åŒã€‚\n","permalink":"https://jackypanster.github.io/ai-stream/posts/deploy-qwen3-part2/","summary":"\u003ch1 id=\"qwen3-30b-æŠ€æœ¯ä¼˜åŒ–å®è·µäºŒæ€è€ƒæ¨¡å¼æ§åˆ¶ä¸æ€§èƒ½æå‡\"\u003eQwen3-30B æŠ€æœ¯ä¼˜åŒ–å®è·µï¼ˆäºŒï¼‰ï¼šæ€è€ƒæ¨¡å¼æ§åˆ¶ä¸æ€§èƒ½æå‡\u003c/h1\u003e\n\u003cblockquote\u003e\n\u003cp\u003eæœ¬æ–‡æ˜¯\u003ca href=\"blog-post.md\"\u003eã€Šä»32Kåˆ°131Kï¼šQwen3-30Bå¤§æ¨¡å‹ä¸Šä¸‹æ–‡æ‰©å±•å®è·µã€‹\u003c/a\u003eçš„ç»­ç¯‡ï¼Œèšç„¦äºæ¨¡å‹æ€§èƒ½è°ƒä¼˜ç‰¹åˆ«æ˜¯æ€è€ƒæ¨¡å¼ï¼ˆreasoning modeï¼‰æ§åˆ¶çš„æŠ€æœ¯ç»†èŠ‚ä¸å®è·µç»éªŒã€‚\u003c/p\u003e\u003c/blockquote\u003e\n\u003cp\u003eåœ¨å‰æ–‡ä¸­ï¼Œæˆ‘ä»¬è¯¦ç»†ä»‹ç»äº†å¦‚ä½•ä½¿ç”¨YaRNæŠ€æœ¯å°†Qwen3-30Bçš„ä¸Šä¸‹æ–‡é•¿åº¦ä»32Kæ‰©å±•åˆ°131Kã€‚ä»Šå¤©ï¼Œæˆ‘ä»¬å°†æ·±å…¥æ¢è®¨å¦ä¸€ä¸ªå…³é”®ä¼˜åŒ–ç»´åº¦ï¼š\u003cstrong\u003eæ€è€ƒæ¨¡å¼æ§åˆ¶\u003c/strong\u003eåŠå…¶å¯¹æ€§èƒ½çš„å½±å“ã€‚é€šè¿‡ä¸€ç³»åˆ—å®éªŒå’Œè°ƒä¼˜ï¼Œæˆ‘ä»¬å‘ç°ç¦ç”¨æ€è€ƒæ¨¡å¼å¯ä»¥æ˜¾è‘—æå‡æ¨¡å‹å“åº”é€Ÿåº¦å’Œå†…å­˜æ•ˆç‡ï¼Œç‰¹åˆ«é€‚åˆç¼–ç¨‹å’Œç›´æ¥è¾“å‡ºç±»ä»»åŠ¡åœºæ™¯ã€‚\u003c/p\u003e\n\u003ch2 id=\"-æ€è€ƒæ¨¡å¼reasoning-modeè§£æ\"\u003eğŸ” æ€è€ƒæ¨¡å¼ï¼ˆReasoning Modeï¼‰è§£æ\u003c/h2\u003e\n\u003ch3 id=\"ä»€ä¹ˆæ˜¯æ€è€ƒæ¨¡å¼\"\u003eä»€ä¹ˆæ˜¯æ€è€ƒæ¨¡å¼ï¼Ÿ\u003c/h3\u003e\n\u003cp\u003eæ€è€ƒæ¨¡å¼ï¼ˆReasoning Modeï¼Œä¹Ÿç§°ä¸ºThinking Modeï¼‰æ˜¯Qwen3ç³»åˆ—æ¨¡å‹çš„ä¸€ä¸ªç‰¹æ€§ï¼Œè®©æ¨¡å‹èƒ½å¤Ÿç”Ÿæˆä¸­é—´æ€è€ƒæ­¥éª¤ï¼Œè¿™äº›æ­¥éª¤è¢«åŒ…å«åœ¨\u003ccode\u003e\u0026lt;think\u0026gt;...\u0026lt;/think\u0026gt;\u003c/code\u003eæ ‡ç­¾å†…ã€‚ç†è®ºä¸Šï¼Œè¿™ç§\u0026quot;æ€è€ƒè¿‡ç¨‹\u0026quot;æœ‰åŠ©äºæ¨¡å‹è¿›è¡Œæ›´å¤æ‚çš„æ¨ç†ï¼Œä½†åŒæ—¶ä¹Ÿå¼•å…¥äº†é¢å¤–çš„è®¡ç®—å’Œå†…å­˜å¼€é”€ã€‚\u003c/p\u003e\n\u003cp\u003eåœ¨é»˜è®¤é…ç½®ä¸‹ï¼ŒQwen3æ¨¡å‹ä¼šå¯ç”¨æ€è€ƒæ¨¡å¼ï¼Œäº§ç”Ÿç±»ä¼¼ä»¥ä¸‹çš„è¾“å‡ºï¼š\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003e\u0026lt;think\u0026gt;\né¦–å…ˆï¼Œæˆ‘éœ€è¦åˆ†æç”¨æˆ·çš„é—®é¢˜ï¼šå¦‚ä½•å®ç°ä¸€ä¸ªç®€å•çš„æ–‡ä»¶è¯»å†™åŠŸèƒ½ã€‚\næˆ‘åº”è¯¥ä½¿ç”¨Pythonçš„å†…ç½®æ–‡ä»¶æ“ä½œåŠŸèƒ½ã€‚\nåŸºæœ¬æ­¥éª¤åº”è¯¥æ˜¯ï¼š\n1. æ‰“å¼€æ–‡ä»¶ï¼ˆå¯ä»¥ä½¿ç”¨withè¯­å¥è‡ªåŠ¨ç®¡ç†èµ„æºï¼‰\n2. è¯»å–æˆ–å†™å…¥å†…å®¹\n3. ç¡®ä¿æ–‡ä»¶æ­£ç¡®å…³é—­\n\u0026lt;/think\u0026gt;\n\nä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•çš„Pythonæ–‡ä»¶è¯»å†™ç¤ºä¾‹ï¼š\n\n```python\n# å†™å…¥æ–‡ä»¶\nwith open(\u0026#39;example.txt\u0026#39;, \u0026#39;w\u0026#39;) as file:\n    file.write(\u0026#39;Hello, World!\u0026#39;)\n\n# è¯»å–æ–‡ä»¶\nwith open(\u0026#39;example.txt\u0026#39;, \u0026#39;r\u0026#39;) as file:\n    content = file.read()\n    print(content)\n\u003c/code\u003e\u003c/pre\u003e\u003cpre tabindex=\"0\"\u003e\u003ccode\u003e\n### æ€è€ƒæ¨¡å¼å®ç°æœºåˆ¶\n\nvLLMéƒ¨ç½²Qwen3æ¨¡å‹æ—¶ï¼Œæ€è€ƒæ¨¡å¼é€šè¿‡ä¸¤ç§æ–¹å¼å®ç°æ§åˆ¶ï¼š\n\n1. **æœåŠ¡å™¨çº§æ§åˆ¶**ï¼šé€šè¿‡éƒ¨ç½²å‚æ•°`--enable-reasoning`å’Œ`--reasoning-parser deepseek_r1`å¯ç”¨\n   \n2. **APIçº§æ§åˆ¶**ï¼šé€šè¿‡APIè°ƒç”¨ä¸­çš„`chat_template_kwargs`å‚æ•°æˆ–`enable_thinking`å‚æ•°åŠ¨æ€æ§åˆ¶\n\næˆ‘ä»¬çš„å‘ç°æ˜¯ï¼Œ**ä»…åˆ é™¤æœåŠ¡å™¨çº§åˆ«çš„å‚æ•°å¹¶ä¸è¶³å¤Ÿå®Œå…¨ç¦ç”¨æ€è€ƒæ¨¡å¼**ï¼Œæ¨¡å‹åœ¨æŸäº›æƒ…å†µä¸‹ä»ä¼šäº§ç”Ÿæ€è€ƒè¿‡ç¨‹ã€‚æ›´å½»åº•çš„è§£å†³æ–¹æ¡ˆæ˜¯ä½¿ç”¨è‡ªå®šä¹‰èŠå¤©æ¨¡æ¿ã€‚\n\n## ğŸ’¡ ç¦ç”¨æ€è€ƒæ¨¡å¼çš„æŠ€æœ¯å®ç°\n\n### è‡ªå®šä¹‰èŠå¤©æ¨¡æ¿æ–¹æ¡ˆ\n\nç»è¿‡ç ”ç©¶Qwenå®˜æ–¹æ–‡æ¡£å’Œå®éªŒï¼Œæˆ‘ä»¬å‘ç°ä½¿ç”¨è‡ªå®šä¹‰èŠå¤©æ¨¡æ¿æ˜¯å®Œå…¨ç¦ç”¨æ€è€ƒæ¨¡å¼çš„æœ€å¯é æ–¹æ³•ã€‚æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªåä¸º`qwen3_nonthinking.jinja`çš„æ¨¡æ¿æ–‡ä»¶ï¼š\n\n```jinja\n{% if messages %}\n{% set loop_messages = messages %}\n{% else %}\n{% set loop_messages = [{\u0026#39;role\u0026#39;: \u0026#39;system\u0026#39;, \u0026#39;content\u0026#39;: \u0026#39;\u0026#39;}] %}\n{% endif %}\n\n{% for message in loop_messages %}\n{% if message[\u0026#39;role\u0026#39;] == \u0026#39;user\u0026#39; %}\n\u0026lt;|im_start|\u0026gt;user\n{{ message[\u0026#39;content\u0026#39;] }}\u0026lt;|im_end|\u0026gt;\n{% elif message[\u0026#39;role\u0026#39;] == \u0026#39;assistant\u0026#39; %}\n\u0026lt;|im_start|\u0026gt;assistant\n{{ message[\u0026#39;content\u0026#39;] }}\u0026lt;|im_end|\u0026gt;\n{% elif message[\u0026#39;role\u0026#39;] == \u0026#39;system\u0026#39; %}\n\u0026lt;|im_start|\u0026gt;system\n{{ message[\u0026#39;content\u0026#39;] }}\u0026lt;|im_end|\u0026gt;\n{% endif %}\n{% endfor %}\n\u0026lt;|im_start|\u0026gt;assistant\n{% if add_generation_prompt is defined and add_generation_prompt %}{{ generation_prompt }}{% endif %}\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eè¿™ä¸ªæ¨¡æ¿çš„å…³é”®ç‚¹æ˜¯\u003cstrong\u003eç§»é™¤äº†æ‰€æœ‰ä¸æ€è€ƒæ¨¡å¼ç›¸å…³çš„æ ‡ç­¾å’Œå¤„ç†é€»è¾‘\u003c/strong\u003eï¼Œç¡®ä¿æ¨¡å‹æ— æ³•ç”Ÿæˆ\u003ccode\u003e\u0026lt;think\u0026gt;...\u0026lt;/think\u0026gt;\u003c/code\u003eå—ï¼Œå³ä½¿APIè¯·æ±‚ä¸­å°è¯•å¯ç”¨æ€è€ƒæ¨¡å¼ã€‚\u003c/p\u003e","title":"Qwen3-30B æŠ€æœ¯ä¼˜åŒ–å®è·µï¼ˆäºŒï¼‰ï¼šæ€è€ƒæ¨¡å¼æ§åˆ¶ä¸15-20%æ€§èƒ½æå‡"},{"content":"é«˜æ€§èƒ½éƒ¨ç½²Qwen3-30Bï¼švLLMä¼˜åŒ–å®è·µæŒ‡å— ğŸ“‹ æ¦‚è¿° æœ¬æ–‡è¯¦ç»†ä»‹ç»å¦‚ä½•ä½¿ç”¨vLLMé«˜æ•ˆéƒ¨ç½²Qwen3-30B-A3Bæ¨¡å‹ï¼Œå®ç°32Kä¸Šä¸‹æ–‡çª—å£å’ŒOpenAIå…¼å®¹APIï¼Œé€‚ç”¨äºç”Ÿäº§ç¯å¢ƒã€‚é€šè¿‡ç²¾ç»†è°ƒæ•´éƒ¨ç½²å‚æ•°ï¼Œæˆ‘ä»¬èƒ½å¤Ÿåœ¨æœ‰é™çš„GPUèµ„æºä¸‹æœ€å¤§åŒ–æ¨¡å‹æ€§èƒ½ã€‚\nğŸ–¥ï¸ ç³»ç»Ÿè¦æ±‚ ç¡¬ä»¶é…ç½® 4å—NVIDIA GPU (æ¯å—22GBæ˜¾å­˜ï¼Œæ€»è®¡88GB) 512GBç³»ç»Ÿå†…å­˜ 2TB SSDå­˜å‚¨ 56æ ¸CPU è½¯ä»¶ç¯å¢ƒ Ubuntu 24.04 NVIDIAé©±åŠ¨ 550.144.03 CUDA 12.4 Docker + NVIDIA Container Toolkit ğŸ§  æ¨¡å‹ä¸æ¶æ„ Qwen3-30B-A3Bæ˜¯é˜¿é‡Œäº‘å‘å¸ƒçš„é€šç”¨å¤§è¯­è¨€æ¨¡å‹ï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š\n30Bå‚æ•°é‡ åŸç”Ÿæ”¯æŒ32Kä¸Šä¸‹æ–‡é•¿åº¦ æ”¯æŒæ€è€ƒæ¨¡å¼(Chain-of-Thought) ä¼˜å¼‚çš„å¤šè¯­è¨€ä¸ä»£ç èƒ½åŠ› æˆ‘ä»¬ä½¿ç”¨vLLMä½œä¸ºæ¨ç†å¼•æ“ï¼Œä¸»è¦åŸºäºä»¥ä¸‹è€ƒé‡ï¼š\né«˜æ•ˆå†…å­˜ç®¡ç†ï¼šé€šè¿‡PagedAttentionæŠ€æœ¯ä¼˜åŒ–KVç¼“å­˜ å¼ é‡å¹¶è¡Œï¼šè‡ªåŠ¨è·¨å¤šGPUåˆ†å¸ƒæ¨¡å‹æƒé‡ OpenAIå…¼å®¹APIï¼šç›´æ¥æ›¿ä»£OpenAI APIï¼Œæ— éœ€ä¿®æ”¹ç°æœ‰åº”ç”¨ åŠ¨æ€æ‰¹å¤„ç†ï¼šè‡ªåŠ¨æ‰¹å¤„ç†å¤šè¯·æ±‚ï¼Œæé«˜ååé‡ ğŸ³ éƒ¨ç½²è„šæœ¬ ä»¥ä¸‹æ˜¯æˆ‘ä»¬ç”¨äºéƒ¨ç½²çš„Dockerå‘½ä»¤ï¼Œç»è¿‡ç²¾å¿ƒè°ƒä¼˜ä»¥å¹³è¡¡æ€§èƒ½ä¸èµ„æºåˆ©ç”¨ï¼š\ndocker run -d \\ --runtime=nvidia \\ --gpus=all \\ --name coder \\ -v /home/llm/model/qwen/qwen3-30b-a3b:/qwen/qwen3-30b-a3b \\ -p 8000:8000 \\ --cpuset-cpus 0-55 \\ --ulimit memlock=-1 \\ --ulimit stack=67108864 \\ --restart always \\ --ipc=host \\ vllm/vllm-openai:v0.8.5 \\ --model /qwen/qwen3-30b-a3b \\ --served-model-name coder \\ --tensor-parallel-size 4 \\ --dtype half \\ --max-model-len 32768 \\ --max-num-batched-tokens 4096 \\ --gpu-memory-utilization 0.93 \\ --block-size 32 \\ --enable-chunked-prefill \\ --swap-space 16 \\ --tokenizer-pool-size 56 \\ --disable-custom-all-reduce ğŸ”§ å‚æ•°è¯¦è§£ä¸ä¼˜åŒ–ç­–ç•¥ Dockerå®¹å™¨é…ç½® å‚æ•° å€¼ ä½œç”¨ --runtime=nvidia å¯ç”¨NVIDIAå®¹å™¨è¿è¡Œæ—¶ --gpus=all å°†æ‰€æœ‰GPUæš´éœ²ç»™å®¹å™¨ --cpuset-cpus 0-55 é™åˆ¶å®¹å™¨ä½¿ç”¨0-55å·CPUæ ¸å¿ƒ --ulimit memlock=-1 ç§»é™¤å†…å­˜é”å®šé™åˆ¶ï¼Œæé«˜æ€§èƒ½ --ipc=host ä½¿ç”¨ä¸»æœºIPCå‘½åç©ºé—´ï¼Œå¯¹å…±äº«å†…å­˜å¾ˆé‡è¦ vLLMå¼•æ“é…ç½® 1. å¼ é‡å¹¶è¡Œç­–ç•¥ --tensor-parallel-size 4 æˆ‘ä»¬ä½¿ç”¨4è·¯å¼ é‡å¹¶è¡Œï¼Œå°†æ¨¡å‹åˆ†å¸ƒåœ¨4å—GPUä¸Šã€‚è¿™æ˜¯åŸºäºå®éªŒå¾—å‡ºçš„æœ€ä½³é…ç½® - åœ¨æˆ‘ä»¬çš„ç¡¬ä»¶ä¸Šï¼Œæ¯å—22GBæ˜¾å­˜çš„GPUæ— æ³•å•ç‹¬åŠ è½½å®Œæ•´çš„30Bæ¨¡å‹ã€‚\n2. å†…å­˜ä¼˜åŒ– --dtype half --gpu-memory-utilization 0.93 --block-size 32 --swap-space 16 halfç²¾åº¦(FP16)ç›¸æ¯”bfloat16èƒ½è¿›ä¸€æ­¥èŠ‚çœå†…å­˜ï¼Œä¸”åœ¨æˆ‘ä»¬çš„åœºæ™¯ä¸­ç²¾åº¦æŸå¤±å¯æ¥å— GPUå†…å­˜åˆ©ç”¨ç‡93%ç•™å‡ºä¸€å®šç¼“å†²ç©ºé—´é˜²æ­¢OOMé”™è¯¯ KVç¼“å­˜å—å¤§å°è®¾ä¸º32ï¼Œå¹³è¡¡å†…å­˜ä½¿ç”¨ä¸è®¡ç®—æ•ˆç‡ 16GBçš„CPU-GPUäº¤æ¢ç©ºé—´æ”¯æŒå¤„ç†è¶…é•¿åºåˆ— 3. ä¸Šä¸‹æ–‡é•¿åº¦ä¸æ‰¹å¤„ç† --max-model-len 32768 --max-num-batched-tokens 4096 --enable-chunked-prefill æˆ‘ä»¬å°†ä¸Šä¸‹æ–‡é•¿åº¦ä»é»˜è®¤çš„16Kå¢åŠ åˆ°32Kï¼Œä»¥æ”¯æŒæ›´é•¿è¾“å…¥å’Œè¾“å‡ºã€‚ä¸ºäº†å¹³è¡¡èµ„æºä½¿ç”¨ï¼Œç›¸åº”åœ°å°†æ‰¹å¤„ç†ä»¤ç‰Œæ•°ä»8192å‡å°‘åˆ°4096ï¼Œè¿™æ˜¯ä¸€ä¸ªç»è¿‡æµ‹è¯•çš„åˆç†æŠ˜ä¸­æ–¹æ¡ˆã€‚\nå¯ç”¨åˆ†å—é¢„å¡«å……(chunked-prefill)å¯¹äºå¤„ç†é•¿ä¸Šä¸‹æ–‡å°¤ä¸ºé‡è¦ï¼Œå®ƒå°†é•¿åºåˆ—åˆ†è§£ä¸ºæ›´å°çš„å—è¿›è¡Œå¤„ç†ï¼Œå‡å°‘æ˜¾å­˜å³°å€¼ä½¿ç”¨ã€‚\n4. å…¶ä»–æ€§èƒ½è°ƒä¼˜ --tokenizer-pool-size 56 --disable-custom-all-reduce ä»¤ç‰ŒåŒ–å·¥ä½œæ± å¤§å°ä¸CPUæ ¸å¿ƒæ•°åŒ¹é…ï¼Œä¼˜åŒ–å¹¶è¡Œå¤„ç†èƒ½åŠ› ç¦ç”¨è‡ªå®šä¹‰all-reduceæ“ä½œï¼Œè§£å†³æŸäº›ç¡¬ä»¶é…ç½®ä¸Šçš„å…¼å®¹æ€§é—®é¢˜ ğŸ“Š æ€§èƒ½åˆ†æ éƒ¨ç½²åï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡docker logs -f coderæŸ¥çœ‹æœåŠ¡çŠ¶æ€ï¼Œå…³é”®æ€§èƒ½æŒ‡æ ‡å¦‚ä¸‹ï¼š\nINFO 06-03 02:01:19 [worker.py:287] the current vLLM instance can use total_gpu_memory (21.66GiB) x gpu_memory_utilization (0.93) = 20.15GiB INFO 06-03 02:01:19 [worker.py:287] model weights take 14.25GiB; non_torch_memory takes 0.20GiB; PyTorch activation peak memory takes 1.40GiB; the rest of the memory reserved for KV Cache is 4.30GiB. INFO 06-03 02:01:20 [executor_base.py:117] Maximum concurrency for 32768 tokens per request: 5.73x è¿™è¡¨æ˜ï¼š\næ¯ä¸ªGPUä½¿ç”¨çº¦20.15GBå†…å­˜ æ¨¡å‹æƒé‡å ç”¨14.25GB å¯¹äº32Kä»¤ç‰Œè¯·æ±‚ï¼Œç³»ç»Ÿå¯ä»¥å¹¶å‘å¤„ç†5.73å€çš„è¯·æ±‚ åœ¨æˆ‘ä»¬çš„ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œè¿™ä¸ªé…ç½®èƒ½å¤Ÿå¤„ç†æ¯åˆ†é’Ÿçº¦15-20ä¸ªå¹¶å‘å¯¹è¯ï¼Œæ»¡è¶³ä¸­å°å‹åº”ç”¨éœ€æ±‚ã€‚\nğŸ“ APIä½¿ç”¨ç¤ºä¾‹ æœåŠ¡å¯åŠ¨åï¼Œå¯ä»¥é€šè¿‡OpenAIå…¼å®¹çš„APIåœ¨æœ¬åœ°ç«¯å£8000è®¿é—®ï¼š\ncurl http://localhost:8000/v1/chat/completions \\ -H \u0026#34;Content-Type: application/json\u0026#34; \\ -d \u0026#39;{ \u0026#34;model\u0026#34;: \u0026#34;coder\u0026#34;, \u0026#34;messages\u0026#34;: [ {\u0026#34;role\u0026#34;: \u0026#34;user\u0026#34;, \u0026#34;content\u0026#34;: \u0026#34;è¯·è§£é‡Šä¸€ä¸‹é‡å­è®¡ç®—çš„åŸºæœ¬åŸç†\u0026#34;} ], \u0026#34;temperature\u0026#34;: 0.7, \u0026#34;max_tokens\u0026#34;: 2000 }\u0026#39; ä½¿ç”¨Pythonå®¢æˆ·ç«¯ï¼š\nfrom openai import OpenAI client = OpenAI( base_url=\u0026#34;http://localhost:8000/v1\u0026#34;, api_key=\u0026#34;not-needed\u0026#34; # vLLMä¸è¦æ±‚APIå¯†é’¥ ) response = client.chat.completions.create( model=\u0026#34;coder\u0026#34;, messages=[ {\u0026#34;role\u0026#34;: \u0026#34;user\u0026#34;, \u0026#34;content\u0026#34;: \u0026#34;å†™ä¸€ä¸ªPythonå‡½æ•°è®¡ç®—æ–æ³¢é‚£å¥‘æ•°åˆ—\u0026#34;} ], temperature=0.7, max_tokens=1000 ) print(response.choices[0].message.content) ğŸš€ æ‰©å±•åˆ°æ›´é•¿ä¸Šä¸‹æ–‡ Qwen3-30BåŸç”Ÿæ”¯æŒ32Kä¸Šä¸‹æ–‡ï¼Œä½†å¦‚éœ€æ‰©å±•åˆ°æ›´é•¿ä¸Šä¸‹æ–‡(å¦‚131Kä»¤ç‰Œ)ï¼Œå¯ä»¥ä½¿ç”¨YaRNæŠ€æœ¯ï¼Œé€šè¿‡åœ¨vLLMå‚æ•°ä¸­æ·»åŠ ï¼š\n--rope-scaling \u0026#39;{\u0026#34;rope_type\u0026#34;:\u0026#34;yarn\u0026#34;,\u0026#34;factor\u0026#34;:4.0,\u0026#34;original_max_position_embeddings\u0026#34;:32768}\u0026#39; \\ --max-model-len 131072 æ³¨æ„è¿™ä¼šå¢åŠ å†…å­˜ä½¿ç”¨ï¼Œå¯èƒ½éœ€è¦è¿›ä¸€æ­¥è°ƒæ•´å…¶ä»–å‚æ•°ä»¥å¹³è¡¡èµ„æºã€‚\nğŸ” å¸¸è§é—®é¢˜æ’æŸ¥ OOMé”™è¯¯ï¼šå‡å°gpu-memory-utilizationæˆ–max-num-batched-tokens æ¨ç†é€Ÿåº¦æ…¢ï¼šæ£€æŸ¥GPUåˆ©ç”¨ç‡ï¼Œè€ƒè™‘å¢åŠ batchå¤§å°æˆ–å‡å°max-model-len CUDAå›¾æ•è·å¤±è´¥ï¼šæ·»åŠ --enforce-eagerå‚æ•°ç¦ç”¨CUDAå›¾ä¼˜åŒ– ğŸ“ˆ æœªæ¥ä¼˜åŒ–æ–¹å‘ æ¢ç´¢ä½¿ç”¨FlashAttention-2åŠ é€Ÿæ³¨æ„åŠ›è®¡ç®— å°è¯•AWQ/GPTQé‡åŒ–æŠ€æœ¯é™ä½å†…å­˜ä½¿ç”¨ é…ç½®LLM Routerå®ç°å¤šæ¨¡å‹è´Ÿè½½å‡è¡¡ ğŸ”š æ€»ç»“ é€šè¿‡ç²¾ç»†è°ƒä¼˜vLLMéƒ¨ç½²å‚æ•°ï¼Œæˆ‘ä»¬æˆåŠŸåœ¨æœ‰é™ç¡¬ä»¶èµ„æºä¸‹éƒ¨ç½²äº†Qwen3-30Bæ¨¡å‹ï¼Œå®ç°äº†32Kä¸Šä¸‹æ–‡çª—å£çš„é«˜æ€§èƒ½æ¨ç†æœåŠ¡ã€‚è¿™å¥—é…ç½®åœ¨ç”Ÿäº§ç¯å¢ƒä¸­è¡¨ç°ç¨³å®šï¼Œä¸ºå„ç±»åº”ç”¨æä¾›å¼ºå¤§çš„AIèƒ½åŠ›æ”¯æŒã€‚\n","permalink":"https://jackypanster.github.io/ai-stream/posts/deploy-qwen3/","summary":"\u003ch1 id=\"é«˜æ€§èƒ½éƒ¨ç½²qwen3-30bvllmä¼˜åŒ–å®è·µæŒ‡å—\"\u003eé«˜æ€§èƒ½éƒ¨ç½²Qwen3-30Bï¼švLLMä¼˜åŒ–å®è·µæŒ‡å—\u003c/h1\u003e\n\u003ch2 id=\"-æ¦‚è¿°\"\u003eğŸ“‹ æ¦‚è¿°\u003c/h2\u003e\n\u003cp\u003eæœ¬æ–‡è¯¦ç»†ä»‹ç»å¦‚ä½•ä½¿ç”¨vLLMé«˜æ•ˆéƒ¨ç½²Qwen3-30B-A3Bæ¨¡å‹ï¼Œå®ç°32Kä¸Šä¸‹æ–‡çª—å£å’ŒOpenAIå…¼å®¹APIï¼Œé€‚ç”¨äºç”Ÿäº§ç¯å¢ƒã€‚é€šè¿‡ç²¾ç»†è°ƒæ•´éƒ¨ç½²å‚æ•°ï¼Œæˆ‘ä»¬èƒ½å¤Ÿåœ¨æœ‰é™çš„GPUèµ„æºä¸‹æœ€å¤§åŒ–æ¨¡å‹æ€§èƒ½ã€‚\u003c/p\u003e\n\u003ch2 id=\"-ç³»ç»Ÿè¦æ±‚\"\u003eğŸ–¥ï¸ ç³»ç»Ÿè¦æ±‚\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eç¡¬ä»¶é…ç½®\u003c/strong\u003e\n\u003cul\u003e\n\u003cli\u003e4å—NVIDIA GPU (æ¯å—22GBæ˜¾å­˜ï¼Œæ€»è®¡88GB)\u003c/li\u003e\n\u003cli\u003e512GBç³»ç»Ÿå†…å­˜\u003c/li\u003e\n\u003cli\u003e2TB SSDå­˜å‚¨\u003c/li\u003e\n\u003cli\u003e56æ ¸CPU\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eè½¯ä»¶ç¯å¢ƒ\u003c/strong\u003e\n\u003cul\u003e\n\u003cli\u003eUbuntu 24.04\u003c/li\u003e\n\u003cli\u003eNVIDIAé©±åŠ¨ 550.144.03\u003c/li\u003e\n\u003cli\u003eCUDA 12.4\u003c/li\u003e\n\u003cli\u003eDocker + NVIDIA Container Toolkit\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"-æ¨¡å‹ä¸æ¶æ„\"\u003eğŸ§  æ¨¡å‹ä¸æ¶æ„\u003c/h2\u003e\n\u003cp\u003eQwen3-30B-A3Bæ˜¯é˜¿é‡Œäº‘å‘å¸ƒçš„é€šç”¨å¤§è¯­è¨€æ¨¡å‹ï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e30Bå‚æ•°é‡\u003c/li\u003e\n\u003cli\u003eåŸç”Ÿæ”¯æŒ32Kä¸Šä¸‹æ–‡é•¿åº¦\u003c/li\u003e\n\u003cli\u003eæ”¯æŒæ€è€ƒæ¨¡å¼(Chain-of-Thought)\u003c/li\u003e\n\u003cli\u003eä¼˜å¼‚çš„å¤šè¯­è¨€ä¸ä»£ç èƒ½åŠ›\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eæˆ‘ä»¬ä½¿ç”¨vLLMä½œä¸ºæ¨ç†å¼•æ“ï¼Œä¸»è¦åŸºäºä»¥ä¸‹è€ƒé‡ï¼š\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\u003cstrong\u003eé«˜æ•ˆå†…å­˜ç®¡ç†\u003c/strong\u003eï¼šé€šè¿‡PagedAttentionæŠ€æœ¯ä¼˜åŒ–KVç¼“å­˜\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eå¼ é‡å¹¶è¡Œ\u003c/strong\u003eï¼šè‡ªåŠ¨è·¨å¤šGPUåˆ†å¸ƒæ¨¡å‹æƒé‡\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eOpenAIå…¼å®¹API\u003c/strong\u003eï¼šç›´æ¥æ›¿ä»£OpenAI APIï¼Œæ— éœ€ä¿®æ”¹ç°æœ‰åº”ç”¨\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eåŠ¨æ€æ‰¹å¤„ç†\u003c/strong\u003eï¼šè‡ªåŠ¨æ‰¹å¤„ç†å¤šè¯·æ±‚ï¼Œæé«˜ååé‡\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch2 id=\"-éƒ¨ç½²è„šæœ¬\"\u003eğŸ³ éƒ¨ç½²è„šæœ¬\u003c/h2\u003e\n\u003cp\u003eä»¥ä¸‹æ˜¯æˆ‘ä»¬ç”¨äºéƒ¨ç½²çš„Dockerå‘½ä»¤ï¼Œç»è¿‡ç²¾å¿ƒè°ƒä¼˜ä»¥å¹³è¡¡æ€§èƒ½ä¸èµ„æºåˆ©ç”¨ï¼š\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003edocker run -d \u003cspan style=\"color:#ae81ff\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#ae81ff\"\u003e\u003c/span\u003e  --runtime\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003envidia \u003cspan style=\"color:#ae81ff\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#ae81ff\"\u003e\u003c/span\u003e  --gpus\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003eall \u003cspan style=\"color:#ae81ff\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#ae81ff\"\u003e\u003c/span\u003e  --name coder \u003cspan style=\"color:#ae81ff\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#ae81ff\"\u003e\u003c/span\u003e  -v /home/llm/model/qwen/qwen3-30b-a3b:/qwen/qwen3-30b-a3b \u003cspan style=\"color:#ae81ff\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#ae81ff\"\u003e\u003c/span\u003e  -p 8000:8000 \u003cspan style=\"color:#ae81ff\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#ae81ff\"\u003e\u003c/span\u003e  --cpuset-cpus 0-55 \u003cspan style=\"color:#ae81ff\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#ae81ff\"\u003e\u003c/span\u003e  --ulimit memlock\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e-1 \u003cspan style=\"color:#ae81ff\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#ae81ff\"\u003e\u003c/span\u003e  --ulimit stack\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e67108864\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#ae81ff\"\u003e\u003c/span\u003e  --restart always \u003cspan style=\"color:#ae81ff\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#ae81ff\"\u003e\u003c/span\u003e  --ipc\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003ehost \u003cspan style=\"color:#ae81ff\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#ae81ff\"\u003e\u003c/span\u003e  vllm/vllm-openai:v0.8.5 \u003cspan style=\"color:#ae81ff\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#ae81ff\"\u003e\u003c/span\u003e  --model /qwen/qwen3-30b-a3b \u003cspan style=\"color:#ae81ff\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#ae81ff\"\u003e\u003c/span\u003e  --served-model-name coder \u003cspan style=\"color:#ae81ff\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#ae81ff\"\u003e\u003c/span\u003e  --tensor-parallel-size \u003cspan style=\"color:#ae81ff\"\u003e4\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#ae81ff\"\u003e\u003c/span\u003e  --dtype half \u003cspan style=\"color:#ae81ff\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#ae81ff\"\u003e\u003c/span\u003e  --max-model-len \u003cspan style=\"color:#ae81ff\"\u003e32768\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#ae81ff\"\u003e\u003c/span\u003e  --max-num-batched-tokens \u003cspan style=\"color:#ae81ff\"\u003e4096\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#ae81ff\"\u003e\u003c/span\u003e  --gpu-memory-utilization 0.93 \u003cspan style=\"color:#ae81ff\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#ae81ff\"\u003e\u003c/span\u003e  --block-size \u003cspan style=\"color:#ae81ff\"\u003e32\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#ae81ff\"\u003e\u003c/span\u003e  --enable-chunked-prefill \u003cspan style=\"color:#ae81ff\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#ae81ff\"\u003e\u003c/span\u003e  --swap-space \u003cspan style=\"color:#ae81ff\"\u003e16\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#ae81ff\"\u003e\u003c/span\u003e  --tokenizer-pool-size \u003cspan style=\"color:#ae81ff\"\u003e56\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#ae81ff\"\u003e\u003c/span\u003e  --disable-custom-all-reduce\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"-å‚æ•°è¯¦è§£ä¸ä¼˜åŒ–ç­–ç•¥\"\u003eğŸ”§ å‚æ•°è¯¦è§£ä¸ä¼˜åŒ–ç­–ç•¥\u003c/h2\u003e\n\u003ch3 id=\"dockerå®¹å™¨é…ç½®\"\u003eDockerå®¹å™¨é…ç½®\u003c/h3\u003e\n\u003ctable\u003e\n  \u003cthead\u003e\n      \u003ctr\u003e\n          \u003cth\u003eå‚æ•°\u003c/th\u003e\n          \u003cth\u003eå€¼\u003c/th\u003e\n          \u003cth\u003eä½œç”¨\u003c/th\u003e\n      \u003c/tr\u003e\n  \u003c/thead\u003e\n  \u003ctbody\u003e\n      \u003ctr\u003e\n          \u003ctd\u003e\u003ccode\u003e--runtime=nvidia\u003c/code\u003e\u003c/td\u003e\n          \u003ctd\u003e\u003c/td\u003e\n          \u003ctd\u003eå¯ç”¨NVIDIAå®¹å™¨è¿è¡Œæ—¶\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003e\u003ccode\u003e--gpus=all\u003c/code\u003e\u003c/td\u003e\n          \u003ctd\u003e\u003c/td\u003e\n          \u003ctd\u003eå°†æ‰€æœ‰GPUæš´éœ²ç»™å®¹å™¨\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003e\u003ccode\u003e--cpuset-cpus\u003c/code\u003e\u003c/td\u003e\n          \u003ctd\u003e\u003ccode\u003e0-55\u003c/code\u003e\u003c/td\u003e\n          \u003ctd\u003eé™åˆ¶å®¹å™¨ä½¿ç”¨0-55å·CPUæ ¸å¿ƒ\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003e\u003ccode\u003e--ulimit memlock=-1\u003c/code\u003e\u003c/td\u003e\n          \u003ctd\u003e\u003c/td\u003e\n          \u003ctd\u003eç§»é™¤å†…å­˜é”å®šé™åˆ¶ï¼Œæé«˜æ€§èƒ½\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003e\u003ccode\u003e--ipc=host\u003c/code\u003e\u003c/td\u003e\n          \u003ctd\u003e\u003c/td\u003e\n          \u003ctd\u003eä½¿ç”¨ä¸»æœºIPCå‘½åç©ºé—´ï¼Œå¯¹å…±äº«å†…å­˜å¾ˆé‡è¦\u003c/td\u003e\n      \u003c/tr\u003e\n  \u003c/tbody\u003e\n\u003c/table\u003e\n\u003ch3 id=\"vllmå¼•æ“é…ç½®\"\u003evLLMå¼•æ“é…ç½®\u003c/h3\u003e\n\u003ch4 id=\"1-å¼ é‡å¹¶è¡Œç­–ç•¥\"\u003e1. å¼ é‡å¹¶è¡Œç­–ç•¥\u003c/h4\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003e--tensor-parallel-size 4\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eæˆ‘ä»¬ä½¿ç”¨4è·¯å¼ é‡å¹¶è¡Œï¼Œå°†æ¨¡å‹åˆ†å¸ƒåœ¨4å—GPUä¸Šã€‚è¿™æ˜¯åŸºäºå®éªŒå¾—å‡ºçš„æœ€ä½³é…ç½® - åœ¨æˆ‘ä»¬çš„ç¡¬ä»¶ä¸Šï¼Œæ¯å—22GBæ˜¾å­˜çš„GPUæ— æ³•å•ç‹¬åŠ è½½å®Œæ•´çš„30Bæ¨¡å‹ã€‚\u003c/p\u003e","title":"é«˜æ€§èƒ½éƒ¨ç½²Qwen3-30Bï¼švLLMä¼˜åŒ–å®è·µæŒ‡å—"},{"content":"AIè¾…åŠ©ç¼–ç¨‹å®æˆ˜ï¼šä»éœ€æ±‚åˆ°å®ç°çš„å®Œæ•´å¯¹è¯è®°å½• å¼•è¨€ æœ¬æ–‡çœŸå®è¿˜åŸäº†æˆ‘ä¸AIåŠ©æ‰‹åä½œå®ç°Dockeré•œåƒå¤§å°ç›‘æ§åŠŸèƒ½çš„å…¨è¿‡ç¨‹ã€‚é€šè¿‡è¿™æ¬¡å®è·µï¼Œå¯ä»¥çœ‹åˆ°AIä¸ä»…èƒ½è¾…åŠ©å¼€å‘è€…æ¢³ç†éœ€æ±‚ã€è®¾è®¡æ–¹æ¡ˆï¼Œè¿˜èƒ½åœ¨ä»£ç å®ç°ã€æ–‡æ¡£ç¼–å†™ç­‰ç¯èŠ‚æä¾›é«˜æ•ˆå¸®åŠ©ã€‚æ•´ä¸ªæµç¨‹è‡ªç„¶æµç•…ï¼Œæå¤§æå‡äº†å¼€å‘ä½“éªŒã€‚\n1. éœ€æ±‚åˆ†æä¸æ–¹æ¡ˆè®¾è®¡ åˆå§‹éœ€æ±‚æè¿° ç”¨æˆ·ï¼š æˆ‘ä»¬éœ€è¦åœ¨Jenkinså…±äº«åº“ä¸­å¢åŠ Dockeré•œåƒå¤§å°ç›‘æ§åŠŸèƒ½ï¼Œå½“é•œåƒè¶…è¿‡4GBæ—¶å‘å‡ºè­¦å‘Šã€‚è¯·å¸®å¿™åˆ†æä¸€ä¸‹å®ç°æ€è·¯ã€‚ AIçš„åˆæ­¥åˆ†æä¸å»ºè®® AIï¼š è®©æˆ‘å…ˆçœ‹çœ‹é¡¹ç›®çš„ç»“æ„â€¦â€¦ è¿™æ˜¯ä¸€ä¸ªJenkinså…±äº«åº“é¡¹ç›®ï¼Œæ ¸å¿ƒä»£ç éƒ½åœ¨`vars/`ç›®å½•ã€‚é’ˆå¯¹é•œåƒå¤§å°ç›‘æ§ï¼Œæˆ‘å»ºè®®ç›´æ¥åœ¨`buildDocker`æ–¹æ³•é‡ŒåŠ é€»è¾‘ï¼š 1. é•œåƒæ„å»ºå®Œæˆåç”¨`du`å‘½ä»¤è·å–å¤§å° 2. ä¸4GBé˜ˆå€¼æ¯”è¾ƒ 3. è¶…è¿‡é˜ˆå€¼å°±è¾“å‡ºè­¦å‘Š 4. ç›¸å…³æŒ‡æ ‡å†™æ—¥å¿—ï¼Œæ–¹ä¾¿åç»­åˆ†æ è¿™ä¸ªæ–¹æ¡ˆæ‚¨è§‰å¾—åˆé€‚å—ï¼Ÿæœ‰æ— è¡¥å……ï¼Ÿ éœ€æ±‚ç¡®è®¤ä¸ç»†åŒ– ç”¨æˆ·ï¼š è¿™ä¸ªæ€è·¯å¯ä»¥ï¼Œä¸è¿‡è¿˜éœ€è¦ï¼š 1. é˜ˆå€¼è¦å¯é…ç½®ï¼Œé»˜è®¤4GB 2. æ—¥å¿—é‡Œè¦æœ‰é•œåƒåã€å¤§å°ã€æ—¶é—´æˆ³ç­‰è¯¦ç»†ä¿¡æ¯ 3. è¾“å‡ºä¼˜åŒ–å»ºè®® å¦å¤–ï¼Œå¼‚å¸¸å¤„ç†ä¹Ÿè¦è€ƒè™‘å¾—æ›´ä¼˜é›…äº›ã€‚ 2. ä»£ç å®ç° åˆå§‹ä»£ç å®ç° AIï¼š æ˜ç™½ï¼Œæˆ‘æ¥å®ç°ã€‚ä¼šåœ¨`buildDocker`æ–¹æ³•é‡Œï¼š 1. ç”¨`getEnvOrDefault`æ”¯æŒé˜ˆå€¼é…ç½® 2. è¯¦ç»†è®°å½•æŒ‡æ ‡ 3. åŠ å¼ºé”™è¯¯å¤„ç† 4. è¾“å‡ºä¼˜åŒ–å»ºè®® å®ç°é€»è¾‘æ‚¨çœ‹è¿˜æœ‰ä»€ä¹ˆè¦è°ƒæ•´çš„å—ï¼Ÿ ä»£ç å®¡æŸ¥ä¸ä¼˜åŒ– ç”¨æˆ·ï¼š æ•´ä½“ä¸é”™ï¼Œä¸è¿‡è­¦å‘Šè¦æ”¹æˆæŠ›å¼‚å¸¸ç›´æ¥ä¸­æ–­æ„å»ºã€‚å¦å¤–ï¼Œèƒ½ä¸èƒ½é¡ºä¾¿åŠ ä¸ŠåŸºç¡€é•œåƒå¤§å°æ£€æµ‹ï¼Ÿ å¼‚å¸¸å¤„ç†ä¼˜åŒ– AIï¼š æ˜ç™½æ‚¨çš„éœ€æ±‚ï¼Œä»£ç æˆ‘ä¼šè¿™æ ·ä¼˜åŒ–ï¼š 1. è¶…æ ‡ç›´æ¥æŠ›å¼‚å¸¸ä¸­æ–­æµæ°´çº¿ 2. å¢åŠ åŸºç¡€é•œåƒå¤§å°æ£€æµ‹ 3. æ˜ç¡®åŒºåˆ†ä¸šåŠ¡å¼‚å¸¸ï¼ˆæ¯”å¦‚é•œåƒè¿‡å¤§ï¼‰å’ŒæŠ€æœ¯å¼‚å¸¸ï¼ˆæ¯”å¦‚å‘½ä»¤å¤±è´¥ï¼‰ åŸºç¡€é•œåƒæ£€æµ‹è¿™å—ï¼Œæˆ‘å»ºè®®ï¼š - è§£æDockerfileçš„FROM - æ‹‰å–å¹¶æ£€æµ‹åŸºç¡€é•œåƒå¤§å° - è¶…é™å°±ç»™å‡ºalpineç­‰è½»é‡é•œåƒå»ºè®® è¿™æ ·å¤„ç†æ‚¨è§‰å¾—OKå—ï¼Ÿ 3. æµ‹è¯•ä¸éªŒè¯ æµ‹è¯•æ–¹æ¡ˆè®¨è®º ç”¨æˆ·ï¼š æ€ä¹ˆéªŒè¯è¿™ä¸ªåŠŸèƒ½ï¼Ÿ AIï¼š å»ºè®®è¿™æ ·æµ‹è¯•ï¼š 1. é•œåƒå¤§å°æ­£å¸¸ 2. æ°å¥½ç­‰äºé˜ˆå€¼ 3. è¶…è¿‡é˜ˆå€¼ 4. Dockerfileè§£æå¼‚å¸¸ ä¹Ÿå¯ä»¥ä¸´æ—¶æŠŠé˜ˆå€¼è°ƒå°ï¼Œå¿«é€ŸéªŒè¯å‘Šè­¦é€»è¾‘ã€‚ 4. æ–‡æ¡£ä¸æ²Ÿé€š å˜æ›´æ—¥å¿—ç”Ÿæˆ AIï¼š æˆ‘å·²ä¸ºæ‚¨ç”Ÿæˆè¯¦ç»†CHANGELOGï¼ŒåŒ…æ‹¬ï¼š - åŠŸèƒ½è¯´æ˜ - æŠ€æœ¯å®ç°ç»†èŠ‚ - é…ç½®å‚æ•°è¯´æ˜ - åç»­ä¼˜åŒ–è®¡åˆ’ å¦‚éœ€è°ƒæ•´ï¼Œéšæ—¶å‘Šè¯‰æˆ‘ã€‚ å›¢é˜Ÿé€šçŸ¥ ç”¨æˆ·ï¼š è¦å‘ä¸ªé€šçŸ¥ç»™å›¢é˜Ÿï¼Œè¯´æ˜æˆ‘ä»¬è¦é™åˆ¶é•œåƒå¤§å°ã€‚ AIï¼š å»ºè®®åˆ†é˜¶æ®µæ¨è¿›ï¼š 1. å…ˆç›‘æ§å’Œé€šçŸ¥ 2. å†è¿›å…¥è­¦å‘ŠæœŸ 3. æœ€åå¼ºåˆ¶é™åˆ¶ è¿™æ ·å¤§å®¶æœ‰ç¼“å†²æœŸï¼Œå¯ä»¥é€æ­¥ä¼˜åŒ–Dockerfileã€‚éœ€è¦å¸®å¿™èµ·è‰é€šçŸ¥å—ï¼Ÿ 5. ç»éªŒæ€»ç»“ æŠ€æœ¯æ”¶è· AIè¾…åŠ©æ•ˆç‡\nä»£ç å®ç°é€Ÿåº¦æå‡æ˜¾è‘— è‡ªåŠ¨ç”Ÿæˆæ–‡æ¡£èŠ‚çœæ—¶é—´ ä»£ç è´¨é‡\nå¼‚å¸¸å¤„ç†æ›´å®Œå–„ é…ç½®æ›´çµæ´» å›¢é˜Ÿåä½œ\næ–‡æ¡£æ›´è§„èŒƒ çŸ¥è¯†ä¼ é€’æ›´é«˜æ•ˆ å»ºè®®ä¸å±•æœ› å»ºç«‹AIè¾…åŠ©ç¼–ç è§„èŒƒ å®Œå–„æç¤ºå·¥ç¨‹å®è·µ æ¢ç´¢æ›´å¤šè‡ªåŠ¨åŒ–åœºæ™¯ ç»“è¯­ é€šè¿‡è¿™æ¬¡å®è·µï¼ŒAIèƒ½é™ªä¼´å¼€å‘è€…ä¸€èµ·æ€è€ƒã€å†³ç­–å’Œè½åœ°å®ç°ã€‚æœŸå¾…æœªæ¥AIåœ¨æ›´å¤šè½¯ä»¶å¼€å‘åœºæ™¯ä¸­å‘æŒ¥æ›´å¤§ä½œç”¨ã€‚\n","permalink":"https://jackypanster.github.io/ai-stream/posts/coding-with-ai/","summary":"\u003ch1 id=\"aiè¾…åŠ©ç¼–ç¨‹å®æˆ˜ä»éœ€æ±‚åˆ°å®ç°çš„å®Œæ•´å¯¹è¯è®°å½•\"\u003eAIè¾…åŠ©ç¼–ç¨‹å®æˆ˜ï¼šä»éœ€æ±‚åˆ°å®ç°çš„å®Œæ•´å¯¹è¯è®°å½•\u003c/h1\u003e\n\u003ch2 id=\"å¼•è¨€\"\u003eå¼•è¨€\u003c/h2\u003e\n\u003cp\u003eæœ¬æ–‡çœŸå®è¿˜åŸäº†æˆ‘ä¸AIåŠ©æ‰‹åä½œå®ç°Dockeré•œåƒå¤§å°ç›‘æ§åŠŸèƒ½çš„å…¨è¿‡ç¨‹ã€‚é€šè¿‡è¿™æ¬¡å®è·µï¼Œå¯ä»¥çœ‹åˆ°AIä¸ä»…èƒ½è¾…åŠ©å¼€å‘è€…æ¢³ç†éœ€æ±‚ã€è®¾è®¡æ–¹æ¡ˆï¼Œè¿˜èƒ½åœ¨ä»£ç å®ç°ã€æ–‡æ¡£ç¼–å†™ç­‰ç¯èŠ‚æä¾›é«˜æ•ˆå¸®åŠ©ã€‚æ•´ä¸ªæµç¨‹è‡ªç„¶æµç•…ï¼Œæå¤§æå‡äº†å¼€å‘ä½“éªŒã€‚\u003c/p\u003e\n\u003ch2 id=\"1-éœ€æ±‚åˆ†æä¸æ–¹æ¡ˆè®¾è®¡\"\u003e1. éœ€æ±‚åˆ†æä¸æ–¹æ¡ˆè®¾è®¡\u003c/h2\u003e\n\u003ch3 id=\"åˆå§‹éœ€æ±‚æè¿°\"\u003eåˆå§‹éœ€æ±‚æè¿°\u003c/h3\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003eç”¨æˆ·ï¼š\næˆ‘ä»¬éœ€è¦åœ¨Jenkinså…±äº«åº“ä¸­å¢åŠ Dockeré•œåƒå¤§å°ç›‘æ§åŠŸèƒ½ï¼Œå½“é•œåƒè¶…è¿‡4GBæ—¶å‘å‡ºè­¦å‘Šã€‚è¯·å¸®å¿™åˆ†æä¸€ä¸‹å®ç°æ€è·¯ã€‚\n\u003c/code\u003e\u003c/pre\u003e\u003ch3 id=\"aiçš„åˆæ­¥åˆ†æä¸å»ºè®®\"\u003eAIçš„åˆæ­¥åˆ†æä¸å»ºè®®\u003c/h3\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003eAIï¼š\nè®©æˆ‘å…ˆçœ‹çœ‹é¡¹ç›®çš„ç»“æ„â€¦â€¦\n\nè¿™æ˜¯ä¸€ä¸ªJenkinså…±äº«åº“é¡¹ç›®ï¼Œæ ¸å¿ƒä»£ç éƒ½åœ¨`vars/`ç›®å½•ã€‚é’ˆå¯¹é•œåƒå¤§å°ç›‘æ§ï¼Œæˆ‘å»ºè®®ç›´æ¥åœ¨`buildDocker`æ–¹æ³•é‡ŒåŠ é€»è¾‘ï¼š\n\n1. é•œåƒæ„å»ºå®Œæˆåç”¨`du`å‘½ä»¤è·å–å¤§å°\n2. ä¸4GBé˜ˆå€¼æ¯”è¾ƒ\n3. è¶…è¿‡é˜ˆå€¼å°±è¾“å‡ºè­¦å‘Š\n4. ç›¸å…³æŒ‡æ ‡å†™æ—¥å¿—ï¼Œæ–¹ä¾¿åç»­åˆ†æ\n\nè¿™ä¸ªæ–¹æ¡ˆæ‚¨è§‰å¾—åˆé€‚å—ï¼Ÿæœ‰æ— è¡¥å……ï¼Ÿ\n\u003c/code\u003e\u003c/pre\u003e\u003ch3 id=\"éœ€æ±‚ç¡®è®¤ä¸ç»†åŒ–\"\u003eéœ€æ±‚ç¡®è®¤ä¸ç»†åŒ–\u003c/h3\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003eç”¨æˆ·ï¼š\nè¿™ä¸ªæ€è·¯å¯ä»¥ï¼Œä¸è¿‡è¿˜éœ€è¦ï¼š\n1. é˜ˆå€¼è¦å¯é…ç½®ï¼Œé»˜è®¤4GB\n2. æ—¥å¿—é‡Œè¦æœ‰é•œåƒåã€å¤§å°ã€æ—¶é—´æˆ³ç­‰è¯¦ç»†ä¿¡æ¯\n3. è¾“å‡ºä¼˜åŒ–å»ºè®®\n\nå¦å¤–ï¼Œå¼‚å¸¸å¤„ç†ä¹Ÿè¦è€ƒè™‘å¾—æ›´ä¼˜é›…äº›ã€‚\n\u003c/code\u003e\u003c/pre\u003e\u003ch2 id=\"2-ä»£ç å®ç°\"\u003e2. ä»£ç å®ç°\u003c/h2\u003e\n\u003ch3 id=\"åˆå§‹ä»£ç å®ç°\"\u003eåˆå§‹ä»£ç å®ç°\u003c/h3\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003eAIï¼š\næ˜ç™½ï¼Œæˆ‘æ¥å®ç°ã€‚ä¼šåœ¨`buildDocker`æ–¹æ³•é‡Œï¼š\n\n1. ç”¨`getEnvOrDefault`æ”¯æŒé˜ˆå€¼é…ç½®\n2. è¯¦ç»†è®°å½•æŒ‡æ ‡\n3. åŠ å¼ºé”™è¯¯å¤„ç†\n4. è¾“å‡ºä¼˜åŒ–å»ºè®®\n\nå®ç°é€»è¾‘æ‚¨çœ‹è¿˜æœ‰ä»€ä¹ˆè¦è°ƒæ•´çš„å—ï¼Ÿ\n\u003c/code\u003e\u003c/pre\u003e\u003ch3 id=\"ä»£ç å®¡æŸ¥ä¸ä¼˜åŒ–\"\u003eä»£ç å®¡æŸ¥ä¸ä¼˜åŒ–\u003c/h3\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003eç”¨æˆ·ï¼š\næ•´ä½“ä¸é”™ï¼Œä¸è¿‡è­¦å‘Šè¦æ”¹æˆæŠ›å¼‚å¸¸ç›´æ¥ä¸­æ–­æ„å»ºã€‚å¦å¤–ï¼Œèƒ½ä¸èƒ½é¡ºä¾¿åŠ ä¸ŠåŸºç¡€é•œåƒå¤§å°æ£€æµ‹ï¼Ÿ\n\u003c/code\u003e\u003c/pre\u003e\u003ch3 id=\"å¼‚å¸¸å¤„ç†ä¼˜åŒ–\"\u003eå¼‚å¸¸å¤„ç†ä¼˜åŒ–\u003c/h3\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003eAIï¼š\næ˜ç™½æ‚¨çš„éœ€æ±‚ï¼Œä»£ç æˆ‘ä¼šè¿™æ ·ä¼˜åŒ–ï¼š\n\n1. è¶…æ ‡ç›´æ¥æŠ›å¼‚å¸¸ä¸­æ–­æµæ°´çº¿\n2. å¢åŠ åŸºç¡€é•œåƒå¤§å°æ£€æµ‹\n3. æ˜ç¡®åŒºåˆ†ä¸šåŠ¡å¼‚å¸¸ï¼ˆæ¯”å¦‚é•œåƒè¿‡å¤§ï¼‰å’ŒæŠ€æœ¯å¼‚å¸¸ï¼ˆæ¯”å¦‚å‘½ä»¤å¤±è´¥ï¼‰\n\nåŸºç¡€é•œåƒæ£€æµ‹è¿™å—ï¼Œæˆ‘å»ºè®®ï¼š\n- è§£æDockerfileçš„FROM\n- æ‹‰å–å¹¶æ£€æµ‹åŸºç¡€é•œåƒå¤§å°\n- è¶…é™å°±ç»™å‡ºalpineç­‰è½»é‡é•œåƒå»ºè®®\n\nè¿™æ ·å¤„ç†æ‚¨è§‰å¾—OKå—ï¼Ÿ\n\u003c/code\u003e\u003c/pre\u003e\u003ch2 id=\"3-æµ‹è¯•ä¸éªŒè¯\"\u003e3. æµ‹è¯•ä¸éªŒè¯\u003c/h2\u003e\n\u003ch3 id=\"æµ‹è¯•æ–¹æ¡ˆè®¨è®º\"\u003eæµ‹è¯•æ–¹æ¡ˆè®¨è®º\u003c/h3\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003eç”¨æˆ·ï¼š\næ€ä¹ˆéªŒè¯è¿™ä¸ªåŠŸèƒ½ï¼Ÿ\n\nAIï¼š\nå»ºè®®è¿™æ ·æµ‹è¯•ï¼š\n1. é•œåƒå¤§å°æ­£å¸¸\n2. æ°å¥½ç­‰äºé˜ˆå€¼\n3. è¶…è¿‡é˜ˆå€¼\n4. Dockerfileè§£æå¼‚å¸¸\n\nä¹Ÿå¯ä»¥ä¸´æ—¶æŠŠé˜ˆå€¼è°ƒå°ï¼Œå¿«é€ŸéªŒè¯å‘Šè­¦é€»è¾‘ã€‚\n\u003c/code\u003e\u003c/pre\u003e\u003ch2 id=\"4-æ–‡æ¡£ä¸æ²Ÿé€š\"\u003e4. æ–‡æ¡£ä¸æ²Ÿé€š\u003c/h2\u003e\n\u003ch3 id=\"å˜æ›´æ—¥å¿—ç”Ÿæˆ\"\u003eå˜æ›´æ—¥å¿—ç”Ÿæˆ\u003c/h3\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003eAIï¼š\næˆ‘å·²ä¸ºæ‚¨ç”Ÿæˆè¯¦ç»†CHANGELOGï¼ŒåŒ…æ‹¬ï¼š\n- åŠŸèƒ½è¯´æ˜\n- æŠ€æœ¯å®ç°ç»†èŠ‚\n- é…ç½®å‚æ•°è¯´æ˜\n- åç»­ä¼˜åŒ–è®¡åˆ’\n\nå¦‚éœ€è°ƒæ•´ï¼Œéšæ—¶å‘Šè¯‰æˆ‘ã€‚\n\u003c/code\u003e\u003c/pre\u003e\u003ch3 id=\"å›¢é˜Ÿé€šçŸ¥\"\u003eå›¢é˜Ÿé€šçŸ¥\u003c/h3\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003eç”¨æˆ·ï¼š\nè¦å‘ä¸ªé€šçŸ¥ç»™å›¢é˜Ÿï¼Œè¯´æ˜æˆ‘ä»¬è¦é™åˆ¶é•œåƒå¤§å°ã€‚\n\nAIï¼š\nå»ºè®®åˆ†é˜¶æ®µæ¨è¿›ï¼š\n1. å…ˆç›‘æ§å’Œé€šçŸ¥\n2. å†è¿›å…¥è­¦å‘ŠæœŸ\n3. æœ€åå¼ºåˆ¶é™åˆ¶\n\nè¿™æ ·å¤§å®¶æœ‰ç¼“å†²æœŸï¼Œå¯ä»¥é€æ­¥ä¼˜åŒ–Dockerfileã€‚éœ€è¦å¸®å¿™èµ·è‰é€šçŸ¥å—ï¼Ÿ\n\u003c/code\u003e\u003c/pre\u003e\u003ch2 id=\"5-ç»éªŒæ€»ç»“\"\u003e5. ç»éªŒæ€»ç»“\u003c/h2\u003e\n\u003ch3 id=\"æŠ€æœ¯æ”¶è·\"\u003eæŠ€æœ¯æ”¶è·\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eAIè¾…åŠ©æ•ˆç‡\u003c/strong\u003e\u003c/p\u003e","title":"AIè¾…åŠ©ç¼–ç¨‹å®æˆ˜ï¼šä»éœ€æ±‚åˆ°å®ç°çš„å®Œæ•´å¯¹è¯è®°å½•"},{"content":"åŸºäºFunAudioLLM/SenseVoiceSmallæ­å»ºé«˜æ•ˆè¯­éŸ³è½¬å½•æœåŠ¡çš„å®è·µä¹‹è·¯ é¡¹ç›®æ¦‚è¿° å®ç°ä¸€ä¸ªè¯­éŸ³è½¬å½•æ–‡æœ¬ï¼ˆASRï¼‰çš„æœåŠ¡ï¼Œç›®æ ‡æ˜¯èƒ½å¤Ÿé«˜æ•ˆåœ°å°†ç”¨æˆ·ä¸Šä¼ çš„éŸ³é¢‘æ–‡ä»¶è½¬æ¢ä¸ºæ–‡å­—ã€‚å‡ºäºä¸­æ–‡è¯­éŸ³çš„è€ƒè™‘ï¼Œé€‰æ‹©äº†æ¥è‡ª FunAudioLLM çš„ SenseVoiceSmall æ¨¡å‹ï¼Œå®ƒä»¥å…¶å¤šè¯­ç§æ”¯æŒã€é«˜æ•ˆç‡ä»¥åŠé›†æˆçš„è¯­éŸ³ç†è§£èƒ½åŠ›ï¼ˆå¦‚æƒ…æ„Ÿè¯†åˆ«ã€äº‹ä»¶æ£€æµ‹ï¼‰å¸å¼•äº†æˆ‘ã€‚æœ¬æ–‡å°†è¯¦ç»†è®°å½•ä»ç¯å¢ƒé…ç½®ã€æ ¸å¿ƒåŠŸèƒ½å®ç°åˆ°è¸©å‘è§£å†³çš„å…¨è¿‡ç¨‹ï¼Œå¹¶åˆ†äº«ä¸€äº›å…³äºæ¨¡å‹é€‰å‹çš„æ€è€ƒã€‚\nå®Œæ•´ä»£ç å·²å¼€æºåœ¨ GitHub ä»“åº“ï¼šhttps://github.com/jackypanster/FunAudioLLM-SenseVoiceSmall\né¡¹ç›®éœ€æ±‚æ–‡æ¡£ï¼ˆprd.mdï¼‰å…³é”®ä¿¡æ¯å¦‚ä¸‹ï¼š\næ¨¡å‹: FunAudioLLM/SenseVoice (å…·ä½“ä¸º SenseVoiceSmall) æœ¬åœ°æ¨¡å‹è·¯å¾„: /home/llm/model/iic/SenseVoiceSmall (ä» ModelScope ä¸‹è½½) APIæ¡†æ¶: FastAPI Pythonç¯å¢ƒç®¡ç†: uv ç¯å¢ƒé…ç½® ä¸ºäº†ä¿æŒå¼€å‘ç¯å¢ƒçš„çº¯å‡€å’Œé«˜æ•ˆï¼Œé‡‡ç”¨äº† uv æ¥ç®¡ç† Python ä¾èµ–ã€‚\nåˆ›å»ºè™šæ‹Ÿç¯å¢ƒ (å¦‚æœå°šæœªåˆ›å»º):\nuv venv .venv source .venv/bin/activate å®‰è£…æ ¸å¿ƒä¾èµ–: åˆå§‹çš„ requirements.txt åŒ…å«äº† fastapi, uvicorn, python-multipart ç­‰åŸºç¡€åº“ã€‚åç»­æ ¹æ®æ¨¡å‹åŠ è½½å’Œå¤„ç†çš„éœ€æ±‚ï¼Œé€æ­¥æ·»åŠ äº† torch, torchaudio, numpy, transformers, sentencepiece, ä»¥åŠæœ€ç»ˆè§£å†³æ¨¡å‹åŠ è½½é—®é¢˜çš„æ ¸å¿ƒåº“ funasrã€‚\nuv pip install -r requirements.txt æ ¸å¿ƒåŠŸèƒ½å®ç°æ¦‚è§ˆ é¡¹ç›®ç»“æ„ é¡¹ç›®çš„ä¸»è¦ç»“æ„åŒ…æ‹¬ï¼š\napp/main.py: FastAPI åº”ç”¨å…¥å£ï¼Œå®šä¹‰ API è·¯ç”±å’Œåº”ç”¨ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ï¼ˆå¦‚æ¨¡å‹åŠ è½½ï¼‰ã€‚ app/models/sensevoice_loader.py: è´Ÿè´£åŠ è½½ SenseVoiceSmall æ¨¡å‹ï¼Œé‡‡ç”¨å•ä¾‹æ¨¡å¼ã€‚ app/services/asr_service.py: å°è£…è¯­éŸ³å¤„ç†å’Œæ¨¡å‹æ¨ç†çš„æ ¸å¿ƒé€»è¾‘ã€‚ app/schemas.py: å®šä¹‰ API çš„è¯·æ±‚å’Œå“åº”æ•°æ®æ¨¡å‹ (Pydantic models)ã€‚ API ç«¯ç‚¹ å…³é”®çš„ API ç«¯ç‚¹è®¾è®¡ä¸ºï¼š\nPOST /asr_pure Content-Type: multipart/form-data Body: file (éŸ³é¢‘æ–‡ä»¶) è¿”å›è½¬å½•åçš„æ–‡æœ¬åŠå¤„ç†æ—¶é—´ã€‚\nè¸©å‘ä¸è§£å†³ä¹‹è·¯ï¼šæ¨¡å‹åŠ è½½çš„æ›²æŠ˜å†ç¨‹ åœ¨é¡¹ç›®æ¨è¿›è¿‡ç¨‹ä¸­ï¼Œæ¨¡å‹åŠ è½½éƒ¨åˆ†æ˜¯é‡åˆ°é—®é¢˜æœ€å¤šçš„åœ°æ–¹ï¼Œä¹Ÿæ˜¯æ”¶è·æœ€å¤šçš„åœ°æ–¹ã€‚\nå‘1ï¼šHugging Face AutoClass çš„ \u0026ldquo;Unrecognized model\u0026rdquo; æœ€åˆï¼Œå°è¯•ä½¿ç”¨ Hugging Face transformers åº“é€šç”¨çš„ AutoProcessor.from_pretrained() å’Œ AutoModelForSpeechSeq2Seq.from_pretrained() æ¥åŠ è½½æœ¬åœ°çš„ SenseVoiceSmall æ¨¡å‹æ–‡ä»¶ã€‚\n# app/models/sensevoice_loader.py (æ—©æœŸå°è¯•) # from transformers import AutoModelForSpeechSeq2Seq, AutoProcessor # ... # self.processor = AutoProcessor.from_pretrained(MODEL_PATH) # self.model = AutoModelForSpeechSeq2Seq.from_pretrained(MODEL_PATH) ç„¶è€Œï¼ŒæœåŠ¡å¯åŠ¨æ—¶ç«‹å³æŠ¥é”™ï¼š\nValueError: Unrecognized model in /home/llm/model/iic/SenseVoiceSmall. Should have a model_type key in its config.json... è¿™ä¸ªé”™è¯¯è¡¨æ˜ transformers çš„è‡ªåŠ¨å‘ç°æœºåˆ¶æ— æ³•è¯†åˆ«æ¨¡å‹ç±»å‹ï¼Œé€šå¸¸æ˜¯å› ä¸ºæ¨¡å‹ç›®å½•ä¸‹çš„ config.json æ–‡ä»¶ç¼ºå°‘ model_type å­—æ®µï¼Œæˆ–è€…è¯¥æ¨¡å‹éœ€è¦ç‰¹å®šçš„åŠ è½½ç±»ã€‚\nå‘2ï¼šè½¬å‘ funasr ä¸ trust_remote_code çš„åˆæ­¥æ¢ç´¢ æŸ¥é˜… FunAudioLLM/SenseVoice çš„å®˜æ–¹æ–‡æ¡£åå‘ç°ï¼Œæ¨èä½¿ç”¨ funasr åº“çš„ AutoModel æ¥åŠ è½½ SenseVoice ç³»åˆ—æ¨¡å‹ã€‚äºæ˜¯è°ƒæ•´äº†ä»£ç ï¼š\næ·»åŠ  funasr åˆ° requirements.txtã€‚ ä¿®æ”¹ SenseVoiceLoader: # app/models/sensevoice_loader.py (å¼•å…¥ funasr) from funasr import AutoModel # ... self.model = AutoModel( model=FUNASR_MODEL_NAME_OR_PATH, # å³æœ¬åœ°è·¯å¾„ trust_remote_code=True, device=self.device ) åŒæ—¶ï¼Œasr_service.py ä¸­çš„æ¨ç†é€»è¾‘ä¹Ÿç›¸åº”è°ƒæ•´ä¸ºè°ƒç”¨ funasr æ¨¡å‹å¯¹è±¡çš„ .generate() æ–¹æ³•ã€‚ æœ¬ä»¥ä¸ºè¿™æ ·èƒ½è§£å†³é—®é¢˜ï¼Œä½†å¯åŠ¨æ—¶åˆé‡åˆ°äº†æ–°çš„æ—¥å¿—ï¼š\nLoading remote code failed: model, No module named \u0026#39;model\u0026#39; å°½ç®¡è¿™æ¡æ—¥å¿—å‡ºç°ï¼Œä½†åç»­çš„ API è°ƒç”¨æµ‹è¯•å±…ç„¶æˆåŠŸäº†ï¼è¿™è®©æˆ‘éå¸¸å›°æƒ‘ã€‚\nå‘3ï¼šremote_code å‚æ•°ä¸ model.py æ–‡ä»¶çš„â€œå¹»å½±â€ æ·±å…¥ç ”ç©¶ funasr å’Œ SenseVoice çš„æ–‡æ¡£ï¼Œæ³¨æ„åˆ°å¯¹äºåŒ…å«è‡ªå®šä¹‰ä»£ç ï¼ˆå¦‚ model.pyï¼‰çš„æ¨¡å‹ï¼Œé™¤äº† trust_remote_code=Trueï¼Œæœ‰æ—¶è¿˜éœ€è¦æ˜ç¡®æŒ‡å®š remote_code å‚æ•°ã€‚\næˆ‘æ£€æŸ¥äº† Hugging Face ä»“åº“ FunAudioLLM/SenseVoiceSmall (https://huggingface.co/FunAudioLLM/SenseVoiceSmall/tree/main)ï¼Œå‘ç°å…¶æ–‡ä»¶åˆ—è¡¨ä¸­ç¡®å®åŒ…å«ä¸€ä¸ª model.pyã€‚å› æ­¤ï¼Œæˆ‘å°è¯•åœ¨ AutoModel è°ƒç”¨ä¸­åŠ å…¥ remote_code=\u0026quot;model.py\u0026quot;ã€‚\n# app/models/sensevoice_loader.py (å°è¯•æŒ‡å®š remote_code) self.model = AutoModel( model=FUNASR_MODEL_NAME_OR_PATH, trust_remote_code=True, remote_code=\u0026#34;model.py\u0026#34;, # \u0026lt;--- æ–°å¢ device=self.device ) ç»“æœï¼ŒNo module named 'model' çš„é”™è¯¯ä¾æ—§ã€‚\nè§£å†³æ–¹æ¡ˆï¼šæ¾„æ¸… ModelScope ä¸ Hugging Face çš„æ¨¡å‹æ–‡ä»¶å·®å¼‚ æœ¬åœ°æ¨¡å‹ /home/llm/model/iic/SenseVoiceSmall æ˜¯ä» ModelScope (https://www.modelscope.cn/models/iic/SenseVoiceSmall/files) ä¸‹è½½çš„ï¼Œè€Œéç›´æ¥ clone Hugging Face çš„ä»“åº“ã€‚é€šè¿‡ ls -al /home/llm/model/iic/SenseVoiceSmall/ æŸ¥çœ‹æœ¬åœ°æ–‡ä»¶ï¼Œå‘ç°ç¡®å®æ²¡æœ‰ model.py æ–‡ä»¶ï¼\nè¿™è§£é‡Šäº†ä¸ºä»€ä¹ˆæŒ‡å®š remote_code=\u0026quot;model.py\u0026quot; ä¾ç„¶æŠ¥é”™ã€‚ModelScope æä¾›çš„æ¨¡å‹åŒ…å¯èƒ½ä¸ Hugging Face ä»“åº“ä¸­çš„æ–‡ä»¶ç»“æ„ä¸å®Œå…¨ä¸€è‡´ï¼Œç‰¹åˆ«æ˜¯å¯¹äºè¿™ç§ä¾èµ– funasr ç‰¹å®šåŠ è½½æ–¹å¼çš„æ¨¡å‹ã€‚\næœ€ç»ˆçš„æ­£ç¡®é…ç½®ï¼šç§»é™¤ remote_code å‚æ•°ï¼Œä½†ä¿ç•™ trust_remote_code=Trueã€‚\n# app/models/sensevoice_loader.py (æœ€ç»ˆæ­£ç¡®é…ç½®) self.model = AutoModel( model=FUNASR_MODEL_NAME_OR_PATH, trust_remote_code=True, # ä¿ç•™ï¼Œfunasr å¯èƒ½ä»éœ€æ­¤æƒé™å¤„ç† ModelScope æ¨¡å‹ # remote_code=\u0026#34;model.py\u0026#34;, # ç§»é™¤ï¼Œå› ä¸ºæœ¬åœ° ModelScope ç‰ˆæœ¬æ— æ­¤æ–‡ä»¶ device=self.device ) è¿™æ ·ä¿®æ”¹åï¼ŒæœåŠ¡å¯åŠ¨æ—¶ä»ç„¶ä¼šæ‰“å° Loading remote code failed: model, No module named 'model'ï¼Œä½† API è°ƒç”¨å®Œå…¨æ­£å¸¸ï¼\nåŸå› åˆ†æï¼šfunasr åœ¨ trust_remote_code=True æ—¶ï¼Œä¼šä¼˜å…ˆå°è¯•åŠ è½½è‡ªå®šä¹‰ä»£ç ã€‚å¦‚æœæœ¬åœ°æ¨¡å‹è·¯å¾„ï¼ˆå¦‚ä» ModelScope ä¸‹è½½çš„ï¼‰æ²¡æœ‰ model.pyï¼Œè¿™ä¸ªå°è¯•ä¼šå¤±è´¥å¹¶æ‰“å°æ—¥å¿—ã€‚ä½†éšåï¼Œfunasr èƒ½å¤Ÿè¯†åˆ«å‡ºè¿™æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„ ModelScope æ¨¡å‹è·¯å¾„ï¼Œå¹¶è½¬ç”¨å…¶å†…éƒ¨çš„æ ‡å‡†åŠ è½½æµç¨‹æˆåŠŸåŠ è½½æ¨¡å‹ã€‚å› æ­¤ï¼Œè¯¥æ—¥å¿—åœ¨è¿™ç§æƒ…å†µä¸‹æ˜¯è‰¯æ€§çš„ã€‚\næ¨¡å‹å¯¹æ¯”ä¸é€‰å‹æ€è€ƒ åœ¨è§£å†³é—®é¢˜çš„è¿‡ç¨‹ä¸­ï¼Œä¹Ÿæ¢è®¨äº† FunAudioLLM/SenseVoiceSmall ä¸å…¶ä»–ä¸»æµ ASR æ¨¡å‹çš„å¯¹æ¯”ï¼š\nOpenAI Whisper ç³»åˆ— (å¦‚ whisper-large-v3):\nä¼˜åŠ¿: æé«˜çš„å‡†ç¡®ç‡ï¼Œå¼ºå¤§çš„å¤šè¯­è¨€èƒ½åŠ›ï¼Œåºå¤§çš„ç¤¾åŒºã€‚ åŠ£åŠ¿: æ¨ç†é€Ÿåº¦ç›¸å¯¹è¾ƒæ…¢ï¼ˆå°¤å…¶å¤§æ¨¡å‹ï¼‰ï¼Œä¸ç›´æ¥æä¾›æƒ…æ„Ÿ/äº‹ä»¶æ£€æµ‹ã€‚ Wav2Vec2 ç³»åˆ—:\nä¼˜åŠ¿: è‡ªç›‘ç£å­¦ä¹ å…¸èŒƒï¼Œå¤§é‡ç‰¹å®šè¯­è¨€å¾®è°ƒæ¨¡å‹ã€‚ åŠ£åŠ¿: åŸºç¡€æ¨¡å‹åŠŸèƒ½ç›¸å¯¹å•ä¸€ã€‚ SenseVoiceSmall çš„æ ¸å¿ƒä¼˜åŠ¿ é«˜æ•ˆæ¨ç†ï¼šå…¶æ¨¡å‹å¡å£°ç§°é‡‡ç”¨éè‡ªå›å½’ç«¯åˆ°ç«¯æ¡†æ¶ï¼Œæ¯” Whisper-Large å¿«15å€ã€‚è¿™å¯¹äºéœ€è¦ä½å»¶è¿Ÿçš„åº”ç”¨è‡³å…³é‡è¦ã€‚\nå¤šä»»åŠ¡é›†æˆï¼šå†…ç½® ASRã€LIDï¼ˆè¯­ç§è¯†åˆ«ï¼‰ã€SERï¼ˆæƒ…æ„Ÿè¯†åˆ«ï¼‰ã€AEDï¼ˆäº‹ä»¶æ£€æµ‹ï¼‰ã€‚å¦‚æœåº”ç”¨åœºæ™¯éœ€è¦è¿™äº›é™„åŠ ä¿¡æ¯ï¼ŒSenseVoiceSmall æä¾›äº†ä¸€ç«™å¼è§£å†³æ–¹æ¡ˆã€‚\nç‰¹å®šè¯­è¨€ä¼˜åŒ–ï¼šåœ¨ä¸­æ–‡ã€ç²¤è¯­ç­‰è¯­è¨€ä¸Šè¡¨ç°çªå‡ºã€‚\nç»“è®º æ²¡æœ‰ç»å¯¹çš„â€œæœ€å¥½â€ï¼Œåªæœ‰â€œæœ€é€‚åˆâ€ã€‚\nè‹¥è¿½æ±‚æè‡´å‡†ç¡®æ€§å’Œæœ€å¹¿è¯­è¨€è¦†ç›–ï¼Œä¸”å¯¹å»¶è¿Ÿä¸æ•æ„Ÿï¼ŒWhisper ä»æ˜¯é¦–é€‰ã€‚ è‹¥å¯¹æ¨ç†æ•ˆç‡ã€é›†æˆçš„å¤šä»»åŠ¡è¯­éŸ³ç†è§£ï¼ˆç‰¹åˆ«æ˜¯æƒ…æ„Ÿ/äº‹ä»¶ï¼‰æˆ–ä¸­æ–‡ç­‰ç‰¹å®šåœºæ™¯æœ‰é«˜è¦æ±‚ï¼ŒSenseVoiceSmall æ˜¯ä¸€ä¸ªæå…·ç«äº‰åŠ›çš„é€‰æ‹©ã€‚ ç›®å‰é€‰æ‹©çš„ SenseVoiceSmallï¼Œå°¤å…¶æ˜¯åœ¨ç¡®è®¤äº†å…¶ ModelScope ç‰ˆæœ¬èƒ½å¤Ÿé¡ºç•…è¿è¡Œåï¼Œå¯¹äºæˆ‘çš„é¡¹ç›®ç›®æ ‡æ¥è¯´æ˜¯ä¸€ä¸ªåˆé€‚çš„èµ·ç‚¹ã€‚\nå½“å‰çŠ¶æ€ä¸å±•æœ› ç›®å‰ï¼ŒåŸºäº FunAudioLLM/SenseVoiceSmall å’Œ FastAPI çš„è¯­éŸ³è½¬å½•æœåŠ¡å·²æˆåŠŸæ­å»ºå¹¶èƒ½æ­£ç¡®å¤„ç†è¯·æ±‚ã€‚\n$ curl -X POST \u0026#34;http://\u0026lt;your_server_ip\u0026gt;:8888/asr_pure\u0026#34; -F \u0026#34;file=@test_audio.wav\u0026#34; {\u0026#34;text\u0026#34;:\u0026#34;å¤ªå¥½äº†ï¼Œé‚£æ¥ä¸‹æ¥å’±ä»¬å¯ä»¥è¯•è¯•å…¶ä»–åŠŸèƒ½äº†ã€‚æ¯”å¦‚è¯´ä½ æƒ³æµ‹è¯•ä¸€ä¸‹è¯­éŸ³åˆæˆçš„æ•ˆæœæ€ä¹ˆæ ·ï¼Œæˆ–è€…æ˜¯çœ‹çœ‹æœ‰æ²¡æœ‰ä»€ä¹ˆæ–°çš„è¯­éŸ³å¤„ç†åŠŸèƒ½å‡ºæ¥å•¦ã€‚ğŸ˜”\u0026#34;,\u0026#34;status\u0026#34;:\u0026#34;success\u0026#34;,\u0026#34;processing_time_ms\u0026#34;:503.39...} åç»­å¯ä¼˜åŒ–çš„æ–¹å‘ æ€§èƒ½ä¼˜åŒ–ï¼šè¿›ä¸€æ­¥æµ‹è¯•å¹¶å‘å¤„ç†èƒ½åŠ›ï¼Œè€ƒè™‘å¤š worker é…ç½®ã€‚ é”™è¯¯å¤„ç†ä¸æ—¥å¿—ï¼šå®Œå–„æ›´ç»†è‡´çš„é”™è¯¯æ•è·å’Œæ—¥å¿—è®°å½•ã€‚ åŠŸèƒ½æ‰©å±•ï¼šå¦‚æœéœ€è¦ï¼Œå¯ä»¥åˆ©ç”¨ SenseVoiceSmall çš„æƒ…æ„Ÿè¯†åˆ«å’Œäº‹ä»¶æ£€æµ‹èƒ½åŠ›ã€‚ VAD é›†æˆï¼šå¯¹äºé•¿éŸ³é¢‘ï¼Œè€ƒè™‘åœ¨ funasr.AutoModel åŠ è½½æ—¶é›†æˆ VAD (Voice Activity Detection) åŠŸèƒ½ï¼Œä»¥å®ç°è‡ªåŠ¨åˆ†æ®µå¤„ç†ï¼Œæå‡é•¿éŸ³é¢‘å¤„ç†çš„ç¨³å®šæ€§å’Œæ•ˆç‡ã€‚ å¼‚æ­¥å¤„ç†ä¸é˜Ÿåˆ—ï¼šå¯¹äºé«˜å¹¶å‘åœºæ™¯ï¼Œå¼•å…¥æ¶ˆæ¯é˜Ÿåˆ—å’Œå¼‚æ­¥ä»»åŠ¡å¤„ç†ã€‚ ","permalink":"https://jackypanster.github.io/ai-stream/posts/howto-use-sensevoicesmall/","summary":"\u003ch1 id=\"åŸºäºfunaudiollmsensevoicesmallæ­å»ºé«˜æ•ˆè¯­éŸ³è½¬å½•æœåŠ¡çš„å®è·µä¹‹è·¯\"\u003eåŸºäºFunAudioLLM/SenseVoiceSmallæ­å»ºé«˜æ•ˆè¯­éŸ³è½¬å½•æœåŠ¡çš„å®è·µä¹‹è·¯\u003c/h1\u003e\n\u003ch2 id=\"é¡¹ç›®æ¦‚è¿°\"\u003eé¡¹ç›®æ¦‚è¿°\u003c/h2\u003e\n\u003cp\u003eå®ç°ä¸€ä¸ªè¯­éŸ³è½¬å½•æ–‡æœ¬ï¼ˆASRï¼‰çš„æœåŠ¡ï¼Œç›®æ ‡æ˜¯èƒ½å¤Ÿé«˜æ•ˆåœ°å°†ç”¨æˆ·ä¸Šä¼ çš„éŸ³é¢‘æ–‡ä»¶è½¬æ¢ä¸ºæ–‡å­—ã€‚å‡ºäºä¸­æ–‡è¯­éŸ³çš„è€ƒè™‘ï¼Œé€‰æ‹©äº†æ¥è‡ª \u003ccode\u003eFunAudioLLM\u003c/code\u003e çš„ \u003ccode\u003eSenseVoiceSmall\u003c/code\u003e æ¨¡å‹ï¼Œå®ƒä»¥å…¶å¤šè¯­ç§æ”¯æŒã€é«˜æ•ˆç‡ä»¥åŠé›†æˆçš„è¯­éŸ³ç†è§£èƒ½åŠ›ï¼ˆå¦‚æƒ…æ„Ÿè¯†åˆ«ã€äº‹ä»¶æ£€æµ‹ï¼‰å¸å¼•äº†æˆ‘ã€‚æœ¬æ–‡å°†è¯¦ç»†è®°å½•ä»ç¯å¢ƒé…ç½®ã€æ ¸å¿ƒåŠŸèƒ½å®ç°åˆ°è¸©å‘è§£å†³çš„å…¨è¿‡ç¨‹ï¼Œå¹¶åˆ†äº«ä¸€äº›å…³äºæ¨¡å‹é€‰å‹çš„æ€è€ƒã€‚\u003c/p\u003e\n\u003cp\u003eå®Œæ•´ä»£ç å·²å¼€æºåœ¨ GitHub ä»“åº“ï¼š\u003ca href=\"https://github.com/jackypanster/FunAudioLLM-SenseVoiceSmall\"\u003ehttps://github.com/jackypanster/FunAudioLLM-SenseVoiceSmall\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eé¡¹ç›®éœ€æ±‚æ–‡æ¡£ï¼ˆ\u003ccode\u003eprd.md\u003c/code\u003eï¼‰å…³é”®ä¿¡æ¯å¦‚ä¸‹ï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eæ¨¡å‹\u003c/strong\u003e: FunAudioLLM/SenseVoice (å…·ä½“ä¸º \u003ccode\u003eSenseVoiceSmall\u003c/code\u003e)\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eæœ¬åœ°æ¨¡å‹è·¯å¾„\u003c/strong\u003e: \u003ccode\u003e/home/llm/model/iic/SenseVoiceSmall\u003c/code\u003e (ä» ModelScope ä¸‹è½½)\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eAPIæ¡†æ¶\u003c/strong\u003e: FastAPI\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003ePythonç¯å¢ƒç®¡ç†\u003c/strong\u003e: \u003ccode\u003euv\u003c/code\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"ç¯å¢ƒé…ç½®\"\u003eç¯å¢ƒé…ç½®\u003c/h2\u003e\n\u003cp\u003eä¸ºäº†ä¿æŒå¼€å‘ç¯å¢ƒçš„çº¯å‡€å’Œé«˜æ•ˆï¼Œé‡‡ç”¨äº† \u003ccode\u003euv\u003c/code\u003e æ¥ç®¡ç† Python ä¾èµ–ã€‚\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eåˆ›å»ºè™šæ‹Ÿç¯å¢ƒ\u003c/strong\u003e (å¦‚æœå°šæœªåˆ›å»º):\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003euv venv .venv\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003esource .venv/bin/activate\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eå®‰è£…æ ¸å¿ƒä¾èµ–\u003c/strong\u003e:\nåˆå§‹çš„ \u003ccode\u003erequirements.txt\u003c/code\u003e åŒ…å«äº† \u003ccode\u003efastapi\u003c/code\u003e, \u003ccode\u003euvicorn\u003c/code\u003e, \u003ccode\u003epython-multipart\u003c/code\u003e ç­‰åŸºç¡€åº“ã€‚åç»­æ ¹æ®æ¨¡å‹åŠ è½½å’Œå¤„ç†çš„éœ€æ±‚ï¼Œé€æ­¥æ·»åŠ äº† \u003ccode\u003etorch\u003c/code\u003e, \u003ccode\u003etorchaudio\u003c/code\u003e, \u003ccode\u003enumpy\u003c/code\u003e, \u003ccode\u003etransformers\u003c/code\u003e, \u003ccode\u003esentencepiece\u003c/code\u003e, ä»¥åŠæœ€ç»ˆè§£å†³æ¨¡å‹åŠ è½½é—®é¢˜çš„æ ¸å¿ƒåº“ \u003ccode\u003efunasr\u003c/code\u003eã€‚\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003euv pip install -r requirements.txt\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch2 id=\"æ ¸å¿ƒåŠŸèƒ½å®ç°æ¦‚è§ˆ\"\u003eæ ¸å¿ƒåŠŸèƒ½å®ç°æ¦‚è§ˆ\u003c/h2\u003e\n\u003ch3 id=\"é¡¹ç›®ç»“æ„\"\u003eé¡¹ç›®ç»“æ„\u003c/h3\u003e\n\u003cp\u003eé¡¹ç›®çš„ä¸»è¦ç»“æ„åŒ…æ‹¬ï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003eapp/main.py\u003c/code\u003e: FastAPI åº”ç”¨å…¥å£ï¼Œå®šä¹‰ API è·¯ç”±å’Œåº”ç”¨ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ï¼ˆå¦‚æ¨¡å‹åŠ è½½ï¼‰ã€‚\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eapp/models/sensevoice_loader.py\u003c/code\u003e: è´Ÿè´£åŠ è½½ \u003ccode\u003eSenseVoiceSmall\u003c/code\u003e æ¨¡å‹ï¼Œé‡‡ç”¨å•ä¾‹æ¨¡å¼ã€‚\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eapp/services/asr_service.py\u003c/code\u003e: å°è£…è¯­éŸ³å¤„ç†å’Œæ¨¡å‹æ¨ç†çš„æ ¸å¿ƒé€»è¾‘ã€‚\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eapp/schemas.py\u003c/code\u003e: å®šä¹‰ API çš„è¯·æ±‚å’Œå“åº”æ•°æ®æ¨¡å‹ (Pydantic models)ã€‚\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"api-ç«¯ç‚¹\"\u003eAPI ç«¯ç‚¹\u003c/h3\u003e\n\u003cp\u003eå…³é”®çš„ API ç«¯ç‚¹è®¾è®¡ä¸ºï¼š\u003c/p\u003e","title":"åŸºäºFunAudioLLM/SenseVoiceSmallæ­å»ºé«˜æ•ˆè¯­éŸ³è½¬å½•æœåŠ¡çš„å®è·µä¹‹è·¯"},{"content":"å¦‚ä½•ä½¿ç”¨Qwen2.5-Omniå®ç°æ–‡æœ¬è½¬è¯­éŸ³(TTS)å’Œè¯­éŸ³è½¬æ–‡æœ¬(ASR) é¡¹ç›®æ¦‚è¿° æœ¬é¡¹ç›®åŸºäºQwen2.5-Omni-7Bæ¨¡å‹ï¼Œå®ç°äº†ä¸¤ä¸ªæ ¸å¿ƒåŠŸèƒ½ï¼š\næ–‡æœ¬è½¬è¯­éŸ³ï¼ˆTTSï¼‰ï¼šå°†è¾“å…¥æ–‡æœ¬è½¬æ¢ä¸ºè‡ªç„¶æµç•…çš„è¯­éŸ³ è¯­éŸ³è½¬æ–‡æœ¬ï¼ˆASRï¼‰ï¼šå°†è¯­éŸ³æ–‡ä»¶è½¬æ¢ä¸ºæ–‡æœ¬ï¼Œæ”¯æŒæ ‡å‡†ASRå’Œçº¯ASRä¸¤ç§æ¨¡å¼ é¡¹ç›®åœ°å€ï¼šhttps://github.com/jackypanster/qwen-omni\nç¯å¢ƒé…ç½® æ¨èä½¿ç”¨condaç®¡ç†Pythonç¯å¢ƒï¼Œç¡®ä¿ä¾èµ–å®‰è£…çš„ç¨³å®šæ€§ï¼š\n# åˆ›å»ºå¹¶æ¿€æ´»ç¯å¢ƒ conda create -n qwen-tts python=3.10 conda activate qwen-tts # å®‰è£…PyTorchï¼ˆGPUç‰ˆæœ¬ï¼‰ conda install pytorch=2.5.1 pytorch-cuda=12.1 -c pytorch -c nvidia conda install torchvision torchaudio -c pytorch # å®‰è£…å…¶ä»–ä¾èµ– conda install streamlit python-soundfile -c conda-forge pip install git+https://github.com/huggingface/transformers@v4.51.3-Qwen2.5-Omni-preview pip install qwen-omni-utils æ ¸å¿ƒåŠŸèƒ½å®ç° 1. æ–‡æœ¬è½¬è¯­éŸ³ï¼ˆTTSï¼‰ def text_to_speech(text_input, output_audio_path=\u0026#34;output/output.wav\u0026#34;, speaker=\u0026#34;Chelsie\u0026#34;): # åŠ è½½æ¨¡å‹å’Œå¤„ç†å™¨ model = Qwen2_5OmniForConditionalGeneration.from_pretrained( model_path, config=config, torch_dtype=\u0026#34;auto\u0026#34;, device_map=\u0026#34;auto\u0026#34; ) processor = Qwen2_5OmniProcessor.from_pretrained(model_path) # æ„é€ å¯¹è¯ conversation = [ {\u0026#34;role\u0026#34;: \u0026#34;system\u0026#34;, \u0026#34;content\u0026#34;: [{\u0026#34;type\u0026#34;: \u0026#34;text\u0026#34;, \u0026#34;text\u0026#34;: \u0026#34;You are Qwen...\u0026#34;}]}, {\u0026#34;role\u0026#34;: \u0026#34;user\u0026#34;, \u0026#34;content\u0026#34;: [{\u0026#34;type\u0026#34;: \u0026#34;text\u0026#34;, \u0026#34;text\u0026#34;: text_input}]} ] # ç”Ÿæˆè¯­éŸ³ with torch.no_grad(): text_ids, audio = model.generate( **inputs, speaker=speaker, do_sample=True, temperature=0.8, top_p=0.95, max_new_tokens=1024 ) 2. è¯­éŸ³è½¬æ–‡æœ¬ï¼ˆASRï¼‰ def audio_to_text(audio_path: str) -\u0026gt; str: # æ ‡å‡†ASRæ¨¡å¼ conversation = [ {\u0026#34;role\u0026#34;: \u0026#34;system\u0026#34;, \u0026#34;content\u0026#34;: [{\u0026#34;type\u0026#34;: \u0026#34;text\u0026#34;, \u0026#34;text\u0026#34;: \u0026#34;ä½ æ˜¯Qwen...\u0026#34;}]}, {\u0026#34;role\u0026#34;: \u0026#34;user\u0026#34;, \u0026#34;content\u0026#34;: [{\u0026#34;type\u0026#34;: \u0026#34;audio\u0026#34;, \u0026#34;audio\u0026#34;: audio_path}]} ] # ç”Ÿæˆæ–‡æœ¬ with torch.no_grad(): text_ids = model.generate( **inputs, do_sample=False, max_new_tokens=1024, return_audio=False ) Webç•Œé¢å®ç° ä½¿ç”¨Streamlitæ„å»ºäº†ç®€æ´çš„Webç•Œé¢ï¼š\n# æ–‡æœ¬è¾“å…¥ text_input = st.text_area(\u0026#34;è¯·è¾“å…¥è¦åˆæˆçš„æ–‡æœ¬ï¼š\u0026#34;, height=120, max_chars=200) # å‘éŸ³äººé€‰æ‹© speaker = st.selectbox(\u0026#34;è¯·é€‰æ‹©å‘éŸ³äººï¼š\u0026#34;, [\u0026#34;Chelsie\u0026#34;, \u0026#34;Ethan\u0026#34;], index=0) # ç”ŸæˆæŒ‰é’® if st.button(\u0026#34;ç”Ÿæˆè¯­éŸ³\u0026#34;): # ç”Ÿæˆè¯­éŸ³å¹¶æ’­æ”¾ audio_path = os.path.join(OUTPUT_DIR, f\u0026#34;tts_{uuid.uuid4().hex}.wav\u0026#34;) text_to_speech(text_input, output_audio_path=audio_path, speaker=speaker) st.audio(audio_path, format=\u0026#34;audio/wav\u0026#34;) RESTful APIå®ç° ä½¿ç”¨FastAPIæ„å»ºäº†RESTful APIæ¥å£ï¼š\n@app.post(\u0026#34;/tts\u0026#34;) async def tts(request: TTSRequest): audio_filename = f\u0026#34;tts_{uuid.uuid4().hex}.wav\u0026#34; audio_path = os.path.join(OUTPUT_DIR, audio_filename) text_to_speech(request.text, audio_path, request.speaker) return {\u0026#34;audio_url\u0026#34;: f\u0026#34;/output/{audio_filename}\u0026#34;} @app.post(\u0026#34;/asr\u0026#34;) async def asr(file: UploadFile = File(...)): # å¤„ç†ä¸Šä¼ çš„éŸ³é¢‘æ–‡ä»¶ audio_path = os.path.join(OUTPUT_DIR, f\u0026#34;asr_{uuid.uuid4().hex}.wav\u0026#34;) with open(audio_path, \u0026#34;wb\u0026#34;) as buffer: shutil.copyfileobj(file.file, buffer) text = audio_to_text(audio_path) return {\u0026#34;text\u0026#34;: text} ä½¿ç”¨è¯´æ˜ å¯åŠ¨Webç•Œé¢ï¼š streamlit run app_text2audio.py å¯åŠ¨APIæœåŠ¡ï¼š uvicorn fastapi_app:app --host 0.0.0.0 --port 8000 æ³¨æ„äº‹é¡¹ æ¨¡å‹æ–‡ä»¶è¾ƒå¤§ï¼Œå»ºè®®æå‰ä¸‹è½½å¹¶é…ç½®å¥½æ¨¡å‹è·¯å¾„ ä½¿ç”¨condaå®‰è£…ä¾èµ–å¯ä»¥é¿å…å¤§å¤šæ•°ç¯å¢ƒé—®é¢˜ éŸ³é¢‘æ–‡ä»¶ä¼šä¿å­˜åœ¨outputç›®å½•ä¸‹ APIæ¥å£æ”¯æŒæ–‡ä»¶ä¸Šä¼ å’Œæ–‡æœ¬è½¬å†™ åç»­ä¼˜åŒ–æ–¹å‘ æ”¯æŒæ›´å¤šå‘éŸ³äººé€‰é¡¹ ä¼˜åŒ–æ¨¡å‹åŠ è½½é€Ÿåº¦ æ·»åŠ æ‰¹é‡å¤„ç†åŠŸèƒ½ æ”¯æŒæ›´å¤šéŸ³é¢‘æ ¼å¼ æ·»åŠ å†å²è®°å½•åŠŸèƒ½ å‚è€ƒèµ„æº Qwen2.5-Omni-7Bå®˜æ–¹æ–‡æ¡£ Streamlitæ–‡æ¡£ FastAPIæ–‡æ¡£ ","permalink":"https://jackypanster.github.io/ai-stream/posts/how-to-use-qwen-omni-tts-asr/","summary":"\u003ch1 id=\"å¦‚ä½•ä½¿ç”¨qwen25-omniå®ç°æ–‡æœ¬è½¬è¯­éŸ³ttså’Œè¯­éŸ³è½¬æ–‡æœ¬asr\"\u003eå¦‚ä½•ä½¿ç”¨Qwen2.5-Omniå®ç°æ–‡æœ¬è½¬è¯­éŸ³(TTS)å’Œè¯­éŸ³è½¬æ–‡æœ¬(ASR)\u003c/h1\u003e\n\u003ch2 id=\"é¡¹ç›®æ¦‚è¿°\"\u003eé¡¹ç›®æ¦‚è¿°\u003c/h2\u003e\n\u003cp\u003eæœ¬é¡¹ç›®åŸºäºQwen2.5-Omni-7Bæ¨¡å‹ï¼Œå®ç°äº†ä¸¤ä¸ªæ ¸å¿ƒåŠŸèƒ½ï¼š\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eæ–‡æœ¬è½¬è¯­éŸ³ï¼ˆTTSï¼‰ï¼šå°†è¾“å…¥æ–‡æœ¬è½¬æ¢ä¸ºè‡ªç„¶æµç•…çš„è¯­éŸ³\u003c/li\u003e\n\u003cli\u003eè¯­éŸ³è½¬æ–‡æœ¬ï¼ˆASRï¼‰ï¼šå°†è¯­éŸ³æ–‡ä»¶è½¬æ¢ä¸ºæ–‡æœ¬ï¼Œæ”¯æŒæ ‡å‡†ASRå’Œçº¯ASRä¸¤ç§æ¨¡å¼\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eé¡¹ç›®åœ°å€ï¼š\u003ca href=\"https://github.com/jackypanster/qwen-omni\"\u003ehttps://github.com/jackypanster/qwen-omni\u003c/a\u003e\u003c/p\u003e\n\u003ch2 id=\"ç¯å¢ƒé…ç½®\"\u003eç¯å¢ƒé…ç½®\u003c/h2\u003e\n\u003cp\u003eæ¨èä½¿ç”¨condaç®¡ç†Pythonç¯å¢ƒï¼Œç¡®ä¿ä¾èµ–å®‰è£…çš„ç¨³å®šæ€§ï¼š\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e# åˆ›å»ºå¹¶æ¿€æ´»ç¯å¢ƒ\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003econda create -n qwen-tts python\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e3.10\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003econda activate qwen-tts\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e# å®‰è£…PyTorchï¼ˆGPUç‰ˆæœ¬ï¼‰\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003econda install pytorch\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e2.5.1 pytorch-cuda\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e12.1 -c pytorch -c nvidia\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003econda install torchvision torchaudio -c pytorch\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e# å®‰è£…å…¶ä»–ä¾èµ–\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003econda install streamlit python-soundfile -c conda-forge\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003epip install git+https://github.com/huggingface/transformers@v4.51.3-Qwen2.5-Omni-preview\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003epip install qwen-omni-utils\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"æ ¸å¿ƒåŠŸèƒ½å®ç°\"\u003eæ ¸å¿ƒåŠŸèƒ½å®ç°\u003c/h2\u003e\n\u003ch3 id=\"1-æ–‡æœ¬è½¬è¯­éŸ³tts\"\u003e1. æ–‡æœ¬è½¬è¯­éŸ³ï¼ˆTTSï¼‰\u003c/h3\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-python\" data-lang=\"python\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#66d9ef\"\u003edef\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003etext_to_speech\u003c/span\u003e(text_input, output_audio_path\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;output/output.wav\u0026#34;\u003c/span\u003e, speaker\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Chelsie\u0026#34;\u003c/span\u003e):\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#75715e\"\u003e# åŠ è½½æ¨¡å‹å’Œå¤„ç†å™¨\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    model \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e Qwen2_5OmniForConditionalGeneration\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003efrom_pretrained(\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        model_path, \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        config\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003econfig, \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        torch_dtype\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;auto\u0026#34;\u003c/span\u003e, \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        device_map\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;auto\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    )\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    processor \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e Qwen2_5OmniProcessor\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003efrom_pretrained(model_path)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#75715e\"\u003e# æ„é€ å¯¹è¯\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    conversation \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e [\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        {\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;role\u0026#34;\u003c/span\u003e: \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;system\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;content\u0026#34;\u003c/span\u003e: [{\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;type\u0026#34;\u003c/span\u003e: \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;text\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;text\u0026#34;\u003c/span\u003e: \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;You are Qwen...\u0026#34;\u003c/span\u003e}]},\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        {\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;role\u0026#34;\u003c/span\u003e: \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;user\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;content\u0026#34;\u003c/span\u003e: [{\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;type\u0026#34;\u003c/span\u003e: \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;text\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;text\u0026#34;\u003c/span\u003e: text_input}]}\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    ]\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#75715e\"\u003e# ç”Ÿæˆè¯­éŸ³\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003ewith\u003c/span\u003e torch\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003eno_grad():\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        text_ids, audio \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e model\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003egenerate(\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#f92672\"\u003e**\u003c/span\u003einputs,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            speaker\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003espeaker,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            do_sample\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#66d9ef\"\u003eTrue\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            temperature\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e0.8\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            top_p\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e0.95\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            max_new_tokens\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e1024\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        )\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"2-è¯­éŸ³è½¬æ–‡æœ¬asr\"\u003e2. è¯­éŸ³è½¬æ–‡æœ¬ï¼ˆASRï¼‰\u003c/h3\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-python\" data-lang=\"python\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#66d9ef\"\u003edef\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eaudio_to_text\u003c/span\u003e(audio_path: str) \u003cspan style=\"color:#f92672\"\u003e-\u0026gt;\u003c/span\u003e str:\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#75715e\"\u003e# æ ‡å‡†ASRæ¨¡å¼\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    conversation \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e [\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        {\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;role\u0026#34;\u003c/span\u003e: \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;system\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;content\u0026#34;\u003c/span\u003e: [{\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;type\u0026#34;\u003c/span\u003e: \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;text\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;text\u0026#34;\u003c/span\u003e: \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;ä½ æ˜¯Qwen...\u0026#34;\u003c/span\u003e}]},\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        {\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;role\u0026#34;\u003c/span\u003e: \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;user\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;content\u0026#34;\u003c/span\u003e: [{\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;type\u0026#34;\u003c/span\u003e: \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;audio\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;audio\u0026#34;\u003c/span\u003e: audio_path}]}\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    ]\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#75715e\"\u003e# ç”Ÿæˆæ–‡æœ¬\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003ewith\u003c/span\u003e torch\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003eno_grad():\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        text_ids \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e model\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003egenerate(\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#f92672\"\u003e**\u003c/span\u003einputs,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            do_sample\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#66d9ef\"\u003eFalse\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            max_new_tokens\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e1024\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            return_audio\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#66d9ef\"\u003eFalse\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        )\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"webç•Œé¢å®ç°\"\u003eWebç•Œé¢å®ç°\u003c/h2\u003e\n\u003cp\u003eä½¿ç”¨Streamlitæ„å»ºäº†ç®€æ´çš„Webç•Œé¢ï¼š\u003c/p\u003e","title":"å¦‚ä½•ä½¿ç”¨Qwen2.5-Omniå®ç°æ–‡æœ¬è½¬è¯­éŸ³(TTS)å’Œè¯­éŸ³è½¬æ–‡æœ¬(ASR)"},{"content":"\næ¦‚è¿° æœ¬è„šæœ¬åŸºäº Qwen2.5-Omni-7B å¤šæ¨¡æ€æ¨¡å‹å®ç°æ–‡æœ¬è½¬è¯­éŸ³ï¼ˆTTSï¼‰åŠŸèƒ½ï¼Œæ”¯æŒç”Ÿæˆè‡ªç„¶æµç•…çš„ä¸­æ–‡ / è‹±æ–‡è¯­éŸ³ï¼Œå¹¶æä¾›ä¸¤ç§è¯­éŸ³ç±»å‹ï¼ˆå¥³æ€§ â€œChelsieâ€ã€ç”·æ€§ â€œEthanâ€ï¼‰ã€‚è„šæœ¬å¯å°†è¾“å…¥æ–‡æœ¬è½¬æ¢ä¸ºéŸ³é¢‘æ–‡ä»¶ï¼ˆ.wavæ ¼å¼ï¼‰ï¼Œé€‚ç”¨äºè¯­éŸ³åŠ©æ‰‹ã€å†…å®¹åˆ›ä½œã€æ— éšœç¢æœåŠ¡ç­‰åœºæ™¯ã€‚\nä¸»è¦ç‰¹æ€§ ğŸ™ï¸ æ”¯æŒè‡ªç„¶æµç•…çš„ ä¸­æ–‡/è‹±æ–‡ è¯­éŸ³åˆæˆ ğŸ‘¥ æä¾›ä¸¤ç§è¯­éŸ³ç±»å‹é€‰æ‹©ï¼š å¥³æ€§å£°çº¿ï¼š\u0026ldquo;Chelsie\u0026rdquo; ç”·æ€§å£°çº¿ï¼š\u0026ldquo;Ethan\u0026rdquo; ğŸ’¾ è¾“å‡ºæ ¼å¼ï¼šæ ‡å‡† .wav éŸ³é¢‘æ–‡ä»¶ ğŸš€ é«˜æ€§èƒ½æ¨ç†ï¼Œé€‚ç”¨äºç”Ÿäº§ç¯å¢ƒ åº”ç”¨åœºæ™¯ æ™ºèƒ½è¯­éŸ³åŠ©æ‰‹å¼€å‘ å†…å®¹åˆ›ä½œä¸æ’­å®¢åˆ¶ä½œ æ— éšœç¢æœåŠ¡ æ•™è‚²ç±»åº”ç”¨ å¤šåª’ä½“å†…å®¹ç”Ÿæˆ å¼€å§‹ä½¿ç”¨ ğŸ’¡ åœ¨å¼€å§‹ä¹‹å‰ï¼Œè¯·ç¡®ä¿æ‚¨çš„ç³»ç»Ÿæ»¡è¶³ä»¥ä¸‹è¦æ±‚ï¼š\nPython 3.8+ CUDA 11.7+ (å¦‚éœ€GPUåŠ é€Ÿ) è‡³å°‘16GBå¯ç”¨å†…å­˜ å®‰è£…ä¾èµ–åº“\nuv init uv add git+https://github.com/huggingface/transformers@v4.51.3-Qwen2.5-Omni-preview uv add accelerate uv add qwen-omni-utils[decord] uv add soundfile uv add torchvision uv sync å®Œæ•´è„šæœ¬ä»£ç ï¼ˆmain_text2audio.pyï¼‰\nimport os import soundfile as sf import torch from transformers import Qwen2_5OmniForConditionalGeneration, Qwen2_5OmniProcessor from qwen_omni_utils import process_mm_info from transformers import AutoConfig def text_to_speech( text_input: str, output_audio_path: str = \u0026#34;output/test_audio.wav\u0026#34;, speaker: str = \u0026#34;Chelsie\u0026#34;, model_path: str = \u0026#34;/home/llm/model/qwen/Omni/\u0026#34; # æ”¹ä¸ºæœ¬åœ°è·¯å¾„æˆ–è¿œç¨‹è·¯å¾„ ): \u0026#34;\u0026#34;\u0026#34; æ–‡æœ¬è½¬è¯­éŸ³æ ¸å¿ƒå‡½æ•° :param text_input: è¾“å…¥æ–‡æœ¬ï¼ˆæ”¯æŒä¸­æ–‡/è‹±æ–‡ï¼‰ :param output_audio_path: éŸ³é¢‘è¾“å‡ºè·¯å¾„ï¼ˆå«æ–‡ä»¶åï¼‰ :param speaker: è¯­éŸ³ç±»å‹ï¼ˆ\u0026#34;Chelsie\u0026#34;å¥³æ€§/\u0026#34;Ethan\u0026#34;ç”·æ€§ï¼‰ :param model_path: æ¨¡å‹è·¯å¾„ï¼ˆæœ¬åœ°/è¿œç¨‹ï¼‰ \u0026#34;\u0026#34;\u0026#34; # 1. åŠ è½½æ¨¡å‹é…ç½®ï¼ˆä¿®å¤ROPEå‚æ•°å…¼å®¹æ€§ï¼‰ config = AutoConfig.from_pretrained(model_path, local_files_only=True) if hasattr(config, \u0026#34;rope_scaling\u0026#34;) and \u0026#34;mrope_section\u0026#34; in config.rope_scaling: config.rope_scaling.pop(\u0026#34;mrope_section\u0026#34;) # 2. åŠ è½½æ¨¡å‹ï¼ˆæ”¯æŒGPUè‡ªåŠ¨åˆ†é…ï¼‰ model = Qwen2_5OmniForConditionalGeneration.from_pretrained( model_path, config=config, torch_dtype=\u0026#34;auto\u0026#34;, device_map=\u0026#34;auto\u0026#34;, local_files_only=(model_path != \u0026#34;Qwen/Qwen2.5-Omni-7B\u0026#34;) ) processor = Qwen2_5OmniProcessor.from_pretrained(model_path) # 3. ç³»ç»Ÿæç¤ºï¼ˆå¿…é¡»åŒ…å«è¯­éŸ³ç”Ÿæˆèƒ½åŠ›å£°æ˜ï¼‰ system_prompt = [ { \u0026#34;role\u0026#34;: \u0026#34;system\u0026#34;, \u0026#34;content\u0026#34;: [ {\u0026#34;type\u0026#34;: \u0026#34;text\u0026#34;, \u0026#34;text\u0026#34;: \u0026#34;You are Qwen, a virtual human developed by the Qwen Team, Alibaba Group, capable of perceiving auditory and visual inputs, as well as generating text and speech.\u0026#34;} ] } ] # 4. æ„å»ºå¯¹è¯ï¼ˆçº¯æ–‡æœ¬è¾“å…¥ï¼‰ conversation = system_prompt + [ {\u0026#34;role\u0026#34;: \u0026#34;user\u0026#34;, \u0026#34;content\u0026#34;: [{\u0026#34;type\u0026#34;: \u0026#34;text\u0026#34;, \u0026#34;text\u0026#34;: text_input}]} ] # 5. å¤„ç†è¾“å…¥æ•°æ® text = processor.apply_chat_template(conversation, add_generation_prompt=True, tokenize=False) audios, images, videos = process_mm_info(conversation, use_audio_in_video=False) # 6. ç”Ÿæˆè¯­éŸ³ inputs = processor( text=text, audio=audios, images=images, videos=videos, return_tensors=\u0026#34;pt\u0026#34;, padding=True, use_audio_in_video=False ).to(model.device, model.dtype) with torch.no_grad(): text_ids, audio = model.generate( **inputs, speaker=speaker, do_sample=True, # å¯ç”¨é‡‡æ ·æ¨¡å¼ä»¥ä½¿ç”¨temperature/top_p temperature=0.8, # æ§åˆ¶éšæœºæ€§ï¼ˆ0.5-1.0è¾ƒè‡ªç„¶ï¼‰ top_p=0.95, # æ ¸é‡‡æ ·å‚æ•° max_new_tokens=1024, # æ§åˆ¶è¯­éŸ³æ—¶é•¿ï¼ˆçº¦15ç§’ï¼‰ use_audio_in_video=False ) # 7. ä¿å­˜ç»“æœ os.makedirs(os.path.dirname(output_audio_path), exist_ok=True) sf.write(output_audio_path, audio.reshape(-1).cpu().numpy(), samplerate=24000) print(f\u0026#34;âœ… ç”Ÿæˆå®Œæˆï¼š{output_audio_path}\u0026#34;) print(f\u0026#34;ğŸ“„ ç”Ÿæˆæ–‡æœ¬ï¼š{processor.batch_decode(text_ids, skip_special_tokens=True)[0]}\u0026#34;) if __name__ == \u0026#34;__main__\u0026#34;: # ç¤ºä¾‹è¾“å…¥ï¼ˆå¯æ›¿æ¢ä¸ºä»»æ„æ–‡æœ¬ï¼‰ input_text = \u0026#34;ä½ å¥½ï¼Œè¿™æ˜¯Qwen2.5-Omniçš„æ–‡æœ¬è½¬è¯­éŸ³ç¤ºä¾‹ã€‚ç¥ä½ ä½¿ç”¨æ„‰å¿«ï¼\u0026#34; # è°ƒç”¨å‡½æ•°ï¼ˆæŒ‡å®šè¾“å‡ºè·¯å¾„å’Œè¯­éŸ³ç±»å‹ï¼‰ text_to_speech( input_text, output_audio_path=\u0026#34;output/hello_qwen.wav\u0026#34;, speaker=\u0026#34;Chelsie\u0026#34; # å¯é€‰\u0026#34;Ethan\u0026#34; ) è¿è¡Œè„šæœ¬\nuv run main.py ","permalink":"https://jackypanster.github.io/ai-stream/posts/how-to-setup-qwen-omni/","summary":"\u003cp\u003e\u003cimg alt=\"Qwen2.5-Omni-7B TTS\" loading=\"lazy\" src=\"https://via.placeholder.com/800x400.png/007bff/ffffff?text=Qwen2.5-Omni-7B+TTS\"\u003e\u003c/p\u003e\n\u003ch2 id=\"æ¦‚è¿°\"\u003eæ¦‚è¿°\u003c/h2\u003e\n\u003cp\u003eæœ¬è„šæœ¬åŸºäº Qwen2.5-Omni-7B å¤šæ¨¡æ€æ¨¡å‹å®ç°æ–‡æœ¬è½¬è¯­éŸ³ï¼ˆTTSï¼‰åŠŸèƒ½ï¼Œæ”¯æŒç”Ÿæˆè‡ªç„¶æµç•…çš„ä¸­æ–‡ / è‹±æ–‡è¯­éŸ³ï¼Œå¹¶æä¾›ä¸¤ç§è¯­éŸ³ç±»å‹ï¼ˆå¥³æ€§ â€œChelsieâ€ã€ç”·æ€§ â€œEthanâ€ï¼‰ã€‚è„šæœ¬å¯å°†è¾“å…¥æ–‡æœ¬è½¬æ¢ä¸ºéŸ³é¢‘æ–‡ä»¶ï¼ˆ.wavæ ¼å¼ï¼‰ï¼Œé€‚ç”¨äºè¯­éŸ³åŠ©æ‰‹ã€å†…å®¹åˆ›ä½œã€æ— éšœç¢æœåŠ¡ç­‰åœºæ™¯ã€‚\u003c/p\u003e\n\u003ch2 id=\"ä¸»è¦ç‰¹æ€§\"\u003eä¸»è¦ç‰¹æ€§\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003eğŸ™ï¸ æ”¯æŒè‡ªç„¶æµç•…çš„ \u003cstrong\u003eä¸­æ–‡/è‹±æ–‡\u003c/strong\u003e è¯­éŸ³åˆæˆ\u003c/li\u003e\n\u003cli\u003eğŸ‘¥ æä¾›ä¸¤ç§è¯­éŸ³ç±»å‹é€‰æ‹©ï¼š\n\u003cul\u003e\n\u003cli\u003eå¥³æ€§å£°çº¿ï¼š\u0026ldquo;Chelsie\u0026rdquo;\u003c/li\u003e\n\u003cli\u003eç”·æ€§å£°çº¿ï¼š\u0026ldquo;Ethan\u0026rdquo;\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eğŸ’¾ è¾“å‡ºæ ¼å¼ï¼šæ ‡å‡† \u003ccode\u003e.wav\u003c/code\u003e éŸ³é¢‘æ–‡ä»¶\u003c/li\u003e\n\u003cli\u003eğŸš€ é«˜æ€§èƒ½æ¨ç†ï¼Œé€‚ç”¨äºç”Ÿäº§ç¯å¢ƒ\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"åº”ç”¨åœºæ™¯\"\u003eåº”ç”¨åœºæ™¯\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003eæ™ºèƒ½è¯­éŸ³åŠ©æ‰‹å¼€å‘\u003c/li\u003e\n\u003cli\u003eå†…å®¹åˆ›ä½œä¸æ’­å®¢åˆ¶ä½œ\u003c/li\u003e\n\u003cli\u003eæ— éšœç¢æœåŠ¡\u003c/li\u003e\n\u003cli\u003eæ•™è‚²ç±»åº”ç”¨\u003c/li\u003e\n\u003cli\u003eå¤šåª’ä½“å†…å®¹ç”Ÿæˆ\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"å¼€å§‹ä½¿ç”¨\"\u003eå¼€å§‹ä½¿ç”¨\u003c/h2\u003e\n\u003cblockquote\u003e\n\u003cp\u003eğŸ’¡ åœ¨å¼€å§‹ä¹‹å‰ï¼Œè¯·ç¡®ä¿æ‚¨çš„ç³»ç»Ÿæ»¡è¶³ä»¥ä¸‹è¦æ±‚ï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003ePython 3.8+\u003c/li\u003e\n\u003cli\u003eCUDA 11.7+ (å¦‚éœ€GPUåŠ é€Ÿ)\u003c/li\u003e\n\u003cli\u003eè‡³å°‘16GBå¯ç”¨å†…å­˜\u003c/li\u003e\n\u003c/ul\u003e\u003c/blockquote\u003e\n\u003cp\u003eå®‰è£…ä¾èµ–åº“\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003euv init\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003euv add git+https://github.com/huggingface/transformers@v4.51.3-Qwen2.5-Omni-preview\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003euv add accelerate\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003euv add qwen-omni-utils\u003cspan style=\"color:#f92672\"\u003e[\u003c/span\u003edecord\u003cspan style=\"color:#f92672\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003euv add soundfile\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003euv add torchvision\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003euv sync\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eå®Œæ•´è„šæœ¬ä»£ç ï¼ˆmain_text2audio.pyï¼‰\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-python\" data-lang=\"python\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e os\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e soundfile \u003cspan style=\"color:#66d9ef\"\u003eas\u003c/span\u003e sf\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e torch\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#f92672\"\u003efrom\u003c/span\u003e transformers \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e Qwen2_5OmniForConditionalGeneration, Qwen2_5OmniProcessor\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#f92672\"\u003efrom\u003c/span\u003e qwen_omni_utils \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e process_mm_info\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#f92672\"\u003efrom\u003c/span\u003e transformers \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e AutoConfig\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#66d9ef\"\u003edef\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003etext_to_speech\u003c/span\u003e(\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    text_input: str,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    output_audio_path: str \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;output/test_audio.wav\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    speaker: str \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Chelsie\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    model_path: str \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;/home/llm/model/qwen/Omni/\u0026#34;\u003c/span\u003e  \u003cspan style=\"color:#75715e\"\u003e# æ”¹ä¸ºæœ¬åœ°è·¯å¾„æˆ–è¿œç¨‹è·¯å¾„\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e):\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;\u0026#34;\u0026#34;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003e    æ–‡æœ¬è½¬è¯­éŸ³æ ¸å¿ƒå‡½æ•°\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003e    :param text_input: è¾“å…¥æ–‡æœ¬ï¼ˆæ”¯æŒä¸­æ–‡/è‹±æ–‡ï¼‰\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003e    :param output_audio_path: éŸ³é¢‘è¾“å‡ºè·¯å¾„ï¼ˆå«æ–‡ä»¶åï¼‰\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003e    :param speaker: è¯­éŸ³ç±»å‹ï¼ˆ\u0026#34;Chelsie\u0026#34;å¥³æ€§/\u0026#34;Ethan\u0026#34;ç”·æ€§ï¼‰\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003e    :param model_path: æ¨¡å‹è·¯å¾„ï¼ˆæœ¬åœ°/è¿œç¨‹ï¼‰\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003e    \u0026#34;\u0026#34;\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#75715e\"\u003e# 1. åŠ è½½æ¨¡å‹é…ç½®ï¼ˆä¿®å¤ROPEå‚æ•°å…¼å®¹æ€§ï¼‰\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    config \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e AutoConfig\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003efrom_pretrained(model_path, local_files_only\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#66d9ef\"\u003eTrue\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e hasattr(config, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;rope_scaling\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003eand\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;mrope_section\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003ein\u003c/span\u003e config\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003erope_scaling:\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        config\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003erope_scaling\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003epop(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;mrope_section\u0026#34;\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#75715e\"\u003e# 2. åŠ è½½æ¨¡å‹ï¼ˆæ”¯æŒGPUè‡ªåŠ¨åˆ†é…ï¼‰\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    model \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e Qwen2_5OmniForConditionalGeneration\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003efrom_pretrained(\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        model_path,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        config\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003econfig,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        torch_dtype\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;auto\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        device_map\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;auto\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        local_files_only\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e(model_path \u003cspan style=\"color:#f92672\"\u003e!=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Qwen/Qwen2.5-Omni-7B\u0026#34;\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    )\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    processor \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e Qwen2_5OmniProcessor\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003efrom_pretrained(model_path)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#75715e\"\u003e# 3. ç³»ç»Ÿæç¤ºï¼ˆå¿…é¡»åŒ…å«è¯­éŸ³ç”Ÿæˆèƒ½åŠ›å£°æ˜ï¼‰\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    system_prompt \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e [\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;role\u0026#34;\u003c/span\u003e: \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;system\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;content\u0026#34;\u003c/span\u003e: [\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                {\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;type\u0026#34;\u003c/span\u003e: \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;text\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;text\u0026#34;\u003c/span\u003e: \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;You are Qwen, a virtual human developed by the Qwen Team, Alibaba Group, capable of perceiving auditory and visual inputs, as well as generating text and speech.\u0026#34;\u003c/span\u003e}\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            ]\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    ]\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#75715e\"\u003e# 4. æ„å»ºå¯¹è¯ï¼ˆçº¯æ–‡æœ¬è¾“å…¥ï¼‰\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    conversation \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e system_prompt \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e [\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        {\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;role\u0026#34;\u003c/span\u003e: \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;user\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;content\u0026#34;\u003c/span\u003e: [{\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;type\u0026#34;\u003c/span\u003e: \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;text\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;text\u0026#34;\u003c/span\u003e: text_input}]}\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    ]\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#75715e\"\u003e# 5. å¤„ç†è¾“å…¥æ•°æ®\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    text \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e processor\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003eapply_chat_template(conversation, add_generation_prompt\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#66d9ef\"\u003eTrue\u003c/span\u003e, tokenize\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#66d9ef\"\u003eFalse\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    audios, images, videos \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e process_mm_info(conversation, use_audio_in_video\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#66d9ef\"\u003eFalse\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#75715e\"\u003e# 6. ç”Ÿæˆè¯­éŸ³\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    inputs \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e processor(\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        text\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003etext, audio\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003eaudios, images\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003eimages, videos\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003evideos,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        return_tensors\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;pt\u0026#34;\u003c/span\u003e, padding\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#66d9ef\"\u003eTrue\u003c/span\u003e, use_audio_in_video\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#66d9ef\"\u003eFalse\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    )\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003eto(model\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003edevice, model\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003edtype)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003ewith\u003c/span\u003e torch\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003eno_grad():\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        text_ids, audio \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e model\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003egenerate(\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#f92672\"\u003e**\u003c/span\u003einputs,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            speaker\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003espeaker,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            do_sample\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#66d9ef\"\u003eTrue\u003c/span\u003e,  \u003cspan style=\"color:#75715e\"\u003e# å¯ç”¨é‡‡æ ·æ¨¡å¼ä»¥ä½¿ç”¨temperature/top_p\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            temperature\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e0.8\u003c/span\u003e,  \u003cspan style=\"color:#75715e\"\u003e# æ§åˆ¶éšæœºæ€§ï¼ˆ0.5-1.0è¾ƒè‡ªç„¶ï¼‰\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            top_p\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e0.95\u003c/span\u003e,       \u003cspan style=\"color:#75715e\"\u003e# æ ¸é‡‡æ ·å‚æ•°\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            max_new_tokens\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e1024\u003c/span\u003e,  \u003cspan style=\"color:#75715e\"\u003e# æ§åˆ¶è¯­éŸ³æ—¶é•¿ï¼ˆçº¦15ç§’ï¼‰\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            use_audio_in_video\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#66d9ef\"\u003eFalse\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        )\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#75715e\"\u003e# 7. ä¿å­˜ç»“æœ\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    os\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003emakedirs(os\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003epath\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003edirname(output_audio_path), exist_ok\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#66d9ef\"\u003eTrue\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    sf\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003ewrite(output_audio_path, audio\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003ereshape(\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003ecpu()\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003enumpy(), samplerate\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e24000\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    print(\u003cspan style=\"color:#e6db74\"\u003ef\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;âœ… ç”Ÿæˆå®Œæˆï¼š\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e{\u003c/span\u003eoutput_audio_path\u003cspan style=\"color:#e6db74\"\u003e}\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    print(\u003cspan style=\"color:#e6db74\"\u003ef\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;ğŸ“„ ç”Ÿæˆæ–‡æœ¬ï¼š\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e{\u003c/span\u003eprocessor\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003ebatch_decode(text_ids, skip_special_tokens\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#66d9ef\"\u003eTrue\u003c/span\u003e)[\u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e]\u003cspan style=\"color:#e6db74\"\u003e}\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e __name__ \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;__main__\u0026#34;\u003c/span\u003e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#75715e\"\u003e# ç¤ºä¾‹è¾“å…¥ï¼ˆå¯æ›¿æ¢ä¸ºä»»æ„æ–‡æœ¬ï¼‰\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    input_text \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;ä½ å¥½ï¼Œè¿™æ˜¯Qwen2.5-Omniçš„æ–‡æœ¬è½¬è¯­éŸ³ç¤ºä¾‹ã€‚ç¥ä½ ä½¿ç”¨æ„‰å¿«ï¼\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#75715e\"\u003e# è°ƒç”¨å‡½æ•°ï¼ˆæŒ‡å®šè¾“å‡ºè·¯å¾„å’Œè¯­éŸ³ç±»å‹ï¼‰\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    text_to_speech(\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        input_text,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        output_audio_path\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;output/hello_qwen.wav\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        speaker\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Chelsie\u0026#34;\u003c/span\u003e  \u003cspan style=\"color:#75715e\"\u003e# å¯é€‰\u0026#34;Ethan\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    )\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eè¿è¡Œè„šæœ¬\u003c/p\u003e","title":"Qwen2.5-Omni-7B æ–‡æœ¬è½¬è¯­éŸ³éƒ¨ç½²æŒ‡å—"}]