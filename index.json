[{"content":"Qwen3-30B æŠ€æœ¯ä¼˜åŒ–å®è·µï¼ˆäºŒï¼‰ï¼šæ€è€ƒæ¨¡å¼æ§åˆ¶ä¸æ€§èƒ½æå‡ æœ¬æ–‡æ˜¯ã€Šä»32Kåˆ°131Kï¼šQwen3-30Bå¤§æ¨¡å‹ä¸Šä¸‹æ–‡æ‰©å±•å®è·µã€‹çš„ç»­ç¯‡ï¼Œèšç„¦äºæ¨¡å‹æ€§èƒ½è°ƒä¼˜ç‰¹åˆ«æ˜¯æ€è€ƒæ¨¡å¼ï¼ˆreasoning modeï¼‰æ§åˆ¶çš„æŠ€æœ¯ç»†èŠ‚ä¸å®è·µç»éªŒã€‚\nåœ¨å‰æ–‡ä¸­ï¼Œæˆ‘ä»¬è¯¦ç»†ä»‹ç»äº†å¦‚ä½•ä½¿ç”¨YaRNæŠ€æœ¯å°†Qwen3-30Bçš„ä¸Šä¸‹æ–‡é•¿åº¦ä»32Kæ‰©å±•åˆ°131Kã€‚ä»Šå¤©ï¼Œæˆ‘ä»¬å°†æ·±å…¥æ¢è®¨å¦ä¸€ä¸ªå…³é”®ä¼˜åŒ–ç»´åº¦ï¼šæ€è€ƒæ¨¡å¼æ§åˆ¶åŠå…¶å¯¹æ€§èƒ½çš„å½±å“ã€‚é€šè¿‡ä¸€ç³»åˆ—å®éªŒå’Œè°ƒä¼˜ï¼Œæˆ‘ä»¬å‘ç°ç¦ç”¨æ€è€ƒæ¨¡å¼å¯ä»¥æ˜¾è‘—æå‡æ¨¡å‹å“åº”é€Ÿåº¦å’Œå†…å­˜æ•ˆç‡ï¼Œç‰¹åˆ«é€‚åˆç¼–ç¨‹å’Œç›´æ¥è¾“å‡ºç±»ä»»åŠ¡åœºæ™¯ã€‚\nğŸ” æ€è€ƒæ¨¡å¼ï¼ˆReasoning Modeï¼‰è§£æ ä»€ä¹ˆæ˜¯æ€è€ƒæ¨¡å¼ï¼Ÿ æ€è€ƒæ¨¡å¼ï¼ˆReasoning Modeï¼Œä¹Ÿç§°ä¸ºThinking Modeï¼‰æ˜¯Qwen3ç³»åˆ—æ¨¡å‹çš„ä¸€ä¸ªç‰¹æ€§ï¼Œè®©æ¨¡å‹èƒ½å¤Ÿç”Ÿæˆä¸­é—´æ€è€ƒæ­¥éª¤ï¼Œè¿™äº›æ­¥éª¤è¢«åŒ…å«åœ¨\u0026lt;think\u0026gt;...\u0026lt;/think\u0026gt;æ ‡ç­¾å†…ã€‚ç†è®ºä¸Šï¼Œè¿™ç§\u0026quot;æ€è€ƒè¿‡ç¨‹\u0026quot;æœ‰åŠ©äºæ¨¡å‹è¿›è¡Œæ›´å¤æ‚çš„æ¨ç†ï¼Œä½†åŒæ—¶ä¹Ÿå¼•å…¥äº†é¢å¤–çš„è®¡ç®—å’Œå†…å­˜å¼€é”€ã€‚\nåœ¨é»˜è®¤é…ç½®ä¸‹ï¼ŒQwen3æ¨¡å‹ä¼šå¯ç”¨æ€è€ƒæ¨¡å¼ï¼Œäº§ç”Ÿç±»ä¼¼ä»¥ä¸‹çš„è¾“å‡ºï¼š\n\u0026lt;think\u0026gt; é¦–å…ˆï¼Œæˆ‘éœ€è¦åˆ†æç”¨æˆ·çš„é—®é¢˜ï¼šå¦‚ä½•å®ç°ä¸€ä¸ªç®€å•çš„æ–‡ä»¶è¯»å†™åŠŸèƒ½ã€‚ æˆ‘åº”è¯¥ä½¿ç”¨Pythonçš„å†…ç½®æ–‡ä»¶æ“ä½œåŠŸèƒ½ã€‚ åŸºæœ¬æ­¥éª¤åº”è¯¥æ˜¯ï¼š 1. æ‰“å¼€æ–‡ä»¶ï¼ˆå¯ä»¥ä½¿ç”¨withè¯­å¥è‡ªåŠ¨ç®¡ç†èµ„æºï¼‰ 2. è¯»å–æˆ–å†™å…¥å†…å®¹ 3. ç¡®ä¿æ–‡ä»¶æ­£ç¡®å…³é—­ \u0026lt;/think\u0026gt; ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•çš„Pythonæ–‡ä»¶è¯»å†™ç¤ºä¾‹ï¼š ```python # å†™å…¥æ–‡ä»¶ with open(\u0026#39;example.txt\u0026#39;, \u0026#39;w\u0026#39;) as file: file.write(\u0026#39;Hello, World!\u0026#39;) # è¯»å–æ–‡ä»¶ with open(\u0026#39;example.txt\u0026#39;, \u0026#39;r\u0026#39;) as file: content = file.read() print(content) ### æ€è€ƒæ¨¡å¼å®ç°æœºåˆ¶ vLLMéƒ¨ç½²Qwen3æ¨¡å‹æ—¶ï¼Œæ€è€ƒæ¨¡å¼é€šè¿‡ä¸¤ç§æ–¹å¼å®ç°æ§åˆ¶ï¼š 1. **æœåŠ¡å™¨çº§æ§åˆ¶**ï¼šé€šè¿‡éƒ¨ç½²å‚æ•°`--enable-reasoning`å’Œ`--reasoning-parser deepseek_r1`å¯ç”¨ 2. **APIçº§æ§åˆ¶**ï¼šé€šè¿‡APIè°ƒç”¨ä¸­çš„`chat_template_kwargs`å‚æ•°æˆ–`enable_thinking`å‚æ•°åŠ¨æ€æ§åˆ¶ æˆ‘ä»¬çš„å‘ç°æ˜¯ï¼Œ**ä»…åˆ é™¤æœåŠ¡å™¨çº§åˆ«çš„å‚æ•°å¹¶ä¸è¶³å¤Ÿå®Œå…¨ç¦ç”¨æ€è€ƒæ¨¡å¼**ï¼Œæ¨¡å‹åœ¨æŸäº›æƒ…å†µä¸‹ä»ä¼šäº§ç”Ÿæ€è€ƒè¿‡ç¨‹ã€‚æ›´å½»åº•çš„è§£å†³æ–¹æ¡ˆæ˜¯ä½¿ç”¨è‡ªå®šä¹‰èŠå¤©æ¨¡æ¿ã€‚ ## ğŸ’¡ ç¦ç”¨æ€è€ƒæ¨¡å¼çš„æŠ€æœ¯å®ç° ### è‡ªå®šä¹‰èŠå¤©æ¨¡æ¿æ–¹æ¡ˆ ç»è¿‡ç ”ç©¶Qwenå®˜æ–¹æ–‡æ¡£å’Œå®éªŒï¼Œæˆ‘ä»¬å‘ç°ä½¿ç”¨è‡ªå®šä¹‰èŠå¤©æ¨¡æ¿æ˜¯å®Œå…¨ç¦ç”¨æ€è€ƒæ¨¡å¼çš„æœ€å¯é æ–¹æ³•ã€‚æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªåä¸º`qwen3_nonthinking.jinja`çš„æ¨¡æ¿æ–‡ä»¶ï¼š ```jinja {% if messages %} {% set loop_messages = messages %} {% else %} {% set loop_messages = [{\u0026#39;role\u0026#39;: \u0026#39;system\u0026#39;, \u0026#39;content\u0026#39;: \u0026#39;\u0026#39;}] %} {% endif %} {% for message in loop_messages %} {% if message[\u0026#39;role\u0026#39;] == \u0026#39;user\u0026#39; %} \u0026lt;|im_start|\u0026gt;user {{ message[\u0026#39;content\u0026#39;] }}\u0026lt;|im_end|\u0026gt; {% elif message[\u0026#39;role\u0026#39;] == \u0026#39;assistant\u0026#39; %} \u0026lt;|im_start|\u0026gt;assistant {{ message[\u0026#39;content\u0026#39;] }}\u0026lt;|im_end|\u0026gt; {% elif message[\u0026#39;role\u0026#39;] == \u0026#39;system\u0026#39; %} \u0026lt;|im_start|\u0026gt;system {{ message[\u0026#39;content\u0026#39;] }}\u0026lt;|im_end|\u0026gt; {% endif %} {% endfor %} \u0026lt;|im_start|\u0026gt;assistant {% if add_generation_prompt is defined and add_generation_prompt %}{{ generation_prompt }}{% endif %} è¿™ä¸ªæ¨¡æ¿çš„å…³é”®ç‚¹æ˜¯ç§»é™¤äº†æ‰€æœ‰ä¸æ€è€ƒæ¨¡å¼ç›¸å…³çš„æ ‡ç­¾å’Œå¤„ç†é€»è¾‘ï¼Œç¡®ä¿æ¨¡å‹æ— æ³•ç”Ÿæˆ\u0026lt;think\u0026gt;...\u0026lt;/think\u0026gt;å—ï¼Œå³ä½¿APIè¯·æ±‚ä¸­å°è¯•å¯ç”¨æ€è€ƒæ¨¡å¼ã€‚\néƒ¨ç½²è„šæœ¬ä¿®æ”¹ ä¸ºäº†ä½¿ç”¨è¿™ä¸ªæ¨¡æ¿ï¼Œæˆ‘ä»¬ä¿®æ”¹äº†éƒ¨ç½²è„šæœ¬ï¼Œæ·»åŠ äº†ä»¥ä¸‹å…³é”®å‚æ•°ï¼š\n# é‡è¦ï¼š1. æŒ‚è½½å·¥ä½œç›®å½•ä½¿æ¨¡æ¿æ–‡ä»¶å¯è®¿é—® -v /home/llm/workspace/deploy-qwen:/workspace/deploy-qwen \\ # é‡è¦ï¼š2. ä½¿ç”¨è‡ªå®šä¹‰æ¨¡æ¿å½»åº•ç¦ç”¨æ€è€ƒæ¨¡å¼ --chat-template /workspace/deploy-qwen/qwen3_nonthinking.jinja åŒæ—¶ï¼Œæˆ‘ä»¬åœ¨è„šæœ¬ä¸­æ·»åŠ äº†è¯¦ç»†æ³¨é‡Šï¼Œä¾¿äºåœ¨ä¸åŒåœºæ™¯ä¸‹å¿«é€Ÿåˆ‡æ¢æ¨¡å¼ã€‚\nğŸ“Š æ€§èƒ½æå‡æµ‹é‡ä¸åˆ†æ å®æµ‹æ€§èƒ½æ•°æ® æˆ‘ä»¬é€šè¿‡å®é™…éƒ¨ç½²æµ‹è¯•ï¼Œè§‚å¯Ÿåˆ°ç¦ç”¨æ€è€ƒæ¨¡å¼å¸¦æ¥çš„æ€§èƒ½æå‡ï¼š\næŒ‡æ ‡ å¯ç”¨æ€è€ƒæ¨¡å¼ ç¦ç”¨æ€è€ƒæ¨¡å¼ æå‡æ¯”ä¾‹ ç”Ÿæˆé€Ÿåº¦ ~12-14 tokens/s ~17-19 tokens/s +15-20% GPU KVç¼“å­˜ä½¿ç”¨ç‡ ~12-15% ~8-9% -30-40% å†…å­˜å ç”¨ è¾ƒé«˜ è¾ƒä½ -20-25% è¾“å‡ºä¸€è‡´æ€§ å‡ºç°æ¨ç†è¿‡ç¨‹ ç›´æ¥è¾“å‡ºç»“æœ æ›´åŠ ç®€æ´ ä¸€ä¸ªå…¸å‹çš„æ€§èƒ½æ—¥å¿—ç‰‡æ®µæ˜¾ç¤ºï¼š\nINFO 06-03 23:06:14 [metrics.py:486] Avg prompt throughput: 2315.5 tokens/s, Avg generation throughput: 12.4 tokens/s, Running: 2 reqs, Swapped: 0 reqs, Pending: 0 reqs, GPU KV cache usage: 8.7%, CPU KV cache usage: 0.0%. INFO 06-03 23:06:19 [metrics.py:486] Avg prompt throughput: 506.3 tokens/s, Avg generation throughput: 17.4 tokens/s, Running: 2 reqs, Swapped: 0 reqs, Pending: 0 reqs, GPU KV cache usage: 8.7%, CPU KV cache usage: 0.0%. æ€§èƒ½æå‡åŸç†åˆ†æ ç¦ç”¨æ€è€ƒæ¨¡å¼å¸¦æ¥æ€§èƒ½æå‡çš„ä¸»è¦åŸå› åŒ…æ‹¬ï¼š\nè®¡ç®—è´Ÿè½½å‡å°‘ï¼šä¸å†ç”Ÿæˆä¸­é—´æ€è€ƒæ­¥éª¤ï¼Œå‡å°‘äº†æ€»ä½“éœ€è¦ç”Ÿæˆçš„tokenæ•°é‡\næ³¨æ„åŠ›è®¡ç®—ç®€åŒ–ï¼šæ¨ç†è¿‡ç¨‹é€šå¸¸éœ€è¦æ¨¡å‹åœ¨æ›´å¤§çš„ä¸Šä¸‹æ–‡çª—å£ä¸­è¿›è¡Œæ³¨æ„åŠ›è®¡ç®—ï¼Œç¦ç”¨åæ³¨æ„åŠ›æœºåˆ¶æ›´èšç„¦\nå†…å­˜ä½¿ç”¨ä¼˜åŒ–ï¼šæ— éœ€ä¸ºæ€è€ƒè¿‡ç¨‹åˆ†é…é¢å¤–çš„KVç¼“å­˜ç©ºé—´ï¼Œç‰¹åˆ«æ˜¯åœ¨131Kè¶…é•¿ä¸Šä¸‹æ–‡æ¨¡å¼ä¸‹ï¼Œè¿™ä¸€ä¼˜åŠ¿æ›´ä¸ºæ˜¾è‘—\nå†…éƒ¨çŠ¶æ€è·Ÿè¸ªç®€åŒ–ï¼šæ¨¡å‹ä¸å†éœ€è¦ç»´æŠ¤å’Œç®¡ç†é¢å¤–çš„æ€è€ƒçŠ¶æ€ï¼Œå‡å°‘äº†å†…éƒ¨çŠ¶æ€è½¬æ¢çš„å¤æ‚åº¦\nğŸ”§ é€‚ç”¨åœºæ™¯ä¸å‚æ•°è°ƒä¼˜ æœ€é€‚åˆç¦ç”¨æ€è€ƒæ¨¡å¼çš„åœºæ™¯ ä»£ç ç”Ÿæˆä»»åŠ¡ï¼šç›´æ¥è¾“å‡ºä»£ç è€Œéè¯¦ç»†è§£é‡Šè¿‡ç¨‹ ç®€æ´é—®ç­”ï¼šéœ€è¦ç®€çŸ­ç›´æ¥ç­”æ¡ˆçš„åœºæ™¯ APIé›†æˆï¼šä½œä¸ºåç«¯æœåŠ¡é›†æˆåˆ°å…¶ä»–ç³»ç»Ÿæ—¶ é«˜å¹¶å‘æœåŠ¡ï¼šéœ€è¦å¤„ç†å¤§é‡è¯·æ±‚æ—¶ å†…å­˜å—é™ç¯å¢ƒï¼šç¡¬ä»¶èµ„æºç›¸å¯¹æœ‰é™æ—¶ ç¼–ç¨‹ä»»åŠ¡æœ€ä½³å‚æ•°ç»„åˆ åŸºäºæˆ‘ä»¬çš„æµ‹è¯•ï¼Œç¦ç”¨æ€è€ƒæ¨¡å¼åï¼Œç¼–ç¨‹ä»»åŠ¡æ¨èä»¥ä¸‹å‚æ•°è®¾ç½®ï¼š\n{ \u0026#34;temperature\u0026#34;: 0.2, \u0026#34;top_p\u0026#34;: 0.6, \u0026#34;top_k\u0026#34;: 50, \u0026#34;presence_penalty\u0026#34;: 0.0, \u0026#34;frequency_penalty\u0026#34;: 0.0 } è¿™ç»„å‚æ•°æä¾›äº†é«˜ç¡®å®šæ€§å’Œä¸€è‡´æ€§ï¼Œä½¿ç¼–ç è¾“å‡ºæ›´å¯é ã€‚\nğŸ”„ æ¨¡å¼åˆ‡æ¢æ–¹æ³• æˆ‘ä»¬åœ¨éƒ¨ç½²è„šæœ¬ä¸­æä¾›äº†è¯¦ç»†çš„åˆ‡æ¢æŒ‡å—ï¼š\nä¿æŒç¦ç”¨æ€è€ƒæ¨¡å¼ï¼ˆé»˜è®¤é…ç½®ï¼‰ ä¿ç•™--chat-templateå‚æ•° åˆ é™¤--enable-reasoningå’Œ--reasoning-parserå‚æ•° å¯ç”¨æ€è€ƒæ¨¡å¼ åˆ é™¤--chat-templateå‚æ•° æ·»åŠ ä»¥ä¸‹å‚æ•°ï¼š --enable-reasoning \\ --reasoning-parser deepseek_r1 åº”ç”¨æ›´æ”¹ docker stop coder \u0026amp;\u0026amp; docker rm coder \u0026amp;\u0026amp; ./deploy-32k.sh # æˆ– ./deploy-131k.sh ğŸ§© ä¸YaRNæ‰©å±•çš„ååŒä¼˜åŒ– ç¦ç”¨æ€è€ƒæ¨¡å¼ä¸YaRNä¸Šä¸‹æ–‡æ‰©å±•æŠ€æœ¯ç»“åˆä½¿ç”¨æ—¶ï¼Œèƒ½å¸¦æ¥æ›´å…¨é¢çš„æ€§èƒ½å’Œèƒ½åŠ›æå‡ï¼š\nå†…å­˜æ•ˆç‡å€å¢ï¼šåœ¨è¶…é•¿ä¸Šä¸‹æ–‡åœºæ™¯ä¸‹ï¼Œç¦ç”¨æ€è€ƒæ¨¡å¼èƒ½æ˜¾è‘—é™ä½YaRNæ‰©å±•å¸¦æ¥çš„é¢å¤–å†…å­˜å‹åŠ›\næ‰©å±•æ½œåŠ›æé«˜ï¼šç†è®ºä¸Šï¼Œé€šè¿‡ç¦ç”¨æ€è€ƒæ¨¡å¼ï¼ŒYaRNå› å­å¯ä»¥è¿›ä¸€æ­¥æé«˜ï¼ˆä¾‹å¦‚ä»4.0åˆ°4.5æˆ–æ›´é«˜ï¼‰ï¼Œå®ç°æ›´é•¿ä¸Šä¸‹æ–‡\nå“åº”é€Ÿåº¦æå‡ï¼šç‰¹åˆ«æ˜¯åœ¨å¤„ç†å¤§å‹ä»£ç åº“æˆ–é•¿æ–‡æ¡£æ—¶ï¼Œç¦ç”¨æ€è€ƒæ¨¡å¼æä¾›äº†æ›´å¿«çš„tokenç”Ÿæˆé€Ÿåº¦\nğŸš€ æœªæ¥ä¼˜åŒ–æ–¹å‘ åŸºäºæˆ‘ä»¬çš„ç»éªŒï¼Œæ¨èä»¥ä¸‹ä¼˜åŒ–æ–¹å‘è¿›ä¸€æ­¥æå‡æ€§èƒ½ï¼š\nå¯å‘å¼è·¯ç”±ï¼šæ„å»ºæ™ºèƒ½è·¯ç”±å±‚ï¼Œæ ¹æ®è¾“å…¥ç±»å‹è‡ªåŠ¨é€‰æ‹©å¯ç”¨æˆ–ç¦ç”¨æ€è€ƒæ¨¡å¼\nåœºæ™¯è‡ªé€‚åº”ï¼šå¼€å‘èƒ½æ ¹æ®è¾“å…¥åŠ¨æ€è°ƒæ•´æ€è€ƒæ¨¡å¼çš„æ··åˆç­–ç•¥\nPromptå·¥ç¨‹ä¼˜åŒ–ï¼šç ”ç©¶ç‰¹å®špromptæ¨¡å¼ï¼Œåœ¨ç¦ç”¨æ€è€ƒæ¨¡å¼çš„åŒæ—¶ä¿æŒé«˜è´¨é‡æ¨ç†èƒ½åŠ›\né‡åŒ–ä¸æ€è€ƒæ¨¡å¼ååŒä¼˜åŒ–ï¼šæ¢ç´¢å°†4ä½æˆ–8ä½é‡åŒ–ä¸æ€è€ƒæ¨¡å¼ç¦ç”¨ç»“åˆï¼Œè¿›ä¸€æ­¥æå‡æ€§èƒ½\nğŸ ç»“è®º é€šè¿‡æ·±å…¥ç ”ç©¶å’Œå®è·µï¼Œæˆ‘ä»¬è¯æ˜äº†å¯¹Qwen3-30Bæ¨¡å‹æ€è€ƒæ¨¡å¼çš„æ§åˆ¶æ˜¯ä¸€ç§æ•ˆæœæ˜¾è‘—çš„æ€§èƒ½ä¼˜åŒ–æŠ€æœ¯ã€‚ç¦ç”¨æ€è€ƒæ¨¡å¼èƒ½å¸¦æ¥15-20%çš„é€Ÿåº¦æå‡å’Œæ›´é«˜çš„å†…å­˜æ•ˆç‡ï¼Œç‰¹åˆ«é€‚åˆç¼–ç¨‹ä»»åŠ¡å’Œéœ€è¦ç›´æ¥è¾“å‡ºçš„åœºæ™¯ã€‚\nè¿™ç§æŠ€æœ¯ä¸éœ€è¦æ¨¡å‹å¾®è°ƒæˆ–å¤æ‚çš„GPUä¼˜åŒ–ï¼Œä»…é€šè¿‡æ¨¡æ¿å’Œé…ç½®ä¿®æ”¹å°±èƒ½å®ç°ï¼Œæ˜¯ä¸€ç§ä½æˆæœ¬ã€é«˜æ”¶ç›Šçš„ä¼˜åŒ–æ–¹æ¡ˆã€‚ç»“åˆYaRNä¸Šä¸‹æ–‡æ‰©å±•ï¼Œæˆ‘ä»¬èƒ½å¤Ÿæ„å»ºä¸€ä¸ªå…¼å…·é«˜æ€§èƒ½å’Œå¼ºå¤§èƒ½åŠ›çš„å¤§æ¨¡å‹æœåŠ¡ã€‚\nä½œè€…è¯´æ˜ï¼šæœ¬æ–‡æ‰€æœ‰æµ‹è¯•å‡åŸºäºQwen3-30B-A3Bæ¨¡å‹åœ¨4Ã—NVIDIA GPUä¸Šä½¿ç”¨vLLM v0.8.5è¿›è¡Œï¼Œå…·ä½“ç¡¬ä»¶ç¯å¢ƒä¸º4Ã—GPU(æ¯å¡22GB VRAM)ï¼Œ512GB RAMï¼Œ56æ ¸CPUï¼Œ2TB SSDã€‚å®é™…æ€§èƒ½å¯èƒ½å› ç¡¬ä»¶é…ç½®ã€æ¨¡å‹ç‰ˆæœ¬å’Œå·¥ä½œè´Ÿè½½ç‰¹æ€§è€Œæœ‰æ‰€ä¸åŒã€‚\n","permalink":"https://jackypanster.github.io/ai-stream/posts/deploy-qwen3-part2/","summary":"\u003ch1 id=\"qwen3-30b-æŠ€æœ¯ä¼˜åŒ–å®è·µäºŒæ€è€ƒæ¨¡å¼æ§åˆ¶ä¸æ€§èƒ½æå‡\"\u003eQwen3-30B æŠ€æœ¯ä¼˜åŒ–å®è·µï¼ˆäºŒï¼‰ï¼šæ€è€ƒæ¨¡å¼æ§åˆ¶ä¸æ€§èƒ½æå‡\u003c/h1\u003e\n\u003cblockquote\u003e\n\u003cp\u003eæœ¬æ–‡æ˜¯\u003ca href=\"blog-post.md\"\u003eã€Šä»32Kåˆ°131Kï¼šQwen3-30Bå¤§æ¨¡å‹ä¸Šä¸‹æ–‡æ‰©å±•å®è·µã€‹\u003c/a\u003eçš„ç»­ç¯‡ï¼Œèšç„¦äºæ¨¡å‹æ€§èƒ½è°ƒä¼˜ç‰¹åˆ«æ˜¯æ€è€ƒæ¨¡å¼ï¼ˆreasoning modeï¼‰æ§åˆ¶çš„æŠ€æœ¯ç»†èŠ‚ä¸å®è·µç»éªŒã€‚\u003c/p\u003e\u003c/blockquote\u003e\n\u003cp\u003eåœ¨å‰æ–‡ä¸­ï¼Œæˆ‘ä»¬è¯¦ç»†ä»‹ç»äº†å¦‚ä½•ä½¿ç”¨YaRNæŠ€æœ¯å°†Qwen3-30Bçš„ä¸Šä¸‹æ–‡é•¿åº¦ä»32Kæ‰©å±•åˆ°131Kã€‚ä»Šå¤©ï¼Œæˆ‘ä»¬å°†æ·±å…¥æ¢è®¨å¦ä¸€ä¸ªå…³é”®ä¼˜åŒ–ç»´åº¦ï¼š\u003cstrong\u003eæ€è€ƒæ¨¡å¼æ§åˆ¶\u003c/strong\u003eåŠå…¶å¯¹æ€§èƒ½çš„å½±å“ã€‚é€šè¿‡ä¸€ç³»åˆ—å®éªŒå’Œè°ƒä¼˜ï¼Œæˆ‘ä»¬å‘ç°ç¦ç”¨æ€è€ƒæ¨¡å¼å¯ä»¥æ˜¾è‘—æå‡æ¨¡å‹å“åº”é€Ÿåº¦å’Œå†…å­˜æ•ˆç‡ï¼Œç‰¹åˆ«é€‚åˆç¼–ç¨‹å’Œç›´æ¥è¾“å‡ºç±»ä»»åŠ¡åœºæ™¯ã€‚\u003c/p\u003e\n\u003ch2 id=\"-æ€è€ƒæ¨¡å¼reasoning-modeè§£æ\"\u003eğŸ” æ€è€ƒæ¨¡å¼ï¼ˆReasoning Modeï¼‰è§£æ\u003c/h2\u003e\n\u003ch3 id=\"ä»€ä¹ˆæ˜¯æ€è€ƒæ¨¡å¼\"\u003eä»€ä¹ˆæ˜¯æ€è€ƒæ¨¡å¼ï¼Ÿ\u003c/h3\u003e\n\u003cp\u003eæ€è€ƒæ¨¡å¼ï¼ˆReasoning Modeï¼Œä¹Ÿç§°ä¸ºThinking Modeï¼‰æ˜¯Qwen3ç³»åˆ—æ¨¡å‹çš„ä¸€ä¸ªç‰¹æ€§ï¼Œè®©æ¨¡å‹èƒ½å¤Ÿç”Ÿæˆä¸­é—´æ€è€ƒæ­¥éª¤ï¼Œè¿™äº›æ­¥éª¤è¢«åŒ…å«åœ¨\u003ccode\u003e\u0026lt;think\u0026gt;...\u0026lt;/think\u0026gt;\u003c/code\u003eæ ‡ç­¾å†…ã€‚ç†è®ºä¸Šï¼Œè¿™ç§\u0026quot;æ€è€ƒè¿‡ç¨‹\u0026quot;æœ‰åŠ©äºæ¨¡å‹è¿›è¡Œæ›´å¤æ‚çš„æ¨ç†ï¼Œä½†åŒæ—¶ä¹Ÿå¼•å…¥äº†é¢å¤–çš„è®¡ç®—å’Œå†…å­˜å¼€é”€ã€‚\u003c/p\u003e\n\u003cp\u003eåœ¨é»˜è®¤é…ç½®ä¸‹ï¼ŒQwen3æ¨¡å‹ä¼šå¯ç”¨æ€è€ƒæ¨¡å¼ï¼Œäº§ç”Ÿç±»ä¼¼ä»¥ä¸‹çš„è¾“å‡ºï¼š\u003c/p\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003e\u0026lt;think\u0026gt;\né¦–å…ˆï¼Œæˆ‘éœ€è¦åˆ†æç”¨æˆ·çš„é—®é¢˜ï¼šå¦‚ä½•å®ç°ä¸€ä¸ªç®€å•çš„æ–‡ä»¶è¯»å†™åŠŸèƒ½ã€‚\næˆ‘åº”è¯¥ä½¿ç”¨Pythonçš„å†…ç½®æ–‡ä»¶æ“ä½œåŠŸèƒ½ã€‚\nåŸºæœ¬æ­¥éª¤åº”è¯¥æ˜¯ï¼š\n1. æ‰“å¼€æ–‡ä»¶ï¼ˆå¯ä»¥ä½¿ç”¨withè¯­å¥è‡ªåŠ¨ç®¡ç†èµ„æºï¼‰\n2. è¯»å–æˆ–å†™å…¥å†…å®¹\n3. ç¡®ä¿æ–‡ä»¶æ­£ç¡®å…³é—­\n\u0026lt;/think\u0026gt;\n\nä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•çš„Pythonæ–‡ä»¶è¯»å†™ç¤ºä¾‹ï¼š\n\n```python\n# å†™å…¥æ–‡ä»¶\nwith open(\u0026#39;example.txt\u0026#39;, \u0026#39;w\u0026#39;) as file:\n    file.write(\u0026#39;Hello, World!\u0026#39;)\n\n# è¯»å–æ–‡ä»¶\nwith open(\u0026#39;example.txt\u0026#39;, \u0026#39;r\u0026#39;) as file:\n    content = file.read()\n    print(content)\n\u003c/code\u003e\u003c/pre\u003e\u003cpre tabindex=\"0\"\u003e\u003ccode\u003e\n### æ€è€ƒæ¨¡å¼å®ç°æœºåˆ¶\n\nvLLMéƒ¨ç½²Qwen3æ¨¡å‹æ—¶ï¼Œæ€è€ƒæ¨¡å¼é€šè¿‡ä¸¤ç§æ–¹å¼å®ç°æ§åˆ¶ï¼š\n\n1. **æœåŠ¡å™¨çº§æ§åˆ¶**ï¼šé€šè¿‡éƒ¨ç½²å‚æ•°`--enable-reasoning`å’Œ`--reasoning-parser deepseek_r1`å¯ç”¨\n   \n2. **APIçº§æ§åˆ¶**ï¼šé€šè¿‡APIè°ƒç”¨ä¸­çš„`chat_template_kwargs`å‚æ•°æˆ–`enable_thinking`å‚æ•°åŠ¨æ€æ§åˆ¶\n\næˆ‘ä»¬çš„å‘ç°æ˜¯ï¼Œ**ä»…åˆ é™¤æœåŠ¡å™¨çº§åˆ«çš„å‚æ•°å¹¶ä¸è¶³å¤Ÿå®Œå…¨ç¦ç”¨æ€è€ƒæ¨¡å¼**ï¼Œæ¨¡å‹åœ¨æŸäº›æƒ…å†µä¸‹ä»ä¼šäº§ç”Ÿæ€è€ƒè¿‡ç¨‹ã€‚æ›´å½»åº•çš„è§£å†³æ–¹æ¡ˆæ˜¯ä½¿ç”¨è‡ªå®šä¹‰èŠå¤©æ¨¡æ¿ã€‚\n\n## ğŸ’¡ ç¦ç”¨æ€è€ƒæ¨¡å¼çš„æŠ€æœ¯å®ç°\n\n### è‡ªå®šä¹‰èŠå¤©æ¨¡æ¿æ–¹æ¡ˆ\n\nç»è¿‡ç ”ç©¶Qwenå®˜æ–¹æ–‡æ¡£å’Œå®éªŒï¼Œæˆ‘ä»¬å‘ç°ä½¿ç”¨è‡ªå®šä¹‰èŠå¤©æ¨¡æ¿æ˜¯å®Œå…¨ç¦ç”¨æ€è€ƒæ¨¡å¼çš„æœ€å¯é æ–¹æ³•ã€‚æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªåä¸º`qwen3_nonthinking.jinja`çš„æ¨¡æ¿æ–‡ä»¶ï¼š\n\n```jinja\n{% if messages %}\n{% set loop_messages = messages %}\n{% else %}\n{% set loop_messages = [{\u0026#39;role\u0026#39;: \u0026#39;system\u0026#39;, \u0026#39;content\u0026#39;: \u0026#39;\u0026#39;}] %}\n{% endif %}\n\n{% for message in loop_messages %}\n{% if message[\u0026#39;role\u0026#39;] == \u0026#39;user\u0026#39; %}\n\u0026lt;|im_start|\u0026gt;user\n{{ message[\u0026#39;content\u0026#39;] }}\u0026lt;|im_end|\u0026gt;\n{% elif message[\u0026#39;role\u0026#39;] == \u0026#39;assistant\u0026#39; %}\n\u0026lt;|im_start|\u0026gt;assistant\n{{ message[\u0026#39;content\u0026#39;] }}\u0026lt;|im_end|\u0026gt;\n{% elif message[\u0026#39;role\u0026#39;] == \u0026#39;system\u0026#39; %}\n\u0026lt;|im_start|\u0026gt;system\n{{ message[\u0026#39;content\u0026#39;] }}\u0026lt;|im_end|\u0026gt;\n{% endif %}\n{% endfor %}\n\u0026lt;|im_start|\u0026gt;assistant\n{% if add_generation_prompt is defined and add_generation_prompt %}{{ generation_prompt }}{% endif %}\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eè¿™ä¸ªæ¨¡æ¿çš„å…³é”®ç‚¹æ˜¯\u003cstrong\u003eç§»é™¤äº†æ‰€æœ‰ä¸æ€è€ƒæ¨¡å¼ç›¸å…³çš„æ ‡ç­¾å’Œå¤„ç†é€»è¾‘\u003c/strong\u003eï¼Œç¡®ä¿æ¨¡å‹æ— æ³•ç”Ÿæˆ\u003ccode\u003e\u0026lt;think\u0026gt;...\u0026lt;/think\u0026gt;\u003c/code\u003eå—ï¼Œå³ä½¿APIè¯·æ±‚ä¸­å°è¯•å¯ç”¨æ€è€ƒæ¨¡å¼ã€‚\u003c/p\u003e","title":"Qwen3-30B æŠ€æœ¯ä¼˜åŒ–å®è·µï¼ˆäºŒï¼‰ï¼šæ€è€ƒæ¨¡å¼æ§åˆ¶ä¸15-20%æ€§èƒ½æå‡"},{"content":"é«˜æ€§èƒ½éƒ¨ç½²Qwen3-30Bï¼švLLMä¼˜åŒ–å®è·µæŒ‡å— ğŸ“‹ æ¦‚è¿° æœ¬æ–‡è¯¦ç»†ä»‹ç»å¦‚ä½•ä½¿ç”¨vLLMé«˜æ•ˆéƒ¨ç½²Qwen3-30B-A3Bæ¨¡å‹ï¼Œå®ç°32Kä¸Šä¸‹æ–‡çª—å£å’ŒOpenAIå…¼å®¹APIï¼Œé€‚ç”¨äºç”Ÿäº§ç¯å¢ƒã€‚é€šè¿‡ç²¾ç»†è°ƒæ•´éƒ¨ç½²å‚æ•°ï¼Œæˆ‘ä»¬èƒ½å¤Ÿåœ¨æœ‰é™çš„GPUèµ„æºä¸‹æœ€å¤§åŒ–æ¨¡å‹æ€§èƒ½ã€‚\nğŸ–¥ï¸ ç³»ç»Ÿè¦æ±‚ ç¡¬ä»¶é…ç½® 4å—NVIDIA GPU (æ¯å—22GBæ˜¾å­˜ï¼Œæ€»è®¡88GB) 512GBç³»ç»Ÿå†…å­˜ 2TB SSDå­˜å‚¨ 56æ ¸CPU è½¯ä»¶ç¯å¢ƒ Ubuntu 24.04 NVIDIAé©±åŠ¨ 550.144.03 CUDA 12.4 Docker + NVIDIA Container Toolkit ğŸ§  æ¨¡å‹ä¸æ¶æ„ Qwen3-30B-A3Bæ˜¯é˜¿é‡Œäº‘å‘å¸ƒçš„é€šç”¨å¤§è¯­è¨€æ¨¡å‹ï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š\n30Bå‚æ•°é‡ åŸç”Ÿæ”¯æŒ32Kä¸Šä¸‹æ–‡é•¿åº¦ æ”¯æŒæ€è€ƒæ¨¡å¼(Chain-of-Thought) ä¼˜å¼‚çš„å¤šè¯­è¨€ä¸ä»£ç èƒ½åŠ› æˆ‘ä»¬ä½¿ç”¨vLLMä½œä¸ºæ¨ç†å¼•æ“ï¼Œä¸»è¦åŸºäºä»¥ä¸‹è€ƒé‡ï¼š\né«˜æ•ˆå†…å­˜ç®¡ç†ï¼šé€šè¿‡PagedAttentionæŠ€æœ¯ä¼˜åŒ–KVç¼“å­˜ å¼ é‡å¹¶è¡Œï¼šè‡ªåŠ¨è·¨å¤šGPUåˆ†å¸ƒæ¨¡å‹æƒé‡ OpenAIå…¼å®¹APIï¼šç›´æ¥æ›¿ä»£OpenAI APIï¼Œæ— éœ€ä¿®æ”¹ç°æœ‰åº”ç”¨ åŠ¨æ€æ‰¹å¤„ç†ï¼šè‡ªåŠ¨æ‰¹å¤„ç†å¤šè¯·æ±‚ï¼Œæé«˜ååé‡ ğŸ³ éƒ¨ç½²è„šæœ¬ ä»¥ä¸‹æ˜¯æˆ‘ä»¬ç”¨äºéƒ¨ç½²çš„Dockerå‘½ä»¤ï¼Œç»è¿‡ç²¾å¿ƒè°ƒä¼˜ä»¥å¹³è¡¡æ€§èƒ½ä¸èµ„æºåˆ©ç”¨ï¼š\ndocker run -d \\ --runtime=nvidia \\ --gpus=all \\ --name coder \\ -v /home/llm/model/qwen/qwen3-30b-a3b:/qwen/qwen3-30b-a3b \\ -p 8000:8000 \\ --cpuset-cpus 0-55 \\ --ulimit memlock=-1 \\ --ulimit stack=67108864 \\ --restart always \\ --ipc=host \\ vllm/vllm-openai:v0.8.5 \\ --model /qwen/qwen3-30b-a3b \\ --served-model-name coder \\ --tensor-parallel-size 4 \\ --dtype half \\ --max-model-len 32768 \\ --max-num-batched-tokens 4096 \\ --gpu-memory-utilization 0.93 \\ --block-size 32 \\ --enable-chunked-prefill \\ --swap-space 16 \\ --tokenizer-pool-size 56 \\ --disable-custom-all-reduce ğŸ”§ å‚æ•°è¯¦è§£ä¸ä¼˜åŒ–ç­–ç•¥ Dockerå®¹å™¨é…ç½® å‚æ•° å€¼ ä½œç”¨ --runtime=nvidia å¯ç”¨NVIDIAå®¹å™¨è¿è¡Œæ—¶ --gpus=all å°†æ‰€æœ‰GPUæš´éœ²ç»™å®¹å™¨ --cpuset-cpus 0-55 é™åˆ¶å®¹å™¨ä½¿ç”¨0-55å·CPUæ ¸å¿ƒ --ulimit memlock=-1 ç§»é™¤å†…å­˜é”å®šé™åˆ¶ï¼Œæé«˜æ€§èƒ½ --ipc=host ä½¿ç”¨ä¸»æœºIPCå‘½åç©ºé—´ï¼Œå¯¹å…±äº«å†…å­˜å¾ˆé‡è¦ vLLMå¼•æ“é…ç½® 1. å¼ é‡å¹¶è¡Œç­–ç•¥ --tensor-parallel-size 4 æˆ‘ä»¬ä½¿ç”¨4è·¯å¼ é‡å¹¶è¡Œï¼Œå°†æ¨¡å‹åˆ†å¸ƒåœ¨4å—GPUä¸Šã€‚è¿™æ˜¯åŸºäºå®éªŒå¾—å‡ºçš„æœ€ä½³é…ç½® - åœ¨æˆ‘ä»¬çš„ç¡¬ä»¶ä¸Šï¼Œæ¯å—22GBæ˜¾å­˜çš„GPUæ— æ³•å•ç‹¬åŠ è½½å®Œæ•´çš„30Bæ¨¡å‹ã€‚\n2. å†…å­˜ä¼˜åŒ– --dtype half --gpu-memory-utilization 0.93 --block-size 32 --swap-space 16 halfç²¾åº¦(FP16)ç›¸æ¯”bfloat16èƒ½è¿›ä¸€æ­¥èŠ‚çœå†…å­˜ï¼Œä¸”åœ¨æˆ‘ä»¬çš„åœºæ™¯ä¸­ç²¾åº¦æŸå¤±å¯æ¥å— GPUå†…å­˜åˆ©ç”¨ç‡93%ç•™å‡ºä¸€å®šç¼“å†²ç©ºé—´é˜²æ­¢OOMé”™è¯¯ KVç¼“å­˜å—å¤§å°è®¾ä¸º32ï¼Œå¹³è¡¡å†…å­˜ä½¿ç”¨ä¸è®¡ç®—æ•ˆç‡ 16GBçš„CPU-GPUäº¤æ¢ç©ºé—´æ”¯æŒå¤„ç†è¶…é•¿åºåˆ— 3. ä¸Šä¸‹æ–‡é•¿åº¦ä¸æ‰¹å¤„ç† --max-model-len 32768 --max-num-batched-tokens 4096 --enable-chunked-prefill æˆ‘ä»¬å°†ä¸Šä¸‹æ–‡é•¿åº¦ä»é»˜è®¤çš„16Kå¢åŠ åˆ°32Kï¼Œä»¥æ”¯æŒæ›´é•¿è¾“å…¥å’Œè¾“å‡ºã€‚ä¸ºäº†å¹³è¡¡èµ„æºä½¿ç”¨ï¼Œç›¸åº”åœ°å°†æ‰¹å¤„ç†ä»¤ç‰Œæ•°ä»8192å‡å°‘åˆ°4096ï¼Œè¿™æ˜¯ä¸€ä¸ªç»è¿‡æµ‹è¯•çš„åˆç†æŠ˜ä¸­æ–¹æ¡ˆã€‚\nå¯ç”¨åˆ†å—é¢„å¡«å……(chunked-prefill)å¯¹äºå¤„ç†é•¿ä¸Šä¸‹æ–‡å°¤ä¸ºé‡è¦ï¼Œå®ƒå°†é•¿åºåˆ—åˆ†è§£ä¸ºæ›´å°çš„å—è¿›è¡Œå¤„ç†ï¼Œå‡å°‘æ˜¾å­˜å³°å€¼ä½¿ç”¨ã€‚\n4. å…¶ä»–æ€§èƒ½è°ƒä¼˜ --tokenizer-pool-size 56 --disable-custom-all-reduce ä»¤ç‰ŒåŒ–å·¥ä½œæ± å¤§å°ä¸CPUæ ¸å¿ƒæ•°åŒ¹é…ï¼Œä¼˜åŒ–å¹¶è¡Œå¤„ç†èƒ½åŠ› ç¦ç”¨è‡ªå®šä¹‰all-reduceæ“ä½œï¼Œè§£å†³æŸäº›ç¡¬ä»¶é…ç½®ä¸Šçš„å…¼å®¹æ€§é—®é¢˜ ğŸ“Š æ€§èƒ½åˆ†æ éƒ¨ç½²åï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡docker logs -f coderæŸ¥çœ‹æœåŠ¡çŠ¶æ€ï¼Œå…³é”®æ€§èƒ½æŒ‡æ ‡å¦‚ä¸‹ï¼š\nINFO 06-03 02:01:19 [worker.py:287] the current vLLM instance can use total_gpu_memory (21.66GiB) x gpu_memory_utilization (0.93) = 20.15GiB INFO 06-03 02:01:19 [worker.py:287] model weights take 14.25GiB; non_torch_memory takes 0.20GiB; PyTorch activation peak memory takes 1.40GiB; the rest of the memory reserved for KV Cache is 4.30GiB. INFO 06-03 02:01:20 [executor_base.py:117] Maximum concurrency for 32768 tokens per request: 5.73x è¿™è¡¨æ˜ï¼š\næ¯ä¸ªGPUä½¿ç”¨çº¦20.15GBå†…å­˜ æ¨¡å‹æƒé‡å ç”¨14.25GB å¯¹äº32Kä»¤ç‰Œè¯·æ±‚ï¼Œç³»ç»Ÿå¯ä»¥å¹¶å‘å¤„ç†5.73å€çš„è¯·æ±‚ åœ¨æˆ‘ä»¬çš„ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œè¿™ä¸ªé…ç½®èƒ½å¤Ÿå¤„ç†æ¯åˆ†é’Ÿçº¦15-20ä¸ªå¹¶å‘å¯¹è¯ï¼Œæ»¡è¶³ä¸­å°å‹åº”ç”¨éœ€æ±‚ã€‚\nğŸ“ APIä½¿ç”¨ç¤ºä¾‹ æœåŠ¡å¯åŠ¨åï¼Œå¯ä»¥é€šè¿‡OpenAIå…¼å®¹çš„APIåœ¨æœ¬åœ°ç«¯å£8000è®¿é—®ï¼š\ncurl http://localhost:8000/v1/chat/completions \\ -H \u0026#34;Content-Type: application/json\u0026#34; \\ -d \u0026#39;{ \u0026#34;model\u0026#34;: \u0026#34;coder\u0026#34;, \u0026#34;messages\u0026#34;: [ {\u0026#34;role\u0026#34;: \u0026#34;user\u0026#34;, \u0026#34;content\u0026#34;: \u0026#34;è¯·è§£é‡Šä¸€ä¸‹é‡å­è®¡ç®—çš„åŸºæœ¬åŸç†\u0026#34;} ], \u0026#34;temperature\u0026#34;: 0.7, \u0026#34;max_tokens\u0026#34;: 2000 }\u0026#39; ä½¿ç”¨Pythonå®¢æˆ·ç«¯ï¼š\nfrom openai import OpenAI client = OpenAI( base_url=\u0026#34;http://localhost:8000/v1\u0026#34;, api_key=\u0026#34;not-needed\u0026#34; # vLLMä¸è¦æ±‚APIå¯†é’¥ ) response = client.chat.completions.create( model=\u0026#34;coder\u0026#34;, messages=[ {\u0026#34;role\u0026#34;: \u0026#34;user\u0026#34;, \u0026#34;content\u0026#34;: \u0026#34;å†™ä¸€ä¸ªPythonå‡½æ•°è®¡ç®—æ–æ³¢é‚£å¥‘æ•°åˆ—\u0026#34;} ], temperature=0.7, max_tokens=1000 ) print(response.choices[0].message.content) ğŸš€ æ‰©å±•åˆ°æ›´é•¿ä¸Šä¸‹æ–‡ Qwen3-30BåŸç”Ÿæ”¯æŒ32Kä¸Šä¸‹æ–‡ï¼Œä½†å¦‚éœ€æ‰©å±•åˆ°æ›´é•¿ä¸Šä¸‹æ–‡(å¦‚131Kä»¤ç‰Œ)ï¼Œå¯ä»¥ä½¿ç”¨YaRNæŠ€æœ¯ï¼Œé€šè¿‡åœ¨vLLMå‚æ•°ä¸­æ·»åŠ ï¼š\n--rope-scaling \u0026#39;{\u0026#34;rope_type\u0026#34;:\u0026#34;yarn\u0026#34;,\u0026#34;factor\u0026#34;:4.0,\u0026#34;original_max_position_embeddings\u0026#34;:32768}\u0026#39; \\ --max-model-len 131072 æ³¨æ„è¿™ä¼šå¢åŠ å†…å­˜ä½¿ç”¨ï¼Œå¯èƒ½éœ€è¦è¿›ä¸€æ­¥è°ƒæ•´å…¶ä»–å‚æ•°ä»¥å¹³è¡¡èµ„æºã€‚\nğŸ” å¸¸è§é—®é¢˜æ’æŸ¥ OOMé”™è¯¯ï¼šå‡å°gpu-memory-utilizationæˆ–max-num-batched-tokens æ¨ç†é€Ÿåº¦æ…¢ï¼šæ£€æŸ¥GPUåˆ©ç”¨ç‡ï¼Œè€ƒè™‘å¢åŠ batchå¤§å°æˆ–å‡å°max-model-len CUDAå›¾æ•è·å¤±è´¥ï¼šæ·»åŠ --enforce-eagerå‚æ•°ç¦ç”¨CUDAå›¾ä¼˜åŒ– ğŸ“ˆ æœªæ¥ä¼˜åŒ–æ–¹å‘ æ¢ç´¢ä½¿ç”¨FlashAttention-2åŠ é€Ÿæ³¨æ„åŠ›è®¡ç®— å°è¯•AWQ/GPTQé‡åŒ–æŠ€æœ¯é™ä½å†…å­˜ä½¿ç”¨ é…ç½®LLM Routerå®ç°å¤šæ¨¡å‹è´Ÿè½½å‡è¡¡ ğŸ”š æ€»ç»“ é€šè¿‡ç²¾ç»†è°ƒä¼˜vLLMéƒ¨ç½²å‚æ•°ï¼Œæˆ‘ä»¬æˆåŠŸåœ¨æœ‰é™ç¡¬ä»¶èµ„æºä¸‹éƒ¨ç½²äº†Qwen3-30Bæ¨¡å‹ï¼Œå®ç°äº†32Kä¸Šä¸‹æ–‡çª—å£çš„é«˜æ€§èƒ½æ¨ç†æœåŠ¡ã€‚è¿™å¥—é…ç½®åœ¨ç”Ÿäº§ç¯å¢ƒä¸­è¡¨ç°ç¨³å®šï¼Œä¸ºå„ç±»åº”ç”¨æä¾›å¼ºå¤§çš„AIèƒ½åŠ›æ”¯æŒã€‚\n","permalink":"https://jackypanster.github.io/ai-stream/posts/deploy-qwen3/","summary":"\u003ch1 id=\"é«˜æ€§èƒ½éƒ¨ç½²qwen3-30bvllmä¼˜åŒ–å®è·µæŒ‡å—\"\u003eé«˜æ€§èƒ½éƒ¨ç½²Qwen3-30Bï¼švLLMä¼˜åŒ–å®è·µæŒ‡å—\u003c/h1\u003e\n\u003ch2 id=\"-æ¦‚è¿°\"\u003eğŸ“‹ æ¦‚è¿°\u003c/h2\u003e\n\u003cp\u003eæœ¬æ–‡è¯¦ç»†ä»‹ç»å¦‚ä½•ä½¿ç”¨vLLMé«˜æ•ˆéƒ¨ç½²Qwen3-30B-A3Bæ¨¡å‹ï¼Œå®ç°32Kä¸Šä¸‹æ–‡çª—å£å’ŒOpenAIå…¼å®¹APIï¼Œé€‚ç”¨äºç”Ÿäº§ç¯å¢ƒã€‚é€šè¿‡ç²¾ç»†è°ƒæ•´éƒ¨ç½²å‚æ•°ï¼Œæˆ‘ä»¬èƒ½å¤Ÿåœ¨æœ‰é™çš„GPUèµ„æºä¸‹æœ€å¤§åŒ–æ¨¡å‹æ€§èƒ½ã€‚\u003c/p\u003e\n\u003ch2 id=\"-ç³»ç»Ÿè¦æ±‚\"\u003eğŸ–¥ï¸ ç³»ç»Ÿè¦æ±‚\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eç¡¬ä»¶é…ç½®\u003c/strong\u003e\n\u003cul\u003e\n\u003cli\u003e4å—NVIDIA GPU (æ¯å—22GBæ˜¾å­˜ï¼Œæ€»è®¡88GB)\u003c/li\u003e\n\u003cli\u003e512GBç³»ç»Ÿå†…å­˜\u003c/li\u003e\n\u003cli\u003e2TB SSDå­˜å‚¨\u003c/li\u003e\n\u003cli\u003e56æ ¸CPU\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eè½¯ä»¶ç¯å¢ƒ\u003c/strong\u003e\n\u003cul\u003e\n\u003cli\u003eUbuntu 24.04\u003c/li\u003e\n\u003cli\u003eNVIDIAé©±åŠ¨ 550.144.03\u003c/li\u003e\n\u003cli\u003eCUDA 12.4\u003c/li\u003e\n\u003cli\u003eDocker + NVIDIA Container Toolkit\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"-æ¨¡å‹ä¸æ¶æ„\"\u003eğŸ§  æ¨¡å‹ä¸æ¶æ„\u003c/h2\u003e\n\u003cp\u003eQwen3-30B-A3Bæ˜¯é˜¿é‡Œäº‘å‘å¸ƒçš„é€šç”¨å¤§è¯­è¨€æ¨¡å‹ï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e30Bå‚æ•°é‡\u003c/li\u003e\n\u003cli\u003eåŸç”Ÿæ”¯æŒ32Kä¸Šä¸‹æ–‡é•¿åº¦\u003c/li\u003e\n\u003cli\u003eæ”¯æŒæ€è€ƒæ¨¡å¼(Chain-of-Thought)\u003c/li\u003e\n\u003cli\u003eä¼˜å¼‚çš„å¤šè¯­è¨€ä¸ä»£ç èƒ½åŠ›\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eæˆ‘ä»¬ä½¿ç”¨vLLMä½œä¸ºæ¨ç†å¼•æ“ï¼Œä¸»è¦åŸºäºä»¥ä¸‹è€ƒé‡ï¼š\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\u003cstrong\u003eé«˜æ•ˆå†…å­˜ç®¡ç†\u003c/strong\u003eï¼šé€šè¿‡PagedAttentionæŠ€æœ¯ä¼˜åŒ–KVç¼“å­˜\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eå¼ é‡å¹¶è¡Œ\u003c/strong\u003eï¼šè‡ªåŠ¨è·¨å¤šGPUåˆ†å¸ƒæ¨¡å‹æƒé‡\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eOpenAIå…¼å®¹API\u003c/strong\u003eï¼šç›´æ¥æ›¿ä»£OpenAI APIï¼Œæ— éœ€ä¿®æ”¹ç°æœ‰åº”ç”¨\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eåŠ¨æ€æ‰¹å¤„ç†\u003c/strong\u003eï¼šè‡ªåŠ¨æ‰¹å¤„ç†å¤šè¯·æ±‚ï¼Œæé«˜ååé‡\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch2 id=\"-éƒ¨ç½²è„šæœ¬\"\u003eğŸ³ éƒ¨ç½²è„šæœ¬\u003c/h2\u003e\n\u003cp\u003eä»¥ä¸‹æ˜¯æˆ‘ä»¬ç”¨äºéƒ¨ç½²çš„Dockerå‘½ä»¤ï¼Œç»è¿‡ç²¾å¿ƒè°ƒä¼˜ä»¥å¹³è¡¡æ€§èƒ½ä¸èµ„æºåˆ©ç”¨ï¼š\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003edocker run -d \u003cspan style=\"color:#ae81ff\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#ae81ff\"\u003e\u003c/span\u003e  --runtime\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003envidia \u003cspan style=\"color:#ae81ff\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#ae81ff\"\u003e\u003c/span\u003e  --gpus\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003eall \u003cspan style=\"color:#ae81ff\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#ae81ff\"\u003e\u003c/span\u003e  --name coder \u003cspan style=\"color:#ae81ff\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#ae81ff\"\u003e\u003c/span\u003e  -v /home/llm/model/qwen/qwen3-30b-a3b:/qwen/qwen3-30b-a3b \u003cspan style=\"color:#ae81ff\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#ae81ff\"\u003e\u003c/span\u003e  -p 8000:8000 \u003cspan style=\"color:#ae81ff\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#ae81ff\"\u003e\u003c/span\u003e  --cpuset-cpus 0-55 \u003cspan style=\"color:#ae81ff\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#ae81ff\"\u003e\u003c/span\u003e  --ulimit memlock\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e-1 \u003cspan style=\"color:#ae81ff\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#ae81ff\"\u003e\u003c/span\u003e  --ulimit stack\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e67108864\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#ae81ff\"\u003e\u003c/span\u003e  --restart always \u003cspan style=\"color:#ae81ff\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#ae81ff\"\u003e\u003c/span\u003e  --ipc\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003ehost \u003cspan style=\"color:#ae81ff\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#ae81ff\"\u003e\u003c/span\u003e  vllm/vllm-openai:v0.8.5 \u003cspan style=\"color:#ae81ff\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#ae81ff\"\u003e\u003c/span\u003e  --model /qwen/qwen3-30b-a3b \u003cspan style=\"color:#ae81ff\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#ae81ff\"\u003e\u003c/span\u003e  --served-model-name coder \u003cspan style=\"color:#ae81ff\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#ae81ff\"\u003e\u003c/span\u003e  --tensor-parallel-size \u003cspan style=\"color:#ae81ff\"\u003e4\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#ae81ff\"\u003e\u003c/span\u003e  --dtype half \u003cspan style=\"color:#ae81ff\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#ae81ff\"\u003e\u003c/span\u003e  --max-model-len \u003cspan style=\"color:#ae81ff\"\u003e32768\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#ae81ff\"\u003e\u003c/span\u003e  --max-num-batched-tokens \u003cspan style=\"color:#ae81ff\"\u003e4096\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#ae81ff\"\u003e\u003c/span\u003e  --gpu-memory-utilization 0.93 \u003cspan style=\"color:#ae81ff\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#ae81ff\"\u003e\u003c/span\u003e  --block-size \u003cspan style=\"color:#ae81ff\"\u003e32\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#ae81ff\"\u003e\u003c/span\u003e  --enable-chunked-prefill \u003cspan style=\"color:#ae81ff\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#ae81ff\"\u003e\u003c/span\u003e  --swap-space \u003cspan style=\"color:#ae81ff\"\u003e16\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#ae81ff\"\u003e\u003c/span\u003e  --tokenizer-pool-size \u003cspan style=\"color:#ae81ff\"\u003e56\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e\\\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#ae81ff\"\u003e\u003c/span\u003e  --disable-custom-all-reduce\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"-å‚æ•°è¯¦è§£ä¸ä¼˜åŒ–ç­–ç•¥\"\u003eğŸ”§ å‚æ•°è¯¦è§£ä¸ä¼˜åŒ–ç­–ç•¥\u003c/h2\u003e\n\u003ch3 id=\"dockerå®¹å™¨é…ç½®\"\u003eDockerå®¹å™¨é…ç½®\u003c/h3\u003e\n\u003ctable\u003e\n  \u003cthead\u003e\n      \u003ctr\u003e\n          \u003cth\u003eå‚æ•°\u003c/th\u003e\n          \u003cth\u003eå€¼\u003c/th\u003e\n          \u003cth\u003eä½œç”¨\u003c/th\u003e\n      \u003c/tr\u003e\n  \u003c/thead\u003e\n  \u003ctbody\u003e\n      \u003ctr\u003e\n          \u003ctd\u003e\u003ccode\u003e--runtime=nvidia\u003c/code\u003e\u003c/td\u003e\n          \u003ctd\u003e\u003c/td\u003e\n          \u003ctd\u003eå¯ç”¨NVIDIAå®¹å™¨è¿è¡Œæ—¶\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003e\u003ccode\u003e--gpus=all\u003c/code\u003e\u003c/td\u003e\n          \u003ctd\u003e\u003c/td\u003e\n          \u003ctd\u003eå°†æ‰€æœ‰GPUæš´éœ²ç»™å®¹å™¨\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003e\u003ccode\u003e--cpuset-cpus\u003c/code\u003e\u003c/td\u003e\n          \u003ctd\u003e\u003ccode\u003e0-55\u003c/code\u003e\u003c/td\u003e\n          \u003ctd\u003eé™åˆ¶å®¹å™¨ä½¿ç”¨0-55å·CPUæ ¸å¿ƒ\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003e\u003ccode\u003e--ulimit memlock=-1\u003c/code\u003e\u003c/td\u003e\n          \u003ctd\u003e\u003c/td\u003e\n          \u003ctd\u003eç§»é™¤å†…å­˜é”å®šé™åˆ¶ï¼Œæé«˜æ€§èƒ½\u003c/td\u003e\n      \u003c/tr\u003e\n      \u003ctr\u003e\n          \u003ctd\u003e\u003ccode\u003e--ipc=host\u003c/code\u003e\u003c/td\u003e\n          \u003ctd\u003e\u003c/td\u003e\n          \u003ctd\u003eä½¿ç”¨ä¸»æœºIPCå‘½åç©ºé—´ï¼Œå¯¹å…±äº«å†…å­˜å¾ˆé‡è¦\u003c/td\u003e\n      \u003c/tr\u003e\n  \u003c/tbody\u003e\n\u003c/table\u003e\n\u003ch3 id=\"vllmå¼•æ“é…ç½®\"\u003evLLMå¼•æ“é…ç½®\u003c/h3\u003e\n\u003ch4 id=\"1-å¼ é‡å¹¶è¡Œç­–ç•¥\"\u003e1. å¼ é‡å¹¶è¡Œç­–ç•¥\u003c/h4\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003e--tensor-parallel-size 4\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eæˆ‘ä»¬ä½¿ç”¨4è·¯å¼ é‡å¹¶è¡Œï¼Œå°†æ¨¡å‹åˆ†å¸ƒåœ¨4å—GPUä¸Šã€‚è¿™æ˜¯åŸºäºå®éªŒå¾—å‡ºçš„æœ€ä½³é…ç½® - åœ¨æˆ‘ä»¬çš„ç¡¬ä»¶ä¸Šï¼Œæ¯å—22GBæ˜¾å­˜çš„GPUæ— æ³•å•ç‹¬åŠ è½½å®Œæ•´çš„30Bæ¨¡å‹ã€‚\u003c/p\u003e","title":"é«˜æ€§èƒ½éƒ¨ç½²Qwen3-30Bï¼švLLMä¼˜åŒ–å®è·µæŒ‡å—"},{"content":"AIè¾…åŠ©ç¼–ç¨‹å®æˆ˜ï¼šä»éœ€æ±‚åˆ°å®ç°çš„å®Œæ•´å¯¹è¯è®°å½• å¼•è¨€ æœ¬æ–‡çœŸå®è¿˜åŸäº†æˆ‘ä¸AIåŠ©æ‰‹åä½œå®ç°Dockeré•œåƒå¤§å°ç›‘æ§åŠŸèƒ½çš„å…¨è¿‡ç¨‹ã€‚é€šè¿‡è¿™æ¬¡å®è·µï¼Œå¯ä»¥çœ‹åˆ°AIä¸ä»…èƒ½è¾…åŠ©å¼€å‘è€…æ¢³ç†éœ€æ±‚ã€è®¾è®¡æ–¹æ¡ˆï¼Œè¿˜èƒ½åœ¨ä»£ç å®ç°ã€æ–‡æ¡£ç¼–å†™ç­‰ç¯èŠ‚æä¾›é«˜æ•ˆå¸®åŠ©ã€‚æ•´ä¸ªæµç¨‹è‡ªç„¶æµç•…ï¼Œæå¤§æå‡äº†å¼€å‘ä½“éªŒã€‚\n1. éœ€æ±‚åˆ†æä¸æ–¹æ¡ˆè®¾è®¡ åˆå§‹éœ€æ±‚æè¿° ç”¨æˆ·ï¼š æˆ‘ä»¬éœ€è¦åœ¨Jenkinså…±äº«åº“ä¸­å¢åŠ Dockeré•œåƒå¤§å°ç›‘æ§åŠŸèƒ½ï¼Œå½“é•œåƒè¶…è¿‡4GBæ—¶å‘å‡ºè­¦å‘Šã€‚è¯·å¸®å¿™åˆ†æä¸€ä¸‹å®ç°æ€è·¯ã€‚ AIçš„åˆæ­¥åˆ†æä¸å»ºè®® AIï¼š è®©æˆ‘å…ˆçœ‹çœ‹é¡¹ç›®çš„ç»“æ„â€¦â€¦ è¿™æ˜¯ä¸€ä¸ªJenkinså…±äº«åº“é¡¹ç›®ï¼Œæ ¸å¿ƒä»£ç éƒ½åœ¨`vars/`ç›®å½•ã€‚é’ˆå¯¹é•œåƒå¤§å°ç›‘æ§ï¼Œæˆ‘å»ºè®®ç›´æ¥åœ¨`buildDocker`æ–¹æ³•é‡ŒåŠ é€»è¾‘ï¼š 1. é•œåƒæ„å»ºå®Œæˆåç”¨`du`å‘½ä»¤è·å–å¤§å° 2. ä¸4GBé˜ˆå€¼æ¯”è¾ƒ 3. è¶…è¿‡é˜ˆå€¼å°±è¾“å‡ºè­¦å‘Š 4. ç›¸å…³æŒ‡æ ‡å†™æ—¥å¿—ï¼Œæ–¹ä¾¿åç»­åˆ†æ è¿™ä¸ªæ–¹æ¡ˆæ‚¨è§‰å¾—åˆé€‚å—ï¼Ÿæœ‰æ— è¡¥å……ï¼Ÿ éœ€æ±‚ç¡®è®¤ä¸ç»†åŒ– ç”¨æˆ·ï¼š è¿™ä¸ªæ€è·¯å¯ä»¥ï¼Œä¸è¿‡è¿˜éœ€è¦ï¼š 1. é˜ˆå€¼è¦å¯é…ç½®ï¼Œé»˜è®¤4GB 2. æ—¥å¿—é‡Œè¦æœ‰é•œåƒåã€å¤§å°ã€æ—¶é—´æˆ³ç­‰è¯¦ç»†ä¿¡æ¯ 3. è¾“å‡ºä¼˜åŒ–å»ºè®® å¦å¤–ï¼Œå¼‚å¸¸å¤„ç†ä¹Ÿè¦è€ƒè™‘å¾—æ›´ä¼˜é›…äº›ã€‚ 2. ä»£ç å®ç° åˆå§‹ä»£ç å®ç° AIï¼š æ˜ç™½ï¼Œæˆ‘æ¥å®ç°ã€‚ä¼šåœ¨`buildDocker`æ–¹æ³•é‡Œï¼š 1. ç”¨`getEnvOrDefault`æ”¯æŒé˜ˆå€¼é…ç½® 2. è¯¦ç»†è®°å½•æŒ‡æ ‡ 3. åŠ å¼ºé”™è¯¯å¤„ç† 4. è¾“å‡ºä¼˜åŒ–å»ºè®® å®ç°é€»è¾‘æ‚¨çœ‹è¿˜æœ‰ä»€ä¹ˆè¦è°ƒæ•´çš„å—ï¼Ÿ ä»£ç å®¡æŸ¥ä¸ä¼˜åŒ– ç”¨æˆ·ï¼š æ•´ä½“ä¸é”™ï¼Œä¸è¿‡è­¦å‘Šè¦æ”¹æˆæŠ›å¼‚å¸¸ç›´æ¥ä¸­æ–­æ„å»ºã€‚å¦å¤–ï¼Œèƒ½ä¸èƒ½é¡ºä¾¿åŠ ä¸ŠåŸºç¡€é•œåƒå¤§å°æ£€æµ‹ï¼Ÿ å¼‚å¸¸å¤„ç†ä¼˜åŒ– AIï¼š æ˜ç™½æ‚¨çš„éœ€æ±‚ï¼Œä»£ç æˆ‘ä¼šè¿™æ ·ä¼˜åŒ–ï¼š 1. è¶…æ ‡ç›´æ¥æŠ›å¼‚å¸¸ä¸­æ–­æµæ°´çº¿ 2. å¢åŠ åŸºç¡€é•œåƒå¤§å°æ£€æµ‹ 3. æ˜ç¡®åŒºåˆ†ä¸šåŠ¡å¼‚å¸¸ï¼ˆæ¯”å¦‚é•œåƒè¿‡å¤§ï¼‰å’ŒæŠ€æœ¯å¼‚å¸¸ï¼ˆæ¯”å¦‚å‘½ä»¤å¤±è´¥ï¼‰ åŸºç¡€é•œåƒæ£€æµ‹è¿™å—ï¼Œæˆ‘å»ºè®®ï¼š - è§£æDockerfileçš„FROM - æ‹‰å–å¹¶æ£€æµ‹åŸºç¡€é•œåƒå¤§å° - è¶…é™å°±ç»™å‡ºalpineç­‰è½»é‡é•œåƒå»ºè®® è¿™æ ·å¤„ç†æ‚¨è§‰å¾—OKå—ï¼Ÿ 3. æµ‹è¯•ä¸éªŒè¯ æµ‹è¯•æ–¹æ¡ˆè®¨è®º ç”¨æˆ·ï¼š æ€ä¹ˆéªŒè¯è¿™ä¸ªåŠŸèƒ½ï¼Ÿ AIï¼š å»ºè®®è¿™æ ·æµ‹è¯•ï¼š 1. é•œåƒå¤§å°æ­£å¸¸ 2. æ°å¥½ç­‰äºé˜ˆå€¼ 3. è¶…è¿‡é˜ˆå€¼ 4. Dockerfileè§£æå¼‚å¸¸ ä¹Ÿå¯ä»¥ä¸´æ—¶æŠŠé˜ˆå€¼è°ƒå°ï¼Œå¿«é€ŸéªŒè¯å‘Šè­¦é€»è¾‘ã€‚ 4. æ–‡æ¡£ä¸æ²Ÿé€š å˜æ›´æ—¥å¿—ç”Ÿæˆ AIï¼š æˆ‘å·²ä¸ºæ‚¨ç”Ÿæˆè¯¦ç»†CHANGELOGï¼ŒåŒ…æ‹¬ï¼š - åŠŸèƒ½è¯´æ˜ - æŠ€æœ¯å®ç°ç»†èŠ‚ - é…ç½®å‚æ•°è¯´æ˜ - åç»­ä¼˜åŒ–è®¡åˆ’ å¦‚éœ€è°ƒæ•´ï¼Œéšæ—¶å‘Šè¯‰æˆ‘ã€‚ å›¢é˜Ÿé€šçŸ¥ ç”¨æˆ·ï¼š è¦å‘ä¸ªé€šçŸ¥ç»™å›¢é˜Ÿï¼Œè¯´æ˜æˆ‘ä»¬è¦é™åˆ¶é•œåƒå¤§å°ã€‚ AIï¼š å»ºè®®åˆ†é˜¶æ®µæ¨è¿›ï¼š 1. å…ˆç›‘æ§å’Œé€šçŸ¥ 2. å†è¿›å…¥è­¦å‘ŠæœŸ 3. æœ€åå¼ºåˆ¶é™åˆ¶ è¿™æ ·å¤§å®¶æœ‰ç¼“å†²æœŸï¼Œå¯ä»¥é€æ­¥ä¼˜åŒ–Dockerfileã€‚éœ€è¦å¸®å¿™èµ·è‰é€šçŸ¥å—ï¼Ÿ 5. ç»éªŒæ€»ç»“ æŠ€æœ¯æ”¶è· AIè¾…åŠ©æ•ˆç‡\nä»£ç å®ç°é€Ÿåº¦æå‡æ˜¾è‘— è‡ªåŠ¨ç”Ÿæˆæ–‡æ¡£èŠ‚çœæ—¶é—´ ä»£ç è´¨é‡\nå¼‚å¸¸å¤„ç†æ›´å®Œå–„ é…ç½®æ›´çµæ´» å›¢é˜Ÿåä½œ\næ–‡æ¡£æ›´è§„èŒƒ çŸ¥è¯†ä¼ é€’æ›´é«˜æ•ˆ å»ºè®®ä¸å±•æœ› å»ºç«‹AIè¾…åŠ©ç¼–ç è§„èŒƒ å®Œå–„æç¤ºå·¥ç¨‹å®è·µ æ¢ç´¢æ›´å¤šè‡ªåŠ¨åŒ–åœºæ™¯ ç»“è¯­ é€šè¿‡è¿™æ¬¡å®è·µï¼ŒAIèƒ½é™ªä¼´å¼€å‘è€…ä¸€èµ·æ€è€ƒã€å†³ç­–å’Œè½åœ°å®ç°ã€‚æœŸå¾…æœªæ¥AIåœ¨æ›´å¤šè½¯ä»¶å¼€å‘åœºæ™¯ä¸­å‘æŒ¥æ›´å¤§ä½œç”¨ã€‚\n","permalink":"https://jackypanster.github.io/ai-stream/posts/coding-with-ai/","summary":"\u003ch1 id=\"aiè¾…åŠ©ç¼–ç¨‹å®æˆ˜ä»éœ€æ±‚åˆ°å®ç°çš„å®Œæ•´å¯¹è¯è®°å½•\"\u003eAIè¾…åŠ©ç¼–ç¨‹å®æˆ˜ï¼šä»éœ€æ±‚åˆ°å®ç°çš„å®Œæ•´å¯¹è¯è®°å½•\u003c/h1\u003e\n\u003ch2 id=\"å¼•è¨€\"\u003eå¼•è¨€\u003c/h2\u003e\n\u003cp\u003eæœ¬æ–‡çœŸå®è¿˜åŸäº†æˆ‘ä¸AIåŠ©æ‰‹åä½œå®ç°Dockeré•œåƒå¤§å°ç›‘æ§åŠŸèƒ½çš„å…¨è¿‡ç¨‹ã€‚é€šè¿‡è¿™æ¬¡å®è·µï¼Œå¯ä»¥çœ‹åˆ°AIä¸ä»…èƒ½è¾…åŠ©å¼€å‘è€…æ¢³ç†éœ€æ±‚ã€è®¾è®¡æ–¹æ¡ˆï¼Œè¿˜èƒ½åœ¨ä»£ç å®ç°ã€æ–‡æ¡£ç¼–å†™ç­‰ç¯èŠ‚æä¾›é«˜æ•ˆå¸®åŠ©ã€‚æ•´ä¸ªæµç¨‹è‡ªç„¶æµç•…ï¼Œæå¤§æå‡äº†å¼€å‘ä½“éªŒã€‚\u003c/p\u003e\n\u003ch2 id=\"1-éœ€æ±‚åˆ†æä¸æ–¹æ¡ˆè®¾è®¡\"\u003e1. éœ€æ±‚åˆ†æä¸æ–¹æ¡ˆè®¾è®¡\u003c/h2\u003e\n\u003ch3 id=\"åˆå§‹éœ€æ±‚æè¿°\"\u003eåˆå§‹éœ€æ±‚æè¿°\u003c/h3\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003eç”¨æˆ·ï¼š\næˆ‘ä»¬éœ€è¦åœ¨Jenkinså…±äº«åº“ä¸­å¢åŠ Dockeré•œåƒå¤§å°ç›‘æ§åŠŸèƒ½ï¼Œå½“é•œåƒè¶…è¿‡4GBæ—¶å‘å‡ºè­¦å‘Šã€‚è¯·å¸®å¿™åˆ†æä¸€ä¸‹å®ç°æ€è·¯ã€‚\n\u003c/code\u003e\u003c/pre\u003e\u003ch3 id=\"aiçš„åˆæ­¥åˆ†æä¸å»ºè®®\"\u003eAIçš„åˆæ­¥åˆ†æä¸å»ºè®®\u003c/h3\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003eAIï¼š\nè®©æˆ‘å…ˆçœ‹çœ‹é¡¹ç›®çš„ç»“æ„â€¦â€¦\n\nè¿™æ˜¯ä¸€ä¸ªJenkinså…±äº«åº“é¡¹ç›®ï¼Œæ ¸å¿ƒä»£ç éƒ½åœ¨`vars/`ç›®å½•ã€‚é’ˆå¯¹é•œåƒå¤§å°ç›‘æ§ï¼Œæˆ‘å»ºè®®ç›´æ¥åœ¨`buildDocker`æ–¹æ³•é‡ŒåŠ é€»è¾‘ï¼š\n\n1. é•œåƒæ„å»ºå®Œæˆåç”¨`du`å‘½ä»¤è·å–å¤§å°\n2. ä¸4GBé˜ˆå€¼æ¯”è¾ƒ\n3. è¶…è¿‡é˜ˆå€¼å°±è¾“å‡ºè­¦å‘Š\n4. ç›¸å…³æŒ‡æ ‡å†™æ—¥å¿—ï¼Œæ–¹ä¾¿åç»­åˆ†æ\n\nè¿™ä¸ªæ–¹æ¡ˆæ‚¨è§‰å¾—åˆé€‚å—ï¼Ÿæœ‰æ— è¡¥å……ï¼Ÿ\n\u003c/code\u003e\u003c/pre\u003e\u003ch3 id=\"éœ€æ±‚ç¡®è®¤ä¸ç»†åŒ–\"\u003eéœ€æ±‚ç¡®è®¤ä¸ç»†åŒ–\u003c/h3\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003eç”¨æˆ·ï¼š\nè¿™ä¸ªæ€è·¯å¯ä»¥ï¼Œä¸è¿‡è¿˜éœ€è¦ï¼š\n1. é˜ˆå€¼è¦å¯é…ç½®ï¼Œé»˜è®¤4GB\n2. æ—¥å¿—é‡Œè¦æœ‰é•œåƒåã€å¤§å°ã€æ—¶é—´æˆ³ç­‰è¯¦ç»†ä¿¡æ¯\n3. è¾“å‡ºä¼˜åŒ–å»ºè®®\n\nå¦å¤–ï¼Œå¼‚å¸¸å¤„ç†ä¹Ÿè¦è€ƒè™‘å¾—æ›´ä¼˜é›…äº›ã€‚\n\u003c/code\u003e\u003c/pre\u003e\u003ch2 id=\"2-ä»£ç å®ç°\"\u003e2. ä»£ç å®ç°\u003c/h2\u003e\n\u003ch3 id=\"åˆå§‹ä»£ç å®ç°\"\u003eåˆå§‹ä»£ç å®ç°\u003c/h3\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003eAIï¼š\næ˜ç™½ï¼Œæˆ‘æ¥å®ç°ã€‚ä¼šåœ¨`buildDocker`æ–¹æ³•é‡Œï¼š\n\n1. ç”¨`getEnvOrDefault`æ”¯æŒé˜ˆå€¼é…ç½®\n2. è¯¦ç»†è®°å½•æŒ‡æ ‡\n3. åŠ å¼ºé”™è¯¯å¤„ç†\n4. è¾“å‡ºä¼˜åŒ–å»ºè®®\n\nå®ç°é€»è¾‘æ‚¨çœ‹è¿˜æœ‰ä»€ä¹ˆè¦è°ƒæ•´çš„å—ï¼Ÿ\n\u003c/code\u003e\u003c/pre\u003e\u003ch3 id=\"ä»£ç å®¡æŸ¥ä¸ä¼˜åŒ–\"\u003eä»£ç å®¡æŸ¥ä¸ä¼˜åŒ–\u003c/h3\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003eç”¨æˆ·ï¼š\næ•´ä½“ä¸é”™ï¼Œä¸è¿‡è­¦å‘Šè¦æ”¹æˆæŠ›å¼‚å¸¸ç›´æ¥ä¸­æ–­æ„å»ºã€‚å¦å¤–ï¼Œèƒ½ä¸èƒ½é¡ºä¾¿åŠ ä¸ŠåŸºç¡€é•œåƒå¤§å°æ£€æµ‹ï¼Ÿ\n\u003c/code\u003e\u003c/pre\u003e\u003ch3 id=\"å¼‚å¸¸å¤„ç†ä¼˜åŒ–\"\u003eå¼‚å¸¸å¤„ç†ä¼˜åŒ–\u003c/h3\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003eAIï¼š\næ˜ç™½æ‚¨çš„éœ€æ±‚ï¼Œä»£ç æˆ‘ä¼šè¿™æ ·ä¼˜åŒ–ï¼š\n\n1. è¶…æ ‡ç›´æ¥æŠ›å¼‚å¸¸ä¸­æ–­æµæ°´çº¿\n2. å¢åŠ åŸºç¡€é•œåƒå¤§å°æ£€æµ‹\n3. æ˜ç¡®åŒºåˆ†ä¸šåŠ¡å¼‚å¸¸ï¼ˆæ¯”å¦‚é•œåƒè¿‡å¤§ï¼‰å’ŒæŠ€æœ¯å¼‚å¸¸ï¼ˆæ¯”å¦‚å‘½ä»¤å¤±è´¥ï¼‰\n\nåŸºç¡€é•œåƒæ£€æµ‹è¿™å—ï¼Œæˆ‘å»ºè®®ï¼š\n- è§£æDockerfileçš„FROM\n- æ‹‰å–å¹¶æ£€æµ‹åŸºç¡€é•œåƒå¤§å°\n- è¶…é™å°±ç»™å‡ºalpineç­‰è½»é‡é•œåƒå»ºè®®\n\nè¿™æ ·å¤„ç†æ‚¨è§‰å¾—OKå—ï¼Ÿ\n\u003c/code\u003e\u003c/pre\u003e\u003ch2 id=\"3-æµ‹è¯•ä¸éªŒè¯\"\u003e3. æµ‹è¯•ä¸éªŒè¯\u003c/h2\u003e\n\u003ch3 id=\"æµ‹è¯•æ–¹æ¡ˆè®¨è®º\"\u003eæµ‹è¯•æ–¹æ¡ˆè®¨è®º\u003c/h3\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003eç”¨æˆ·ï¼š\næ€ä¹ˆéªŒè¯è¿™ä¸ªåŠŸèƒ½ï¼Ÿ\n\nAIï¼š\nå»ºè®®è¿™æ ·æµ‹è¯•ï¼š\n1. é•œåƒå¤§å°æ­£å¸¸\n2. æ°å¥½ç­‰äºé˜ˆå€¼\n3. è¶…è¿‡é˜ˆå€¼\n4. Dockerfileè§£æå¼‚å¸¸\n\nä¹Ÿå¯ä»¥ä¸´æ—¶æŠŠé˜ˆå€¼è°ƒå°ï¼Œå¿«é€ŸéªŒè¯å‘Šè­¦é€»è¾‘ã€‚\n\u003c/code\u003e\u003c/pre\u003e\u003ch2 id=\"4-æ–‡æ¡£ä¸æ²Ÿé€š\"\u003e4. æ–‡æ¡£ä¸æ²Ÿé€š\u003c/h2\u003e\n\u003ch3 id=\"å˜æ›´æ—¥å¿—ç”Ÿæˆ\"\u003eå˜æ›´æ—¥å¿—ç”Ÿæˆ\u003c/h3\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003eAIï¼š\næˆ‘å·²ä¸ºæ‚¨ç”Ÿæˆè¯¦ç»†CHANGELOGï¼ŒåŒ…æ‹¬ï¼š\n- åŠŸèƒ½è¯´æ˜\n- æŠ€æœ¯å®ç°ç»†èŠ‚\n- é…ç½®å‚æ•°è¯´æ˜\n- åç»­ä¼˜åŒ–è®¡åˆ’\n\nå¦‚éœ€è°ƒæ•´ï¼Œéšæ—¶å‘Šè¯‰æˆ‘ã€‚\n\u003c/code\u003e\u003c/pre\u003e\u003ch3 id=\"å›¢é˜Ÿé€šçŸ¥\"\u003eå›¢é˜Ÿé€šçŸ¥\u003c/h3\u003e\n\u003cpre tabindex=\"0\"\u003e\u003ccode\u003eç”¨æˆ·ï¼š\nè¦å‘ä¸ªé€šçŸ¥ç»™å›¢é˜Ÿï¼Œè¯´æ˜æˆ‘ä»¬è¦é™åˆ¶é•œåƒå¤§å°ã€‚\n\nAIï¼š\nå»ºè®®åˆ†é˜¶æ®µæ¨è¿›ï¼š\n1. å…ˆç›‘æ§å’Œé€šçŸ¥\n2. å†è¿›å…¥è­¦å‘ŠæœŸ\n3. æœ€åå¼ºåˆ¶é™åˆ¶\n\nè¿™æ ·å¤§å®¶æœ‰ç¼“å†²æœŸï¼Œå¯ä»¥é€æ­¥ä¼˜åŒ–Dockerfileã€‚éœ€è¦å¸®å¿™èµ·è‰é€šçŸ¥å—ï¼Ÿ\n\u003c/code\u003e\u003c/pre\u003e\u003ch2 id=\"5-ç»éªŒæ€»ç»“\"\u003e5. ç»éªŒæ€»ç»“\u003c/h2\u003e\n\u003ch3 id=\"æŠ€æœ¯æ”¶è·\"\u003eæŠ€æœ¯æ”¶è·\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eAIè¾…åŠ©æ•ˆç‡\u003c/strong\u003e\u003c/p\u003e","title":"AIè¾…åŠ©ç¼–ç¨‹å®æˆ˜ï¼šä»éœ€æ±‚åˆ°å®ç°çš„å®Œæ•´å¯¹è¯è®°å½•"},{"content":"åŸºäºFunAudioLLM/SenseVoiceSmallæ­å»ºé«˜æ•ˆè¯­éŸ³è½¬å½•æœåŠ¡çš„å®è·µä¹‹è·¯ é¡¹ç›®æ¦‚è¿° å®ç°ä¸€ä¸ªè¯­éŸ³è½¬å½•æ–‡æœ¬ï¼ˆASRï¼‰çš„æœåŠ¡ï¼Œç›®æ ‡æ˜¯èƒ½å¤Ÿé«˜æ•ˆåœ°å°†ç”¨æˆ·ä¸Šä¼ çš„éŸ³é¢‘æ–‡ä»¶è½¬æ¢ä¸ºæ–‡å­—ã€‚å‡ºäºä¸­æ–‡è¯­éŸ³çš„è€ƒè™‘ï¼Œé€‰æ‹©äº†æ¥è‡ª FunAudioLLM çš„ SenseVoiceSmall æ¨¡å‹ï¼Œå®ƒä»¥å…¶å¤šè¯­ç§æ”¯æŒã€é«˜æ•ˆç‡ä»¥åŠé›†æˆçš„è¯­éŸ³ç†è§£èƒ½åŠ›ï¼ˆå¦‚æƒ…æ„Ÿè¯†åˆ«ã€äº‹ä»¶æ£€æµ‹ï¼‰å¸å¼•äº†æˆ‘ã€‚æœ¬æ–‡å°†è¯¦ç»†è®°å½•ä»ç¯å¢ƒé…ç½®ã€æ ¸å¿ƒåŠŸèƒ½å®ç°åˆ°è¸©å‘è§£å†³çš„å…¨è¿‡ç¨‹ï¼Œå¹¶åˆ†äº«ä¸€äº›å…³äºæ¨¡å‹é€‰å‹çš„æ€è€ƒã€‚\nå®Œæ•´ä»£ç å·²å¼€æºåœ¨ GitHub ä»“åº“ï¼šhttps://github.com/jackypanster/FunAudioLLM-SenseVoiceSmall\né¡¹ç›®éœ€æ±‚æ–‡æ¡£ï¼ˆprd.mdï¼‰å…³é”®ä¿¡æ¯å¦‚ä¸‹ï¼š\næ¨¡å‹: FunAudioLLM/SenseVoice (å…·ä½“ä¸º SenseVoiceSmall) æœ¬åœ°æ¨¡å‹è·¯å¾„: /home/llm/model/iic/SenseVoiceSmall (ä» ModelScope ä¸‹è½½) APIæ¡†æ¶: FastAPI Pythonç¯å¢ƒç®¡ç†: uv ç¯å¢ƒé…ç½® ä¸ºäº†ä¿æŒå¼€å‘ç¯å¢ƒçš„çº¯å‡€å’Œé«˜æ•ˆï¼Œé‡‡ç”¨äº† uv æ¥ç®¡ç† Python ä¾èµ–ã€‚\nåˆ›å»ºè™šæ‹Ÿç¯å¢ƒ (å¦‚æœå°šæœªåˆ›å»º):\nuv venv .venv source .venv/bin/activate å®‰è£…æ ¸å¿ƒä¾èµ–: åˆå§‹çš„ requirements.txt åŒ…å«äº† fastapi, uvicorn, python-multipart ç­‰åŸºç¡€åº“ã€‚åç»­æ ¹æ®æ¨¡å‹åŠ è½½å’Œå¤„ç†çš„éœ€æ±‚ï¼Œé€æ­¥æ·»åŠ äº† torch, torchaudio, numpy, transformers, sentencepiece, ä»¥åŠæœ€ç»ˆè§£å†³æ¨¡å‹åŠ è½½é—®é¢˜çš„æ ¸å¿ƒåº“ funasrã€‚\nuv pip install -r requirements.txt æ ¸å¿ƒåŠŸèƒ½å®ç°æ¦‚è§ˆ é¡¹ç›®ç»“æ„ é¡¹ç›®çš„ä¸»è¦ç»“æ„åŒ…æ‹¬ï¼š\napp/main.py: FastAPI åº”ç”¨å…¥å£ï¼Œå®šä¹‰ API è·¯ç”±å’Œåº”ç”¨ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ï¼ˆå¦‚æ¨¡å‹åŠ è½½ï¼‰ã€‚ app/models/sensevoice_loader.py: è´Ÿè´£åŠ è½½ SenseVoiceSmall æ¨¡å‹ï¼Œé‡‡ç”¨å•ä¾‹æ¨¡å¼ã€‚ app/services/asr_service.py: å°è£…è¯­éŸ³å¤„ç†å’Œæ¨¡å‹æ¨ç†çš„æ ¸å¿ƒé€»è¾‘ã€‚ app/schemas.py: å®šä¹‰ API çš„è¯·æ±‚å’Œå“åº”æ•°æ®æ¨¡å‹ (Pydantic models)ã€‚ API ç«¯ç‚¹ å…³é”®çš„ API ç«¯ç‚¹è®¾è®¡ä¸ºï¼š\nPOST /asr_pure Content-Type: multipart/form-data Body: file (éŸ³é¢‘æ–‡ä»¶) è¿”å›è½¬å½•åçš„æ–‡æœ¬åŠå¤„ç†æ—¶é—´ã€‚\nè¸©å‘ä¸è§£å†³ä¹‹è·¯ï¼šæ¨¡å‹åŠ è½½çš„æ›²æŠ˜å†ç¨‹ åœ¨é¡¹ç›®æ¨è¿›è¿‡ç¨‹ä¸­ï¼Œæ¨¡å‹åŠ è½½éƒ¨åˆ†æ˜¯é‡åˆ°é—®é¢˜æœ€å¤šçš„åœ°æ–¹ï¼Œä¹Ÿæ˜¯æ”¶è·æœ€å¤šçš„åœ°æ–¹ã€‚\nå‘1ï¼šHugging Face AutoClass çš„ \u0026ldquo;Unrecognized model\u0026rdquo; æœ€åˆï¼Œå°è¯•ä½¿ç”¨ Hugging Face transformers åº“é€šç”¨çš„ AutoProcessor.from_pretrained() å’Œ AutoModelForSpeechSeq2Seq.from_pretrained() æ¥åŠ è½½æœ¬åœ°çš„ SenseVoiceSmall æ¨¡å‹æ–‡ä»¶ã€‚\n# app/models/sensevoice_loader.py (æ—©æœŸå°è¯•) # from transformers import AutoModelForSpeechSeq2Seq, AutoProcessor # ... # self.processor = AutoProcessor.from_pretrained(MODEL_PATH) # self.model = AutoModelForSpeechSeq2Seq.from_pretrained(MODEL_PATH) ç„¶è€Œï¼ŒæœåŠ¡å¯åŠ¨æ—¶ç«‹å³æŠ¥é”™ï¼š\nValueError: Unrecognized model in /home/llm/model/iic/SenseVoiceSmall. Should have a model_type key in its config.json... è¿™ä¸ªé”™è¯¯è¡¨æ˜ transformers çš„è‡ªåŠ¨å‘ç°æœºåˆ¶æ— æ³•è¯†åˆ«æ¨¡å‹ç±»å‹ï¼Œé€šå¸¸æ˜¯å› ä¸ºæ¨¡å‹ç›®å½•ä¸‹çš„ config.json æ–‡ä»¶ç¼ºå°‘ model_type å­—æ®µï¼Œæˆ–è€…è¯¥æ¨¡å‹éœ€è¦ç‰¹å®šçš„åŠ è½½ç±»ã€‚\nå‘2ï¼šè½¬å‘ funasr ä¸ trust_remote_code çš„åˆæ­¥æ¢ç´¢ æŸ¥é˜… FunAudioLLM/SenseVoice çš„å®˜æ–¹æ–‡æ¡£åå‘ç°ï¼Œæ¨èä½¿ç”¨ funasr åº“çš„ AutoModel æ¥åŠ è½½ SenseVoice ç³»åˆ—æ¨¡å‹ã€‚äºæ˜¯è°ƒæ•´äº†ä»£ç ï¼š\næ·»åŠ  funasr åˆ° requirements.txtã€‚ ä¿®æ”¹ SenseVoiceLoader: # app/models/sensevoice_loader.py (å¼•å…¥ funasr) from funasr import AutoModel # ... self.model = AutoModel( model=FUNASR_MODEL_NAME_OR_PATH, # å³æœ¬åœ°è·¯å¾„ trust_remote_code=True, device=self.device ) åŒæ—¶ï¼Œasr_service.py ä¸­çš„æ¨ç†é€»è¾‘ä¹Ÿç›¸åº”è°ƒæ•´ä¸ºè°ƒç”¨ funasr æ¨¡å‹å¯¹è±¡çš„ .generate() æ–¹æ³•ã€‚ æœ¬ä»¥ä¸ºè¿™æ ·èƒ½è§£å†³é—®é¢˜ï¼Œä½†å¯åŠ¨æ—¶åˆé‡åˆ°äº†æ–°çš„æ—¥å¿—ï¼š\nLoading remote code failed: model, No module named \u0026#39;model\u0026#39; å°½ç®¡è¿™æ¡æ—¥å¿—å‡ºç°ï¼Œä½†åç»­çš„ API è°ƒç”¨æµ‹è¯•å±…ç„¶æˆåŠŸäº†ï¼è¿™è®©æˆ‘éå¸¸å›°æƒ‘ã€‚\nå‘3ï¼šremote_code å‚æ•°ä¸ model.py æ–‡ä»¶çš„â€œå¹»å½±â€ æ·±å…¥ç ”ç©¶ funasr å’Œ SenseVoice çš„æ–‡æ¡£ï¼Œæ³¨æ„åˆ°å¯¹äºåŒ…å«è‡ªå®šä¹‰ä»£ç ï¼ˆå¦‚ model.pyï¼‰çš„æ¨¡å‹ï¼Œé™¤äº† trust_remote_code=Trueï¼Œæœ‰æ—¶è¿˜éœ€è¦æ˜ç¡®æŒ‡å®š remote_code å‚æ•°ã€‚\næˆ‘æ£€æŸ¥äº† Hugging Face ä»“åº“ FunAudioLLM/SenseVoiceSmall (https://huggingface.co/FunAudioLLM/SenseVoiceSmall/tree/main)ï¼Œå‘ç°å…¶æ–‡ä»¶åˆ—è¡¨ä¸­ç¡®å®åŒ…å«ä¸€ä¸ª model.pyã€‚å› æ­¤ï¼Œæˆ‘å°è¯•åœ¨ AutoModel è°ƒç”¨ä¸­åŠ å…¥ remote_code=\u0026quot;model.py\u0026quot;ã€‚\n# app/models/sensevoice_loader.py (å°è¯•æŒ‡å®š remote_code) self.model = AutoModel( model=FUNASR_MODEL_NAME_OR_PATH, trust_remote_code=True, remote_code=\u0026#34;model.py\u0026#34;, # \u0026lt;--- æ–°å¢ device=self.device ) ç»“æœï¼ŒNo module named 'model' çš„é”™è¯¯ä¾æ—§ã€‚\nè§£å†³æ–¹æ¡ˆï¼šæ¾„æ¸… ModelScope ä¸ Hugging Face çš„æ¨¡å‹æ–‡ä»¶å·®å¼‚ æœ¬åœ°æ¨¡å‹ /home/llm/model/iic/SenseVoiceSmall æ˜¯ä» ModelScope (https://www.modelscope.cn/models/iic/SenseVoiceSmall/files) ä¸‹è½½çš„ï¼Œè€Œéç›´æ¥ clone Hugging Face çš„ä»“åº“ã€‚é€šè¿‡ ls -al /home/llm/model/iic/SenseVoiceSmall/ æŸ¥çœ‹æœ¬åœ°æ–‡ä»¶ï¼Œå‘ç°ç¡®å®æ²¡æœ‰ model.py æ–‡ä»¶ï¼\nè¿™è§£é‡Šäº†ä¸ºä»€ä¹ˆæŒ‡å®š remote_code=\u0026quot;model.py\u0026quot; ä¾ç„¶æŠ¥é”™ã€‚ModelScope æä¾›çš„æ¨¡å‹åŒ…å¯èƒ½ä¸ Hugging Face ä»“åº“ä¸­çš„æ–‡ä»¶ç»“æ„ä¸å®Œå…¨ä¸€è‡´ï¼Œç‰¹åˆ«æ˜¯å¯¹äºè¿™ç§ä¾èµ– funasr ç‰¹å®šåŠ è½½æ–¹å¼çš„æ¨¡å‹ã€‚\næœ€ç»ˆçš„æ­£ç¡®é…ç½®ï¼šç§»é™¤ remote_code å‚æ•°ï¼Œä½†ä¿ç•™ trust_remote_code=Trueã€‚\n# app/models/sensevoice_loader.py (æœ€ç»ˆæ­£ç¡®é…ç½®) self.model = AutoModel( model=FUNASR_MODEL_NAME_OR_PATH, trust_remote_code=True, # ä¿ç•™ï¼Œfunasr å¯èƒ½ä»éœ€æ­¤æƒé™å¤„ç† ModelScope æ¨¡å‹ # remote_code=\u0026#34;model.py\u0026#34;, # ç§»é™¤ï¼Œå› ä¸ºæœ¬åœ° ModelScope ç‰ˆæœ¬æ— æ­¤æ–‡ä»¶ device=self.device ) è¿™æ ·ä¿®æ”¹åï¼ŒæœåŠ¡å¯åŠ¨æ—¶ä»ç„¶ä¼šæ‰“å° Loading remote code failed: model, No module named 'model'ï¼Œä½† API è°ƒç”¨å®Œå…¨æ­£å¸¸ï¼\nåŸå› åˆ†æï¼šfunasr åœ¨ trust_remote_code=True æ—¶ï¼Œä¼šä¼˜å…ˆå°è¯•åŠ è½½è‡ªå®šä¹‰ä»£ç ã€‚å¦‚æœæœ¬åœ°æ¨¡å‹è·¯å¾„ï¼ˆå¦‚ä» ModelScope ä¸‹è½½çš„ï¼‰æ²¡æœ‰ model.pyï¼Œè¿™ä¸ªå°è¯•ä¼šå¤±è´¥å¹¶æ‰“å°æ—¥å¿—ã€‚ä½†éšåï¼Œfunasr èƒ½å¤Ÿè¯†åˆ«å‡ºè¿™æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„ ModelScope æ¨¡å‹è·¯å¾„ï¼Œå¹¶è½¬ç”¨å…¶å†…éƒ¨çš„æ ‡å‡†åŠ è½½æµç¨‹æˆåŠŸåŠ è½½æ¨¡å‹ã€‚å› æ­¤ï¼Œè¯¥æ—¥å¿—åœ¨è¿™ç§æƒ…å†µä¸‹æ˜¯è‰¯æ€§çš„ã€‚\næ¨¡å‹å¯¹æ¯”ä¸é€‰å‹æ€è€ƒ åœ¨è§£å†³é—®é¢˜çš„è¿‡ç¨‹ä¸­ï¼Œä¹Ÿæ¢è®¨äº† FunAudioLLM/SenseVoiceSmall ä¸å…¶ä»–ä¸»æµ ASR æ¨¡å‹çš„å¯¹æ¯”ï¼š\nOpenAI Whisper ç³»åˆ— (å¦‚ whisper-large-v3):\nä¼˜åŠ¿: æé«˜çš„å‡†ç¡®ç‡ï¼Œå¼ºå¤§çš„å¤šè¯­è¨€èƒ½åŠ›ï¼Œåºå¤§çš„ç¤¾åŒºã€‚ åŠ£åŠ¿: æ¨ç†é€Ÿåº¦ç›¸å¯¹è¾ƒæ…¢ï¼ˆå°¤å…¶å¤§æ¨¡å‹ï¼‰ï¼Œä¸ç›´æ¥æä¾›æƒ…æ„Ÿ/äº‹ä»¶æ£€æµ‹ã€‚ Wav2Vec2 ç³»åˆ—:\nä¼˜åŠ¿: è‡ªç›‘ç£å­¦ä¹ å…¸èŒƒï¼Œå¤§é‡ç‰¹å®šè¯­è¨€å¾®è°ƒæ¨¡å‹ã€‚ åŠ£åŠ¿: åŸºç¡€æ¨¡å‹åŠŸèƒ½ç›¸å¯¹å•ä¸€ã€‚ SenseVoiceSmall çš„æ ¸å¿ƒä¼˜åŠ¿ é«˜æ•ˆæ¨ç†ï¼šå…¶æ¨¡å‹å¡å£°ç§°é‡‡ç”¨éè‡ªå›å½’ç«¯åˆ°ç«¯æ¡†æ¶ï¼Œæ¯” Whisper-Large å¿«15å€ã€‚è¿™å¯¹äºéœ€è¦ä½å»¶è¿Ÿçš„åº”ç”¨è‡³å…³é‡è¦ã€‚\nå¤šä»»åŠ¡é›†æˆï¼šå†…ç½® ASRã€LIDï¼ˆè¯­ç§è¯†åˆ«ï¼‰ã€SERï¼ˆæƒ…æ„Ÿè¯†åˆ«ï¼‰ã€AEDï¼ˆäº‹ä»¶æ£€æµ‹ï¼‰ã€‚å¦‚æœåº”ç”¨åœºæ™¯éœ€è¦è¿™äº›é™„åŠ ä¿¡æ¯ï¼ŒSenseVoiceSmall æä¾›äº†ä¸€ç«™å¼è§£å†³æ–¹æ¡ˆã€‚\nç‰¹å®šè¯­è¨€ä¼˜åŒ–ï¼šåœ¨ä¸­æ–‡ã€ç²¤è¯­ç­‰è¯­è¨€ä¸Šè¡¨ç°çªå‡ºã€‚\nç»“è®º æ²¡æœ‰ç»å¯¹çš„â€œæœ€å¥½â€ï¼Œåªæœ‰â€œæœ€é€‚åˆâ€ã€‚\nè‹¥è¿½æ±‚æè‡´å‡†ç¡®æ€§å’Œæœ€å¹¿è¯­è¨€è¦†ç›–ï¼Œä¸”å¯¹å»¶è¿Ÿä¸æ•æ„Ÿï¼ŒWhisper ä»æ˜¯é¦–é€‰ã€‚ è‹¥å¯¹æ¨ç†æ•ˆç‡ã€é›†æˆçš„å¤šä»»åŠ¡è¯­éŸ³ç†è§£ï¼ˆç‰¹åˆ«æ˜¯æƒ…æ„Ÿ/äº‹ä»¶ï¼‰æˆ–ä¸­æ–‡ç­‰ç‰¹å®šåœºæ™¯æœ‰é«˜è¦æ±‚ï¼ŒSenseVoiceSmall æ˜¯ä¸€ä¸ªæå…·ç«äº‰åŠ›çš„é€‰æ‹©ã€‚ ç›®å‰é€‰æ‹©çš„ SenseVoiceSmallï¼Œå°¤å…¶æ˜¯åœ¨ç¡®è®¤äº†å…¶ ModelScope ç‰ˆæœ¬èƒ½å¤Ÿé¡ºç•…è¿è¡Œåï¼Œå¯¹äºæˆ‘çš„é¡¹ç›®ç›®æ ‡æ¥è¯´æ˜¯ä¸€ä¸ªåˆé€‚çš„èµ·ç‚¹ã€‚\nå½“å‰çŠ¶æ€ä¸å±•æœ› ç›®å‰ï¼ŒåŸºäº FunAudioLLM/SenseVoiceSmall å’Œ FastAPI çš„è¯­éŸ³è½¬å½•æœåŠ¡å·²æˆåŠŸæ­å»ºå¹¶èƒ½æ­£ç¡®å¤„ç†è¯·æ±‚ã€‚\n$ curl -X POST \u0026#34;http://\u0026lt;your_server_ip\u0026gt;:8888/asr_pure\u0026#34; -F \u0026#34;file=@test_audio.wav\u0026#34; {\u0026#34;text\u0026#34;:\u0026#34;å¤ªå¥½äº†ï¼Œé‚£æ¥ä¸‹æ¥å’±ä»¬å¯ä»¥è¯•è¯•å…¶ä»–åŠŸèƒ½äº†ã€‚æ¯”å¦‚è¯´ä½ æƒ³æµ‹è¯•ä¸€ä¸‹è¯­éŸ³åˆæˆçš„æ•ˆæœæ€ä¹ˆæ ·ï¼Œæˆ–è€…æ˜¯çœ‹çœ‹æœ‰æ²¡æœ‰ä»€ä¹ˆæ–°çš„è¯­éŸ³å¤„ç†åŠŸèƒ½å‡ºæ¥å•¦ã€‚ğŸ˜”\u0026#34;,\u0026#34;status\u0026#34;:\u0026#34;success\u0026#34;,\u0026#34;processing_time_ms\u0026#34;:503.39...} åç»­å¯ä¼˜åŒ–çš„æ–¹å‘ æ€§èƒ½ä¼˜åŒ–ï¼šè¿›ä¸€æ­¥æµ‹è¯•å¹¶å‘å¤„ç†èƒ½åŠ›ï¼Œè€ƒè™‘å¤š worker é…ç½®ã€‚ é”™è¯¯å¤„ç†ä¸æ—¥å¿—ï¼šå®Œå–„æ›´ç»†è‡´çš„é”™è¯¯æ•è·å’Œæ—¥å¿—è®°å½•ã€‚ åŠŸèƒ½æ‰©å±•ï¼šå¦‚æœéœ€è¦ï¼Œå¯ä»¥åˆ©ç”¨ SenseVoiceSmall çš„æƒ…æ„Ÿè¯†åˆ«å’Œäº‹ä»¶æ£€æµ‹èƒ½åŠ›ã€‚ VAD é›†æˆï¼šå¯¹äºé•¿éŸ³é¢‘ï¼Œè€ƒè™‘åœ¨ funasr.AutoModel åŠ è½½æ—¶é›†æˆ VAD (Voice Activity Detection) åŠŸèƒ½ï¼Œä»¥å®ç°è‡ªåŠ¨åˆ†æ®µå¤„ç†ï¼Œæå‡é•¿éŸ³é¢‘å¤„ç†çš„ç¨³å®šæ€§å’Œæ•ˆç‡ã€‚ å¼‚æ­¥å¤„ç†ä¸é˜Ÿåˆ—ï¼šå¯¹äºé«˜å¹¶å‘åœºæ™¯ï¼Œå¼•å…¥æ¶ˆæ¯é˜Ÿåˆ—å’Œå¼‚æ­¥ä»»åŠ¡å¤„ç†ã€‚ ","permalink":"https://jackypanster.github.io/ai-stream/posts/howto-use-sensevoicesmall/","summary":"\u003ch1 id=\"åŸºäºfunaudiollmsensevoicesmallæ­å»ºé«˜æ•ˆè¯­éŸ³è½¬å½•æœåŠ¡çš„å®è·µä¹‹è·¯\"\u003eåŸºäºFunAudioLLM/SenseVoiceSmallæ­å»ºé«˜æ•ˆè¯­éŸ³è½¬å½•æœåŠ¡çš„å®è·µä¹‹è·¯\u003c/h1\u003e\n\u003ch2 id=\"é¡¹ç›®æ¦‚è¿°\"\u003eé¡¹ç›®æ¦‚è¿°\u003c/h2\u003e\n\u003cp\u003eå®ç°ä¸€ä¸ªè¯­éŸ³è½¬å½•æ–‡æœ¬ï¼ˆASRï¼‰çš„æœåŠ¡ï¼Œç›®æ ‡æ˜¯èƒ½å¤Ÿé«˜æ•ˆåœ°å°†ç”¨æˆ·ä¸Šä¼ çš„éŸ³é¢‘æ–‡ä»¶è½¬æ¢ä¸ºæ–‡å­—ã€‚å‡ºäºä¸­æ–‡è¯­éŸ³çš„è€ƒè™‘ï¼Œé€‰æ‹©äº†æ¥è‡ª \u003ccode\u003eFunAudioLLM\u003c/code\u003e çš„ \u003ccode\u003eSenseVoiceSmall\u003c/code\u003e æ¨¡å‹ï¼Œå®ƒä»¥å…¶å¤šè¯­ç§æ”¯æŒã€é«˜æ•ˆç‡ä»¥åŠé›†æˆçš„è¯­éŸ³ç†è§£èƒ½åŠ›ï¼ˆå¦‚æƒ…æ„Ÿè¯†åˆ«ã€äº‹ä»¶æ£€æµ‹ï¼‰å¸å¼•äº†æˆ‘ã€‚æœ¬æ–‡å°†è¯¦ç»†è®°å½•ä»ç¯å¢ƒé…ç½®ã€æ ¸å¿ƒåŠŸèƒ½å®ç°åˆ°è¸©å‘è§£å†³çš„å…¨è¿‡ç¨‹ï¼Œå¹¶åˆ†äº«ä¸€äº›å…³äºæ¨¡å‹é€‰å‹çš„æ€è€ƒã€‚\u003c/p\u003e\n\u003cp\u003eå®Œæ•´ä»£ç å·²å¼€æºåœ¨ GitHub ä»“åº“ï¼š\u003ca href=\"https://github.com/jackypanster/FunAudioLLM-SenseVoiceSmall\"\u003ehttps://github.com/jackypanster/FunAudioLLM-SenseVoiceSmall\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eé¡¹ç›®éœ€æ±‚æ–‡æ¡£ï¼ˆ\u003ccode\u003eprd.md\u003c/code\u003eï¼‰å…³é”®ä¿¡æ¯å¦‚ä¸‹ï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eæ¨¡å‹\u003c/strong\u003e: FunAudioLLM/SenseVoice (å…·ä½“ä¸º \u003ccode\u003eSenseVoiceSmall\u003c/code\u003e)\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eæœ¬åœ°æ¨¡å‹è·¯å¾„\u003c/strong\u003e: \u003ccode\u003e/home/llm/model/iic/SenseVoiceSmall\u003c/code\u003e (ä» ModelScope ä¸‹è½½)\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eAPIæ¡†æ¶\u003c/strong\u003e: FastAPI\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003ePythonç¯å¢ƒç®¡ç†\u003c/strong\u003e: \u003ccode\u003euv\u003c/code\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"ç¯å¢ƒé…ç½®\"\u003eç¯å¢ƒé…ç½®\u003c/h2\u003e\n\u003cp\u003eä¸ºäº†ä¿æŒå¼€å‘ç¯å¢ƒçš„çº¯å‡€å’Œé«˜æ•ˆï¼Œé‡‡ç”¨äº† \u003ccode\u003euv\u003c/code\u003e æ¥ç®¡ç† Python ä¾èµ–ã€‚\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eåˆ›å»ºè™šæ‹Ÿç¯å¢ƒ\u003c/strong\u003e (å¦‚æœå°šæœªåˆ›å»º):\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003euv venv .venv\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003esource .venv/bin/activate\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eå®‰è£…æ ¸å¿ƒä¾èµ–\u003c/strong\u003e:\nåˆå§‹çš„ \u003ccode\u003erequirements.txt\u003c/code\u003e åŒ…å«äº† \u003ccode\u003efastapi\u003c/code\u003e, \u003ccode\u003euvicorn\u003c/code\u003e, \u003ccode\u003epython-multipart\u003c/code\u003e ç­‰åŸºç¡€åº“ã€‚åç»­æ ¹æ®æ¨¡å‹åŠ è½½å’Œå¤„ç†çš„éœ€æ±‚ï¼Œé€æ­¥æ·»åŠ äº† \u003ccode\u003etorch\u003c/code\u003e, \u003ccode\u003etorchaudio\u003c/code\u003e, \u003ccode\u003enumpy\u003c/code\u003e, \u003ccode\u003etransformers\u003c/code\u003e, \u003ccode\u003esentencepiece\u003c/code\u003e, ä»¥åŠæœ€ç»ˆè§£å†³æ¨¡å‹åŠ è½½é—®é¢˜çš„æ ¸å¿ƒåº“ \u003ccode\u003efunasr\u003c/code\u003eã€‚\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003euv pip install -r requirements.txt\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch2 id=\"æ ¸å¿ƒåŠŸèƒ½å®ç°æ¦‚è§ˆ\"\u003eæ ¸å¿ƒåŠŸèƒ½å®ç°æ¦‚è§ˆ\u003c/h2\u003e\n\u003ch3 id=\"é¡¹ç›®ç»“æ„\"\u003eé¡¹ç›®ç»“æ„\u003c/h3\u003e\n\u003cp\u003eé¡¹ç›®çš„ä¸»è¦ç»“æ„åŒ…æ‹¬ï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003eapp/main.py\u003c/code\u003e: FastAPI åº”ç”¨å…¥å£ï¼Œå®šä¹‰ API è·¯ç”±å’Œåº”ç”¨ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ï¼ˆå¦‚æ¨¡å‹åŠ è½½ï¼‰ã€‚\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eapp/models/sensevoice_loader.py\u003c/code\u003e: è´Ÿè´£åŠ è½½ \u003ccode\u003eSenseVoiceSmall\u003c/code\u003e æ¨¡å‹ï¼Œé‡‡ç”¨å•ä¾‹æ¨¡å¼ã€‚\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eapp/services/asr_service.py\u003c/code\u003e: å°è£…è¯­éŸ³å¤„ç†å’Œæ¨¡å‹æ¨ç†çš„æ ¸å¿ƒé€»è¾‘ã€‚\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eapp/schemas.py\u003c/code\u003e: å®šä¹‰ API çš„è¯·æ±‚å’Œå“åº”æ•°æ®æ¨¡å‹ (Pydantic models)ã€‚\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"api-ç«¯ç‚¹\"\u003eAPI ç«¯ç‚¹\u003c/h3\u003e\n\u003cp\u003eå…³é”®çš„ API ç«¯ç‚¹è®¾è®¡ä¸ºï¼š\u003c/p\u003e","title":"åŸºäºFunAudioLLM/SenseVoiceSmallæ­å»ºé«˜æ•ˆè¯­éŸ³è½¬å½•æœåŠ¡çš„å®è·µä¹‹è·¯"},{"content":"å¦‚ä½•ä½¿ç”¨Qwen2.5-Omniå®ç°æ–‡æœ¬è½¬è¯­éŸ³(TTS)å’Œè¯­éŸ³è½¬æ–‡æœ¬(ASR) é¡¹ç›®æ¦‚è¿° æœ¬é¡¹ç›®åŸºäºQwen2.5-Omni-7Bæ¨¡å‹ï¼Œå®ç°äº†ä¸¤ä¸ªæ ¸å¿ƒåŠŸèƒ½ï¼š\næ–‡æœ¬è½¬è¯­éŸ³ï¼ˆTTSï¼‰ï¼šå°†è¾“å…¥æ–‡æœ¬è½¬æ¢ä¸ºè‡ªç„¶æµç•…çš„è¯­éŸ³ è¯­éŸ³è½¬æ–‡æœ¬ï¼ˆASRï¼‰ï¼šå°†è¯­éŸ³æ–‡ä»¶è½¬æ¢ä¸ºæ–‡æœ¬ï¼Œæ”¯æŒæ ‡å‡†ASRå’Œçº¯ASRä¸¤ç§æ¨¡å¼ é¡¹ç›®åœ°å€ï¼šhttps://github.com/jackypanster/qwen-omni\nç¯å¢ƒé…ç½® æ¨èä½¿ç”¨condaç®¡ç†Pythonç¯å¢ƒï¼Œç¡®ä¿ä¾èµ–å®‰è£…çš„ç¨³å®šæ€§ï¼š\n# åˆ›å»ºå¹¶æ¿€æ´»ç¯å¢ƒ conda create -n qwen-tts python=3.10 conda activate qwen-tts # å®‰è£…PyTorchï¼ˆGPUç‰ˆæœ¬ï¼‰ conda install pytorch=2.5.1 pytorch-cuda=12.1 -c pytorch -c nvidia conda install torchvision torchaudio -c pytorch # å®‰è£…å…¶ä»–ä¾èµ– conda install streamlit python-soundfile -c conda-forge pip install git+https://github.com/huggingface/transformers@v4.51.3-Qwen2.5-Omni-preview pip install qwen-omni-utils æ ¸å¿ƒåŠŸèƒ½å®ç° 1. æ–‡æœ¬è½¬è¯­éŸ³ï¼ˆTTSï¼‰ def text_to_speech(text_input, output_audio_path=\u0026#34;output/output.wav\u0026#34;, speaker=\u0026#34;Chelsie\u0026#34;): # åŠ è½½æ¨¡å‹å’Œå¤„ç†å™¨ model = Qwen2_5OmniForConditionalGeneration.from_pretrained( model_path, config=config, torch_dtype=\u0026#34;auto\u0026#34;, device_map=\u0026#34;auto\u0026#34; ) processor = Qwen2_5OmniProcessor.from_pretrained(model_path) # æ„é€ å¯¹è¯ conversation = [ {\u0026#34;role\u0026#34;: \u0026#34;system\u0026#34;, \u0026#34;content\u0026#34;: [{\u0026#34;type\u0026#34;: \u0026#34;text\u0026#34;, \u0026#34;text\u0026#34;: \u0026#34;You are Qwen...\u0026#34;}]}, {\u0026#34;role\u0026#34;: \u0026#34;user\u0026#34;, \u0026#34;content\u0026#34;: [{\u0026#34;type\u0026#34;: \u0026#34;text\u0026#34;, \u0026#34;text\u0026#34;: text_input}]} ] # ç”Ÿæˆè¯­éŸ³ with torch.no_grad(): text_ids, audio = model.generate( **inputs, speaker=speaker, do_sample=True, temperature=0.8, top_p=0.95, max_new_tokens=1024 ) 2. è¯­éŸ³è½¬æ–‡æœ¬ï¼ˆASRï¼‰ def audio_to_text(audio_path: str) -\u0026gt; str: # æ ‡å‡†ASRæ¨¡å¼ conversation = [ {\u0026#34;role\u0026#34;: \u0026#34;system\u0026#34;, \u0026#34;content\u0026#34;: [{\u0026#34;type\u0026#34;: \u0026#34;text\u0026#34;, \u0026#34;text\u0026#34;: \u0026#34;ä½ æ˜¯Qwen...\u0026#34;}]}, {\u0026#34;role\u0026#34;: \u0026#34;user\u0026#34;, \u0026#34;content\u0026#34;: [{\u0026#34;type\u0026#34;: \u0026#34;audio\u0026#34;, \u0026#34;audio\u0026#34;: audio_path}]} ] # ç”Ÿæˆæ–‡æœ¬ with torch.no_grad(): text_ids = model.generate( **inputs, do_sample=False, max_new_tokens=1024, return_audio=False ) Webç•Œé¢å®ç° ä½¿ç”¨Streamlitæ„å»ºäº†ç®€æ´çš„Webç•Œé¢ï¼š\n# æ–‡æœ¬è¾“å…¥ text_input = st.text_area(\u0026#34;è¯·è¾“å…¥è¦åˆæˆçš„æ–‡æœ¬ï¼š\u0026#34;, height=120, max_chars=200) # å‘éŸ³äººé€‰æ‹© speaker = st.selectbox(\u0026#34;è¯·é€‰æ‹©å‘éŸ³äººï¼š\u0026#34;, [\u0026#34;Chelsie\u0026#34;, \u0026#34;Ethan\u0026#34;], index=0) # ç”ŸæˆæŒ‰é’® if st.button(\u0026#34;ç”Ÿæˆè¯­éŸ³\u0026#34;): # ç”Ÿæˆè¯­éŸ³å¹¶æ’­æ”¾ audio_path = os.path.join(OUTPUT_DIR, f\u0026#34;tts_{uuid.uuid4().hex}.wav\u0026#34;) text_to_speech(text_input, output_audio_path=audio_path, speaker=speaker) st.audio(audio_path, format=\u0026#34;audio/wav\u0026#34;) RESTful APIå®ç° ä½¿ç”¨FastAPIæ„å»ºäº†RESTful APIæ¥å£ï¼š\n@app.post(\u0026#34;/tts\u0026#34;) async def tts(request: TTSRequest): audio_filename = f\u0026#34;tts_{uuid.uuid4().hex}.wav\u0026#34; audio_path = os.path.join(OUTPUT_DIR, audio_filename) text_to_speech(request.text, audio_path, request.speaker) return {\u0026#34;audio_url\u0026#34;: f\u0026#34;/output/{audio_filename}\u0026#34;} @app.post(\u0026#34;/asr\u0026#34;) async def asr(file: UploadFile = File(...)): # å¤„ç†ä¸Šä¼ çš„éŸ³é¢‘æ–‡ä»¶ audio_path = os.path.join(OUTPUT_DIR, f\u0026#34;asr_{uuid.uuid4().hex}.wav\u0026#34;) with open(audio_path, \u0026#34;wb\u0026#34;) as buffer: shutil.copyfileobj(file.file, buffer) text = audio_to_text(audio_path) return {\u0026#34;text\u0026#34;: text} ä½¿ç”¨è¯´æ˜ å¯åŠ¨Webç•Œé¢ï¼š streamlit run app_text2audio.py å¯åŠ¨APIæœåŠ¡ï¼š uvicorn fastapi_app:app --host 0.0.0.0 --port 8000 æ³¨æ„äº‹é¡¹ æ¨¡å‹æ–‡ä»¶è¾ƒå¤§ï¼Œå»ºè®®æå‰ä¸‹è½½å¹¶é…ç½®å¥½æ¨¡å‹è·¯å¾„ ä½¿ç”¨condaå®‰è£…ä¾èµ–å¯ä»¥é¿å…å¤§å¤šæ•°ç¯å¢ƒé—®é¢˜ éŸ³é¢‘æ–‡ä»¶ä¼šä¿å­˜åœ¨outputç›®å½•ä¸‹ APIæ¥å£æ”¯æŒæ–‡ä»¶ä¸Šä¼ å’Œæ–‡æœ¬è½¬å†™ åç»­ä¼˜åŒ–æ–¹å‘ æ”¯æŒæ›´å¤šå‘éŸ³äººé€‰é¡¹ ä¼˜åŒ–æ¨¡å‹åŠ è½½é€Ÿåº¦ æ·»åŠ æ‰¹é‡å¤„ç†åŠŸèƒ½ æ”¯æŒæ›´å¤šéŸ³é¢‘æ ¼å¼ æ·»åŠ å†å²è®°å½•åŠŸèƒ½ å‚è€ƒèµ„æº Qwen2.5-Omni-7Bå®˜æ–¹æ–‡æ¡£ Streamlitæ–‡æ¡£ FastAPIæ–‡æ¡£ ","permalink":"https://jackypanster.github.io/ai-stream/posts/how-to-use-qwen-omni-tts-asr/","summary":"\u003ch1 id=\"å¦‚ä½•ä½¿ç”¨qwen25-omniå®ç°æ–‡æœ¬è½¬è¯­éŸ³ttså’Œè¯­éŸ³è½¬æ–‡æœ¬asr\"\u003eå¦‚ä½•ä½¿ç”¨Qwen2.5-Omniå®ç°æ–‡æœ¬è½¬è¯­éŸ³(TTS)å’Œè¯­éŸ³è½¬æ–‡æœ¬(ASR)\u003c/h1\u003e\n\u003ch2 id=\"é¡¹ç›®æ¦‚è¿°\"\u003eé¡¹ç›®æ¦‚è¿°\u003c/h2\u003e\n\u003cp\u003eæœ¬é¡¹ç›®åŸºäºQwen2.5-Omni-7Bæ¨¡å‹ï¼Œå®ç°äº†ä¸¤ä¸ªæ ¸å¿ƒåŠŸèƒ½ï¼š\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eæ–‡æœ¬è½¬è¯­éŸ³ï¼ˆTTSï¼‰ï¼šå°†è¾“å…¥æ–‡æœ¬è½¬æ¢ä¸ºè‡ªç„¶æµç•…çš„è¯­éŸ³\u003c/li\u003e\n\u003cli\u003eè¯­éŸ³è½¬æ–‡æœ¬ï¼ˆASRï¼‰ï¼šå°†è¯­éŸ³æ–‡ä»¶è½¬æ¢ä¸ºæ–‡æœ¬ï¼Œæ”¯æŒæ ‡å‡†ASRå’Œçº¯ASRä¸¤ç§æ¨¡å¼\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eé¡¹ç›®åœ°å€ï¼š\u003ca href=\"https://github.com/jackypanster/qwen-omni\"\u003ehttps://github.com/jackypanster/qwen-omni\u003c/a\u003e\u003c/p\u003e\n\u003ch2 id=\"ç¯å¢ƒé…ç½®\"\u003eç¯å¢ƒé…ç½®\u003c/h2\u003e\n\u003cp\u003eæ¨èä½¿ç”¨condaç®¡ç†Pythonç¯å¢ƒï¼Œç¡®ä¿ä¾èµ–å®‰è£…çš„ç¨³å®šæ€§ï¼š\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e# åˆ›å»ºå¹¶æ¿€æ´»ç¯å¢ƒ\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003econda create -n qwen-tts python\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e3.10\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003econda activate qwen-tts\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e# å®‰è£…PyTorchï¼ˆGPUç‰ˆæœ¬ï¼‰\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003econda install pytorch\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e2.5.1 pytorch-cuda\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e12.1 -c pytorch -c nvidia\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003econda install torchvision torchaudio -c pytorch\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e# å®‰è£…å…¶ä»–ä¾èµ–\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003econda install streamlit python-soundfile -c conda-forge\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003epip install git+https://github.com/huggingface/transformers@v4.51.3-Qwen2.5-Omni-preview\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003epip install qwen-omni-utils\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"æ ¸å¿ƒåŠŸèƒ½å®ç°\"\u003eæ ¸å¿ƒåŠŸèƒ½å®ç°\u003c/h2\u003e\n\u003ch3 id=\"1-æ–‡æœ¬è½¬è¯­éŸ³tts\"\u003e1. æ–‡æœ¬è½¬è¯­éŸ³ï¼ˆTTSï¼‰\u003c/h3\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-python\" data-lang=\"python\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#66d9ef\"\u003edef\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003etext_to_speech\u003c/span\u003e(text_input, output_audio_path\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;output/output.wav\u0026#34;\u003c/span\u003e, speaker\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Chelsie\u0026#34;\u003c/span\u003e):\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#75715e\"\u003e# åŠ è½½æ¨¡å‹å’Œå¤„ç†å™¨\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    model \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e Qwen2_5OmniForConditionalGeneration\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003efrom_pretrained(\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        model_path, \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        config\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003econfig, \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        torch_dtype\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;auto\u0026#34;\u003c/span\u003e, \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        device_map\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;auto\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    )\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    processor \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e Qwen2_5OmniProcessor\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003efrom_pretrained(model_path)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#75715e\"\u003e# æ„é€ å¯¹è¯\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    conversation \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e [\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        {\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;role\u0026#34;\u003c/span\u003e: \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;system\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;content\u0026#34;\u003c/span\u003e: [{\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;type\u0026#34;\u003c/span\u003e: \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;text\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;text\u0026#34;\u003c/span\u003e: \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;You are Qwen...\u0026#34;\u003c/span\u003e}]},\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        {\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;role\u0026#34;\u003c/span\u003e: \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;user\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;content\u0026#34;\u003c/span\u003e: [{\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;type\u0026#34;\u003c/span\u003e: \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;text\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;text\u0026#34;\u003c/span\u003e: text_input}]}\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    ]\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#75715e\"\u003e# ç”Ÿæˆè¯­éŸ³\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003ewith\u003c/span\u003e torch\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003eno_grad():\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        text_ids, audio \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e model\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003egenerate(\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#f92672\"\u003e**\u003c/span\u003einputs,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            speaker\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003espeaker,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            do_sample\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#66d9ef\"\u003eTrue\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            temperature\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e0.8\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            top_p\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e0.95\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            max_new_tokens\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e1024\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        )\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"2-è¯­éŸ³è½¬æ–‡æœ¬asr\"\u003e2. è¯­éŸ³è½¬æ–‡æœ¬ï¼ˆASRï¼‰\u003c/h3\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-python\" data-lang=\"python\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#66d9ef\"\u003edef\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eaudio_to_text\u003c/span\u003e(audio_path: str) \u003cspan style=\"color:#f92672\"\u003e-\u0026gt;\u003c/span\u003e str:\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#75715e\"\u003e# æ ‡å‡†ASRæ¨¡å¼\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    conversation \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e [\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        {\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;role\u0026#34;\u003c/span\u003e: \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;system\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;content\u0026#34;\u003c/span\u003e: [{\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;type\u0026#34;\u003c/span\u003e: \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;text\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;text\u0026#34;\u003c/span\u003e: \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;ä½ æ˜¯Qwen...\u0026#34;\u003c/span\u003e}]},\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        {\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;role\u0026#34;\u003c/span\u003e: \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;user\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;content\u0026#34;\u003c/span\u003e: [{\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;type\u0026#34;\u003c/span\u003e: \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;audio\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;audio\u0026#34;\u003c/span\u003e: audio_path}]}\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    ]\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#75715e\"\u003e# ç”Ÿæˆæ–‡æœ¬\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003ewith\u003c/span\u003e torch\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003eno_grad():\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        text_ids \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e model\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003egenerate(\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#f92672\"\u003e**\u003c/span\u003einputs,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            do_sample\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#66d9ef\"\u003eFalse\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            max_new_tokens\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e1024\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            return_audio\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#66d9ef\"\u003eFalse\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        )\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"webç•Œé¢å®ç°\"\u003eWebç•Œé¢å®ç°\u003c/h2\u003e\n\u003cp\u003eä½¿ç”¨Streamlitæ„å»ºäº†ç®€æ´çš„Webç•Œé¢ï¼š\u003c/p\u003e","title":"å¦‚ä½•ä½¿ç”¨Qwen2.5-Omniå®ç°æ–‡æœ¬è½¬è¯­éŸ³(TTS)å’Œè¯­éŸ³è½¬æ–‡æœ¬(ASR)"},{"content":"\næ¦‚è¿° æœ¬è„šæœ¬åŸºäº Qwen2.5-Omni-7B å¤šæ¨¡æ€æ¨¡å‹å®ç°æ–‡æœ¬è½¬è¯­éŸ³ï¼ˆTTSï¼‰åŠŸèƒ½ï¼Œæ”¯æŒç”Ÿæˆè‡ªç„¶æµç•…çš„ä¸­æ–‡ / è‹±æ–‡è¯­éŸ³ï¼Œå¹¶æä¾›ä¸¤ç§è¯­éŸ³ç±»å‹ï¼ˆå¥³æ€§ â€œChelsieâ€ã€ç”·æ€§ â€œEthanâ€ï¼‰ã€‚è„šæœ¬å¯å°†è¾“å…¥æ–‡æœ¬è½¬æ¢ä¸ºéŸ³é¢‘æ–‡ä»¶ï¼ˆ.wavæ ¼å¼ï¼‰ï¼Œé€‚ç”¨äºè¯­éŸ³åŠ©æ‰‹ã€å†…å®¹åˆ›ä½œã€æ— éšœç¢æœåŠ¡ç­‰åœºæ™¯ã€‚\nä¸»è¦ç‰¹æ€§ ğŸ™ï¸ æ”¯æŒè‡ªç„¶æµç•…çš„ ä¸­æ–‡/è‹±æ–‡ è¯­éŸ³åˆæˆ ğŸ‘¥ æä¾›ä¸¤ç§è¯­éŸ³ç±»å‹é€‰æ‹©ï¼š å¥³æ€§å£°çº¿ï¼š\u0026ldquo;Chelsie\u0026rdquo; ç”·æ€§å£°çº¿ï¼š\u0026ldquo;Ethan\u0026rdquo; ğŸ’¾ è¾“å‡ºæ ¼å¼ï¼šæ ‡å‡† .wav éŸ³é¢‘æ–‡ä»¶ ğŸš€ é«˜æ€§èƒ½æ¨ç†ï¼Œé€‚ç”¨äºç”Ÿäº§ç¯å¢ƒ åº”ç”¨åœºæ™¯ æ™ºèƒ½è¯­éŸ³åŠ©æ‰‹å¼€å‘ å†…å®¹åˆ›ä½œä¸æ’­å®¢åˆ¶ä½œ æ— éšœç¢æœåŠ¡ æ•™è‚²ç±»åº”ç”¨ å¤šåª’ä½“å†…å®¹ç”Ÿæˆ å¼€å§‹ä½¿ç”¨ ğŸ’¡ åœ¨å¼€å§‹ä¹‹å‰ï¼Œè¯·ç¡®ä¿æ‚¨çš„ç³»ç»Ÿæ»¡è¶³ä»¥ä¸‹è¦æ±‚ï¼š\nPython 3.8+ CUDA 11.7+ (å¦‚éœ€GPUåŠ é€Ÿ) è‡³å°‘16GBå¯ç”¨å†…å­˜ å®‰è£…ä¾èµ–åº“\nuv init uv add git+https://github.com/huggingface/transformers@v4.51.3-Qwen2.5-Omni-preview uv add accelerate uv add qwen-omni-utils[decord] uv add soundfile uv add torchvision uv sync å®Œæ•´è„šæœ¬ä»£ç ï¼ˆmain_text2audio.pyï¼‰\nimport os import soundfile as sf import torch from transformers import Qwen2_5OmniForConditionalGeneration, Qwen2_5OmniProcessor from qwen_omni_utils import process_mm_info from transformers import AutoConfig def text_to_speech( text_input: str, output_audio_path: str = \u0026#34;output/test_audio.wav\u0026#34;, speaker: str = \u0026#34;Chelsie\u0026#34;, model_path: str = \u0026#34;/home/llm/model/qwen/Omni/\u0026#34; # æ”¹ä¸ºæœ¬åœ°è·¯å¾„æˆ–è¿œç¨‹è·¯å¾„ ): \u0026#34;\u0026#34;\u0026#34; æ–‡æœ¬è½¬è¯­éŸ³æ ¸å¿ƒå‡½æ•° :param text_input: è¾“å…¥æ–‡æœ¬ï¼ˆæ”¯æŒä¸­æ–‡/è‹±æ–‡ï¼‰ :param output_audio_path: éŸ³é¢‘è¾“å‡ºè·¯å¾„ï¼ˆå«æ–‡ä»¶åï¼‰ :param speaker: è¯­éŸ³ç±»å‹ï¼ˆ\u0026#34;Chelsie\u0026#34;å¥³æ€§/\u0026#34;Ethan\u0026#34;ç”·æ€§ï¼‰ :param model_path: æ¨¡å‹è·¯å¾„ï¼ˆæœ¬åœ°/è¿œç¨‹ï¼‰ \u0026#34;\u0026#34;\u0026#34; # 1. åŠ è½½æ¨¡å‹é…ç½®ï¼ˆä¿®å¤ROPEå‚æ•°å…¼å®¹æ€§ï¼‰ config = AutoConfig.from_pretrained(model_path, local_files_only=True) if hasattr(config, \u0026#34;rope_scaling\u0026#34;) and \u0026#34;mrope_section\u0026#34; in config.rope_scaling: config.rope_scaling.pop(\u0026#34;mrope_section\u0026#34;) # 2. åŠ è½½æ¨¡å‹ï¼ˆæ”¯æŒGPUè‡ªåŠ¨åˆ†é…ï¼‰ model = Qwen2_5OmniForConditionalGeneration.from_pretrained( model_path, config=config, torch_dtype=\u0026#34;auto\u0026#34;, device_map=\u0026#34;auto\u0026#34;, local_files_only=(model_path != \u0026#34;Qwen/Qwen2.5-Omni-7B\u0026#34;) ) processor = Qwen2_5OmniProcessor.from_pretrained(model_path) # 3. ç³»ç»Ÿæç¤ºï¼ˆå¿…é¡»åŒ…å«è¯­éŸ³ç”Ÿæˆèƒ½åŠ›å£°æ˜ï¼‰ system_prompt = [ { \u0026#34;role\u0026#34;: \u0026#34;system\u0026#34;, \u0026#34;content\u0026#34;: [ {\u0026#34;type\u0026#34;: \u0026#34;text\u0026#34;, \u0026#34;text\u0026#34;: \u0026#34;You are Qwen, a virtual human developed by the Qwen Team, Alibaba Group, capable of perceiving auditory and visual inputs, as well as generating text and speech.\u0026#34;} ] } ] # 4. æ„å»ºå¯¹è¯ï¼ˆçº¯æ–‡æœ¬è¾“å…¥ï¼‰ conversation = system_prompt + [ {\u0026#34;role\u0026#34;: \u0026#34;user\u0026#34;, \u0026#34;content\u0026#34;: [{\u0026#34;type\u0026#34;: \u0026#34;text\u0026#34;, \u0026#34;text\u0026#34;: text_input}]} ] # 5. å¤„ç†è¾“å…¥æ•°æ® text = processor.apply_chat_template(conversation, add_generation_prompt=True, tokenize=False) audios, images, videos = process_mm_info(conversation, use_audio_in_video=False) # 6. ç”Ÿæˆè¯­éŸ³ inputs = processor( text=text, audio=audios, images=images, videos=videos, return_tensors=\u0026#34;pt\u0026#34;, padding=True, use_audio_in_video=False ).to(model.device, model.dtype) with torch.no_grad(): text_ids, audio = model.generate( **inputs, speaker=speaker, do_sample=True, # å¯ç”¨é‡‡æ ·æ¨¡å¼ä»¥ä½¿ç”¨temperature/top_p temperature=0.8, # æ§åˆ¶éšæœºæ€§ï¼ˆ0.5-1.0è¾ƒè‡ªç„¶ï¼‰ top_p=0.95, # æ ¸é‡‡æ ·å‚æ•° max_new_tokens=1024, # æ§åˆ¶è¯­éŸ³æ—¶é•¿ï¼ˆçº¦15ç§’ï¼‰ use_audio_in_video=False ) # 7. ä¿å­˜ç»“æœ os.makedirs(os.path.dirname(output_audio_path), exist_ok=True) sf.write(output_audio_path, audio.reshape(-1).cpu().numpy(), samplerate=24000) print(f\u0026#34;âœ… ç”Ÿæˆå®Œæˆï¼š{output_audio_path}\u0026#34;) print(f\u0026#34;ğŸ“„ ç”Ÿæˆæ–‡æœ¬ï¼š{processor.batch_decode(text_ids, skip_special_tokens=True)[0]}\u0026#34;) if __name__ == \u0026#34;__main__\u0026#34;: # ç¤ºä¾‹è¾“å…¥ï¼ˆå¯æ›¿æ¢ä¸ºä»»æ„æ–‡æœ¬ï¼‰ input_text = \u0026#34;ä½ å¥½ï¼Œè¿™æ˜¯Qwen2.5-Omniçš„æ–‡æœ¬è½¬è¯­éŸ³ç¤ºä¾‹ã€‚ç¥ä½ ä½¿ç”¨æ„‰å¿«ï¼\u0026#34; # è°ƒç”¨å‡½æ•°ï¼ˆæŒ‡å®šè¾“å‡ºè·¯å¾„å’Œè¯­éŸ³ç±»å‹ï¼‰ text_to_speech( input_text, output_audio_path=\u0026#34;output/hello_qwen.wav\u0026#34;, speaker=\u0026#34;Chelsie\u0026#34; # å¯é€‰\u0026#34;Ethan\u0026#34; ) è¿è¡Œè„šæœ¬\nuv run main.py ","permalink":"https://jackypanster.github.io/ai-stream/posts/how-to-setup-qwen-omni/","summary":"\u003cp\u003e\u003cimg alt=\"Qwen2.5-Omni-7B TTS\" loading=\"lazy\" src=\"https://via.placeholder.com/800x400.png/007bff/ffffff?text=Qwen2.5-Omni-7B+TTS\"\u003e\u003c/p\u003e\n\u003ch2 id=\"æ¦‚è¿°\"\u003eæ¦‚è¿°\u003c/h2\u003e\n\u003cp\u003eæœ¬è„šæœ¬åŸºäº Qwen2.5-Omni-7B å¤šæ¨¡æ€æ¨¡å‹å®ç°æ–‡æœ¬è½¬è¯­éŸ³ï¼ˆTTSï¼‰åŠŸèƒ½ï¼Œæ”¯æŒç”Ÿæˆè‡ªç„¶æµç•…çš„ä¸­æ–‡ / è‹±æ–‡è¯­éŸ³ï¼Œå¹¶æä¾›ä¸¤ç§è¯­éŸ³ç±»å‹ï¼ˆå¥³æ€§ â€œChelsieâ€ã€ç”·æ€§ â€œEthanâ€ï¼‰ã€‚è„šæœ¬å¯å°†è¾“å…¥æ–‡æœ¬è½¬æ¢ä¸ºéŸ³é¢‘æ–‡ä»¶ï¼ˆ.wavæ ¼å¼ï¼‰ï¼Œé€‚ç”¨äºè¯­éŸ³åŠ©æ‰‹ã€å†…å®¹åˆ›ä½œã€æ— éšœç¢æœåŠ¡ç­‰åœºæ™¯ã€‚\u003c/p\u003e\n\u003ch2 id=\"ä¸»è¦ç‰¹æ€§\"\u003eä¸»è¦ç‰¹æ€§\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003eğŸ™ï¸ æ”¯æŒè‡ªç„¶æµç•…çš„ \u003cstrong\u003eä¸­æ–‡/è‹±æ–‡\u003c/strong\u003e è¯­éŸ³åˆæˆ\u003c/li\u003e\n\u003cli\u003eğŸ‘¥ æä¾›ä¸¤ç§è¯­éŸ³ç±»å‹é€‰æ‹©ï¼š\n\u003cul\u003e\n\u003cli\u003eå¥³æ€§å£°çº¿ï¼š\u0026ldquo;Chelsie\u0026rdquo;\u003c/li\u003e\n\u003cli\u003eç”·æ€§å£°çº¿ï¼š\u0026ldquo;Ethan\u0026rdquo;\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eğŸ’¾ è¾“å‡ºæ ¼å¼ï¼šæ ‡å‡† \u003ccode\u003e.wav\u003c/code\u003e éŸ³é¢‘æ–‡ä»¶\u003c/li\u003e\n\u003cli\u003eğŸš€ é«˜æ€§èƒ½æ¨ç†ï¼Œé€‚ç”¨äºç”Ÿäº§ç¯å¢ƒ\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"åº”ç”¨åœºæ™¯\"\u003eåº”ç”¨åœºæ™¯\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003eæ™ºèƒ½è¯­éŸ³åŠ©æ‰‹å¼€å‘\u003c/li\u003e\n\u003cli\u003eå†…å®¹åˆ›ä½œä¸æ’­å®¢åˆ¶ä½œ\u003c/li\u003e\n\u003cli\u003eæ— éšœç¢æœåŠ¡\u003c/li\u003e\n\u003cli\u003eæ•™è‚²ç±»åº”ç”¨\u003c/li\u003e\n\u003cli\u003eå¤šåª’ä½“å†…å®¹ç”Ÿæˆ\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"å¼€å§‹ä½¿ç”¨\"\u003eå¼€å§‹ä½¿ç”¨\u003c/h2\u003e\n\u003cblockquote\u003e\n\u003cp\u003eğŸ’¡ åœ¨å¼€å§‹ä¹‹å‰ï¼Œè¯·ç¡®ä¿æ‚¨çš„ç³»ç»Ÿæ»¡è¶³ä»¥ä¸‹è¦æ±‚ï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003ePython 3.8+\u003c/li\u003e\n\u003cli\u003eCUDA 11.7+ (å¦‚éœ€GPUåŠ é€Ÿ)\u003c/li\u003e\n\u003cli\u003eè‡³å°‘16GBå¯ç”¨å†…å­˜\u003c/li\u003e\n\u003c/ul\u003e\u003c/blockquote\u003e\n\u003cp\u003eå®‰è£…ä¾èµ–åº“\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003euv init\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003euv add git+https://github.com/huggingface/transformers@v4.51.3-Qwen2.5-Omni-preview\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003euv add accelerate\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003euv add qwen-omni-utils\u003cspan style=\"color:#f92672\"\u003e[\u003c/span\u003edecord\u003cspan style=\"color:#f92672\"\u003e]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003euv add soundfile\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003euv add torchvision\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003euv sync\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eå®Œæ•´è„šæœ¬ä»£ç ï¼ˆmain_text2audio.pyï¼‰\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-python\" data-lang=\"python\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e os\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e soundfile \u003cspan style=\"color:#66d9ef\"\u003eas\u003c/span\u003e sf\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e torch\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#f92672\"\u003efrom\u003c/span\u003e transformers \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e Qwen2_5OmniForConditionalGeneration, Qwen2_5OmniProcessor\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#f92672\"\u003efrom\u003c/span\u003e qwen_omni_utils \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e process_mm_info\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#f92672\"\u003efrom\u003c/span\u003e transformers \u003cspan style=\"color:#f92672\"\u003eimport\u003c/span\u003e AutoConfig\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#66d9ef\"\u003edef\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003etext_to_speech\u003c/span\u003e(\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    text_input: str,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    output_audio_path: str \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;output/test_audio.wav\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    speaker: str \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Chelsie\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    model_path: str \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;/home/llm/model/qwen/Omni/\u0026#34;\u003c/span\u003e  \u003cspan style=\"color:#75715e\"\u003e# æ”¹ä¸ºæœ¬åœ°è·¯å¾„æˆ–è¿œç¨‹è·¯å¾„\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e):\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;\u0026#34;\u0026#34;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003e    æ–‡æœ¬è½¬è¯­éŸ³æ ¸å¿ƒå‡½æ•°\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003e    :param text_input: è¾“å…¥æ–‡æœ¬ï¼ˆæ”¯æŒä¸­æ–‡/è‹±æ–‡ï¼‰\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003e    :param output_audio_path: éŸ³é¢‘è¾“å‡ºè·¯å¾„ï¼ˆå«æ–‡ä»¶åï¼‰\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003e    :param speaker: è¯­éŸ³ç±»å‹ï¼ˆ\u0026#34;Chelsie\u0026#34;å¥³æ€§/\u0026#34;Ethan\u0026#34;ç”·æ€§ï¼‰\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003e    :param model_path: æ¨¡å‹è·¯å¾„ï¼ˆæœ¬åœ°/è¿œç¨‹ï¼‰\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003e    \u0026#34;\u0026#34;\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#75715e\"\u003e# 1. åŠ è½½æ¨¡å‹é…ç½®ï¼ˆä¿®å¤ROPEå‚æ•°å…¼å®¹æ€§ï¼‰\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    config \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e AutoConfig\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003efrom_pretrained(model_path, local_files_only\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#66d9ef\"\u003eTrue\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e hasattr(config, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;rope_scaling\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003eand\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;mrope_section\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003ein\u003c/span\u003e config\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003erope_scaling:\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        config\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003erope_scaling\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003epop(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;mrope_section\u0026#34;\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#75715e\"\u003e# 2. åŠ è½½æ¨¡å‹ï¼ˆæ”¯æŒGPUè‡ªåŠ¨åˆ†é…ï¼‰\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    model \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e Qwen2_5OmniForConditionalGeneration\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003efrom_pretrained(\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        model_path,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        config\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003econfig,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        torch_dtype\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;auto\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        device_map\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;auto\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        local_files_only\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e(model_path \u003cspan style=\"color:#f92672\"\u003e!=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Qwen/Qwen2.5-Omni-7B\u0026#34;\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    )\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    processor \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e Qwen2_5OmniProcessor\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003efrom_pretrained(model_path)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#75715e\"\u003e# 3. ç³»ç»Ÿæç¤ºï¼ˆå¿…é¡»åŒ…å«è¯­éŸ³ç”Ÿæˆèƒ½åŠ›å£°æ˜ï¼‰\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    system_prompt \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e [\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;role\u0026#34;\u003c/span\u003e: \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;system\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;content\u0026#34;\u003c/span\u003e: [\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                {\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;type\u0026#34;\u003c/span\u003e: \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;text\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;text\u0026#34;\u003c/span\u003e: \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;You are Qwen, a virtual human developed by the Qwen Team, Alibaba Group, capable of perceiving auditory and visual inputs, as well as generating text and speech.\u0026#34;\u003c/span\u003e}\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            ]\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    ]\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#75715e\"\u003e# 4. æ„å»ºå¯¹è¯ï¼ˆçº¯æ–‡æœ¬è¾“å…¥ï¼‰\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    conversation \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e system_prompt \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e [\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        {\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;role\u0026#34;\u003c/span\u003e: \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;user\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;content\u0026#34;\u003c/span\u003e: [{\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;type\u0026#34;\u003c/span\u003e: \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;text\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;text\u0026#34;\u003c/span\u003e: text_input}]}\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    ]\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#75715e\"\u003e# 5. å¤„ç†è¾“å…¥æ•°æ®\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    text \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e processor\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003eapply_chat_template(conversation, add_generation_prompt\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#66d9ef\"\u003eTrue\u003c/span\u003e, tokenize\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#66d9ef\"\u003eFalse\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    audios, images, videos \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e process_mm_info(conversation, use_audio_in_video\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#66d9ef\"\u003eFalse\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#75715e\"\u003e# 6. ç”Ÿæˆè¯­éŸ³\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    inputs \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e processor(\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        text\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003etext, audio\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003eaudios, images\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003eimages, videos\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003evideos,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        return_tensors\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;pt\u0026#34;\u003c/span\u003e, padding\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#66d9ef\"\u003eTrue\u003c/span\u003e, use_audio_in_video\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#66d9ef\"\u003eFalse\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    )\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003eto(model\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003edevice, model\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003edtype)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#66d9ef\"\u003ewith\u003c/span\u003e torch\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003eno_grad():\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        text_ids, audio \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e model\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003egenerate(\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            \u003cspan style=\"color:#f92672\"\u003e**\u003c/span\u003einputs,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            speaker\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003espeaker,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            do_sample\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#66d9ef\"\u003eTrue\u003c/span\u003e,  \u003cspan style=\"color:#75715e\"\u003e# å¯ç”¨é‡‡æ ·æ¨¡å¼ä»¥ä½¿ç”¨temperature/top_p\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            temperature\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e0.8\u003c/span\u003e,  \u003cspan style=\"color:#75715e\"\u003e# æ§åˆ¶éšæœºæ€§ï¼ˆ0.5-1.0è¾ƒè‡ªç„¶ï¼‰\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            top_p\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e0.95\u003c/span\u003e,       \u003cspan style=\"color:#75715e\"\u003e# æ ¸é‡‡æ ·å‚æ•°\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            max_new_tokens\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e1024\u003c/span\u003e,  \u003cspan style=\"color:#75715e\"\u003e# æ§åˆ¶è¯­éŸ³æ—¶é•¿ï¼ˆçº¦15ç§’ï¼‰\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e            use_audio_in_video\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#66d9ef\"\u003eFalse\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        )\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#75715e\"\u003e# 7. ä¿å­˜ç»“æœ\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    os\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003emakedirs(os\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003epath\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003edirname(output_audio_path), exist_ok\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#66d9ef\"\u003eTrue\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    sf\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003ewrite(output_audio_path, audio\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003ereshape(\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003ecpu()\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003enumpy(), samplerate\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e24000\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    print(\u003cspan style=\"color:#e6db74\"\u003ef\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;âœ… ç”Ÿæˆå®Œæˆï¼š\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e{\u003c/span\u003eoutput_audio_path\u003cspan style=\"color:#e6db74\"\u003e}\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    print(\u003cspan style=\"color:#e6db74\"\u003ef\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;ğŸ“„ ç”Ÿæˆæ–‡æœ¬ï¼š\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e{\u003c/span\u003eprocessor\u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003ebatch_decode(text_ids, skip_special_tokens\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#66d9ef\"\u003eTrue\u003c/span\u003e)[\u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e]\u003cspan style=\"color:#e6db74\"\u003e}\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e __name__ \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;__main__\u0026#34;\u003c/span\u003e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#75715e\"\u003e# ç¤ºä¾‹è¾“å…¥ï¼ˆå¯æ›¿æ¢ä¸ºä»»æ„æ–‡æœ¬ï¼‰\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    input_text \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;ä½ å¥½ï¼Œè¿™æ˜¯Qwen2.5-Omniçš„æ–‡æœ¬è½¬è¯­éŸ³ç¤ºä¾‹ã€‚ç¥ä½ ä½¿ç”¨æ„‰å¿«ï¼\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#75715e\"\u003e# è°ƒç”¨å‡½æ•°ï¼ˆæŒ‡å®šè¾“å‡ºè·¯å¾„å’Œè¯­éŸ³ç±»å‹ï¼‰\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    text_to_speech(\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        input_text,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        output_audio_path\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;output/hello_qwen.wav\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e        speaker\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Chelsie\u0026#34;\u003c/span\u003e  \u003cspan style=\"color:#75715e\"\u003e# å¯é€‰\u0026#34;Ethan\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    )\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eè¿è¡Œè„šæœ¬\u003c/p\u003e","title":"Qwen2.5-Omni-7B æ–‡æœ¬è½¬è¯­éŸ³éƒ¨ç½²æŒ‡å—"}]